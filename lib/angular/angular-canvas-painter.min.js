"use strict";!function(t){angular.module("pw.canvas-painter",[]),function(t){try{t=angular.module("pw.canvas-painter")}catch(e){t=angular.module("pw.canvas-painter",[])}t.run(["$templateCache",function(t){t.put("../templates/canvas.html",'<div class="pwCanvasPaint" style="position:relative"></div>')}])}(),function(t){try{t=angular.module("pw.canvas-painter")}catch(e){t=angular.module("pw.canvas-painter",[])}t.run(["$templateCache",function(t){t.put("../templates/color-selector.html",'<ul class="pwColorSelector"><li ng-repeat="color in colorList track by $index" class="pwColor" ng-class="{\'active\': (selectedColor === color)}" ng-style="{\'background-color\':color}" ng-click="setColor(color)"></li></ul>')}])}(),angular.module("pw.canvas-painter").directive("pwCanvas",function(){return{restrict:"AE",scope:{options:"=",version:"="},templateUrl:"../templates/canvas.html",link:function(e,n){var o=!!("ontouchstart"in t),a=o?"touchstart":"mousedown",i=o?"touchmove":"mousemove",r=o?"touchend":"mouseup",l=e.options;if(l.canvasId=l.customCanvasId||"pwCanvasMain",l.tmpCanvasId=l.customCanvasId?l.canvasId+"Tmp":"pwCanvasTmp",l.width=l.width||400,l.height=l.height||300,l.backgroundColor=l.backgroundColor||"#fff",l.color=l.color||"#000",l.undoEnabled=l.undoEnabled||!1,l.opacity=l.opacity||.9,l.lineWidth=l.lineWidth||1,l.undo=l.undo||!1,l.imageSrc=l.imageSrc||!1,l.imageSrc){var c=new Image;c.onload=function(){h.drawImage(this,0,0)},c.src=l.imageSrc}if(l.undo){var s=[];e.$watch(function(){return s.length},function(t){e.version=t}),e.$watch("version",function(t){return 0>t?(e.version=0,void 0):t>=s.length?(e.version=s.length,void 0):(b(t),void 0)})}var u=document.createElement("canvas");u.id=l.canvasId;var d=document.createElement("canvas");d.id=l.tmpCanvasId,angular.element(d).css({position:"absolute",top:0,left:0}),n.find("div").append(u),n.find("div").append(d);var h=u.getContext("2d"),p=d.getContext("2d"),v={x:0,y:0},f=[];u.width=d.width=l.width,u.height=d.height=l.height,h.fillStyle=l.backgroundColor,h.fillRect(0,0,u.width,u.height),p.globalAlpha=l.opacity,p.lineJoin=p.lineCap="round",p.lineWidth=10,p.strokeStyle=l.color,e.$watch("options.lineWidth",function(t){"string"==typeof t&&(t=parseInt(t,10)),t&&"number"==typeof t&&(p.lineWidth=l.lineWidth=t)}),e.$watch("options.color",function(t){t&&(p.strokeStyle=p.fillStyle=t)}),e.$watch("options.opacity",function(t){t&&(p.globalAlpha=t)});var g=function(t){var e=0,n=0;do isNaN(t.offsetLeft)||(e+=t.offsetTop,n+=t.offsetLeft),t=t.offsetParent;while(t);return{left:n,top:e}},m=function(t,e){o?(t.x=e.changedTouches[0].pageX-g(e.target).left,t.y=e.changedTouches[0].pageY-g(e.target).top):(t.x=void 0!==e.offsetX?e.offsetX:e.layerX,t.y=void 0!==e.offsetY?e.offsetY:e.layerY)},w=function(t){if(t&&(t.preventDefault(),m(v,t)),f.push({x:v.x,y:v.y}),3===f.length){var e=f[0];return p.beginPath(),p.arc(e.x,e.y,p.lineWidth/2,0,2*Math.PI,!0),p.fill(),p.closePath(),void 0}p.clearRect(0,0,d.width,d.height),p.beginPath(),p.moveTo(f[0].x,f[0].y);for(var n=1;n<f.length-2;n++){var o=(f[n].x+f[n+1].x)/2,a=(f[n].y+f[n+1].y)/2;p.quadraticCurveTo(f[n].x,f[n].y,o,a)}p.quadraticCurveTo(f[n].x,f[n].y,f[n+1].x,f[n+1].y),p.stroke()},y=function(){l.undo&&e.$apply(function(){s.push(h.getImageData(0,0,d.width,d.height)),angular.isNumber(l.undo)&&l.undo>0&&(s=s.slice(-1*l.undo))}),d.removeEventListener(i,w,!1),h.drawImage(d,0,0),p.clearRect(0,0,d.width,d.height),f=[]},C=function(t){t.preventDefault(),d.addEventListener(i,w,!1),m(v,t),f.push({x:v.x,y:v.y}),f.push({x:v.x,y:v.y}),w()},x=function(){d.addEventListener(a,C,!1),d.addEventListener(r,y,!1),o||(d.addEventListener("mouseenter",function(t){1===t.which&&C(t)},!1),d.addEventListener("mouseleave",function(t){1===t.which&&y(t)},!1))};x();var b=function(t){s.length>0&&(h.putImageData(s[t],0,0),s=s.slice(0,t))}}}}),angular.module("pw.canvas-painter").directive("pwColorSelector",function(){return{restrict:"AE",scope:{colorList:"=pwColorSelector",selectedColor:"=color"},templateUrl:"../templates/color-selector.html",link:function(t){t.setColor=function(e){t.selectedColor=e}}}})}(this);