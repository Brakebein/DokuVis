!function(){"use strict";angular.module("ngDebounceThrottle",[]).factory("$debounce",["$rootScope","$timeout",function($rootScope,$timeout){return function(callback,delay,leading,invokeApply){var context,args,timeout,result,later=function(){!(timeout=null)!==leading&&(!1!==invokeApply&&$rootScope.$applyAsync(),result=callback.apply(context,args))};function debounce(){context=this,args=arguments;var callNow=leading&&!timeout;return timeout&&$timeout.cancel(timeout),timeout=$timeout(later,delay,!1),callNow&&(!1!==invokeApply&&$rootScope.$applyAsync(),result=callback.apply(context,args)),result}return debounce.cancel=function(){$timeout.cancel(timeout),timeout=null},debounce}}]).factory("$throttle",["$rootScope","$timeout",function($rootScope,$timeout){return function(callback,delay,leading,trailing,invokeApply){var context,args,timeout,result,previous=0,later=function(){previous=!1===leading?0:(new Date).getTime(),!(timeout=null)===invokeApply&&$rootScope.$applyAsync(),result=callback.apply(context,args),timeout||(context=args=null)},throttled=function(){context=this,args=arguments;var now=(new Date).getTime();previous||!1!==leading||(previous=now);var remaining=delay-(now-previous);return remaining<=0||delay<remaining?(timeout&&($timeout.cancel(timeout),timeout=null),previous=now,!0===invokeApply&&$rootScope.$applyAsync(),result=callback.apply(context,args),timeout||(context=args=null)):timeout||!1===trailing||(timeout=$timeout(later,remaining,!1)),result};return throttled.cancel=function(){$timeout.cancel(timeout),previous=0,timeout=context=args=null},throttled}}])}(),function(){"use strict";var dokuvisApp=angular.module("dokuvisApp",["ui.router","ct.ui.router.extras.sticky","ct.ui.router.extras.previous","ngResource","ngAnimate","ngSanitize","ngDebounceThrottle","truncate","xeditable","mgcrea.ngStrap","angularMoment","ngScrollbars","textAngular","ngTagsInput","minicolors","angularFileUpload","pw.canvas-painter","mm.acl","ngCookies","pascalprecht.translate","dokuvis.auth","dokuvis.utils","dokuvis.projects","dokuvis.subprojects","dokuvis.projinfos","dokuvis.sources","dokuvis.archives","dokuvis.authors","dokuvis.models","dokuvis.viewport","dokuvis.comments","dokuvis.categories","dokuvis.tasks","dokuvis.staff","dokuvis.imageViewer","dokuvis.activities"]);dokuvisApp.constant("API","api/"),dokuvisApp.constant("ApiBase","api/"),dokuvisApp.constant("ApiAuth","api/auth/"),dokuvisApp.constant("ApiProject","api/auth/project"),dokuvisApp.constant("ApiSubproject","api/auth/project/:project/subproject"),dokuvisApp.constant("ApiSource","api/auth/project/:project/:subproject/source"),dokuvisApp.constant("ApiComment","api/auth/project/:project/:subproject/comment"),dokuvisApp.constant("ApiProjinfo","api/auth/project/:project/:subproject/projinfo"),dokuvisApp.constant("ApiArchive","api/auth/project/:project/archive"),dokuvisApp.constant("ApiAuthor","api/auth/project/:project/author"),dokuvisApp.constant("ApiCategory","api/auth/project/:project/category"),dokuvisApp.constant("ApiTask","api/auth/project/:project/task"),dokuvisApp.constant("ApiStaff","api/auth/project/:project/staff"),dokuvisApp.constant("ApiRoles","api/roles"),dokuvisApp.constant("ApiModelVersion","api/auth/project/:project/:subproject/model/version"),dokuvisApp.constant("ApiSoftware","api/auth/project/:project/software"),dokuvisApp.constant("ApiActivity","api/auth/project/:project/:subproject/activity"),dokuvisApp.factory("ApiParams",["$stateParams",function($stateParams){return{project:function(){return $stateParams.project},subproject:function(){return $stateParams.subproject}}}]),dokuvisApp.config(["$stateProvider","$urlRouterProvider","$httpProvider","$translateProvider","$translatePartialLoaderProvider","$modalProvider","$alertProvider","$tooltipProvider","$typeaheadProvider","$logProvider","$compileProvider",function($stateProvider,$urlRouterProvider,$httpProvider,$translateProvider,$translatePartialLoaderProvider,$modalProvider,$alertProvider,$tooltipProvider,$typeaheadProvider,$logProvider,$compileProvider){$httpProvider.interceptors.push("TokenInterceptor"),$urlRouterProvider.otherwise("/home");var archiveModalState={url:"/archive/:archiveId",resolve:{archiveModalInstance:["$modal",function($modal){return $modal({templateUrl:"partials/modals/_modalTpl.6301fc2c.html",contentTemplate:"components/dokuvis.archives/archiveModal.tpl.ad64d840.html",controller:"archiveModalCtrl",show:!1})}]},onEnter:["$translatePartialLoader","archiveModalInstance",function($translatePartialLoader,archiveModalInstance){$translatePartialLoader.addPart("archive"),archiveModalInstance.$promise.then(archiveModalInstance.show)}],onExit:["archiveModalInstance",function(archiveModalInstance){archiveModalInstance.hide(),archiveModalInstance.destroy()}],params:{archiveId:"new"}};$stateProvider.state("root",{template:'<div ui-view="header"></div><div class="rootContent" ui-view></div><div ui-view="footer"></div>'}).state("root.home",{url:"/home",views:{"":{templateUrl:"partials/home.5fe9d281.html"},header:{templateUrl:"partials/navbar.10b6e441.html",controller:"navCtrl"},footer:{templateUrl:"partials/footer.f531ae35.html"}},resolve:{validate:["ValidateResolve",function(ValidateResolve){return ValidateResolve()}]}}).state("root.impressum",{url:"/impressum",views:{"":{templateUrl:"partials/impressum.64bbc3f0.html"},header:{templateUrl:"partials/navbar.10b6e441.html",controller:"navCtrl"},footer:{templateUrl:"partials/footer.f531ae35.html"}},resolve:{validate:["ValidateResolve",function(ValidateResolve){return ValidateResolve()}]}}).state("root.register",{url:"/register",views:{"":{templateUrl:"partials/register.4fca307d.html",controller:"registerCtrl"},header:{templateUrl:"partials/navbar.10b6e441.html",controller:"navCtrl"},footer:{templateUrl:"partials/footer.f531ae35.html"}},resolve:{skipIfLogged:["SkipResolve",function(SkipResolve){return SkipResolve()}]}}).state("root.projectlist",{url:"/list",views:{"":{templateUrl:"partials/projects.8384fdca.html",controller:"projectlistCtrl"},header:{templateUrl:"partials/navbar.10b6e441.html",controller:"navCtrl"},footer:{templateUrl:"partials/footer.f531ae35.html"}},resolve:{authenticate:["AuthenticateResolve",function(AuthenticateResolve){return AuthenticateResolve()}]},onEnter:["$translatePartialLoader",function($translatePartialLoader){$translatePartialLoader.addPart("projects")}]}).state("root.projectlist.project",{url:"/project/:projectId",resolve:{projectModalInstance:["$modal",function($modal){return $modal({templateUrl:"partials/modals/_modalTpl.6301fc2c.html",contentTemplate:"components/dokuvis.projects/projectModal.tpl.aff7653b.html",controller:"projectModalCtrl",show:!1})}]},onEnter:["projectModalInstance",function(projectModalInstance){projectModalInstance.$promise.then(projectModalInstance.show)}],onExit:["projectModalInstance",function(projectModalInstance){projectModalInstance.hide(),projectModalInstance.destroy()}],params:{projectId:"new"}}).state("project",{url:"/:project/:subproject",templateUrl:"partials/project.9356c691.html",controller:"projectCtrl",resolve:{authenticate:["AuthenticateResolve",function(AuthenticateResolve){return AuthenticateResolve()}],checkProject:["$stateParams","ProjectResolve",function($stateParams,ProjectResolve){return ProjectResolve($stateParams)}],checkSubproject:["$stateParams","SubprojectResolve",function($stateParams,SubprojectResolve){return SubprojectResolve($stateParams)}]},abstract:!0}).state("project.home",{url:"/home",templateUrl:"partials/projHome.53750c72.html",controller:"projHomeCtrl"}).state("project.home.subproject",{url:"/subproject/:subprojectId",resolve:{subprojectModalInstance:["$modal",function($modal){return $modal({templateUrl:"partials/modals/_modalTpl.6301fc2c.html",contentTemplate:"components/dokuvis.subprojects/subprojectModal.tpl.8bd9070e.html",controller:"subprojectModalCtrl",show:!1})}]},onEnter:["subprojectModalInstance",function(subprojectModalInstance){subprojectModalInstance.$promise.then(subprojectModalInstance.show)}],onExit:["subprojectModalInstance",function(subprojectModalInstance){subprojectModalInstance.hide(),subprojectModalInstance.destroy()}],params:{subprojectId:"new"}}).state("project.home.projinfo",{url:"/projinfo/:infoId",resolve:{projinfoModalInstance:["$modal",function($modal){return $modal({templateUrl:"partials/modals/_modalLargeTpl.e4934810.html",contentTemplate:"components/dokuvis.projinfos/projinfoModal.tpl.accb7be4.html",controller:"projinfoModalCtrl",show:!1})}]},onEnter:["projinfoModalInstance",function(projinfoModalInstance){projinfoModalInstance.$promise.then(projinfoModalInstance.show)}],onExit:["projinfoModalInstance",function(projinfoModalInstance){projinfoModalInstance.hide(),projinfoModalInstance.destroy()}],params:{infoId:"new"}}).state("project.explorer",{url:"/explorer?camera",templateUrl:"partials/explorer.530f8ddf.html",controller:"explorerCtrl",reloadOnSearch:!1,onEnter:["$translatePartialLoader",function($translatePartialLoader){$translatePartialLoader.addPart("sources"),$translatePartialLoader.addPart("model"),$translatePartialLoader.addPart("viewport"),$translatePartialLoader.addPart("comment"),$translatePartialLoader.addPart("category")}],params:{initialVersion:null,initialComment:null}}).state("project.explorer.source",{url:"/source",resolve:{sourceDetailModalInstance:["$translatePartialLoader","$modal",function($translatePartialLoader,$modal){return $translatePartialLoader.addPart("source"),$translatePartialLoader.addPart("languages"),$modal({templateUrl:"partials/modals/_modalLargeTpl.e4934810.html",contentTemplate:"components/dokuvis.sources/sourceDetailModal.tpl.8d00e345.html",controller:"sourceDetailModalCtrl",show:!1})}]},onEnter:["sourceDetailModalInstance",function(sourceDetailModalInstance){sourceDetailModalInstance.$promise.then(sourceDetailModalInstance.show)}],onExit:["sourceDetailModalInstance",function(sourceDetailModalInstance){sourceDetailModalInstance.hide(),sourceDetailModalInstance.destroy()}],reloadOnSearch:!1,abstract:!0}).state("project.explorer.source.id",{url:"/:sourceId"}).state("project.explorer.source.id.edit",{url:"/edit",resolve:{sourceEditModalInstance:["$modal",function($modal){return $modal({templateUrl:"partials/modals/_modalTpl.6301fc2c.html",contentTemplate:"components/dokuvis.sources/sourceEditModal.tpl.9c8d01d1.html",controller:"sourceEditModalCtrl",show:!1})}]},onEnter:["sourceEditModalInstance",function(sourceEditModalInstance){sourceEditModalInstance.$promise.then(sourceEditModalInstance.show)}],onExit:["sourceEditModalInstance",function(sourceEditModalInstance){sourceEditModalInstance.hide(),sourceEditModalInstance.destroy()}]}).state("project.explorer.source.id.edit.archive",angular.copy(archiveModalState)).state("project.explorer.model",{url:"/model",onEnter:["$modal",function($modal){$modal({templateUrl:"partials/modals/_modalTpl.6301fc2c.html",contentTemplate:"partials/modals/modelModal.d20fb2fc.html",controller:"modelModalCtrl",show:!0})}],abstract:!0}).state("project.explorer.model.id",{url:"/:modelId"}).state("project.explorer.upload",{url:"/upload",abstract:!0}).state("project.explorer.upload.model",{url:"/model",resolve:{modelUploadModalInstance:["$translatePartialLoader","$modal",function($translatePartialLoader,$modal){return $translatePartialLoader.addPart("source"),$modal({templateUrl:"partials/modals/_modalTpl.6301fc2c.html",contentTemplate:"components/dokuvis.models/modelUploadModal.tpl.ff58224d.html",controller:"modelUploadModalCtrl",show:!1})}]},onEnter:["modelUploadModalInstance",function(modelUploadModalInstance){modelUploadModalInstance.$promise.then(modelUploadModalInstance.show)}],onExit:["modelUploadModalInstance","ModelUploader",function(modelUploadModalInstance,ModelUploader){modelUploadModalInstance.hide(),modelUploadModalInstance.destroy(),ModelUploader.clearQueue()}],params:{parent:null}}).state("project.explorer.upload.source",{url:"/source",resolve:{sourceUploadModalInstance:["$translatePartialLoader","$modal",function($translatePartialLoader,$modal){return $translatePartialLoader.addPart("source"),$translatePartialLoader.addPart("languages"),$modal({templateUrl:"partials/modals/_modalLargeTpl.e4934810.html",contentTemplate:"components/dokuvis.sources/sourceUploadModal.tpl.3f5e5b7a.html",controller:"sourceUploadModalCtrl",show:!1})}]},onEnter:["sourceUploadModalInstance",function(sourceUploadModalInstance){sourceUploadModalInstance.$promise.then(sourceUploadModalInstance.show)}],onExit:["sourceUploadModalInstance","SourceUploader",function(sourceUploadModalInstance,SourceUploader){sourceUploadModalInstance.hide(),sourceUploadModalInstance.destroy(),SourceUploader.clearQueue()}]}).state("project.explorer.upload.source.archive",angular.copy(archiveModalState)).state("project.explorer.category",{url:"/category",resolve:{categoryModalInstance:["$modal",function($modal){return $modal({templateUrl:"partials/modals/_modalTpl.6301fc2c.html",contentTemplate:"partials/modals/categoryConfigModal.4ed02f9f.html",controller:"simpleModalCtrl",show:!1})}]},onEnter:["categoryModalInstance",function(categoryModalInstance){categoryModalInstance.$promise.then(categoryModalInstance.show)}],onExit:["categoryModalInstance",function(categoryModalInstance){categoryModalInstance.hide(),categoryModalInstance.destroy()}]}).state("project.explorer.version",{url:"/version/:versionId",resolve:{versionModalInstance:["$modal",function($modal){return $modal({templateUrl:"partials/modals/_modalTpl.6301fc2c.html",contentTemplate:"components/dokuvis.models/versionModal.tpl.3eb8edfb.html",controller:"versionModalCtrl",show:!1})}]},onEnter:["versionModalInstance",function(versionModalInstance){versionModalInstance.$promise.then(versionModalInstance.show)}],onExit:["versionModalInstance",function(versionModalInstance){versionModalInstance.hide(),versionModalInstance.destroy()}]}).state("project.explorer.spatialize",{url:"/spatialize",onEnter:["$modal",function($modal){$modal({templateUrl:"partials/modals/_modalXLargeTpl.8fafa1f9.html",contentTemplate:"partials/modals/spatializeModal.b3e1d3c7.html",controller:"spatializeModalCtrl",show:!0})}],params:{source:null},resolve:{check:["$q","$state","$stateParams","$timeout",function($q,$state,$stateParams,$timeout){return $stateParams.source?$q.resolve():($timeout(function(){$state.go("project.explorer",$stateParams)}),$q.reject())}]}}).state("project.tasks",{url:"/tasks",templateUrl:"partials/tasks.6547e080.html",controller:"tasksCtrl",onEnter:["$translatePartialLoader",function($translatePartialLoader){$translatePartialLoader.addPart("comment")}],params:{initialTask:null}}).state("project.tasks.detail",{url:"/:taskId",resolve:{taskModalInstance:["$modal",function($modal){return $modal({templateUrl:"partials/modals/_modalTpl.6301fc2c.html",contentTemplate:"components/dokuvis.tasks/taskModal.tpl.cc645f76.html",controller:"taskModalCtrl",show:!1})}]},onEnter:["taskModalInstance",function(taskModalInstance){taskModalInstance.$promise.then(taskModalInstance.show)}],onExit:["taskModalInstance",function(taskModalInstance){taskModalInstance.hide(),taskModalInstance.destroy()}],params:{parent:null}}).state("project.graph",{url:"/graph",templateUrl:"partials/graph.c0e613b7.html"}).state("project.graph.node",{url:"/:startNode"}).state("project.resources",{url:"/resources?foo",templateUrl:"partials/resources.a0ca1036.html",controller:"resourcesCtrl",onEnter:["$translatePartialLoader",function($translatePartialLoader){$translatePartialLoader.addPart("archive"),$translatePartialLoader.addPart("author")}]}).state("project.resources.archive",archiveModalState).state("project.resources.author",{url:"/author/:authorId",resolve:{authorModalInstance:["$modal",function($modal){return $modal({templateUrl:"partials/modals/_modalTpl.6301fc2c.html",contentTemplate:"components/dokuvis.authors/authorModal.tpl.4965bfda.html",controller:"authorModalCtrl",show:!1})}]},onEnter:["authorModalInstance",function(authorModalInstance){authorModalInstance.$promise.then(authorModalInstance.show)}],onExit:["authorModalInstance",function(authorModalInstance){authorModalInstance.hide(),authorModalInstance.destroy()}],params:{authorId:"new"}}).state("project.config",{url:"/config",templateUrl:"partials/config.38805308.html",controller:"configCtrl",onEnter:["$translatePartialLoader",function($translatePartialLoader){$translatePartialLoader.addPart("config")}]}).state("project.config.staffedit",{url:"/staffedit",resolve:{staffModalInstance:["$modal",function($modal){return $modal({templateUrl:"partials/modals/_modalTpl.6301fc2c.html",contentTemplate:"components/dokuvis.staff/staffModal.tpl.cf221513.html",controller:"staffModalCtrl",show:!1})}]},onEnter:["staffModalInstance",function(staffModalInstance){staffModalInstance.$promise.then(staffModalInstance.show)}],onExit:["staffModalInstance",function(staffModalInstance){staffModalInstance.hide(),staffModalInstance.destroy()}]}),$translateProvider.useSanitizeValueStrategy("sanitizeParameters").useLoader("$translatePartialLoader",{urlTemplate:"/i18n/{part}/{lang}.json"}).registerAvailableLanguageKeys(["en-US","de-DE"],{"en_*":"en-US","de_*":"de-DE","en-*":"en-US","de-*":"de-DE",en:"en-US",de:"de-DE"}).determinePreferredLanguage().useLocalStorage().fallbackLanguage("de-DE"),$translatePartialLoaderProvider.addPart("general"),$translatePartialLoaderProvider.addPart("menu"),angular.extend($modalProvider.defaults,{backdrop:"static",keyboard:!1}),angular.extend($alertProvider.defaults,{keyboard:!1}),angular.extend($tooltipProvider.defaults,{placement:"right",delay:{show:500,hide:100}}),angular.extend($typeaheadProvider.defaults,{delay:{show:500,hide:0},minLength:3}),$logProvider.debugEnabled(!0),$compileProvider.debugInfoEnabled(!0),$compileProvider.commentDirectivesEnabled(!1),$compileProvider.cssClassDirectivesEnabled(!1)}]),dokuvisApp.run(["$rootScope","$state","AuthenticationFactory","AclService","$translate","amMoment","editableOptions","TypeaheadRequest",function($rootScope,$state,AuthenticationFactory,AclService,$translate,amMoment,editableOptions,TypeaheadRequest){AclService.setAbilities({guest:["login","register"],member:["logout","project_create"],visitor:[],historian:["source_upload","source_edit","source_delete","info_edit","archive_edit","author_edit"],modeler:["model_upload","model_edit"],admin:["manage_content","subproject_edit","staff_edit"],superadmin:["project_edit"]}),AclService.attachRole("guest"),$rootScope.can=AclService.can,$rootScope.$on("$translatePartialLoaderStructureChanged",function(){$translate.refresh()}),$rootScope.$on("$stateChangeSuccess",function(){$rootScope.isLogged=AuthenticationFactory.isLogged,$rootScope.userName=AuthenticationFactory.userName}),editableOptions.theme="bs3",$rootScope.availableLanguages=[{key:"en-US",shortKey:"en",label:"English"},{key:"de-DE",shortKey:"de",label:"Deutsch"}],$translate.onReady(function(){var key=$translate.proposedLanguage()||$translate.use();$rootScope.currentLanguage=$rootScope.availableLanguages.find(function(lang){return lang.key===key}),amMoment.changeLocale($rootScope.currentLanguage.shortKey)}),$rootScope.setLanguage=function(){$translate.use($rootScope.currentLanguage.key),amMoment.changeLocale($rootScope.currentLanguage.shortKey)},$rootScope.setTypeahead=function(label,from,prop){TypeaheadRequest.query(label,from,prop).then(function(response){$rootScope.typeaheads=response.data},function(err){console.error(err)})}}])}(),angular.module("dokuvisApp").factory("APIRequest",["$http","API","$stateParams",function($http,API,$stateParams){var requests={assignCategoryToObjects:function(e73ids,attrId){return $http.post(API+"auth/project/"+$stateParams.project+"/"+$stateParams.subproject+"/assignCategory",{objects:e73ids,attrId:attrId})}};return requests}]),angular.module("dokuvisApp").factory("neo4jRequest",["$http","Utilities",function($http,Utilities){var phpUrl="php/neo4jrequest.php",requests={getAttached3DPlan:function(prj,e31content,e36content){return $http.post(phpUrl,{query:"MATCH (:E31:"+prj+" {content: {e31id}})<-[:P138]-(:E36:"+prj+" {content: {e36id}})-[:P106]->(e73:E73)-[:P1]->(e75:E75) RETURN e73 AS object, e75 AS file",params:{e31id:e31content,e36id:e36content}})},attach3DPlan:function(prj,formData,objData,parent){var q="";return q+="MATCH (parent:E31:"+prj+" {content: {parentid}})",q+=",(tmodel:E55:"+prj+' {content: "model"})',q+=" CREATE (parent)<-[:P138]-(e36:E36:"+prj+" {content: {contentid}})-[:P2]->(tmodel)",q+=" CREATE (e73:E73:"+prj+" {e73content})-[:P1]->(e75:E75:"+prj+" {e75content})",q+=" CREATE (e36)-[:P106]->(e73)",q+=" RETURN e73",$http.post(phpUrl,{query:q,params:{contentid:"e36_"+formData.pureNewFileName,parentid:parent.eid,e73content:{content:"e73_"+formData.pureNewFileName,name:objData.name,type:objData.type,materialName:objData.materialName,materialMap:objData.materialMap,materialMapPath:formData.path+"maps/"},e75content:{content:objData.file,path:formData.path}}})}};return requests}]),angular.module("dokuvisApp").factory("phpRequest",["$http",function($http){var requests={indexDocuments:function(prj){return $http.post("php/indexText.php",{project:prj})},getIndex:function(prj){return $http.post("php/getIndex.php",{project:prj})},searchText:function(prj,search){return $http.post("php/searchText.php",{project:prj,search:search})},setNewBlacklist:function(prj,list){return $http.post("php/setBlackWhitelist.php",{project:prj,file:"blacklist.txt",words:list})},setNewWhitelist:function(prj,list){return $http.post("php/setBlackWhitelist.php",{project:prj,file:"whitelist.txt",words:list})},getBlacklist:function(prj){return $http.post("php/getBlackWhitelist.php",{project:prj,file:"blacklist.txt"})},getWhitelist:function(prj){return $http.post("php/getBlackWhitelist.php",{project:prj,file:"whitelist.txt"})}};return requests}]),angular.module("dokuvisApp").directive("horizontalScroll",function(){return{restrict:"A",link:function(scope,element){element.on("wheel",function(event){var delta=-event.originalEvent.deltaY||event.originalEvent.wheelDelta||0,sl=element.scrollLeft();0<delta?element.scrollLeft(sl-100):delta<0&&element.scrollLeft(sl+100)})}}}),angular.module("dokuvisApp").directive("alert",["$timeout",function($timeout){return{restrict:"A",scope:{alert:"="},template:'<span class="glyphicon glyphicon-exclamation-sign"></span> {{alert.message}}',link:function(scope,element){element.hide().fadeIn(300),$timeout(function(){element.fadeOut({duration:1e3,done:function(){scope.$parent.alert.showing=!1,scope.$apply()}})},5e3)}}}]),angular.module("dokuvisApp").directive("resizer",["$document",function($document){return{scope:{resizerEnd:"=",resizerAnim:"="},link:function(scope,element,attrs){var offset=0,space=0;function rMousemove(event){if("vertical"===attrs.resizer){var x=event.pageX-offset;attrs.resizerLeftMin&&x<attrs.resizerLeftMin&&(x=parseInt(attrs.resizerLeftMin)),attrs.resizerRightMin&&x>space-attrs.resizerRightMin&&(x=space-parseInt(attrs.resizerRightMin)),element.css({left:x+"px"}),$(attrs.resizerLeft).css({width:x+"px"}),$(attrs.resizerRight).css({left:x+element.width()+"px"}),x}else{var y=space-event.pageY-offset;attrs.resizerTopMin&&y>space-attrs.resizerTopMin&&(y=space-parseInt(attrs.resizerTopMin)),attrs.resizerBottomMin&&y<attrs.resizerBottomMin&&(y=parseInt(attrs.resizerBottomMin)),element.css({bottom:y+"px"}),$(attrs.resizerTop).css({bottom:y+element.height()+"px"}),$(attrs.resizerBottom).css({height:y+"px"}),y}}function rMouseup(){$document.unbind("mousemove",rMousemove),$document.unbind("mouseup",rMouseup),scope.resizerEnd&&scope.resizerEnd()}element.on("mousedown",function(event){event.preventDefault(),"vertical"!==attrs.resizer&&"horizontal"!==attrs.resizer||($document.bind("mousemove",rMousemove),$document.bind("mouseup",rMouseup),"vertical"===attrs.resizer?(offset=event.pageX-event.offsetX-event.delegateTarget.offsetLeft,space=element.parent()[0].offsetWidth):(offset=event.pageY-event.offsetY-event.delegateTarget.offsetTop,space=element.parent()[0].offsetHeight))}),function(){if("vertical"===attrs.resizer){var x=$(attrs.resizerRight).css("left");element.css({left:x}),$(attrs.resizerLeft).css({width:x}),$(attrs.resizerRight).css({left:x})}}(),scope.$watch("resizerAnim",function(newValue,oldValue){if("vertical"===attrs.resizer){space=element.parent()[0].offsetWidth;var x=newValue;attrs.resizerLeftMin&&x<attrs.resizerLeftMin&&(x=parseInt(attrs.resizerLeftMin)),attrs.resizerRightMin&&x>space-attrs.resizerRightMin&&(x=space-parseInt(attrs.resizerRightMin)),element.animate({left:x+"px"},500),$(attrs.resizerLeft).animate({width:x+"px"},500),$(attrs.resizerRight).animate({left:x+element.width()+"px"},500)}else{space=element.parent()[0].offsetHeight;var y=newValue;attrs.resizerTopMin&&y>space-attrs.resizerTopMin&&(y=space-parseInt(attrs.resizerTopMin)),attrs.resizerBottomMin&&y<attrs.resizerBottomMin&&(y=parseInt(attrs.resizerBottomMin)),element.animate({bottom:y+"px"},500),$(attrs.resizerTop).animate({bottom:y+element.height()+"px"},500),$(attrs.resizerBottom).animate({height:y+"px"},500)}})}}}]),angular.module("dokuvisApp").directive("ngWheel",["$parse",function($parse){return{restrict:"A",link:function(scope,element,attr){var fn=$parse(attr.ngWheel);function mousewheel(event){scope.$apply(function(){fn(scope,{$event:event})})}element.bind("mousewheel",mousewheel),element.bind("DOMMouseScroll",mousewheel)}}}]),angular.module("dokuvisApp").directive("syncScroll",function(){return{restrict:"A",replace:!1,link:function(scope,element,attrs){var scrollTop=0,scrollHeight=0,offsetHeight=0,elements=element.find("."+attrs.syncScroll);elements.on("scroll",function(e){e.isTrigger?e.target.scrollTop=Math.round(scrollTop*(e.target.scrollHeight-e.target.offsetHeight)/(scrollHeight-offsetHeight)):(scrollTop=e.target.scrollTop,scrollHeight=e.target.scrollHeight,offsetHeight=e.target.offsetHeight,elements.each(function(element){this.isSameNode(e.target)||$(this).trigger("scroll")}))})}}}),angular.module("dokuvisApp").directive("convertToNumber",function(){return{require:"ngModel",link:function(scope,element,attrs,ngModel){ngModel.$parsers.push(function(val){return parseInt(val,10)}),ngModel.$formatters.push(function(val){return""+val})}}}),angular.module("dokuvisApp").directive("noContextMenu",function(){return{compile:function(element){element.bind("contextmenu",function(event){event.preventDefault()})}}}),angular.module("dokuvisApp").directive("userInitials",function(){return{template:"<span></span>",restrict:"AE",scope:{userInitials:"<"},link:function(scope,element){var initials="",names=scope.userInitials.toUpperCase().split(/\s+/);names.forEach(function(n){initials+=n[0]});var n0=initials[0];if(1<initials.length)var n1=initials[1];else n1=1<names[0].length?names[0][1]:"Z";if(2<initials.length)var n2=initials[2];else n2=2<names[0].length?names[0][2]:"Z";n0=Math.min(Math.max(n0.charCodeAt(0),65),90),n1=Math.min(Math.max(n1.charCodeAt(0),65),90),n2=Math.min(Math.max(n2.charCodeAt(0),65),90);var c0=Math.round((n0-60)/30*200),c1=Math.round((n1-60)/30*200),c2=Math.round((n2-60)/30*200),hex="#"+c0.toString(16)+c1.toString(16)+c2.toString(16);element.css("background-color",hex),element.attr("title",scope.userInitials),element.find("span").text(initials)}}}),angular.module("dokuvisApp").filter("filterEditor",function(){return function(items,search){return search?items.filter(function(element){return-1!==element.editors.indexOf(search)}):items}}),angular.module("dokuvisApp").filter("amJSDate",["moment",function(moment){return function(input){return console.log(input),moment.isMoment(input)?input.toDate():moment.isDate(input)?input:moment(input).toDate()}}]),angular.module("dokuvisApp").filter("asList",function(){return function(items,separator,sort,key){if(Array.isArray(items)){if(!key)return items.sort(),items.join(separator);var list=[];return items.forEach(function(item){list.push(item[key])}),sort&&list.sort(),list.join(separator)}}}),angular.module("dokuvisApp").animation(".fadeLoadprogress",[function(){return{addClass:function(element,className,doneFn){"ng-hide"===className&&jQuery(element).delay(2e3).fadeOut(2e3)},removeClass:function(element,className,doneFn){"ng-hide"===className&&jQuery(element).show()}}}]),angular.module("dokuvisApp").factory("Utilities",["$alert","$translate",function($alert,$translate){var f={};function getElementInHierarchy(node,content){if(node.content===content)return node;for(var i=0,l=node.children.length;i<l;i++){var obj=getElementInHierarchy(node.children[i],content);if(void 0!==obj)return obj}}return f.Base62=function(){this.characterSet="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"},f.Base62.prototype.encode=function(integer){if(0===integer)return"0";for(var s="";0<integer;)s=this.characterSet[integer%62]+s,integer=Math.floor(integer/62);return s},f.Base62.prototype.decode=function(base62String){var val=0;return base62String.split("").reverse().forEach(function(character,index){val+=this.characterSet.indexOf(character)*Math.pow(62,index)}),val},f.Base62.prototype.setCharacterSet=function(chars){var arrayOfChars=chars.split(""),uniqueCharacters=[];if(62!=arrayOfChars.length)throw Error("You must supply 62 characters");if(arrayOfChars.forEach(function(char){~uniqueCharacters.indexOf(char)||uniqueCharacters.push(char)}),62!=uniqueCharacters.length)throw Error("You must use unique characters.");this.characterSet=arrayOfChars},f.getUniqueId=function(){return(new f.Base62).encode((new Date).getTime())},f.sleep=function(milliseconds){for(var start=(new Date).getTime(),i=0;i<1e7&&!((new Date).getTime()-start>milliseconds);i++);},f.waitfor=function(test,expectedValue,msec,params,callback){test()===expectedValue?callback(params):setTimeout(function(){f.waitfor(test,expectedValue,msec,params,callback)},msec)},f.extractNeo4jData=function(data){for(var results=[],i=0;i<data.data.length;i++){for(var object=new Object,j=0;j<data.columns.length;j++)null==data.data[i][j]?object[data.columns[j]]=null:object[data.columns[j]]=data.data[i][j].data;results.push(object)}return results},f.cleanNeo4jData=function(data,selected){selected=selected||!1;for(var results=[],i=0;i<data.data.length;i++){for(var obj=new Object,j=0;j<data.columns.length;j++)null==data.data[i][j]?obj[data.columns[j]]=null:obj[data.columns[j]]=data.data[i][j];selected&&(obj.selected=!1),results.push(obj)}return results},f.extractNeo4jTransactData=function(data){for(var results=[],i=0,l=data.data.length;i<l;i++){for(var obj={},j=0;j<data.columns.length;j++)obj[data.columns[j]]=data.data[i].row[j];results.push(obj)}return results},f.extractArrayFromNeo4jData=function(data){for(var results=[],i=0;i<data.data.length;i++)results.push(data.data[i][0]);return results},f.createHierarchy=function(data,props,isNode){for(var results=[],i=0,l=data.data.length;i<l;i++){var parent={};parent.content=data.data[i][0].parent.data.content,parent.children=[];for(var j=0,m=data.data[i][1].length;j<m;j++){for(var child={},k=0;k<props.length;k++)child[props[k]]=isNode?data.data[i][1][j][props[k]].data:data.data[i][1][j][props[k]];child.content=data.data[i][1][j].child.data.content,child.children=[],parent.children.push(child)}results.push(parent)}for(i=0;i<results.length;i++)for(j=0,m=results.length;j<m;j++)if(i!==j){var p=getElementInHierarchy(results[j],results[i].content);if(void 0!==p){p.children=results[i].children,results.splice(i,1),i--;break}}return results},f.setUrlParams=function(url,params){for(var match,newUrl=url,regex=/:([^:\/]+)/g;null!==(match=regex.exec(url));)newUrl="function"==typeof params[match[1]]?newUrl.replace(match[0],params[match[1]]()):newUrl.replace(match[0],params[match[1]]);return newUrl},f.dangerAlert=function(message){$translate(message).then(function(translation){$alert({content:translation,type:"danger",duration:5})},function(translationId){$alert({content:translationId,type:"danger",duration:5})})},f.throwException=function(title,message,data){$alert({title:title+":",content:message,type:"danger",duration:5}),console.error(title+": "+message,data,"\n"+(new Error).stack.split("\n")[2])},f.throwNeo4jException=function(message,data){$alert({title:"Neo4jException:",content:message,type:"danger",duration:5}),console.error("Neo4jException: "+message,data)},f.throwApiException=function(message,data){403===data.status&&(message="Access denied "+message+" ("+data.statusText+" "+data.status+")"),$alert({title:"API Exception:",content:message,type:"danger",duration:5}),console.error("API Exception: "+message,data,"\n"+(new Error).stack.split("\n")[2])},f}]),angular.module("dokuvisApp").factory("webglInterface",["$rootScope","$anchorScroll","$debounce",function($rootScope,$anchorScroll,$debounce){var wi={callFunc:{}};DV3D.callFunc=wi.callFunc,wi.viewportSettings={shading:["color","grey","transparent","onlyEdges","xray","Custom"],camera:["Perspective","Top","Front","Back","Left","Right","Custom"],edges:!0,ssao:"aa"},wi.viewportSettings.shadingSel=wi.viewportSettings.shading[0],wi.viewportSettings.cameraSel=wi.viewportSettings.camera[0],wi.unsafeSettings={},wi.categories=[],wi.activeCategory=null,wi.vPanel={},wi.vPanel.expand=!1,wi.vPanel.activeTab=0,wi.vizSettings={opacitySelected:100,edges:!0,edgesOpacity:100,edgesColor:100},wi.snapshot={active:!1,mode:"paint",text:"",title:"",refObj:[],refSrc:[],screenshots:[]},wi.snapshot.paintOptions={opacity:1,color:"rgba(255,255,0,1.0)",backgroundColor:"rgba(255,255,255,0.0)",lineWidth:3,undo:!0,imageSrc:!1},wi.spatialize={active:!1,opacity:50,image:null,fov:35},wi.listProperties={plans:{visible:!0,opacity:1},images:{visible:!0,scale:10,opacity:1}},wi.objects=[],wi.layerList=[],wi.layers=[],wi.hierarchList=[],wi.selected=[],wi.plans=new DV3D.Collection,wi.spatialImages=new DV3D.Collection,wi.spatialImages.setScale(10);var layerDict={};function findHierarchyObject(list,id){for(var i=0,l=list.length;i<l;i++){var child=list[i];if(child.id===id)return child;var object=findHierarchyObject(child.children,id);if(void 0!==object)return object}}function findPlanlistObject(id){for(var i=0;i<wi.plans.length;i++)if(wi.plans[i].id===id)return wi.plans[i]}wi.insertIntoLists=function(item){var objentry=new wi.ObjectEntry(item);!function(item){var parentItem=findHierarchyObject(wi.hierarchList,item.parent);void 0!==parentItem?(item.parent=parentItem).children.push(item):(item.parent=null,wi.hierarchList.push(item))}(objentry),function(item){wi.layerList.push(item),item.layer in layerDict?layerDict[item.layer].count++:(layerDict[item.layer]={count:1},wi.layers.push({name:item.layer,visible:!0,expand:!1}))}(objentry),$rootScope.$applyAsync()},wi.insertIntoPlanlist=function(item){item.visible=!0,item.selected=!1,item.opacity=1,wi.plans.push(item),$rootScope.$applyAsync()},wi.clearLists=function(){console.log("clearList"),wi.layerLists=[],wi.layers=[],wi.hierarchList=[]},wi.ObjectEntry=function(item){this.id=item.id,this.name=item.name,this.title=item.title,this.type=item.type,this.layer=item.layer||0,this.parent=item.parent||null,this.children=[],this.parentVisible=!0,this.visible=!0,this.selected=!1,this.expand=!1,this.opacity=1;var scope=this;this.toggle=function(){scope.visible=!scope.visible,!scope.visible&&scope.selected&&wi.callFunc.selectObject(scope.id,!1,!0),wi.callFunc.toggleObject(scope,scope.visible)},this.select=function(event){scope.visible&&event&&wi.callFunc.selectObject(scope.id,event.ctrlKey,!1)},this.setOpacity=function(value){wi.callFunc.setObjectOpacity(scope,value)},this.focus=function(){wi.callFunc.focusObject(scope.id)},this.showSources=function(){wi.callFunc.highlightSources(scope)}},wi.selectListEntry=function(id,userData){var item="plan"===userData.type?findPlanlistObject(id):findHierarchyObject(wi.hierarchList,id);item&&(item.selected=!0,wi.selected.push(userData),item.parent&&function expandParents(item){item.expand=!0;item.parent&&expandParents(item.parent)}(item.parent),scrollToListEntry(item.id),$rootScope.$applyAsync())},wi.deselectListEntry=function(id,userData){var item="plan"===userData.type?findPlanlistObject(id):findHierarchyObject(wi.hierarchList,id);item&&(item.selected=!1,wi.selected.splice(wi.selected.indexOf(userData),1),$rootScope.$applyAsync())};var scrollToListEntry=$debounce(function(id){console.log("anchorScroll called","list"+id),$anchorScroll("list"+id)},200,!0);return wi}]),angular.module("dokuvisApp").factory("CidocDict",function(){var entities={E21:{de:"Person",prefProp:"title",color:"#ffa992"},E22:{de:"Objekt",prefProp:"title"},E31:{de:"Dokument",prefProp:"title",color:"#cbf09a"},E33:{de:"Kommentar",prefProp:"value",color:"#cae4e8"},E35:{de:"Titel",prefProp:"value",color:"#cae4e8"},E40:{de:"Institution",prefProp:"title"},E42:{de:"Kennung"},E52:{de:"Zeit",prefProp:"title",color:"#ffffbf"},E53:{de:"Ort",prefProp:"title",color:"#ffffbf"},E55:{de:"Typus",color:"#e5e5e5"},E56:{de:"Sprache",color:"#e5e5e5"},E62:{de:"Zeichenkette",prefProp:"value",color:"#ffe866"},E65:{de:"Begriffliche Schöpfung"},E78:{de:"Sammlung",prefProp:"title"},E82:{de:"Akteurbenennung",color:"#cae4e8"},E84:{de:"Informationsträger"}},properties={P1:{de:"wird bezeichnet als",en:"is identified by"},P2:{de:"hat den Typus",en:"has type"},P3:{de:"hat Anmerkung",en:"has note"},P14:{de:"wurde ausgeführt von",en:"carried out by"},P15:{de:"wurde beeinflusst durch",en:"was influenced by"},P52:{de:"im Besitz von",en:"has current owner"},P70:{de:"belegt",en:"documents"},P94:{de:"hat erschaffen",en:"has produced"},P4a:{de:"wurde erstellt während",en:"produced during"},P7a:{de:"wurde erstellt in",en:"produced in"},P14a:{de:"wurde erstellt durch",en:"produced by"},P72a:{de:"hat Sprache",en:"has language"},P128a:{de:"archiviert in",en:"archived in"}},dict={getClassName:function(entityId){return entityId in entities?entities[entityId].de:entityId},getPropertyName:function(propertyId){return propertyId in properties?properties[propertyId].de:propertyId},getNodePropertyName:function(classLabel){return classLabel in entities&&entities[classLabel].prefProp?entities[classLabel].prefProp:"content"},getNodeColor:function(entityId){return entityId in entities&&entities[entityId].color?entities[entityId].color:"#fff"}};return dict}),angular.module("dokuvisApp").factory("GraphVis",["$http","API","$stateParams",function($http,API,$stateParams){return{getNodeNeighbours:function(id){return $http.get(API+"auth/project/"+$stateParams.project+"/graph/"+id)},getNodeTitle:function(id,label){return $http.get(API+"auth/project/"+$stateParams.project+"/graph/"+id+"/"+label)},getE22Name:function(id){return $http.get(API+"auth/project/"+$stateParams.project+"/graph/"+id+"/e22")}}}]),angular.module("dokuvisApp").factory("TypeaheadRequest",["$http","API","$stateParams",function($http,API,$stateParams){return{query:function(label,from,prop){var url=API+"auth/project/"+$stateParams.project+"/typeahead/"+label+"/"+prop+"/"+from;return $http.get(url)},queryTags:function(search){return $http.get(API+"auth/project/"+$stateParams.project+"/typeahead/tag",{params:{search:search}}).then(function(response){for(var data=response.data,tags=[],i=0;i<data.length;i++)tags.push(data[i].tag);return tags})}}}]),angular.module("dokuvisApp").factory("SpatializeInterface",function(){var si={callFunc:{},markers2D:[],markers3D:[],imageWidth:0,imageHeight:0,getDLTInputs:function(){if(si.markers2D.length!==si.markers3D.length)return console.warn("Missing markers!"),void console.log(si.markers2D,si.markers3D);for(var output="",i=0,l=si.markers2D.length;i<l;i++)output+=[i+1,si.markers3D[i].x,si.markers3D[i].y,si.markers3D[i].z,1e3*si.markers2D[i].x,1e3*si.markers2D[i].y,"\n"].join(" ");return console.log(output),output}};return si}),angular.module("dokuvis.auth",["ui.router","mm.acl"]).service("AuthenticationFactory",["$window","$http","$q","API",function($window,$http,$q,API){var scope=this;this.isLogged=!1,this.check=function(){return $window.localStorage.token&&$window.localStorage.user?$http.get(API+"auth/check").then(function(){return scope.set(),$q.resolve()}).catch(function(){return scope.flush(),$q.reject("Invalid token")}):(this.flush(),$q.reject("$window.localStorage not set"))},this.set=function(data){data&&($window.localStorage.token=data.token,$window.localStorage.user=data.user.email,$window.localStorage.userName=data.user.name),$window.localStorage.token&&$window.localStorage.user&&(this.isLogged=!0,this.user=$window.localStorage.user,this.userName=$window.localStorage.userName)},this.flush=function(){this.isLogged=!1,delete this.user,delete this.userName,delete $window.localStorage.token,delete $window.localStorage.user,delete $window.localStorage.userName}}]).factory("UserAuthFactory",["$http","AuthenticationFactory","API","AclService",function($http,AuthenticationFactory,API,AclService){return{login:function(email,password){return $http.post(API+"login",{email:email,password:password}).then(function(response){AuthenticationFactory.set(response.data)})},logout:function(){AuthenticationFactory.isLogged&&(AuthenticationFactory.flush(),AclService.flushRoles(),AclService.attachRole("guest"))},register:function(email,username,password){return $http.post(API+"register",{email:email,username:username,password:password}).then(function(response){AuthenticationFactory.set(response.data)})}}}]).factory("TokenInterceptor",["$q","$window",function($q,$window){return{request:function(config){return config.headers=config.headers||{},$window.localStorage.token&&(config.headers["X-Access-Token"]=$window.localStorage.token,config.headers["X-Key"]=$window.localStorage.user,config.headers["Content-Type"]="application/json"),config||$q.when(config)},response:function(response){return response||$q.when(response)}}}]).factory("ValidateResolve",["$q","AuthenticationFactory","AclService","$log",function($q,AuthenticationFactory,AclService,$log){return function(){var defer=$q.defer();return AuthenticationFactory.check().then(function(){AclService.flushRoles(),AclService.attachRole("member"),defer.resolve()}).catch(function(reason){$log.debug(reason),defer.resolve()}),defer.promise}}]).factory("AuthenticateResolve",["$state","$q","$timeout","AuthenticationFactory","ValidateResolve",function($state,$q,$timeout,AuthenticationFactory,ValidateResolve){return function(){var defer=$q.defer();return ValidateResolve().then(function(){AuthenticationFactory.isLogged?defer.resolve():(defer.reject(),$timeout(function(){$state.go("root.home")}))}),defer.promise}}]).factory("SkipResolve",["$state","$q","$timeout","AuthenticationFactory","ValidateResolve",function($state,$q,$timeout,AuthenticationFactory,ValidateResolve){return function(){var defer=$q.defer();return ValidateResolve().then(function(){AuthenticationFactory.isLogged?(defer.reject(),$timeout(function(){$state.go("root.home")})):defer.resolve()}),defer.promise}}]),angular.module("dokuvis.utils",["mgcrea.ngStrap","pascalprecht.translate"]).factory("Utilities2",["$alert",function($alert){var f={waitfor:function(test,expectedValue,msec,params,callback){test()===expectedValue?callback(params):setTimeout(function(){f.waitfor(test,expectedValue,msec,params,callback)},msec)},dangerAlert:function(message){$alert({content:message,type:"danger",duration:5})},throwException:function(title,message,data){$alert({title:title+":",content:message,type:"danger",duration:5}),console.error(title+": "+message,data,"\n"+(new Error).stack.split("\n")[2])},throwApiException:function(message,data){403===data.status&&(message="Access denied "+message+" ("+data.statusText+" "+data.status+")"),$alert({title:"API Exception:",content:message,type:"danger",duration:5}),console.error("API Exception: "+message,data,"\n"+(new Error).stack.split("\n")[2])}};return f}]).factory("ConfirmDialog",["$q","$alert",function($q,$alert){var alertDefaults={backdrop:"static",templateUrl:"components/dokuvis.utils/confirmAlert.tpl.fdb2729a.html",show:!0},alertOptions={abortButtonText:"abort",actionButtonText:"OK",headerText:"continue?",bodyText:"Sind Sie sicher?",type:"warning",translationData:{}};return function(customAlertOptions,customAlertDefaults){return customAlertDefaults||(customAlertDefaults={}),function(customAlertOptions,customAlertDefaults){var tempAlertDefaults={},tempAlertOptions={};angular.extend(tempAlertDefaults,alertDefaults,customAlertDefaults),angular.extend(tempAlertOptions,alertOptions,customAlertOptions),tempAlertDefaults.alertOptions=tempAlertOptions;var deferred=$q.defer();return tempAlertDefaults.controller=function($scope){$scope.alertOptions=tempAlertOptions,$scope.alertOptions.ok=function(){$scope.$hide(),deferred.resolve()},$scope.alertOptions.abort=function(){$scope.$hide(),deferred.reject()}},$alert(tempAlertDefaults),deferred.promise}(customAlertOptions,customAlertDefaults)}}]).directive("fileDropArea",["$timeout","$state",function($timeout,$state){return{restrict:"AE",scope:{uploader:"=",labelBefore:"@",labelAfter:"@"},link:function(scope,element,attrs){$timeout(function(){var el=angular.element(element);"uiSref"in attrs&&(el.find("input").remove(),scope.uploader.onAfterAddingAll=function(){$state.includes(attrs.uiSref)||$state.includes("**"+attrs.uiSref)||$state.go(attrs.uiSref)}),"multiple"in attrs&&el.find("input").attr("multiple",!0),"column"in attrs&&el.children().css("flex-direction","column")}),scope.openFileDialog=function(){$timeout(function(){angular.element(element).find("input").trigger("click")})}},template:'<div ng-if="uploader" data-uploader="uploader" nv-file-drop nv-file-over ng-click="openFileDialog()">\n\t<input type="file" ng-hide="1" data-uploader="uploader" nv-file-select ng-click="$event.stopPropagation()"/>\n\t<div>{{labelBefore|translate}}</div>\n\t<svg x="0px" y="0px" viewBox="0 0 10 10" enable-background="new 0 0 10 10" xml:space="preserve">\n\t\t<path d="M3.746,10V6.283H0V3.717h3.746V0h2.497v3.717H10v2.566H6.243V10H3.746z"/>\n\t</svg>\n\t<div>{{labelAfter|translate}}</div>\n</div>'}}]),angular.module("dokuvis.projects",["ngResource","ui.router","mm.acl"]).factory("Project",["$resource","ApiProject",function($resource,ApiProject){return $resource(ApiProject+"/:id",{id:"@proj"},{update:{method:"PUT"}})}]).directive("projectList",["$window","$state","Project","Utilities","ConfirmDialog","$log",function($window,$state,Project,Utilities,ConfirmDialog,$log){return{restrict:"E",templateUrl:"components/dokuvis.projects/projectList.tpl.d5e85290.html",scope:{},link:function(scope){function queryProjects(){Project.query().$promise.then(function(results){scope.projects=results}).catch(function(reason){Utilities.throwApiException("#Project.query",reason)})}scope.projects=[],scope.openProject=function(prj){var url=$state.href("project.home",{project:prj,subproject:"master"});$window.open(url,"_blank")},scope.deleteProject=function(p){$log.log("delete ",p),ConfirmDialog({headerText:"Projekt löschen",bodyText:"Soll Projekt "+p.name+" wirklich gelöscht werden?"}).then(function(){p.$delete().then(function(response){$log.debug(response),queryProjects()}).catch(function(err){Utilities.throwApiException("Project#delete",err)})})},queryProjects(),scope.$on("projectsUpdate",function(){queryProjects()})}}}]).controller("projectModalCtrl",["$scope","$rootScope","$state","$stateParams","Project","Utilities","$log",function($scope,$rootScope,$state,$stateParams,Project,Utilities,$log){function projectsUpdate(project){$rootScope.$broadcast("projectsUpdate",project)}$scope.isSaving=!1,$scope.project={name:"",description:""},"new"===$stateParams.projectId?$scope.title="project_new":($scope.title="project_edit",Project.get({id:$stateParams.projectId}).$promise.then(function(result){$scope.project=result}).catch(function(reason){Utilities.throwApiException("#Project.get",reason)})),$scope.save=function(){$scope.project.name.length?($scope.isSaving=!0,"new"!==$stateParams.projectId?$scope.project.$update().then(function(){projectsUpdate($scope.project),$scope.close()}).catch(function(err){Utilities.throwApiException("#Project.update",err),$scope.isSaving=!1}):Project.save($scope.project).$promise.then(function(result){$log.log(result),projectsUpdate(result),$scope.close()}).catch(function(err){Utilities.throwApiException("#Project.save",err),$scope.isSaving=!1})):Utilities.dangerAlert("Geben sie dem Projekt einen Namen!")},$scope.close=function(){$state.go("^")}}]).factory("ProjectResolve",["$q","$state","$rootScope","Project","AclService","$log",function($q,$state,$rootScope,Project,AclService,$log){return function(params){return Project.get({id:params.project}).$promise.then(function(result){if("NO_ENTRY"===result.status)return $state.go("root.projectlist"),$q.reject(result.status);switch($rootScope.globalProject=result,$rootScope.userRole=result.role,AclService.attachRole("visitor"),result.role){case"superadmin":AclService.attachRole("superadmin");case"admin":AclService.attachRole("admin"),AclService.attachRole("historian"),AclService.attachRole("modeler");break;case"historian":AclService.attachRole("historian");break;case"modeler":AclService.attachRole("modeler")}$log.debug(AclService.getRoles())}).catch(function(err){return console.error("API Exception on Project.get()",err),$q.reject(err)})}}]),angular.module("dokuvis.subprojects",["ngResource","mm.acl"]).factory("Subproject",["$resource","ApiParams","ApiSubproject",function($resource,ApiParams,ApiSubproject){return $resource(ApiSubproject+"/:id",angular.extend({id:"@id"},ApiParams),{get:{method:"GET",cache:!0},update:{method:"PUT"}})}]).directive("subprojectList",["Subproject","Utilities","AclService",function(Subproject,Utilities,AclService){return{restrict:"E",templateUrl:"components/dokuvis.subprojects/subprojectList.tpl.a14de52e.html",scope:{},link:function(scope){function querySubprojects(){Subproject.query().$promise.then(function(results){scope.subprojects=results}).catch(function(reason){Utilities.throwApiException("#Subproject.query",reason)})}scope.can=AclService.can,scope.subprojects=[],querySubprojects(),scope.$on("subprojectsUpdate",function(){querySubprojects()})}}}]).controller("subprojectModalCtrl",["$scope","$rootScope","$state","$stateParams","Subproject","Utilities",function($scope,$rootScope,$state,$stateParams,Subproject,Utilities){function subprojectsUpdate(subproject){$rootScope.$broadcast("subprojectsUpdate",subproject)}$scope.isSaving=!1,$scope.subproject={name:"",description:""},"new"===$stateParams.subprojectId?$scope.title="subproject_new":($scope.title="subproject_edit",Subproject.get({id:$stateParams.subprojectId}).$promise.then(function(result){$scope.subproject=result}).catch(function(reason){Utilities.throwApiException("#Subproject.get",reason)})),$scope.save=function(){$scope.subproject.name.length?($scope.isSaving=!0,"new"!==$stateParams.subprojectId?$scope.subproject.$update().then(function(result){subprojectsUpdate(result),$scope.close()}).catch(function(err){Utilities.throwApiException("#Subproject.update",err),$scope.isSaving=!1}):Subproject.save($scope.subproject).$promise.then(function(result){subprojectsUpdate(result),$scope.close()}).catch(function(err){Utilities.throwApiException("#Subproject.save",err),$scope.isSaving=!1})):Utilities.dangerAlert("Keinen Namen angegeben!")},$scope.close=function(){$state.go("^")}}]).factory("SubprojectResolve",["$q","$rootScope","$state","Subproject",function($q,$rootScope,$state,Subproject){return function(params){return"master"===params.subproject?($rootScope.globalSubproject=void 0,$q.resolve()):Subproject.get({id:params.subproject,project:params.project}).$promise.then(function(result){if(!result.id)return $rootScope.globalSubproject=void 0,$state.go("project.home",{project:params.project,subproject:"master"}),$q.reject("Subproject does not exist!");$rootScope.globalSubproject=result}).catch(function(err){return console.error("API Exception on Subproject.check()",err),$q.reject(err)})}}]),angular.module("dokuvis.projinfos",["ngResource","ui.router"]).factory("ProjInfo",["$resource","ApiParams","ApiProjinfo",function($resource,ApiParams,ApiProjinfo){return $resource(ApiProjinfo+"/:id",angular.extend({id:"@id"},ApiParams),{update:{method:"PUT"},swap:{method:"PUT"}})}]).directive("projinfoList",["$rootScope","ProjInfo","Utilities","ConfirmDialog",function($rootScope,ProjInfo,Utilities,ConfirmDialog){return{restrict:"E",templateUrl:"components/dokuvis.projinfos/projinfoList.tpl.2336f531.html",scope:{},link:function(scope){function queryProjInfos(){ProjInfo.query().$promise.then(function(results){scope.infos=results}).catch(function(reason){Utilities.throwApiException("#ProjInfo.query",reason)})}function projinfosUpdate(info){$rootScope.$broadcast("projinfosUpdate",info)}scope.infos=[],scope.filteredInfos=[],queryProjInfos(),scope.removeProjInfo=function(info){ConfirmDialog({headerText:"Info löschen",bodyText:"Soll die Info gelöscht werden?"}).then(function(){info.$delete().then(function(){projinfosUpdate()}).catch(function(err){Utilities.throwApiException("#ProjInfo.delete",err)})})},scope.swapInfoOrder=function(oldIndex,newIndex){ProjInfo.swap({from:scope.filteredInfos[oldIndex].id,to:scope.filteredInfos[newIndex].id}).$promise.then(function(result){console.log(result),projinfosUpdate()}).catch(function(err){Utilities.throwApiException("#ProjInfo.swap",err)})},scope.$on("projinfosUpdate",function(){queryProjInfos()})}}}]).controller("projinfoModalCtrl",["$scope","$rootScope","$state","$stateParams","ProjInfo","Utilities",function($scope,$rootScope,$state,$stateParams,ProjInfo,Utilities){$scope.input="";var info=null;function projinfosUpdate(info){$rootScope.$broadcast("projinfosUpdate",info)}"new"===$stateParams.infoId?$scope.title="Neue Info":($scope.title="Info bearbeiten",ProjInfo.get({id:$stateParams.infoId}).$promise.then(function(result){info=result,$scope.input=result.value}).catch(function(reason){Utilities.throwApiException("#ProjInfo.get",reason)})),$scope.save=function(){$scope.input.length?info?(info.value=$scope.input,info.$update().then(function(){projinfosUpdate(),$scope.close()}).catch(function(err){Utilities.throwApiException("#ProjInfo.update",err)})):ProjInfo.save({value:$scope.input}).$promise.then(function(){projinfosUpdate(),$scope.close()}).catch(function(err){Utilities.throwApiException("#ProjInfo.save",err)}):Utilities.dangerAlert("Bitte geben Sie Text ein!")},$scope.close=function(){this.$hide(),this.$destroy(),$state.go("^")}}]),angular.module("dokuvis.sources",["ngResource","ui.router","angularFileUpload","angularMoment","dokuvis.archives"]).factory("Source",["$resource","ApiParams","ApiSource","moment",function($resource,ApiParams,ApiSource,moment){return $resource(ApiSource+"/:id",angular.extend({id:"@id",type:"@type"},ApiParams),{save:{method:"POST",transformRequest:function(data){return angular.toJson(angular.extend(data,{date:moment().format()}))}},update:{method:"PUT",transformRequest:function(data){return angular.toJson(angular.extend(data,{modificationDate:moment().format()}))}},link:{method:"POST",url:ApiSource+"/connect"},getLinks:{method:"GET",url:ApiSource+"/connect",isArray:!0},spatialize:{method:"PUT",url:ApiSource+"/:id/spatial"},getSpatial:{method:"GET",url:ApiSource+"/:type/spatial"}})}]).factory("SourceUploader",["$window","$rootScope","ApiParams","ApiSource","FileUploader","Utilities","moment",function($window,$rootScope,ApiParams,ApiSource,FileUploader,Utilities,moment){var headers={};$window.localStorage.token&&(headers["X-Access-Token"]=$window.localStorage.token,headers["X-Key"]=$window.localStorage.user);var uploader=new FileUploader({headers:headers,alias:"uploadSourceFile"}),imageTypes=["jpg","png","jpeg","bmp","gif","tiff"],textTypes=["pdf"];return uploader.filters.push({name:"sourceFilter",fn:function(item){var type=item.type.slice(item.type.lastIndexOf("/")+1).toLowerCase();return-1!==imageTypes.concat(textTypes).indexOf(type)}}),uploader.onWhenAddingFileFailed=function(item,filter,options){console.warn("onWhenAddingFileFailed",item,filter,options),Utilities.dangerAlert("Nicht unterstütztes Format!")},uploader.onAfterAddingFile=function(item){console.info("onAfterAddingFile",item);var type=item.file.type.slice(item.file.type.lastIndexOf("/")+1);-1!==imageTypes.indexOf(type)?item.sourceType="plan":-1!==textTypes.indexOf(type)&&(item.sourceType="text",item.language="de"),item.title="",item.author="",item.creationDate="",item.repros="",item.note="",item.formExtend=!1,item.creationPlace="",item.archive="",item.archiveNr="",item.primary=!1,item.tags=[],item.ocr=!1,item.resample=!1,item.errorInput=!1,item.isProcessing=!1},uploader.onProgressItem=function(fileItem,progress){100===progress&&(fileItem.isProcessing=!0)},uploader.onBeforeUploadItem=function(item){item.url=Utilities.setUrlParams(ApiSource,ApiParams),item.formData=[],item.formData.push({sourceType:item.sourceType,date:moment().format(),title:item.title,author:item.author,creationDate:item.creationDate,repros:item.repros,note:item.note,creationPlace:item.creationPlace,archive:item.archive,archiveNr:item.archiveNr,primary:item.primary,tags:item.tags.map(function(t){return t.text}),language:item.language,ocr:item.ocr,resample:item.resample})},uploader.onSuccessItem=function(item,response){console.log(item,response),item.isProcessing=!1,response instanceof Object&&!response.error||(console.error(response),item.isSuccess=!1,item.isError=!0,item.isUploaded=!1)},uploader.onErrorItem=function(fileItem,response,status,headers){console.error("onErrorItem",fileItem,response,status,headers),fileItem.isProcessing=!1,fileItem.isUploaded=!1,Utilities.throwApiException("#source.create",response)},uploader.onCancelItem=function(fileItem,response,status,headers){console.warn("onCancelItem",fileItem,response,status,headers),fileItem.isProcessing=!1},uploader.onCompleteAll=function(){$rootScope.$broadcast("sourcesUpdate")},uploader}]).controller("sourceUploadModalCtrl",["$scope","$state","$stateParams","$timeout","API","SourceUploader","Archive","TypeaheadRequest","Utilities",function($scope,$state,$stateParams,$timeout,API,SourceUploader,Archive,TypeaheadRequest,Utilities){var uploader=$scope.uploader=SourceUploader;function queryArchives(){Archive.query().$promise.then(function(archives){$scope.archives=archives}).catch(function(reason){Utilities.throwApiException("#Archive.query",reason)})}$scope.checkAndUploadAll=function(){$timeout(function(){for(var i=0,l=uploader.queue.length;i<l;i++){var item=uploader.queue[i];item.title.length?(item.errorInput=!1,item.isSuccess||item.upload()):(item.errorInput=!0,Utilities.dangerAlert("Geben Sie mindestens einen Titel ein!"))}},1e3)},$scope.onTagAdded=function(tag){tag.text=tag.text.toLowerCase()},$scope.getTags=function(query){return TypeaheadRequest.queryTags(query).then(function(tags){return tags}).catch(function(err){Utilities.throwApiException("#TypeaheadRequest.queryTags",err)})},$scope.archives=[],$scope.$on("archivesUpdate",function(){queryArchives()}),queryArchives(),$scope.close=function(){$state.go("^.^")}}]).directive("sourcesList",["$rootScope","$state","SourcesCache","SourceUploader",function($rootScope,$state,SourcesCache,SourceUploader){return{templateUrl:"components/dokuvis.sources/sourcesList.tpl.f1b7fdcd.html",restrict:"E",scope:{showUpload:"="},link:function(scope){scope.options={orderBy:"title",filterBy:"",reverse:!1,listSize:"normal",activeTab:""},(scope.sc=SourcesCache).reload(),scope.sourceUploader=SourceUploader,scope.sourceUploader.onAfterAddingAll=function(){$state.includes("**.upload.source")||$state.includes("**.source.edit")||$state.go(".upload.source")},scope.selectSource=function(event,source){var ref,btnBar=angular.element(event.delegateTarget).find(".btn-bar"),target=angular.element(event.target);target.parent().is(btnBar)||target.parent().parent().is(btnBar)||(scope.snapshotMode?(ref=source,$rootScope.$broadcast("snapshotReference",ref)):event.ctrlKey?event.delegateTarget!==event.target&&(source.selected=!source.selected):(scope.sc.sources.forEach(function(t){t.selected=!1}),event.delegateTarget!==event.target&&(source.selected=!0)))},scope.openSource=function(event,source){if(!scope.snapshotMode){var btnBar=angular.element(event.delegateTarget).find(".btn-bar"),target=angular.element(event.target);target.parent().is(btnBar)||target.parent().parent().is(btnBar)||$state.go(".source.id",{sourceId:source.id})}},scope.load3DImage=function(source){var images;images=source,$rootScope.$broadcast("spatialImageLoad",images)},scope.snapshotMode=!1,scope.$on("snapshotStart",function(){scope.snapshotMode=!0}),scope.$on("snapshotEnd",function(){scope.snapshotMode=!1})}}}]).factory("SourcesCache",["$rootScope","Source","Utilities",function($rootScope,Source,Utilities){var sc={};function getIndexByIncr(id,incr){for(var length=sc.filtered.length,index=0;sc.filtered[index].id!==id;)if(++index===length)return;return((index+incr)%length+length)%length}return sc.sources=[],sc.filtered=[],sc.reload=function(){Source.query().$promise.then(function(sources){sources.forEach(function(s){s.selected=!1}),sc.sources=sources}).catch(function(reason){Utilities.throwApiException("#Source.query",reason)})},sc.getPredecessorId=function(id){return sc.filtered[getIndexByIncr(id,-1)].id},sc.getSuccessorId=function(id){return sc.filtered[getIndexByIncr(id,1)].id},$rootScope.$on("sourcesUpdate",function(){sc.reload()}),sc}]).controller("sourceDetailModalCtrl",["$scope","$rootScope","$state","$stateParams","$timeout","$http","Source","SourcesCache","Utilities","ConfirmDialog","$log","$sce",function($scope,$rootScope,$state,$stateParams,$timeout,$http,Source,SourcesCache,Utilities,ConfirmDialog,$log,$sce){function loadSource(id){Source.get({id:id}).$promise.then(function(data){$log.debug(data),data.id?($scope.item=data,"text"===$scope.item.type&&($scope.pdfUrl=$sce.trustAsResourceUrl("pdf/web/viewer.html?file=../../data/"+$scope.item.file.path+$scope.item.file.content)),$scope.pageNr=0):$scope.close()}).catch(function(err){Utilities.throwApiException("#Source.get",err)})}$scope.iterable=!1,$scope.$watch(function(){return $stateParams.sourceId},function(value){value?loadSource(value):$timeout(function(){$scope.close()})}),$scope.$watch(function(){return SourcesCache.filtered.length},function(value){$scope.iterable=$state.includes("project.explorer")&&1<value}),$scope.prev=function(){$state.go($state.current,{sourceId:SourcesCache.getPredecessorId($scope.item.id)},{notify:!1})},$scope.next=function(){$state.go($state.current,{sourceId:SourcesCache.getSuccessorId($scope.item.id)},{notify:!1})},$scope.pageNr=0,$scope.nextPage=function(incr){$scope.pageNr=(($scope.pageNr+incr)%$scope.item.file.preview.length+$scope.item.file.preview.length)%$scope.item.file.preview.length},$scope.highlight=function(event){if("ocrx_word"===event.target.className){var values=$(".displayText").find(".ocr_page")[0].attributes.title.value.match(/bbox (\d+) (\d+) (\d+) (\d+);/),global=[values[1],values[2],values[3],values[4]],bbox=[(values=event.target.attributes.title.value.match(/^bbox (\d+) (\d+) (\d+) (\d+); x_wconf (\d+)$/))[1],values[2],values[3],values[4]],img=$(".displayText").find("img"),left=Math.floor(bbox[0]*img.width()/global[2]),width=Math.ceil(bbox[2]*img.width()/global[2])-left+1,top=Math.floor(bbox[1]*img.height()/global[3]),height=Math.ceil(bbox[3]*img.height()/global[3])-top+1;$("#wordRect").css({left:left+"px",top:top+"px",width:width+"px",height:height+"px"})}},$scope.toggleConfidence=function(){$scope.showConfidence=!$scope.showConfidence;for(var words=$(".displayText").find(".ocrx_word"),i=0,l=words.length;i<l;i++)if($scope.showConfidence){var wconf=words[i].attributes.title.value.match(/^bbox (\d+) (\d+) (\d+) (\d+); x_wconf (\d+)$/)[5],hue=Math.floor((wconf-50)/50*120);$(words[i]).css("background","hsl("+hue+",100%,85%)")}else $(words[i]).css("background","none")},$scope.editText=function(){$http.get("data/"+$scope.item.file.path+$scope.item.file.preview[$scope.pageNr]).then(function(response){console.log(response),$scope.editorInput=response.data,$scope.textEdit=!0})},$scope.saveText=function(){console.log($scope.editorInput)},$scope.startSpatialize=function(){var src;$state.go("project.explorer"),src=$scope.item,$rootScope.$broadcast("spatializeManualStart",src)},$scope.delete=function(){ConfirmDialog({headerText:"Quelle löschen",bodyText:"Soll die Quelle wirklich gelöscht werden? Jegliche Metadaten, Referenzen und sich darauf beziehende Kommentare werden gelöscht."}).then(function(){$scope.item.$delete().then(function(response){var source;$log.debug(response),$rootScope.$broadcast("sourcesUpdate",source),$scope.close()}).catch(function(reason){Utilities.throwApiException("#Source.delete",reason)})})},$scope.$on("sourcesUpdate",function(event,source){source&&$scope.item.id===source.id&&loadSource(source.id)}),$scope.close=function(){$state.go("^.^")}}]).controller("sourceEditModalCtrl",["$scope","$rootScope","$window","$state","$stateParams","$timeout","FileUploader","moment","Source","Archive","ApiSource","ApiParams","TypeaheadRequest","Utilities","$log",function($scope,$rootScope,$window,$state,$stateParams,$timeout,FileUploader,moment,Source,Archive,ApiSource,ApiParams,TypeaheadRequest,Utilities,$log){$scope.isSaving=!1;var imageTypes=["jpg","JPG","png","PNG","jpeg","bmp","gif","tiff"],textTypes=["pdf"],uploader=$scope.uploader=new FileUploader({headers:{"X-Access-Token":$window.localStorage.token,"X-Key":$window.localStorage.user},alias:"updateSourceFile",url:Utilities.setUrlParams(ApiSource,ApiParams)+"/"+$stateParams.sourceId+"/file",autoUpload:!0,removeAfterUpload:!0,queueLimit:1,filters:[{name:"sourceFilter",fn:function(item){var type=item.type.slice(item.type.lastIndexOf("/")+1);return-1!==imageTypes.concat(textTypes).indexOf(type)}}]});function queryArchives(){Archive.query().$promise.then(function(results){$log.debug(results),$scope.archives=results}).catch(function(reason){Utilities.throwApiException("#Archive.query",reason)})}function sourcesUpdate(source){$rootScope.$broadcast("sourcesUpdate",source)}uploader.onWhenAddingFileFailed=function(item,filter,options){console.warn("onWhenAddingFileFailed",item,filter,options),Utilities.dangerAlert("Nicht unterstütztes Format!")},uploader.onBeforeUploadItem=function(item){item.formData.push({date:moment().format()})},uploader.onSuccessItem=function(item,response){$scope.item.file=response.file,sourcesUpdate({id:$stateParams.sourceId})},uploader.onErrorItem=function(item,response){Utilities.throwApiException("#Source.updateFile",response)},Source.get({id:$stateParams.sourceId}).$promise.then(function(result){$scope.item=result}).catch(function(reason){Utilities.throwApiException("#Source.get",reason)}),queryArchives(),$scope.save=function(){if($log.debug($scope.item),$scope.item){if(!$scope.item.title.length)return Utilities.dangerAlert("Geben Sie der Quelle einen Titel"),void($scope.titleError=!0);$scope.titleError=!1,$scope.item.tags=$scope.item.tags.map(function(t){return t.text}),$scope.isSaving=!0,$scope.item.$update().then(function(source){sourcesUpdate(source),$scope.close()}).catch(function(reason){Utilities.throwApiException("#Source.update",reason),$scope.isSaving=!1})}},$scope.onTagAdded=function(tag){tag.text=tag.text.toLowerCase()},$scope.getTags=function(query){return TypeaheadRequest.queryTags(query).then(function(tags){return tags}).catch(function(err){Utilities.throwApiException("#TypeaheadRequest.queryTags",err)})},$scope.$on("archivesUpdate",function(){queryArchives()}),$scope.close=function(){uploader.clearQueue(),$state.go("^")}}]),angular.module("dokuvis.archives",["ngResource","ui.router"]).factory("Archive",["$resource","ApiParams","ApiArchive",function($resource,ApiParams,ApiArchive){return $resource(ApiArchive+"/:id",angular.extend({id:"@collection.id"},ApiParams),{update:{method:"PUT"}})}]).controller("archiveModalCtrl",["$scope","$rootScope","$state","$stateParams","Archive","Utilities","ConfirmDialog","$log",function($scope,$rootScope,$state,$stateParams,Archive,Utilities,ConfirmDialog,$log){$scope.isSaving=!1,$scope.archive={institution:"",abbr:"",collection:""};var archive=null;function archivesUpdate(archive){$rootScope.$broadcast("archivesUpdate",archive)}"new"===$stateParams.archiveId?($scope.title="archive_new",$scope.new=!0):($scope.title="archive_edit",$scope.new=!1,Archive.get({id:$stateParams.archiveId}).$promise.then(function(result){$log.debug(result),$scope.archive.institution=result.institution.name,$scope.archive.abbr=result.institution.abbr,$scope.archive.collection=result.collection.name,archive=result}).catch(function(reason){Utilities.throwApiException("#Archive.get",reason)})),$scope.save=function(){$scope.archive.institution.length?$scope.archive.collection.length?($scope.isSaving=!0,"new"!==$stateParams.archiveId?(archive.institution.name=$scope.archive.institution,archive.institution.abbr=$scope.archive.abbr,archive.collection.name=$scope.archive.collection,archive.$update().then(function(){archivesUpdate(archive),$scope.close()}).catch(function(reason){Utilities.throwApiException("#Archive.update",reason),$scope.isSaving=!1})):Archive.save($scope.archive).$promise.then(function(archive){archivesUpdate(archive),$scope.close()}).catch(function(err){Utilities.throwApiException("#Archive.save",err),$scope.isSaving=!1})):Utilities.dangerAlert("Geben Sie der Kollektion einen Namen!"):Utilities.dangerAlert("Geben Sie der Institution einen Namen!")},$scope.delete=function(){ConfirmDialog({headerText:"archive_delete",bodyText:"archive_delete_question"}).then(function(){$scope.isSaving=!0,archive.$delete().then(function(response){$log.debug(response),archivesUpdate(),$scope.close()}).catch(function(reason){Utilities.throwApiException("#Archive.delete",reason),$scope.isSaving=!1})})},$scope.close=function(){$state.go("^")}}]).component("archivesList",{bindings:{},templateUrl:"components/dokuvis.archives/archivesList.tpl.f1c18f33.html",controller:["$scope","Archive","Utilities",function($scope,Archive,Utilities){function queryArchives(){Archive.query().$promise.then(function(results){$scope.archives=results}).catch(function(reason){Utilities.throwApiException("#Archive.query",reason)})}$scope.archives=[],this.$onInit=function(){queryArchives()},$scope.$on("archivesUpdate",function(){queryArchives()})}]}),angular.module("dokuvis.models",["ngResource","ui.router","angularFileUpload","angularMoment","pascalprecht.translate","ngTagsInput"]).factory("Model",["$http","API","$stateParams",function($http,API,$stateParams){return{getModels:function(){return $http.get(API+"auth/project/"+$stateParams.project+"/"+$stateParams.subproject+"/models")},insert:function(formData,objDatas){return $http.post(API+"auth/project/"+$stateParams.project+"/"+$stateParams.subproject+"/models",{formData:formData,objDatas:objDatas})},getConnections:function(id){return $http.get(API+"auth/project/"+$stateParams.project+"/"+$stateParams.subproject+"/model/"+id+"/connect")},get:function(id){return $http.get(API+"auth/project/"+$stateParams.project+"/model/"+id)},update:function(data){return $http.put(API+"auth/project/"+$stateParams.project+"/model/"+data.obj.content,data)}}}]).factory("ModelVersion",["$resource","ApiParams","ApiModelVersion","moment",function($resource,ApiParams,ApiModelVersion,moment){return $resource(ApiModelVersion+"/:id",angular.extend({id:"@id"},ApiParams),{queryModels:{url:ApiModelVersion+"/:id/object",methed:"GET",isArray:!0},update:{method:"PUT",transformRequest:function(data){return angular.toJson(angular.extend(data,{modificationDate:moment().format()}))}}})}]).factory("DigitalObject",["$resource","ApiParams","ApiModelVersion",function($resource,ApiParams,ApiModelVersion){function getObjectById(data,id){for(var i=0;i<data.length;i++){if(data[i].id===id)return data[i];if(data[i].children){var obj=getObjectById(data[i].children,id);if(void 0!==obj)return obj}}}var resource=$resource(ApiModelVersion+"/:versionId/object/:id",angular.extend({id:"@id",versionId:"@versionId"},ApiParams),{query:{method:"GET",isArray:!0,transformResponse:function(json){return function(data){for(var i=0;i<data.length;i++){var obj=data[i];if(obj.children||(obj.children=[]),obj.parent){var parent=getObjectById(data,obj.parent);parent&&(parent.children||(parent.children=[]),parent.children.push(new resource(obj)),data.splice(i,1),i--)}}return data}(angular.fromJson(json))}},update:{method:"PUT"}});return resource}]).factory("Software",["$resource","ApiParams","ApiSoftware",function($resource,ApiParams,ApiSoftware){return $resource(ApiSoftware+"/:id",angular.extend({id:"@id"},ApiParams))}]).factory("ModelUploader",["$window","$rootScope","ApiParams","ApiModelVersion","FileUploader","Utilities","moment",function($window,$rootScope,ApiParams,ApiModelVersion,FileUploader,Utilities,moment){var headers={};$window.localStorage.token&&(headers["X-Access-Token"]=$window.localStorage.token,headers["X-Key"]=$window.localStorage.user);var uploader=new FileUploader({headers:headers,alias:"uploadModelFile",queueLimit:1}),modelTypes=["dae","zip"];function modelUploadError(response){$rootScope.$broadcast("modelUploadError",response)}return uploader.filters.push({name:"modelFilter",fn:function(item){var type=item.name.slice(item.name.lastIndexOf(".")+1).toLowerCase();return-1!==modelTypes.indexOf(type)}}),uploader.onWhenAddingFileFailed=function(item,filter,options){"queueLimit"===filter.name?(uploader.clearQueue(),uploader.addToQueue(item)):"modelFilter"===filter.name?Utilities.dangerAlert("error_file_nosupport"):(console.warn("onWhenAddingFileFailed",item,filter,options),Utilities.dangerAlert("error_unknown"))},uploader.onAfterAddingFile=function(item){item.isProcessing=!1},uploader.onProgressItem=function(fileItem,progress){100===progress&&(fileItem.isProcessing=!0)},uploader.onBeforeUploadItem=function(item){item.url=Utilities.setUrlParams(ApiModelVersion,ApiParams),item.formData=[],item.formData.push({date:moment().format(),summary:item.commit.summary,note:item.commit.note,software:item.commit.software.map(function(sw){return sw.name}),predecessor:item.commit.parent}),item.showProgress=!0},uploader.onSuccessItem=function(item,response){item.isProcessing=!1,response instanceof Object&&!response.error?function(response){$rootScope.$broadcast("modelUploadSuccess",response)}(response):(item.isSuccess=!1,item.isError=!0,item.isUploaded=!1,Utilities.throwApiException("#ModelVersion.upload",response),modelUploadError(response))},uploader.onErrorItem=function(fileItem,response,status,headers){console.error("onErrorItem",fileItem,response,status,headers),fileItem.isProcessing=!1,fileItem.isUploaded=!1,Utilities.throwApiException("#ModelVersion.upload",response),modelUploadError(response)},uploader.onCancelItem=function(fileItem,response,status,headers){console.warn("onCancelItem",fileItem,response,status,headers),fileItem.isProcessing=!1},uploader}]).controller("modelUploadModalCtrl",["$scope","$state","$stateParams","$timeout","ModelUploader","Software","Utilities",function($scope,$state,$stateParams,$timeout,ModelUploader,Software,Utilities){$scope.uploader=ModelUploader,$scope.commit={summary:"",note:"",software:[]},$scope.parent=$stateParams.parent,$scope.$watch(function(){return ModelUploader.queue[0]},function(item){$scope.fileitem=item?ModelUploader.queue[0]:null}),$scope.checkAndUpload=function(){$scope.fileitem&&($scope.commit.summary.length?($scope.fileitem.commit=$scope.commit,$scope.fileitem.commit.parent=$scope.parent&&"root"!==$scope.parent.id?$scope.parent.id:null,$scope.fileitem.upload()):Utilities.dangerAlert("model_form_summary_missing"))},$scope.searchSoftware=function(query){return Software.query({search:query}).$promise.then(function(results){return results}).catch(function(reason){return Utilities.throwApiException("#Software.query",reason),[]})},$scope.close=function(){$state.go("^.^")}}]).directive("versionGraph",["$rootScope","$state","$stateParams","ModelVersion","Utilities","moment","$log",function($rootScope,$state,$stateParams,ModelVersion,Utilities,moment,$log){return{templateUrl:"components/dokuvis.models/versionGraph.tpl.5fda3f2f.html",restrict:"E",scope:{},link:function(scope){var versions=null,activeVersion=$stateParams.initialVersion?{id:$stateParams.initialVersion}:null;function queryVersions(){ModelVersion.query().$promise.then(function(results){$log.debug("versions:",results),results.unshift({id:"root",predecessor:null,summary:"root",created:{date:0}}),versions=results,activeVersion?scope.select(versions.find(function(v){return v.id===activeVersion.id})):scope.select(versions[versions.length-1])}).catch(function(reason){Utilities.throwApiException("#ModelVersion.query",reason)})}queryVersions(),scope.$on("modelUploadSuccess",function(){queryVersions()}),scope.$on("modelVersionUpdate",function(event,version){activeVersion=version,queryVersions()}),scope.select=function(vers){$log.debug(vers),"blind"!==vers.id?(activeVersion&&(activeVersion.active=!1),(activeVersion=vers).active=!0,function(data){var tmpData=[].concat(data);$rootScope.globalSubproject&&$rootScope.can("model_upload")&&tmpData.push({id:"blind",predecessor:activeVersion?activeVersion.id:tmpData[tmpData.length-1].id,summary:"model_version_new",created:{date:moment().format()}});var root=d3.stratify().id(function(d){return d.id}).parentId(function(d){return"root"===d.id?null:d.predecessor||"root"})(tmpData),sorted=root.descendants().sort(function(a,b){return a.data.created.date?b.data.created.date&&a.data.created.date<b.data.created.date?-1:1:-1}),newColOffset=0,cols={},blindIndex=0;sorted.forEach(function(node,index){var colIndex=0,parentRow=-1,parentCol=0;if(node.parent){parentRow=node.parent.index.row,parentCol=node.parent.index.col,node.parent.children[0]===node&&(colIndex=parentCol);for(var i=1;i<node.parent.children.length;i++)node.parent.children[i]===node&&(colIndex=++newColOffset,cols[colIndex]||(cols[colIndex]={}),cols[colIndex].start=parentRow)}cols[colIndex]||(cols[colIndex]={start:index}),cols[colIndex].end=index,node.index={row:index,col:colIndex,parentRow:parentRow,parentCol:parentCol},"blind"===node.data.id&&(blindIndex=node.index)});var colCount=Object.keys(cols).length+(blindIndex.col===blindIndex.parentCol?1:0),list=[];root.each(function(node){for(var isBlind=!1,cells=[],i=0;i<colCount;i++)cells.push([]);isBlind="blind"===node.data.id,cells[node.index.col].push({type:"node",css:"root"===node.data.id?"bg-root":isBlind?"bg-blind":"bg-"+node.index.col%5}),"root"!==node.data.id&&cells[node.index.col].push({type:"downtick",css:isBlind?"line-blind":"line-"+node.index.col%5});var children=node.children||[];for(var key in children.forEach(function(c){if(isBlind="blind"===c.data.id,node.index.col===c.index.col)cells[node.index.col].push({type:"uptick",css:isBlind?"line-blind":"line-"+c.index.col%5});else{cells[node.index.col].push({type:"sidetick",css:isBlind?"line-blind":"line-"+c.index.col%5}),cells[c.index.col].push({type:"corner",css:isBlind?"line-blind":"line-"+c.index.col%5});for(var i=node.index.col+1;i<c.index.col;i++)cells[i].push({type:"hline",css:isBlind?"line-blind":"line-"+c.index.col%5})}}),cols)+key!==node.index.col&&node.index.row>cols[key].start&&node.index.row<cols[key].end&&(isBlind=blindIndex.col===+key&&blindIndex.parentRow<node.index.row,cells[key].push({type:"vline",css:isBlind?"line-blind":"line-"+key%5}));list.push({data:node.data,order:node.data.created.date||0,parent:node.parent,children:node.children,index:node.index,cells:cells})}),scope.versions=list}(versions),function(vers){$rootScope.$broadcast("modelVersionActive",vers)}(vers)):$state.go(".upload.model",{parent:activeVersion})}}}}]).directive("versionDetail",["$rootScope","DigitalObject","Utilities","$log",function($rootScope,DigitalObject,Utilities,$log){return{templateUrl:"components/dokuvis.models/versionDetail.tpl.e3f7cec8.html",restrict:"E",scope:{},link:function(scope){scope.version=null,scope.$on("modelVersionActive",function(event,version){scope.version=version}),scope.load=function(keepScene){(scope.version||"root"!==scope.version.id)&&DigitalObject.query({versionId:scope.version.id}).$promise.then(function(results){$log.debug(results),function(entries,keepScene){$rootScope.$broadcast("modelQuerySuccess",entries,!0===keepScene)}(results,keepScene)}).catch(function(reason){Utilities.throwApiException("#DigitalObject.query",reason)})}}}}]).controller("versionModalCtrl",["$scope","$rootScope","$state","$stateParams","ModelVersion","Software","ConfirmDialog","Utilities","$log",function($scope,$rootScope,$state,$stateParams,ModelVersion,Software,ConfirmDialog,Utilities,$log){function modelVersionUpdate(version){$rootScope.$broadcast("modelVersionUpdate",version)}$scope.isSaving=!1,$scope.commit=null,$stateParams.versionId?ModelVersion.get({id:$stateParams.versionId}).$promise.then(function(result){$scope.commit=result,$log.debug(result)}).catch(function(reason){Utilities.throwApiException("#ModelVersion.get",reason)}):$scope.close(),$scope.save=function(){$scope.commit.summary.length?($scope.commit.software=$scope.commit.software.map(function(sw){return sw.name}),$scope.isSaving=!0,$scope.commit.$update().then(function(result){modelVersionUpdate(result),$scope.close()}).catch(function(reason){Utilities.throwApiException("ModelVersion.update",reason),$scope.isSaving=!1})):Utilities.dangerAlert("model_form_summary_missing")},$scope.delete=function(){ConfirmDialog({headerText:"Version löschen",bodyText:"Sollen diese Version und die damit verbunden 3D-Objekte wirklich gelöscht werden?"}).then(function(){$scope.commit.$delete().then(function(result){$log.debug(result),modelVersionUpdate(),$scope.close()}).catch(function(reason){Utilities.throwApiException("ModelVersion.delete",reason)})})},$scope.searchSoftware=function(query){return Software.query({search:query}).$promise.then(function(results){return results}).catch(function(reason){return Utilities.throwApiException("#Software.query",reason),[]})},$scope.close=function(){$state.go("^")}}]),angular.module("dokuvis.comments",["ngResource","angularMoment"]).factory("Comment",["$resource","ApiParams","ApiComment","moment",function($resource,ApiParams,ApiComment,moment){return $resource(ApiComment+"/:id",angular.extend({id:"@id"},ApiParams),{save:{method:"POST",transformRequest:function(data){return angular.toJson(angular.extend(data,{date:moment().format()}))}},queryTarget:{method:"GET",url:ApiComment+"/target/:targetId",isArray:!0}})}]).directive("commentSection",["$rootScope","Comment","Utilities","$log",function($rootScope,Comment,Utilities,$log){return{restrict:"E",templateUrl:"components/dokuvis.comments/commentSection.tpl.b9b569b4.html",scope:{target:"=",type:"="},link:function(scope){function commentsUpdate(comment){$rootScope.$broadcast("commentsUpdate",comment)}scope.commentInput="",scope.$watch("target",function(target){if(!target)return;if(!scope.type)return;Comment.queryTarget({targetId:target}).$promise.then(function(result){$log.debug(result),scope.comments=result}).catch(function(err){Utilities.throwApiException("#Comment.queryTarget",err)})}),scope.postComment=function(){if(!(scope.newCommentInput.length<1)){var type=scope.type;-1!==["picture","plan","text"].indexOf(type)&&(type="source"),Comment.save({type:type,text:scope.newCommentInput,targets:scope.target}).$promise.then(function(newComment){scope.newCommentInput="",newComment&&(newComment.answers=[],scope.comments.push(newComment)),commentsUpdate(newComment)}).catch(function(err){Utilities.throwApiException("#Comment.save",err)})}},scope.postAnswer=function(comment){comment.newAnswerInput.length<1||Comment.save({type:"answer",text:comment.newAnswerInput,targets:comment.id}).$promise.then(function(newAnswer){comment.newAnswerInput="",comment.answering=!1,newAnswer&&comment.answers.push(newAnswer),commentsUpdate(newAnswer)}).catch(function(err){Utilities.throwApiException("#Comment.save",err)})}}}}]).directive("commentList",["$rootScope","Comment","Utilities","$log",function($rootScope,Comment,Utilities,$log){return{templateUrl:"components/dokuvis.comments/commentList.tpl.2a47ca8a.html",restrict:"E",link:function(scope){function queryComments(){Comment.query().$promise.then(function(results){$log.debug("comments:",results),scope.elements=results}).catch(function(reason){Utilities.throwApiException("Comment.query",reason)})}scope.options={activeTab:""},scope.elements=[],queryComments(),scope.$on("commentsUpdate",function(){queryComments()}),scope.openComment=function(comment){!function(comment){$rootScope.$broadcast("commentActive",comment)}(comment)},scope.setScreenshotView=function(comment,event){var data;event.stopPropagation(),comment.screenshots.length&&(data=comment.screenshots[0],$rootScope.$broadcast("snapshotViewStart",data))}}}}]).directive("commentDetail",["$rootScope","Comment","Utilities","$log",function($rootScope,Comment,Utilities,$log){return{templateUrl:"components/dokuvis.comments/commentDetail.tpl.33d03b77.html",restrict:"E",scope:{id:"="},link:function(scope){scope.comment=null,scope.newAnswerInput="",scope.isAnswering=!1,scope.$watch("id",function(id){if(!id)return;Comment.get({id:id}).$promise.then(function(result){$log.debug(result),scope.comment=result}).catch(function(reason){Utilities.throwApiException("Comment.get",reason)})}),scope.setScreenshotView=function(){var data;scope.comment.screenshots.length&&(data=scope.comment.screenshots[0],$rootScope.$broadcast("snapshotViewStart",data))},scope.showSnapshot=function(){var screen,pins;screen=scope.comment.screenshots[0],pins=scope.comment.pins,$rootScope.$broadcast("snapshotViewScreen",screen,pins)},scope.postAnswer=function(){scope.comment&&(scope.newAnswerInput.length<1||Comment.save({type:"answer",text:scope.newAnswerInput,targets:scope.comment.id}).$promise.then(function(newAnswer){var comment;console.log(newAnswer),scope.newAnswerInput="",scope.isAnswering=!1,newAnswer&&scope.comment.answers.push(newAnswer),comment=newAnswer,$rootScope.$broadcast("commentsUpdate",comment)}).catch(function(err){Utilities.throwApiException("#Comment.save",err)}))}}}}]).directive("snapshotForm",["$rootScope","Comment","Utilities","$log",function($rootScope,Comment,Utilities,$log){return{templateUrl:"components/dokuvis.comments/snapshotForm.tpl.b119dadb.html",restrict:"E",scope:!0,link:function(scope){var viewportAPI;function snapshotEnd(){$rootScope.$broadcast("snapshotEnd")}scope.comment="",scope.refObj=[],scope.refSrc=[],scope.isSaving=!1,scope.$on("snapshotSyncViewport",function(event,args){console.log(args),viewportAPI=args,scope.screenshot=viewportAPI.getScreenshot()}),scope.$on("snapshotPinSuccess",function(event,object,pinMatrix){scope.refObj.find(function(obj){return obj.object===object})||scope.refObj.push({object:object,pinMatrix:pinMatrix})}),scope.$on("snapshotReference",function(event,ref){-1===scope.refSrc.indexOf(ref)&&scope.refSrc.push(ref)}),scope.removeObject=function(obj){scope.refObj.splice(scope.refObj.indexOf(obj),1),viewportAPI.removeObjectFromMarked(obj.object)},scope.removeSource=function(src){scope.refSrc.splice(scope.refSrc.indexOf(src),1)},scope.save=function(){scope.comment.length?scope.refObj.length?scope.screenshot?(scope.screenshot.pData=viewportAPI.getPainting(),$log.debug(scope.comment,scope.refObj,scope.refSrc,scope.screenshot),scope.isSaving=!0,Comment.save({type:"model",text:scope.comment,targets:scope.refObj.map(function(t){return{object:t.object.name,pinMatrix:t.pinMatrix}}),refs:scope.refSrc.map(function(t){return t.id}),screenshots:[scope.screenshot]}).$promise.then(function(result){var comment;$log.debug(result),snapshotEnd(),comment=result,$rootScope.$broadcast("commentsUpdate",comment)}).catch(function(reason){Utilities.throwApiException("Comment.save",reason),scope.isSaving=!1})):Utilities.dangerAlert("No screenshot available!"):Utilities.dangerAlert("Markiere mindestens ein Objekt, über das dieser Kommentar handelt."):Utilities.dangerAlert("Bitte geben Sie einen Text ein!")},scope.abort=function(){snapshotEnd()}}}}]),angular.module("dokuvis.categories",["ngResource","ngAnimate","ui.router","xeditable","minicolors"]).factory("Category",["$resource","ApiParams","ApiCategory","CategoryAttribute",function($resource,ApiParams,ApiCategory,CategoryAttribute){return $resource(ApiCategory+"/:cid",angular.extend({cid:"@id"},ApiParams),{query:{method:"GET",isArray:!0,transformResponse:function(json){for(var data=angular.fromJson(json),i=0;i<data.length;i++)for(var j=0;j<data[i].attributes.length;j++)data[i].attributes[j]=new CategoryAttribute(data[i].attributes[j]),data[i].attributes[j].cid=data[i].id;return data}},update:{method:"PUT"}})}]).factory("CategoryAttribute",["$resource","ApiParams","ApiCategory",function($resource,ApiParams,ApiCategory){return $resource(ApiCategory+"/:cid/attribute/:aid",angular.extend({cid:"@cid",aid:"@id"}),{update:{method:"PUT"}})}]).directive("categoryList",["$rootScope","Category","Utilities",function($rootScope,Category,Utilities){return{restrict:"E",templateUrl:"components/dokuvis.categories/categoryList.tpl.998f0267.html",scope:{},link:function(scope){scope.categories=[];function queryCategories(){Category.query().$promise.then(function(categories){for(var i=0;i<categories.length;i++)categories[i].attributes.push({id:0,value:"<Nicht zugewiesen>"}),categories[i].attributes.push({id:-1,value:"<Beibehalten>"});scope.categories=categories}).catch(function(reason){Utilities.throwApiException("#Category#query",reason)})}queryCategories(),scope.assignAttribute=function(){},scope.activateCategory=function(category){!function(category){$rootScope.$broadcast("categoryActivate",category)}(category),!0},scope.$on("categoryUpdate",function(){queryCategories()})}}}]).directive("categoryConfig",["$rootScope","Category","CategoryAttribute","Utilities",function($rootScope,Category,CategoryAttribute,Utilities){return{restrict:"E",templateUrl:"components/dokuvis.categories/categoryConfig.tpl.0ddfb369.html",scope:{},link:function(scope){function categoryUpdate(category){$rootScope.$broadcast("categoryUpdate",category)}scope.categories=[],scope.minicolors={control:"wheel",opacity:!0,position:"bottom left",format:"rgb",changeDelay:200},Category.query().$promise.then(function(categories){scope.categories=categories}).catch(function(reason){Utilities.throwApiException("#Category.query",reason)}),scope.addCategory=function(){scope.newCategory&&Category.save({value:scope.newCategory}).$promise.then(function(category){scope.categories.push(category),scope.newCategory="",categoryUpdate(category)}).catch(function(reason){Utilities.throwApiException("#Category.save",reason)})},scope.updateCategory=function(category){category.$update().then(function(){categoryUpdate(category)}).catch(function(reason){Utilities.throwApiException("#Category.update",reason)})},scope.removeCategory=function(category){category.$delegate().then(function(){scope.categories.splice(scope.categories.indexOf(category),1),categoryUpdate()}).catch(function(reason){Utilities.throwApiException("#Category.delete",reason)})},scope.addAttribute=function(category){category.newAttribute&&CategoryAttribute.save({cid:category.id,value:category.newAttribute,color:getRandomColor()}).$promise.then(function(attribute){category.attributes.push(attribute),category.newAttribute="",categoryUpdate(category)}).catch(function(reason){Utilities.throwApiException("#CategoryAttribute.save",reason)})},scope.updateAttribute=function(attribute){attribute.$update().then(function(){categoryUpdate()}).catch(function(reason){Utilities.throwApiException("#CategoryAttribute.update",reason)})},scope.removeAttribute=function(category,attribute){attribute.$delete().then(function(){category.attributes.splice(category.attributes.indexOf(attribute),1),categoryUpdate()}).catch(function(reason){Utilities.throwApiException("#CategoryAttribute.delete",reason)})};var getRandomColor=function(){for(var letters="0123456789ABCDEF".split(""),color="#",i=0;i<6;i++)color+=letters[Math.round(15*Math.random())];return color}}}}]).directive("categoryLegend",[function(){return{restrict:"E",templateUrl:"components/dokuvis.categories/categoryLegend.tpl.0cf261c2.html",scope:{},link:function(scope,element,attrs){attrs.$addClass("ng-hide"),console.log("link",element,attrs),scope.$on("categoryActivate",function(event,category){attrs.$removeClass("ng-hide"),scope.category=category,console.log(category,scope)}),scope.$on("categoryDeactivate",function(){attrs.$addClass("ng-hide")}),scope.hide=function(){attrs.$addClass("ng-hide")},scope.show=function(){attrs.$removeClass("ng-hide")}}}}]),angular.module("dokuvis.tasks",["ngResource","ui.router","angularMoment","gantt","gantt.table","gantt.tree","gantt.groups","gantt.movable","gantt.tooltips","gantt.sortable","gantt.resizeSensor"]).factory("Task",["$resource","ApiParams","ApiTask","moment",function($resource,ApiParams,ApiTask,moment){return $resource(ApiTask+"/:id",angular.extend({id:"@id"},ApiParams),{save:{method:"POST",transformRequest:function(data){return angular.toJson(angular.extend(data,{date:moment().format()}))}},update:{method:"PUT",transformRequest:function(data){return angular.toJson(angular.extend(data,{date:moment().format()}))}}})}]).directive("tasksGantt",["$rootScope","$timeout","$q","$stateParams","moment","Task","Subproject","Staff","Utilities","$log",function($rootScope,$timeout,$q,$stateParams,moment,Task,Subproject,Staff,Utilities,$log){return{restrict:"E",templateUrl:"components/dokuvis.tasks/tasksGantt.tpl.23fbfbea.html",scope:{},link:function(scope){var apiGlobal,apiHierarchy,enableInitialTask=!0,tasks=[],projects=[],staff=[],activeTask=null,updatedTask=null,apiReady=$q.defer(),deferredTaskActivate=void 0;function onDataChange(){if("task"===scope.config.sort.primary)for(var i=0,l=scope.data.length;i<l;i++)"staff"!==scope.data[i].data.type&&(scope.data[i].data.editors=retrieveEditors(scope.data[i]));$log.debug("final",scope.data,$stateParams),updatedTask?(activateRow(getDataEntryById(updatedTask.id)),updatedTask=null):enableInitialTask&&$stateParams.initialTask&&(activateRow(getDataEntryById($stateParams.initialTask)),enableInitialTask=!1),$timeout(function(){apiGlobal.side.setWidth()})}function updateGantt(reload){var promises=[apiReady.promise];reload&&(promises.push(Subproject.query().$promise.then(function(results){$log.debug("Projects",results),projects=results}).catch(function(err){Utilities.throwApiException("#Subproject.query",err)})),promises.push(Task.query().$promise.then(function(results){$log.debug("Tasks",results),tasks=results}).catch(function(err){Utilities.throwApiException("#Task.query",err)})),promises.push(void Staff.query().$promise.then(function(results){$log.debug("Staff",results),staff=results,scope.staff=staff}).catch(function(err){Utilities.throwApiException("#Staff.query",err)}))),$q.all(promises).then(function(){scope.data=[],activeTask=null,"staff"===scope.config.sort.primary&&(staff.forEach(function(value){var row={id:value.email,name:value.name,data:{type:"staff",resource:value},classes:["staff-row"]};scope.data.push(row)}),scope.data.push({id:"not_assigned",name:"~Nicht zugewiesen~",data:{type:"staff"},classes:["staff-row"]})),"task"===scope.config.sort.primary&&projects.forEach(function(prj){var row={id:prj.id,name:prj.name,parent:void 0,data:{type:"project",resource:prj},classes:[],active:!1};scope.data.push(row)}),"task"===scope.config.sort.primary?tasks.forEach(function(task){addTask(task,task.id,task.parent)}):"staff"===scope.config.sort.primary&&tasks.forEach(function(task){var hasEditor=!1;if(staff.forEach(function(value){var found=task.editors.find(function(e){return e.id===value.email});if(found){var id=task.id+"_"+value.email;getDataEntryById(id)||(addTask(task,id,task.parent+"_"+value.email),addParent(task.parent,value.email),hasEditor=!0)}}),!hasEditor){var id=task.id+"_not_assigned";getDataEntryById(id)||(addTask(task,id,task.parent+"_not_assigned"),addParent(task.parent,"not_assigned"))}})})}function addTask(task,id,parent){var data={type:task.type,priority:task.priority,status:task.status,editors:[],resource:task},row={id:id,name:task.title,parent:parent,data:data,classes:["task-group"],tasks:[],active:!1},classes=[];classes.push(getTaskClass("priority",task.priority)),classes.push(getTaskClass("status",task.status));var rowTask={id:id,name:task.title,from:task.from,to:task.to,data:data,classes:classes,row:row,progress:40};row.tasks.push(rowTask),scope.data.push(row)}function addParent(parentId,staffId){var parent=parentId+"_"+staffId;if(!getDataEntryById(parent)){var id,pObj=(id=parentId,projects.find(function(p){return p.id===id}));if(pObj){var row={id:parent,name:pObj.name,parent:staffId,data:{type:"project",resource:pObj},classes:[],active:!1};scope.data.push(row)}else(pObj=function(id){return tasks.find(function(t){return t.id===id})}(parentId))&&(addTask(pObj,parent,pObj.parent+"_"+staffId),addParent(pObj.parent,staffId))}}function retrieveEditors(row){var editors=[];row.data.resource&&row.data.resource.editors&&(editors=editors.concat(row.data.resource.editors));for(var desc=apiHierarchy.descendants({model:row}),i=0,l=desc.length;i<l;i++)desc[i].model.data.resource&&desc[i].model.data.resource.editors&&(editors=editors.concat(desc[i].model.data.resource.editors));for(var j=0;j<editors.length;j++)for(var k=j+1;k<editors.length;k++)editors[j].id===editors[k].id&&editors.splice(k--,1);return editors}function getDataEntryById(id){return scope.data.find(function(d){return d.id===id})}function getTaskClass(type,value){if("priority"===type)switch(value){case 1:return"task-priority-medium";case 2:return"task-priority-high";default:return"task-priority-low"}else if("status"===type)switch(value){case 1:return"task-status-done";default:return"task-status-todo"}}function onTaskDateChange(task){$log.debug(task);var taskResource=task.model.data.resource,newFrom=moment(task.model.from).format(),newTo=moment(task.model.to).format();taskResource.from===newFrom&&taskResource.to===newTo||(taskResource.from=newFrom,taskResource.to=newTo,$log.debug(taskResource.from,taskResource.to),$log.debug(taskResource),taskResource.$update().catch(function(err){Utilities.throwApiException("#Task.update",err)}),"staff"===scope.config.sort.primary&&updateGantt())}function activateRow(row){row.active=!0,taskActivate((activeTask=row).data.resource,row),updateRowClasses(row)}function deactivateRow(row){row&&(row.active=!1,activeTask=null,taskActivate(),updateRowClasses(row),scope.$applyAsync())}function updateRowClasses(row){if(row){var activeRowClassIndex=row.classes.indexOf("active");if(row.active&&-1===activeRowClassIndex?row.classes.push("active"):row.active||-1===activeRowClassIndex||row.classes.splice(activeRowClassIndex,1),row.tasks)for(var i=0;i<row.tasks.length;i++){var activeTaskClassIndex=row.tasks[i].classes.indexOf("active");row.active&&-1===activeTaskClassIndex?row.tasks[i].classes.push("active"):row.active||-1===activeTaskClassIndex||row.tasks[i].classes.splice(activeTaskClassIndex,1);var statusTaskClassIndex=row.tasks[i].classes.indexOf("task-status-done");row.data.status&&-1===statusTaskClassIndex?row.tasks[i].classes.push("task-status-done"):row.data.status||-1===statusTaskClassIndex||row.tasks[i].classes.splice(statusTaskClassIndex,1)}}}function taskActivate(task,row){$rootScope.$broadcast("taskActivate",task,row)}scope.data=[],scope.config={date:{from:moment().subtract(2,"weeks"),to:moment().add(2,"weeks"),viewScale:"day"},filter:{row:""},sort:{primary:"task",secondary:[{name:"Name",value:"model.name"},{name:"Priority",value:["model.data.status","-model.data.priority","model.name"]},{name:"Von",value:["model.data.resource.from","model.name"]},{name:"Bis",value:["model.data.resource.to","model.name"]}],sortMode:"model.name"},gantt:{allowSideResizing:!0,autoExpand:"both",currentDate:"line",currentDateValue:moment(),daily:!0,expandToWidth:!0,sideWidth:"min-width",taskOutOfRange:"truncate",rowContent:'\t\t\t\t\t<span ng-switch="row.model.data.type">\t\t\t\t\t\t<span ng-switch-when="project">\t\t\t\t\t\t\t<i class="btn-row fa fa-folder-open" ng-click="scope.openDescAndComments"></i>\t\t\t\t\t\t\t<b class="label-highlight" ng-click="scope.activateRow(row.model)">{{row.model.name | characters:30}}</b>\t\t\t\t\t\t\t<i class="btn-row fa fa-plus" bs-tooltip="tooltip[1]" ui-sref=".detail({taskId: \'new\', parent: {id: row.model.data.resource.id, name: row.model.name}})"></i>\t\t\t\t\t\t</span>\t\t\t\t\t\t<span ng-switch-when="task">\t\t\t\t\t\t\t<i class="btn-row" ng-class="row.model.hasData ? \'fa fa-envelope\' : \'glyphicon glyphicon-file\'" ng-click="scope.openDescAndComments(row)"></i>\t\t\t\t\t\t\t<span class="label-highlight" ng-click="scope.activateRow(row.model)">{{row.model.name | characters:30}}</span>\t\t\t\t\t\t\t<i class="btn-row fa fa-plus" bs-tooltip="tooltip[1]" ui-sref=".detail({taskId: \'new\', parent: {id: row.model.data.resource.id, name: row.model.name}})"></i>\t\t\t\t\t\t</span>\t\t\t\t\t\t<span ng-switch-when="staff">\t\t\t\t\t\t\t<i class="btn-row fa fa-user"></i>\t\t\t\t\t\t\t<b><u>{{row.model.name | characters:30}}</u></b>\t\t\t\t\t\t</span>\t\t\t\t\t</span>',taskContent:"{{task.model.name}}"},tree:{header:"Projektstruktur"},table:{columns:["model.data.editors"],headers:{"model.data.editors":"Editors"},contents:{"model.data.editors":'<span user-initials="ed.name" ng-repeat="ed in getValue()"></span>'}},groups:{display:"overview"},tooltips:{content:'{{task.model.name}}</br><small>{{task.isMilestone() === true && task.model.from.format("ll") || task.model.from.format("ll") + \' - \' + task.model.to.format("ll")}}</small>'}},scope.registerApi=function(api){(apiGlobal=api).core.on.ready(scope,function(){$log.debug(api),apiHierarchy=api.tree.getHierarchy(),apiReady.resolve(),api.data.on.change(scope,onDataChange),api.tasks.on.moveEnd(scope,onTaskDateChange),api.tasks.on.resizeEnd(scope,onTaskDateChange)}),api.directives.on.new(scope,function(dName,dScope,dElement){"ganttBody"===dName?dElement.on("click",function(){deactivateRow(activeTask),deferredTaskActivate&&deferredTaskActivate.resolve()}):"ganttTask"===dName?dElement.on("click",function(){deferredTaskActivate||(deferredTaskActivate=$q.defer()),deferredTaskActivate.promise.then(function(){activateRow(dScope.task.model.row),deferredTaskActivate=void 0})}):"ganttRow"===dName&&dElement.on("click",function(){})})},scope.activateRow=function(row){deactivateRow(activeTask),activateRow(row)},scope.updateSort=function(sortby){scope.config.sort.primary=sortby,updateGantt()},scope.updateViewScale=function(){var fromDate=moment(scope.config.date.from),toDate=moment(scope.config.date.to);toDate.diff(fromDate,"days")<35?scope.config.date.viewScale="day":toDate.diff(fromDate,"weeks")<20?scope.config.date.viewScale="week":scope.config.date.viewScale="month"},scope.zoomAllTasks=function(){var tmp=scope.data.filter(function(d){return"task"===d.data.type});if(tmp.length){console.log(tmp.length);var firstDate=tmp.sort(function(a,b){return a.data.resource.from<b.data.resource.from?-1:1})[0],lastDate=tmp.sort(function(a,b){return a.data.resource.to>b.data.resource.to?-1:1})[0];console.log(firstDate,lastDate),scope.config.date.from=firstDate.data.resource.from,scope.config.date.to=lastDate.data.resource.to,scope.updateViewScale()}},scope.$on("tasksUpdate",function(event,task){$log.debug("event tasksUpdate"),updatedTask=task,updateGantt(!0)}),scope.$on("taskStatusUpdate",function(event,task,row){var dRow=scope.data.find(function(r){return r.id===row.id});console.log(dRow,row),dRow&&(dRow.data.status=row.data.status,updateRowClasses(dRow))}),updateGantt(!0)}}}]).directive("taskDetail",["$rootScope","Utilities","$log",function($rootScope,Utilities,$log){return{restrict:"E",templateUrl:"components/dokuvis.tasks/taskDetail.tpl.41ef1ac7.html",scope:{},link:function(scope){var taskRow=scope.task=null;scope.setTaskStatus=function(status){var taskResource=scope.task;taskResource&&taskRow&&(taskResource.status=status?1:0,taskResource.$update().then(function(result){$log.debug(result),taskRow.data.status=taskResource.status;for(var i=0;i<taskRow.tasks.length;i++)taskRow.tasks[i].status=taskResource.status;var task,row;task=taskResource,row=taskRow,$rootScope.$broadcast("taskStatusUpdate",task,row)}).catch(function(err){Utilities.throwApiException("#Task.update",err)}))},scope.$on("taskActivate",function(event,task,row){$log.debug(task,row),scope.task=task,taskRow=row})}}}]).controller("taskModalCtrl",["$scope","$rootScope","$state","$stateParams","moment","Task","Staff","Utilities","ConfirmDialog","$log",function($scope,$rootScope,$state,$stateParams,moment,Task,Staff,Utilities,ConfirmDialog,$log){var parent=null,task=null;function tasksUpdate(task){$scope.$root.$broadcast("tasksUpdate",task)}"new"===$stateParams.taskId?($scope.title="Neue Aufgabe",$scope.newTask=!0,function(){$stateParams.parent?($scope.parentName=$stateParams.parent.name,parent=$stateParams.parent.id):"master"===$stateParams.subproject?($scope.attachNote="Aufgabe wird als Aufgabe des Hauptprojektes erstellt.",parent=$stateParams.project):($scope.attachNote="Aufgabe wird als Aufgabe des Unterprojektes <strong>"+$rootScope.globalSubproject.name+"</strong> erstellt.",parent=$stateParams.subproject);$scope.task={title:"",description:"",from:moment().format("YYYY-MM-DD"),to:moment().add(1,"days").format("YYYY-MM-DD"),priority:0,editors:[]}}()):($scope.title="Aufgabe bearbeiten",$scope.newTask=!1,Task.get({id:$stateParams.taskId}).$promise.then(function(result){$log.debug(result),$scope.task={title:result.title,description:result.description,from:moment(result.from).format("YYYY-MM-DD"),to:moment(result.to).format("YYYY-MM-DD"),priority:result.priority,editors:result.editors,created:result.created,modified:result.modified},task=result}).catch(function(reason){Utilities.throwApiException("#Task.get",reason)})),$scope.save=function(){if($scope.task.title.length)if($scope.task.from.length&&$scope.task.to.length&&moment($scope.task.from).isValid()&&moment($scope.task.to).isValid()&&!moment($scope.task.from).isAfter($scope.task.to))if(task)task.title=$scope.task.title,task.description=$scope.task.description,task.from=moment($scope.task.from).format(),task.to=moment($scope.task.to).format(),task.priority=$scope.task.priority,task.editors=$scope.task.editors.map(function(value){return value.email||value.id}),$scope.isSaving=!0,task.$update().then(function(result){$log.debug(result),tasksUpdate(task),$scope.close()}).catch(function(err){Utilities.throwApiException("#Task.update",err),$scope.isSaving=!1});else{if(!parent)return void Utilities.throwException("Controller Exception",'"parent" is not set!');$scope.isSaving=!0,Task.save({title:$scope.task.title,description:$scope.task.description,from:moment($scope.task.from).format(),to:moment($scope.task.to).format(),priority:$scope.task.priority,editors:$scope.task.editors.map(function(value){return value.email||value.id}),parent:parent}).$promise.then(function(result){$log.debug(result),tasksUpdate(result),$scope.close()}).catch(function(reason){Utilities.throwApiException("#Task.save",reason),$scope.isSaving=!1})}else Utilities.dangerAlert("Geben Sie ein korrektes Datum an!");else Utilities.dangerAlert("Geben Sie der Aufgabe einen Namen!")},$scope.delete=function(){ConfirmDialog({headerText:"Aufgabe löschen",bodyText:"Soll die Aufgabe <b>"+task.title+"</b> wirklich gelöscht werden? <br/> \t\t\t\t\tAlle Unteraufgaben gehen an die Oberaufgabe."}).then(function(){task.$delete().then(function(result){$log.debug(result),tasksUpdate(),$scope.close()}).catch(function(reason){Utilities.throwApiException("#Task.delete",reason)})})},$scope.searchEditors=function(query){return Staff.query({search:query}).$promise.then(function(result){return result}).catch(function(err){return Utilities.throwApiException("#Staff.query",err),[]})},$scope.checkEditor=function(tag){return!(!tag.email&&!tag.id)&&Staff.get({id:tag.email||tag.id}).$promise.then(function(result){return!!result.email}).catch(function(err){return Utilities.throwApiException("#Staff.get",err),!1})},$scope.close=function(){$state.go("^")}}]),angular.module("dokuvis.staff",["ngResource"]).factory("Staff",["$resource","ApiParams","ApiStaff","ApiRoles",function($resource,ApiParams,ApiStaff,ApiRoles){return $resource(ApiStaff+"/:id",angular.extend({id:"@email"},ApiParams),{queryRoles:{url:ApiRoles,method:"GET",isArray:!0}})}]).directive("staffList",["Staff","Utilities",function(Staff,Utilities){return{restrict:"E",templateUrl:"components/dokuvis.staff/staffList.tpl.c2b91d01.html",scope:{configArray:"<config"},link:function(scope){function queryStaff(){Staff.query().$promise.then(function(results){scope.staff=results}).catch(function(reason){Utilities.throwApiException("#Task.query",reason)})}scope.config={edit:!1,remove:!1},angular.forEach(scope.configArray,function(value){scope.config[value]=!0}),scope.staff=[],queryStaff(),scope.$on("staffUpdate",function(){queryStaff()})}}}]).controller("staffModalCtrl",["$scope","$rootScope","$state","Staff","Utilities",function($scope,$rootScope,$state,Staff,Utilities){$scope.title="Mitarbeiter/Beobachter hinzufügen",$scope.user="",$scope.role="visitor",$scope.save=function(){$scope.user.length?Staff.save({user:$scope.user,role:$scope.role}).$promise.then(function(result){var user;console.log(result),user=result,$rootScope.$broadcast("staffUpdate",user),$scope.close()}).catch(function(err){if(err.data&&"string"==typeof err.data.originalErr)var message=err.data.originalErr;else message="#Staff.save";Utilities.throwApiException(message,err)}):Utilities.dangerAlert("Geben sie dem Projekt einen Namen!")},Staff.queryRoles().$promise.then(function(results){$scope.roles=results}).catch(function(err){Utilities.throwApiException("#Staff.queryRoles",err)}),$scope.close=function(){$state.go("^")}}]),angular.module("dokuvis.authors",["ngResource","pascalprecht.translate"]).factory("Author",["$resource","ApiParams","ApiAuthor",function($resource,ApiParams,ApiAuthor){return $resource(ApiAuthor+"/:id",angular.extend({id:"@id"},ApiParams),{update:{method:"PUT"}})}]).directive("authorList",["Author","Utilities",function(Author,Utilities){return{restrict:"E",templateUrl:"components/dokuvis.authors/authorList.tpl.6bfbad35.html",scope:{},link:function(scope){function queryAuthors(){Author.query().$promise.then(function(results){scope.authors=results}).catch(function(reason){Utilities.throwApiException("#Author.query",reason)})}scope.authors=[],queryAuthors(),scope.$on("authorsUpdate",function(){queryAuthors()})}}}]).controller("authorModalCtrl",["$scope","$rootScope","$state","$stateParams","Author","Utilities","ConfirmDialog",function($scope,$rootScope,$state,$stateParams,Author,Utilities,ConfirmDialog){$scope.isSaving=!1,$scope.name="";var author=null;function authorsUpdate(author){$rootScope.$broadcast("authorsUpdate",author)}"new"===$stateParams.authorId?($scope.title="author_new",$scope.new=!0):($scope.title="author_delete",$scope.new=!1,Author.get({id:$stateParams.authorId}).$promise.then(function(result){$scope.name=result.name,author=result}).catch(function(reason){Utilities.throwApiException("#Author.get",reason)})),$scope.save=function(){$scope.name.length?($scope.isSaving=!0,$scope.new?Author.save({name:$scope.name}).$promise.then(function(result){authorsUpdate(result),$scope.close()}).catch(function(reason){Utilities.throwApiException("#Author.save",reason),$scope.isSaving=!1}):(author.name=$scope.name,author.$update().then(function(){authorsUpdate(author),$scope.close()}).catch(function(reason){Utilities.throwApiException("#Author.update",reason),$scope.isSaving=!1}))):Utilities.dangerAlert("Geben Sie dem Author einen Namen!")},$scope.delete=function(){ConfirmDialog({headerText:"author_delete",bodyText:"author_delete_confirm",translationData:{name:author.name}}).then(function(){$scope.isSaving=!0,author.$delete().then(function(response){console.log(response),authorsUpdate(),$scope.close()}).catch(function(reason){Utilities.throwApiException("#Author.delete",reason),$scope.isSaving=!1})})},$scope.close=function(){$state.go("^")}}]),angular.module("dokuvis.activities",[]).factory("Activity",["$resource","ApiParams","ApiActivity",function($resource,ApiParams,ApiActivity){return $resource(ApiActivity,ApiParams)}]).directive("activityList",["$q","$state","Activity","Subproject","Utilities","$log",function($q,$state,Activity,Subproject,Utilities,$log){return{templateUrl:"components/dokuvis.activities/activityList.tpl.e8860cbe.html",restrict:"E",link:function(scope){scope.activities=[],scope.pages=[],scope.currentPage=0;var deferred,subprojects=null;deferred=$q.defer(),subprojects?deferred.resolve():Subproject.query().$promise.then(function(results){return subprojects=results,$q.resolve()}).catch(function(reason){return Utilities.throwApiException("Subproject.query",reason),$q.reject(reason)}).then(function(){deferred.resolve()}).catch(function(){deferred.reject()}),deferred.promise.catch(function(){}).then(function(){return Activity.query().$promise}).then(function(results){results.forEach(function(a){a.subproject=subprojects.find(function(sp){return a.subproject===sp.id})||{id:"master",name:"master"}}),scope.activities=results,scope.pages=[],scope.pages.push({active:!0});for(var i=1,l=Math.ceil(results.length/10);i<l;i++)scope.pages.push({active:!1});$log.debug("Last activites",results)}).catch(function(reason){Utilities.throwApiException("Activity.query",reason)}),scope.openActivity=function(activity){switch(activity.type){case"source_upload":case"source.update":$state.go("^.explorer.source.id",{subproject:activity.subproject.id,sourceId:activity.id});break;case"model_upload":case"version_update":$state.go("^.explorer",{subproject:activity.subproject.id,initialVersion:activity.id});break;case"task_create":case"task_update":$state.go("^.tasks",{initialTask:activity.id});break;case"comment_create":"commentSource"===activity.commentType?$state.go("^.explorer.source.id",{subproject:activity.subproject.id,sourceId:activity.commentTarget}):"commentModel"===activity.commentType?$state.go("^.explorer",{subproject:activity.subproject.id,initialComment:activity.id}):"commentTask"===activity.commentType?$state.go("^.tasks",{initialTask:activity.commentTarget}):$state.go("^.explorer",{subproject:activity.subproject.id,initialComment:activity.commentTarget})}},scope.setPage=function(value){"prev"===value?value=scope.currentPage-1:"next"===value&&(value=scope.currentPage+1),scope.pages[scope.currentPage].active=!1,scope.currentPage=value,scope.pages[value].active=!0}}}}]),angular.module("dokuvis.viewport",["pascalprecht.translate","ngDebounceThrottle"]).directive("viewport",["$state","$window","$timeout","viewportCache","viewportSettings","webglInterface","$rootScope","$q","Utilities","Comment","$debounce","$throttle","SpatializeInterface","$log","$compile","$animate",function($state,$window,$timeout,viewportCache,viewportSettings,webglInterface,$rootScope,$q,Utilities,Comment,$debounce,$throttle,SpatializeInterface,$log,$compile,$animate){return{restrict:"E",replace:!1,transclude:!0,template:"<canvas ng-class=\"{'cursor_orbit': navigation.rotate, 'cursor_pan': navigation.pan, 'cursor_zoom': navigation.zoom}\"></canvas>\n<div class=\"viewport-extras\" ng-transclude></div>",scope:{callFunc:"=",screenshotCallback:"="},link:function(scope,element,attrs){var cfId=attrs.id||0;webglInterface.callFunc[cfId]={},SpatializeInterface.callFunc[cfId]={},scope.hud={navigation:"navToolbar"in attrs,axis:"axis"in attrs,focus:!1,move:!1,shading:!1,camera:!1,options:"optionToolbar"in attrs,spatialize:"spatialize"in attrs},angular.forEach(scope.navToolbar,function(value){scope.hud[value]=!0});var SCREEN_WIDTH,SCREEN_HEIGHT,canvas,renderer,scene,controls,camera,dlight,ctmloader,textureLoader,gizmo,gizmoMove,gizmoRotate,measureTool,pin,enableSpatializeManual="spatializeManual"in attrs,NEAR=viewportSettings.defaults.NEAR,FAR=viewportSettings.defaults.FAR,raycaster=new THREE.Raycaster,selected=[],highlighted=[],marked=[],pins=[],pcConfig=(webglInterface.viewportSettings.shadingSel,{clipMode:Potree.ClipMode.HIGHLIGHT_INSIDE,isFlipYZ:!1,useDEMCollisions:!1,generateDEM:!1,minNodeSize:100,edlStrength:1,edlRadius:1.4,useEDL:!1,classifications:{0:{visible:!0,name:"never classified"},1:{visible:!0,name:"unclassified"},2:{visible:!0,name:"ground"},3:{visible:!0,name:"low vegetation"},4:{visible:!0,name:"medium vegetation"},5:{visible:!0,name:"high vegetation"},6:{visible:!0,name:"building"},7:{visible:!0,name:"low point(noise)"},8:{visible:!0,name:"key-point"},9:{visible:!0,name:"water"},12:{visible:!0,name:"overlap"}}}),isAnimating=!(Potree.pointBudget=5e5),mouseDownCoord=new THREE.Vector2,mouseDownEvent=null,isMouseDown=-1,isRotatingView=!1,isZoomingView=!1,isPanningView=!1;scope.navigation={default:!0,rotate:!1,pan:!1,zoom:!1};var currentMarker,navigation=scope.navigation,isSelecting=!1,isPinning=!1,objects=viewportCache.objects,pointclouds=[],plans=viewportCache.plans,spatialImages=viewportCache.spatialImages,geometries=viewportCache.geometries,materials=viewportCache.materials;function viewportLoadProgress(item,loaded,total){scope.$broadcast("viewportLoadProgress",item,loaded,total)}function viewportCameraMove(cam){scope.$broadcast("viewportCameraMove",cam)}function enableAnimationRequest(){isAnimating||(controls.removeEventListener("change",animate),isAnimating=!0,animate())}function startAnimation(){isAnimating||(controls.removeEventListener("change",animate),isAnimating=!0,animate())}$timeout(function(){!function(){SCREEN_WIDTH=element.width(),SCREEN_HEIGHT=element.height(),console.log("viewport size: ",SCREEN_WIDTH,SCREEN_HEIGHT),(camera=new THREE.CombinedCamera(SCREEN_WIDTH,SCREEN_HEIGHT,35,NEAR,FAR,NEAR,FAR)).position.set(-100,60,100),scene=viewportCache.scene,canvas=element.find("canvas"),(renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!1,preserveDrawingBuffer:!0,canvas:canvas.get(0)})).setClearColor(DV3D.Defaults.backgroundColor,1),renderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT),element.append(renderer.domElement),(controls=new THREE.OrbitControls(camera,renderer.domElement)).zoomSpeed=1,camera.target=controls.center,controls.addEventListener("change",function(){animateThrottle20(),viewportCameraMove(camera)}),dlight=viewportCache.directionalLight;var manager=new THREE.LoadingManager;manager.onProgress=viewportLoadProgress,manager.onLoad=function(){focusAll()},ctmloader=new THREE.CTMLoader(manager),textureLoader=new THREE.TextureLoader(manager),canvas.on("mousedown",mousedown),canvas.on("mousemove",mousemove),canvas.on("mouseup",mouseup),element.on("mouseleave",mouseleave),canvas.on("wheel",mousewheel),canvas.on("contextmenu",function(event){event.preventDefault()});var windowElement=angular.element($window);windowElement.on("keydown",keydown),windowElement.on("keyup",keyup),windowElement.on("resize",resizeViewport),(gizmoMove=new DV3D.GizmoMove(10,2.5,1.2)).addEventListener("change",animate),(gizmoRotate=new DV3D.GizmoRotate(10)).addEventListener("change",animate),objects.forEach(function(entry){entry.addEventListener("change",animateAsync),entry.addEventListener("toggle",toggleObjectHandler),entry.addEventListener("focus",focusHandler),entry.addEventListener("select",selectHandler)}),spatialImages.forEach(function(entry){entry.addEventListener("change",animateAsync),entry.addEventListener("toggle",toggleSourceHandler),entry.addEventListener("select",selectHandler),entry.addEventListener("focus",focusHandler)}),animate(),viewportCameraMove(camera)}()}),$throttle(function(){for(var i=0;i<pointclouds.length;i++){var pc=pointclouds[i];if(Potree.utils.computeTransformedBoundingBox(pc.boundingBox,pc.matrixWorld),!pc.material._defaultIntensityRangeChanged){var root=pc.pcoGeometry.root;if(null!==root&&root.loaded){var attributes=pc.pcoGeometry.root.geometry.attributes;if(attributes.intensity){for(var array=attributes.intensity.array,ordered=[],j=0;j<array.length;j++)ordered.push(array[j]);ordered.sort();var cap=ordered[parseInt(.75*(ordered.length-1))];pc.material.intensityRange=cap<=1?[0,1]:cap<=256?[0,255]:[0,cap]}}}pc.material.clipMode=pcConfig.clipMode,pc.generateDEM=pcConfig.generateDEM,pc.minimumNodePixelSize=pcConfig.minNodeSize,pc.numVisibleNodes,pc.numVisiblePoints,pc.progress;var classification=pc.material.classification,somethingChanged=!1;for(var key in pcConfig.classifications){var w=pcConfig.classifications[key].visible?1:0;classification[key]?classification[key].w!==w&&(classification[key].w=w,somethingChanged=!0):(classification.DEFAULT?classification[key]=classification.DEFAULT:classification[key]=new THREE.Vector4(.3,.6,.6,.5),somethingChanged=!0),somethingChanged&&pc.material.recomputeClassification()}}var result=Potree.updatePointClouds(pointclouds,camera,renderer);result.visibleNodes.length,result.numVisiblePoints},500,!1,!0),webglInterface.callFunc.animate=function(){animate()};var animateAsync=$debounce(animate,50),animateThrottle20=$throttle(animate,20),animateThrottle500=$throttle(animate,500);function animate(){if(isAnimating&&(TWEEN.getAll().length?requestAnimationFrame(animate):(isAnimating=!1,controls.addEventListener("change",animate))),TWEEN.update(),controls&&controls.update(),spatialImages.forEach(function(img){img.object.updateTexture(img.object.withinLODRange(camera.position))},!0),dlight){dlight.position.set(4,4,4);var lightMatrix=(new THREE.Matrix4).makeRotationFromQuaternion(camera.quaternion);dlight.position.applyMatrix4(lightMatrix)}if(scope.hud.spatialize&&SpatializeInterface.markers3D.length)for(var i=0,l=SpatializeInterface.markers3D.length;i<l;i++)SpatializeInterface.markers3D[i].object.lookAt(camera.position);render()}function render(){renderer&&renderer.render(scene,camera)}function raycast(mouse,testObjects,recursive){recursive=recursive||!1;var direction=new THREE.Vector3(mouse.x,mouse.y,NEAR).unproject(camera).sub(camera.position).normalize();raycaster.set(camera.position,direction);var intersects=raycaster.intersectObjects(testObjects,recursive);return intersects.length?intersects[0]:null}function setSelected(entry,onlySelect,onlyDeselect){onlySelect=onlySelect||!1,onlyDeselect=onlyDeselect||!1,selected.length&&!onlySelect&&(selected.forEach(function(item){deselectEntry(item)}),setGizmo(),selected=[]),entry&&!onlyDeselect&&-1===selected.indexOf(entry)?(function selectEntry(entry){entry instanceof DV3D.ObjectEntry?(function(entry){if("object"===entry.type){switch(viewportSettings.shading){case"xray":entry.object.material=materials.xraySelectionMat}entry.edges&&(entry.edges.material===materials.edgesMat?entry.edges.material=materials.edgesSelectionMat:entry.edges.material.color=materials.edgesSelectionMat.color)}}(entry),entry.children.forEach(function(child){selectEntry(child)})):entry instanceof DV3D.PlanEntry?entry.object.select():entry instanceof DV3D.ImageEntry&&entry.object.select(),entry.select(null,!0)}(entry),selected.push(entry),entry instanceof DV3D.PlanEntry&&setGizmo(entry.object,"move")):entry&&!onlyDeselect&&-1!==selected.indexOf(entry)&&(deselectEntry(entry),selected.splice(selected.indexOf(entry),1),gizmo&&gizmo.object===entry.object&&setGizmo()),$rootScope.$applyAsync(),animateAsync()}function deselectEntry(entry){entry instanceof DV3D.ObjectEntry?(function(entry){if("object"===entry.type){switch(viewportSettings.shading){case"xray":entry.object.material=materials.xrayMat}entry.edges&&(entry.edges.material===materials.edgesSelectionMat?entry.edges.material=materials.edgesMat:entry.edges.material.color=materials.edgesMat.color)}}(entry),entry.children.forEach(function(child){deselectEntry(child)})):entry instanceof DV3D.PlanEntry?entry.object.deselect():entry instanceof DV3D.ImageEntry&&entry.object.deselect(),entry.select(null,!1)}function highlightObject(obj){if(-1===marked.indexOf(obj)){for(var i=0;i<highlighted.length;i++)highlighted[i]!==obj&&-1===marked.indexOf(highlighted[i])&&(rejectHighlightMat(highlighted[i]),highlighted.splice(i,1),--i);obj&&-1===highlighted.indexOf(obj)&&("object"===obj.userData.type&&function(obj){obj.material=obj.material.clone();var hcolor=new THREE.Color(16776960);obj.material.color.lerp(hcolor,.5),obj.material.name+="_highlight"}(obj),highlighted.push(obj))}}function rejectHighlightMat(obj){if(obj.material!==materials[obj.userData.originalMat]&&-1===viewportCache.standardMaterials.indexOf(obj.material.name))switch(obj.material.dispose(),viewportSettings.shading){case"grey":obj.material=materials.defaultDoublesideMat;break;case"transparent":obj.material=materials.transparentMat;break;default:obj.material=materials[obj.userData.originalMat]}}function markObject(obj,remove){!0===remove?obj&&-1!==marked.indexOf(obj)&&(rejectMarkMat(obj),marked.splice(marked.indexOf(obj),1)):obj&&-1===marked.indexOf(obj)&&(highlightObject(),"object"===obj.userData.type&&function(obj){rejectHighlightMat(obj),obj.material=obj.material.clone();var mcolor=new THREE.Color(16711680);obj.material.color.lerp(mcolor,.5),obj.material.name+="_mark"}(obj),marked.push(obj))}function clearMarked(){marked.forEach(function(obj){rejectMarkMat(obj)}),marked=[]}function rejectMarkMat(obj){rejectHighlightMat(obj)}function applyShading(mode,lastMode){if(mode!==lastMode){var hideObj="onlyEdges"===mode&&"onlyEdges"!==lastMode,unhideObj="onlyEdges"===lastMode&&"onlyEdges"!==mode,hideEdges="xray"===mode&&"xray"!==lastMode,unhideEdges=viewportSettings.showEdges&&"xray"===lastMode;"custom"===lastMode&&$rootScope.$broadcast("categoryDeactivate"),objects.forEach(function(obj){switch(obj.visible&&(hideObj&&(obj.parent?obj.parent.object.remove(obj.object):scene.remove(obj.object)),unhideObj&&(obj.parent?obj.parent.object.add(obj.object):scene.add(obj.object)),hideEdges&&obj.edges&&scene.remove(obj.edges),unhideEdges&&obj.edges&&scene.add(obj.edges)),mode){case"color":obj.object.material=materials[obj.object.userData.originalMat];break;case"grey":obj.object.material=materials.defaultDoublesideMat;break;case"transparent":obj.object.material=materials.transparentMat;break;case"xray":-1!==selected.indexOf(obj)?obj.object.material=materials.xraySelectionMat:obj.object.material=materials.xrayMat;break;default:obj.object.material=materials[obj.object.userData.originalMat]}}),animate()}}function setCameraMode(mode){if(camera){switch(mode){case"perspective":camera.toPerspective(),camera.setZoom(1);break;case"top":camera.toOrthographic(controls.center),camera.toTopView();break;case"front":camera.toOrthographic(controls.center),camera.toFrontView();break;case"back":camera.toOrthographic(controls.center),camera.toBackView();break;case"left":camera.toOrthographic(controls.center),camera.toLeftView();break;case"right":camera.toOrthographic(controls.center),camera.toRightView()}animate()}}function setNavigationMode(mode,triggerEvent){measureTool&&(scene.remove(measureTool),measureTool.dispose(),measureTool=null),pin&&(scene.remove(pin),pin.dispose(),isPinning=!1,highlightObject(pin=null)),navigation.default=!1,navigation.rotate=!1,navigation.pan=!1,navigation.zoom=!1,mode&&mode in navigation?navigation[mode]=!0:navigation.default=!0,!1!==triggerEvent&&function(mode){scope.$broadcast("viewportNavigationChange",mode)}(mode),animate()}function setOpacity(mesh,edges,value){1===value?(-1===selected.indexOf(mesh)?(mesh.material=materials[mesh.userData.originalMat],edges&&(edges.material=materials.edgesMat)):(mesh.material=materials.selectionMat,edges&&(edges.material=materials.edgesSelectionMat)),mesh.userData.modifiedMat=!1):mesh.userData.modifiedMat||(mesh.material=mesh.material.clone(),mesh.material.transparent=!0,mesh.material.depthWrite=!1,mesh.material.needsUpdate=!0,edges&&(edges.material=edges.material.clone(),edges.material.transparent=!0,edges.material.depthWrite=!1,edges.material.needsUpdate=!0),mesh.userData.modifiedMat=!0),mesh.material.opacity=value,edges&&(edges.material.opacity=value)}function mouseToViewportCoords(event){var mouse=new THREE.Vector2;return mouse.x=event.offsetX/SCREEN_WIDTH*2-1,mouse.y=-event.offsetY/SCREEN_HEIGHT*2+1,mouse}function viewportCoordsToScreenXY(coords){var left=SCREEN_WIDTH*(coords.x+1)/2,top=SCREEN_HEIGHT*(1-coords.y)/2;return new THREE.Vector2(left,top)}function mousedown(event){if(isMouseDown=event.button,mouseDownCoord=mouseToViewportCoords(event),mouseDownEvent=event,navigation.default)if(0===event.button)if(event.shiftKey){var sr=angular.element("<div/>",{id:"select-rectangle",class:"select-rectangle"});element.append(sr),isSelecting=!0}else camera.inPerspectiveMode;else 1===event.button&&(controls.onMouseDown(event.originalEvent,2),canvas.addClass("cursor_pan"),isPanningView=!0);else navigation.rotate?0===event.button&&camera.inPerspectiveMode&&(controls.onMouseDown(event.originalEvent,0),isRotatingView=!0):navigation.pan?0===event.button&&(controls.onMouseDown(event.originalEvent,2),isPanningView=!0):navigation.zoom&&0===event.button&&(controls.onMouseDown(event.originalEvent,1),isZoomingView=!0)}function mousemove(event){event.preventDefault();var mStart,mEnd,mStartScreen,mEndScreen,css,mouse=mouseToViewportCoords(event);-1!==isMouseDown&&(new THREE.Vector2(event.originalEvent.movementX||event.originalEvent.mozMovementX||event.originalEvent.webkitMovementX||0,event.originalEvent.movementY||event.originalEvent.mozMovementY||event.originalEvent.webkitMovementY||0),isRotatingView||isPanningView||isZoomingView?controls.onMouseMove(event.originalEvent):isSelecting?element.find("#select-rectangle").css((mEnd=mouse,mStartScreen=viewportCoordsToScreenXY(mStart=mouseDownCoord),mEndScreen=viewportCoordsToScreenXY(mEnd),css={},mEnd.x>mStart.x?(css.left=mStartScreen.x,css.width=mEndScreen.x-mStartScreen.x):(css.left=mEndScreen.x,css.width=mStartScreen.x-mEndScreen.x),mEnd.y<mStart.y?(css.top=mStartScreen.y,css.height=mEndScreen.y-mStartScreen.y):(css.top=mEndScreen.y,css.height=mStartScreen.y-mEndScreen.y),css)):0===isMouseDown&&camera.inPerspectiveMode&&!mouseDownCoord.equals(mouse)&&(controls.onMouseDown(mouseDownEvent.originalEvent,0),canvas.addClass("cursor_orbit"),isRotatingView=!0))}function mouseup(event){isMouseDown=-1;var mouse=mouseToViewportCoords(event);if(navigation.default)if(isRotatingView)controls.onMouseUp(event.originalEvent),canvas.removeClass("cursor_orbit"),isRotatingView=!1;else if(isPanningView)controls.onMouseUp(event.originalEvent),canvas.removeClass("cursor_pan"),isPanningView=!1;else if(isZoomingView)controls.onMouseUp(event.originalEvent),canvas.removeClass("cursor_zoom"),isZoomingView=!1;else if(isSelecting){if(element.find("#select-rectangle").remove(),isSelecting=!1,0!==event.button)return;var mStart,mEnd;mouse.x>mouseDownCoord.x&&mouse.y<mouseDownCoord.y||mouse.x<mouseDownCoord.x&&mouse.y>mouseDownCoord.y?(mStart=mouseDownCoord,mEnd=mouse):(mStart=new THREE.Vector2(mouseDownCoord.x,mouse.y),mEnd=new THREE.Vector2(mouse.x,mouseDownCoord.y)),function(mStart,mEnd,ctrlKey){var s0=new THREE.Vector3(mStart.x,mStart.y,.5).unproject(camera),s1=new THREE.Vector3(mStart.x,mEnd.y,.5).unproject(camera),s2=new THREE.Vector3(mEnd.x,mEnd.y,.5).unproject(camera),s3=new THREE.Vector3(mEnd.x,mStart.y,.5).unproject(camera),s4=new THREE.Vector3(0,0,.5).unproject(camera),v0=(new THREE.Vector3).subVectors(s0,camera.position),v1=(new THREE.Vector3).subVectors(s1,camera.position),v2=(new THREE.Vector3).subVectors(s2,camera.position),v3=(new THREE.Vector3).subVectors(s3,camera.position),v4=(new THREE.Vector3).subVectors(s4,camera.position),s5=new THREE.Vector3(0,0,.5).unproject(camera).add(v4.clone().setLength(FAR)),v5=(new THREE.Vector3).subVectors(s5,camera.position),n0=(new THREE.Vector3).crossVectors(v1,v0).normalize(),n1=(new THREE.Vector3).crossVectors(v2,v1).normalize(),n2=(new THREE.Vector3).crossVectors(v3,v2).normalize(),n3=(new THREE.Vector3).crossVectors(v0,v3).normalize(),n4=v4.clone().normalize(),n5=v5.clone().negate().normalize(),d0=-n0.dot(s0),d1=-n1.dot(s1),d2=-n2.dot(s2),d3=-n3.dot(s3),d4=-n4.dot(s4),d5=-n5.dot(s5),p0=new THREE.Plane(n0,d0),p1=new THREE.Plane(n1,d1),p2=new THREE.Plane(n2,d2),p3=new THREE.Plane(n3,d3),p4=new THREE.Plane(n4,d4),p5=new THREE.Plane(n5,d5),frustum=new THREE.Frustum(p0,p1,p2,p3,p4,p5);ctrlKey||setSelected(null,!1,!0),objects.forEach(function(obj){if("object"===obj.type&&-1===selected.indexOf(obj.object)&&frustum.intersectsObject(obj.object)){console.log("first check");for(var position=obj.object.geometry.attributes.position.array,matrix=obj.object.matrixWorld,i=0,l=position.length;i<l;i+=3){var vertex=new THREE.Vector3(position[i],position[i+1],position[i+2]);if(vertex.applyMatrix4(matrix),frustum.containsPoint(vertex)){console.log("second check"),setSelected(obj,!0);break}}}},!0)}(mStart,mEnd,event.ctrlKey),animate()}else mouse.equals(mouseDownCoord)&&(function(mouse,ctrlKey){var testObjects=[];objects.forEach(function(obj){"object"===obj.type&&testObjects.push(obj.object)},!0),plans.forEach(function(plan){testObjects.push(plan.object.mesh)},!0),spatialImages.forEach(function(item){testObjects.push(item.object.collisionObject)},!0);var intersection=raycast(mouse,testObjects,!0);intersection?($log.debug(intersection),$log.debug(objects.get(intersection.object.id)),intersection.object.entry instanceof DV3D.Entry?setSelected(intersection.object.entry,ctrlKey):intersection.object.parent.entry instanceof DV3D.Entry?setSelected(intersection.object.parent.entry,ctrlKey):$log.warn("Raycast hit unknown object",intersection)):setSelected(null,ctrlKey)}(mouse,event.ctrlKey),animate());else(navigation.rotate||navigation.pan||navigation.zoom)&&(2===event.button&&setNavigationMode(),(isRotatingView||isPanningView||isZoomingView)&&(controls.onMouseUp(event.originalEvent),isRotatingView=isPanningView=isZoomingView=!1))}function mouseleave(event){isMouseDown=-1,navigation.default?isRotatingView?(controls.onMouseUp(event.originalEvent),canvas.removeClass("cursor_orbit"),isRotatingView=!1):isPanningView?(controls.onMouseUp(event.originalEvent),canvas.removeClass("cursor_pan"),isPanningView=!1):isZoomingView?(controls.onMouseUp(event.originalEvent),canvas.removeClass("cursor_zoom"),isZoomingView=!1):isSelecting&&(element.find("#select-rectangle").remove(),isSelecting=!1):(navigation.rotate||navigation.pan||navigation.zoom)&&(isRotatingView||isPanningView||isZoomingView)&&(controls.onMouseUp(event.originalEvent),isRotatingView=isPanningView=isZoomingView=!1)}function mousewheel(event){event.preventDefault(),controls.onMouseWheel(event.originalEvent)}function keydown(event){-1===["INPUT","TEXTAREA"].indexOf(event.target.tagName)&&controls.onKeyDown(event.originalEvent)}function keyup(event){if(-1===["INPUT","TEXTAREA"].indexOf(event.target.tagName))switch(event.keyCode){case 70:setCameraMode("front");break;case 76:setCameraMode("left");break;case 80:setCameraMode("perspective");break;case 84:setCameraMode("top")}}scope.$watch(function(){return selected.length},function(){$rootScope.$broadcast("viewportSelectionChange",selected)}),webglInterface.callFunc.setSelected=function(obj,ctrlKey,deselect){setSelected(obj,ctrlKey,deselect),animate()},scope.$on("viewportShadingChange",function(event,mode,lastMode){event.stopPropagation(),applyShading(mode,lastMode)}),scope.$on("viewportCameraChange",function(event,mode){event.stopPropagation(),setCameraMode(mode)}),scope.$on("viewportNavigationChange",function(event,mode){event.targetScope!==scope&&(event.stopPropagation(),setNavigationMode(mode,!1))}),$rootScope.$watch(function(){return webglInterface.vizSettings.opacitySelected},function(value){for(var i=0;i<selected.length;i++){var edges,mesh=selected[i];edges="plan"===mesh.userData.type?plans[mesh.id].edges:objects[mesh.id].edges,mesh.userData.modifiedMat||(mesh.material=mesh.material.clone(),mesh.material.transparent=!0,mesh.material.depthWrite=!1,mesh.material.needsUpdate=!0,edges.material=edges.material.clone(),edges.material.transparent=!0,edges.material.needsUpdate=!0,mesh.userData.modifiedMat=!0),mesh.material.opacity=value/100,edges.material.opacity=value/100}}),webglInterface.callFunc.setObjectOpacity=function(item,value){var mesh=objects[item.id].mesh,edges=objects[item.id].edges;"object"===item.type&&setOpacity(mesh,edges,value),item.opacity=value,function setChildrenOpacity(children,value){for(var i=0;i<children.length;i++){var cid=children[i].id,mesh=objects[cid].mesh,edges=objects[cid].edges;"object"===children[i].type&&setOpacity(mesh,edges,value),children[i].opacity=value,setChildrenOpacity(children[i].children,value)}}(item.children,value),animate()},scope.startMeasuring=function(){scope.setNavigationMode(),(measureTool=new DV3D.Measure(2)).addEventListener("change",animate),scene.add(measureTool),measureTool.onComplete=function(distance){scope.measureDistance=distance,scope.$applyAsync()}};var snapshotElement=null;function getScreenshot(){return{sData:renderer.domElement.toDataURL("image/jpeg"),cameraMatrix:camera.matrix.toArray(),cameraFOV:camera.fov,cameraCenter:controls.center.toArray(),width:SCREEN_WIDTH,height:SCREEN_HEIGHT}}function setSnapshotView(data){var camPos=new THREE.Vector3(data.cameraMatrix[12],data.cameraMatrix[13],data.cameraMatrix[14]),ctrlPos=(new THREE.Vector3).fromArray(data.cameraCenter);new TWEEN.Tween(camera.position.clone()).to(camPos,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){camera.position.copy(this)}).start(),new TWEEN.Tween(controls.center.clone()).to(ctrlPos,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){controls.center.copy(this)}).start(),camera.fov===data.cameraFOV&&new TWEEN.Tween({fov:camera.fov}).to({fov:data.cameraFOV},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){camera.fov=this.fov,camera.updateProjectionMatrix()}).start(),startAnimation()}function clearMarkers(){angular.forEach(SpatializeInterface.markers3D,function(marker){scene.remove(marker.object),marker.object.dispose()}),SpatializeInterface.markers3D.splice(0,SpatializeInterface.markers3D.length),render(),scope.$applyAsync()}if(scope.$on("snapshotViewScreen",function(event,screen,pins){if(!angular.element(element).find("viewport-snapshot-view").length){var elScope=scope.$new(!1);elScope.screen=screen,elScope.pins=pins,snapshotElement=$compile("<viewport-snapshot-view></viewport-snapshot-view>")(elScope),$animate.enter(snapshotElement,element),angular.element(element).find("viewport-navigation").attr("disabled",!0),setSnapshotView(screen)}}),scope.$on("snapshotViewClose",function(){scope.closeSnapshotView()}),scope.closeSnapshotView=function(){snapshotElement&&$animate.leave(snapshotElement),snapshotElement=null,angular.element(element).find("viewport-navigation").attr("disabled",!1)},scope.$on("snapshotStart",function(){if(!angular.element(element).find("viewport-snapshot").length){var elScope=scope.$new(!1);elScope.size={width:SCREEN_WIDTH,height:SCREEN_HEIGHT},elScope.getScreenshot=getScreenshot,elScope.startPinning=function(){setNavigationMode(),pin=new DV3D.Pin(3,.5),scene.add(pin),isPinning=!0},elScope.abortPinning=function(){isPinning=!1,setNavigationMode()},elScope.mousemovePinLayer=function(event){if(isPinning&&pin){var mouse=mouseToViewportCoords(event),testObjects=[];objects.forEach(function(obj){"object"===obj.type&&testObjects.push(obj.object)},!0);var intersection=raycast(mouse,testObjects);intersection?(pin.set(intersection),highlightObject(intersection.object)):(pin.set(),highlightObject()),animateThrottle20()}},elScope.mouseleavePinLayer=function(){isPinning&&pin&&(pin.set(),highlightObject(),animateAsync())},elScope.mouseupPinLayer=function(event){if(event.preventDefault(),isPinning&&pin&&0===event.button&&highlighted[0]){var obj=highlighted[0];-1===marked.indexOf(obj)&&(markObject(obj),object=objects.get(obj.id),pinMatrix=pin.matrixWorld.toArray(),$rootScope.$broadcast("snapshotPinSuccess",object,pinMatrix),animateThrottle20())}var object,pinMatrix},elScope.removeObjectFromMarked=function(obj){markObject(obj.object,!0),animateAsync()},snapshotElement=$compile("<viewport-snapshot></viewport-snapshot>")(elScope),$animate.enter(snapshotElement,element),angular.element(element).find("viewport-navigation").attr("disabled",!0)}}),scope.$on("snapshotEnd",function(){snapshotElement&&$animate.leave(snapshotElement),snapshotElement=null,angular.element(element).find("viewport-navigation").attr("disabled",!1),clearMarked(),animateAsync()}),scope.$on("snapshotViewStart",function(event,screenData){setSnapshotView(screenData)}),enableSpatializeManual){var spatializeManualElement=null;scope.$on("spatializeManualStart",function(event,src){if(!angular.element(element).find("viewport-spatialize-manual").length){var elScope=scope.$new(!1);elScope.source=src,spatializeManualElement=$compile("<viewport-spatialize-manual></viewport-spatialize-manual>")(elScope),$animate.enter(spatializeManualElement,element)}}),scope.closeSpatializeManual=function(){$animate.leave(spatializeManualElement),spatializeManualElement=null}}function loadSpatialImage(img,replace){if(!img.spatial)return $q.reject("No spatial information");var oldImg=spatialImages.getByName(img.content);if(oldImg&&replace)spatialImages.remove(oldImg),scene.remove(oldImg.object),oldImg.object.dispose();else if(oldImg&&!replace)return $q.reject("Already loaded");$log.debug(img);var defer=$q.defer(),imagepane=new DV3D.ImagePane("data/"+img.file.path+img.file.texture,{width:img.file.width,height:img.file.height,ck:img.spatial.ck,offset:img.spatial.offset,preview:"data/"+img.file.path+img.file.texturePreview},10);imagepane.onComplete=function(){animateAsync(),defer.resolve(entry)};var matrix=(new THREE.Matrix4).fromArray(img.spatial.matrix);imagepane.applyMatrix(matrix),scene.add(imagepane),imagepane.name=img.spatial.content,imagepane.userData.source=img,imagepane.userData.type="image";var entry=new DV3D.ImageEntry(imagepane,img.title);return entry.addEventListener("change",animateAsync),entry.addEventListener("toggle",toggleSourceHandler),entry.addEventListener("select",selectHandler),entry.addEventListener("focus",focusHandler),spatialImages.add(entry),$log.debug("ImagePane",imagepane),defer.promise}function setImageView(obj){var end=new THREE.Vector3(0,0,-100);end.applyQuaternion(obj.quaternion),end.add(obj.position),new TWEEN.Tween(camera.position.clone()).to(obj.position,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){camera.position.copy(this)}).start(),new TWEEN.Tween(controls.center.clone()).to(end,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){controls.center.copy(this)}).start(),new TWEEN.Tween({fov:camera.fov}).to({fov:obj.fov},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){camera.fov=this.fov,camera.updateProjectionMatrix()}).start(),startAnimation()}function viewOrthoPlan(obj){var pgeo=obj.mesh.geometry,matWorld=obj.mesh.matrixWorld,q=(new THREE.Quaternion).setFromRotationMatrix(matWorld),normal=new THREE.Vector3(pgeo.attributes.normal.array[0],pgeo.attributes.normal.array[1],pgeo.attributes.normal.array[2]).applyQuaternion(q),boundingBox=pgeo.boundingBox.clone().applyMatrix4(matWorld),aspect=SCREEN_WIDTH/SCREEN_HEIGHT,pwidth=Math.sqrt(Math.pow(boundingBox.max.x-boundingBox.min.x,2)+Math.pow(boundingBox.max.z-boundingBox.min.z,2))/2,pheight=(boundingBox.max.y-boundingBox.min.y)/2;(.707<normal.y||normal.y<-.707)&&(pwidth=Math.sqrt(Math.pow(boundingBox.max.x-boundingBox.min.x,2)+Math.pow(boundingBox.max.y-boundingBox.min.y,2))/2,pheight=(boundingBox.max.z-boundingBox.min.z)/2),aspect<pwidth/pheight&&(pheight=1/aspect*pwidth);var h=pheight/Math.tan(camera.fov/2*Math.PI/180),bsCenter=pgeo.boundingSphere.center.clone().applyMatrix4(matWorld),newpos=new THREE.Vector3;newpos.addVectors(bsCenter,normal.setLength(h)),new TWEEN.Tween(camera.position.clone()).to(newpos,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){camera.position.copy(this)}).start(),new TWEEN.Tween(controls.center.clone()).to(bsCenter,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){controls.center.copy(this)}).onComplete(function(){camera.toOrthographic(controls.center),webglInterface.viewportSettings.cameraSel="Custom",scope.$apply()}).start(),enableAnimationRequest()}function toggleSourceHandler(event){var target=event.target;if(event.visible){if(scene.getObjectById(target.object.id))return;scene.add(target.object)}else scene.remove(target.object),setSelected(target,!1,!0);animateAsync()}function setGizmo(obj,type,refs){switch(gizmo&&gizmo.attachToObject(null),type){case"move":gizmo=gizmoMove;break;case"rotate":gizmo=gizmoRotate;break;default:gizmo=null}gizmo&&gizmo.attachToObject(obj,refs)}function prepareMaterial(m){if(m.name in materials)return materials[m.name];var material=new THREE.MeshLambertMaterial;return material.name=m.id,Array.isArray(m.diffuse)?(material.color=new THREE.Color(m.diffuse[0],m.diffuse[1],m.diffuse[2]),material.color.convertLinearToGamma()):"string"==typeof m.diffuse&&textureLoader.load("data/"+m.path+m.diffuse,function(map){map.anisotropy=2,material.map=map,material.needsUpdate=!0,animateThrottle500()},null,function(xhr){$log.warn("Couldn't load texture",xhr.path[0].src)}),m.alpha&&textureLoader.load("data/"+m.path+m.alpha,function(map){material.alphaMap=map,material.transparent=!0,material.needsUpdate=!0,animateThrottle500()},null,function(xhr){$log.warn("Couldn't load texture",xhr.path[0].src)}),material.side=THREE.DoubleSide,materials[m.name]=material}function loadEdges(file){var defer=$q.defer();return JSZipUtils.getBinaryContent(file,function(err,data){err?defer.reject(err):JSZip.loadAsync(data).then(function(zip){return zip.file(/.+\.json$/i)[0].async("text")}).then(function(json){json=JSON.parse(json);var vertices=new Float32Array(json.data.attributes.position.array),geometry=new THREE.BufferGeometry;geometry.addAttribute("position",new THREE.BufferAttribute(vertices,3)),defer.resolve(geometry)}).catch(function(err){Utilities.throwException("JSZip Error","Failed to load or extract zip file.",err),defer.reject()})}),defer.promise}function toggleObjectHandler(event){var target=event.target,parent=target.parent?target.parent.object:scene;if(event.visible&&target.parent&&!target.parent.visible&&(target.parent.visible=!0,toggleObjectHandler({target:target.parent,visible:!0})),event.visible){if(parent.getObjectById(target.object.id))return;parent.add(target.object),viewportSettings.showEdges&&target.edges&&scene.add(target.edges)}else parent.remove(target.object),viewportSettings.showEdges&&target.edges&&scene.remove(target.edges),setSelected(target,!1,!0);animateAsync()}function focusHandler(event){if(event.target.object){var obj=event.target.object;obj instanceof DV3D.ImagePane?setImageView(obj):obj instanceof DV3D.Plan?viewOrthoPlan(obj):focusSelection([event.target])}}function selectHandler(event){setSelected(event.target,event.originalEvent.ctrlKey)}function focusSelection(array){if(!(array.length<1)){var cc=[];!function collectChildren(children){for(var i=0;i<children.length;i++)collectChildren(children[i].children),"object"!==children[i].type&&"plan"!==children[i].type||cc.push(children[i].object)}(array),focusObjects(cc)}}function focusAll(){var cc=[];objects.forEach(function(obj){"object"===obj.type&&cc.push(obj.object)},!0),cc.length<1||focusObjects(cc)}function focusObjects(objs){var xmin=0,xmax=0,ymin=0,ymax=0,zmin=0,zmax=0;objs.forEach(function(obj,index){obj.geometry.boundingBox||obj.geometry.computeBoundingBox();var bbmin=obj.geometry.boundingBox.min.clone().applyMatrix4(obj.matrixWorld),bbmax=obj.geometry.boundingBox.max.clone().applyMatrix4(obj.matrixWorld);if(0===index)return xmin=bbmin.x,ymin=bbmin.y,zmin=bbmin.z,xmax=bbmax.x,ymax=bbmax.y,void(zmax=bbmax.z);bbmin.x<xmin&&(xmin=bbmin.x),bbmin.y<ymin&&(ymin=bbmin.y),bbmin.z<zmin&&(zmin=bbmin.z),bbmax.x>xmax&&(xmax=bbmax.x),bbmax.y>ymax&&(ymax=bbmax.y),bbmax.z>zmax&&(zmax=bbmax.z)});var geo=new THREE.Geometry;geo.vertices.push(new THREE.Vector3(xmin,ymin,zmin)),geo.vertices.push(new THREE.Vector3(xmax,ymax,zmax)),geo.computeBoundingSphere();var near,far,s=(new THREE.Vector3).subVectors(camera.position,controls.center),h=geo.boundingSphere.radius/Math.tan(camera.fov/2*THREE.Math.DEG2RAD),newpos=(new THREE.Vector3).addVectors(geo.boundingSphere.center,s.setLength(h));near=geo.boundingSphere.radius/100,far=Math.max(100*geo.boundingSphere.radius,200),camera.cameraP.near=near,camera.cameraP.far=far,camera.updateProjectionMatrix(),scene.fog.near=camera.cameraP.far-camera.cameraP.far/10,scene.fog.far=camera.cameraP.far,new TWEEN.Tween(camera.position.clone()).to(newpos,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){camera.position.copy(this)}).start(),new TWEEN.Tween(controls.center.clone()).to(geo.boundingSphere.center,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){controls.center.copy(this)}).start(),startAnimation()}function resizeViewport(){SCREEN_WIDTH=element.width(),SCREEN_HEIGHT=element.height(),$log.debug("resize called",SCREEN_WIDTH,SCREEN_HEIGHT),camera.setSize(SCREEN_WIDTH,SCREEN_HEIGHT),camera.cameraP.updateProjectionMatrix(),renderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT),animate()}scope.setCameraFOV=function(value){return value&&(camera.fov=value,camera.updateProjectionMatrix(),animateThrottle20()),camera},scope.$on("spatialImageLoad",function(event,images){Array.isArray(images)?images.forEach(function(img){loadSpatialImage(img)}):loadSpatialImage(images)}),webglInterface.callFunc[cfId].setImageView=setImageView,scope.hud.spatialize&&(SpatializeInterface.callFunc[cfId].loadSpatializeImage=loadSpatializeImage,SpatializeInterface.callFunc[cfId].setImageView=setImageView,scope.spatialize={markers:SpatializeInterface.markers3D},scope.startMarking=function(){(currentMarker=new DV3D.TorusMarker(.5)).addEventListener("change",animate),scene.add(currentMarker)},scope.clearMarkers=clearMarkers),webglInterface.callFunc.load3DPlan=function(obj){if(!plans.getByName(obj.info.content)){var plan=new DV3D.Plan("data/"+obj.file.path+obj.file.content,"data/"+obj.info.materialMapPath+obj.info.materialMap,obj.info.scale);plan.onComplete=function(){animate()},scene.add(plan),plan.name=obj.info.content,plan.userData.name=obj.info.materialName,plan.userData.source=obj.source,plan.userData.type="plan";var entry=new DV3D.PlanEntry(plan);plan.entry=entry,plans.add(entry),console.log("Plan",plan)}},webglInterface.callFunc.viewOrthoPlan=viewOrthoPlan,webglInterface.callFunc.toggle=function(obj,visible){visible?scene.add(obj):scene.remove(obj),animateAsync()},scope.internalCallFunc=scope.callFunc||{},webglInterface.callFunc.getObjForPlans=function(meshId){if(plans.get(meshId)){for(var pgeo=plans.get(meshId).mesh.geometry,pMatrix=plans.get(meshId).mesh.matrixWorld,objs=[],facesLength=pgeo.index.count*pgeo.index.itemSize,i=0;i<facesLength;i+=3){for(var tg=new THREE.Geometry,j=0;j<3;j++){var index=pgeo.index.array[i+j]*pgeo.attributes.position.itemSize,v=new THREE.Vector3(pgeo.attributes.position.array[index],pgeo.attributes.position.array[index+1],pgeo.attributes.position.array[index+2]);tg.vertices.push(v)}tg.applyMatrix(pMatrix),tg.computeBoundingBox();var tm=new THREE.Mesh(tg,materials.defaultMat);for(var k in objects)"group"!=objects[k].mesh.userData.type&&overlapAABB(objects[k].mesh,tm)&&objs.push(objects[k].mesh.userData.eid);tg.dispose()}return{plan:plans.get(meshId).mesh.name,objs:objs}}},webglInterface.callFunc.highlightObjects=function(data){setSelected(null,!1,!0);for(var i=0;i<data.length;i++)for(var key in objects)objects[key].mesh.userData.eid===data[i].meshId&&(objects[key].mesh,setSelected(objects[key].mesh,!0));animate()},scope.$on("modelQuerySuccess",function(event,entries,keepScene){keepScene||function(){for(var key in setSelected(null),[].concat(objects.list).forEach(function(obj){obj.object.parent.remove(obj.object),obj.edges&&scene.remove(obj.edges),objects.remove(obj),obj.dispose()}),geometries)geometries.hasOwnProperty(key)&&-1===viewportCache.standardGeometries.indexOf(key)&&(geometries[key].mesh&&geometries[key].mesh.dispose(),geometries[key].edges&&geometries[key].edges.dispose(),delete geometries[key]);for(key in materials)materials.hasOwnProperty(key)&&-1===viewportCache.standardMaterials.indexOf(key)&&(materials[key].map&&materials[key].map.dispose(),materials[key].alphaMap&&materials[key].alphaMap.dispose(),materials[key].dispose(),delete materials[key]);animate()}(),ctmloader.manager.reset(),function loadHierarchyObjects(nodes){return nodes.reduce(function(promise,node){return promise.then(function(){return function(entry){var obj,defer=$q.defer();switch(entry.obj.type){case"group":obj=new THREE.Group;break;case"object":obj=new THREE.Mesh(geometries.initGeo,materials.defaultMat);break;default:return defer.reject("Unsupported type"),defer.promise}var matrix=new THREE.Matrix4;if(matrix.fromArray(entry.obj.matrix),"Z"===entry.obj.up&&!entry.parent){var yupMatrix=new THREE.Matrix4;yupMatrix.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),matrix.multiplyMatrices(yupMatrix,matrix)}var t=new THREE.Vector3,q=new THREE.Quaternion,s=new THREE.Vector3;matrix.decompose(t,q,s);var scale="number"==typeof entry.obj.unit?entry.obj.unit:1;entry.parent||(t.multiplyScalar(scale),s.multiplyScalar(scale)),matrix.compose(t,q,s),obj.applyMatrix(matrix),obj.matrixAutoUpdate=!1,obj.name=entry.obj.content,obj.userData.id=entry.obj.content,obj.userData.name=entry.obj.name,obj.userData.type=entry.obj.type,obj.userData.layer=entry.obj.layer;var parent=null;entry.parent&&(parent=scene.getObjectByName(entry.parent,!0)),parent?parent.add(obj):scene.add(obj);var objentry=new DV3D.ObjectEntry(obj);if(objentry.addEventListener("change",animateAsync),objentry.addEventListener("toggle",toggleObjectHandler),objentry.addEventListener("focus",focusHandler),objentry.addEventListener("select",selectHandler),objects.add(objentry),"object"===entry.obj.type){var geomId=Array.isArray(entry.file.content)?entry.file.content.reduce(function(acc,next){return acc+next}):entry.file.content;if(geomId in geometries&&ctmHandler(geometries[geomId].mesh),Array.isArray(entry.file.content)){var geoParts=[];entry.file.content.reduce(function(promise,file){return promise.then(function(){var deferGeo=$q.defer();return ctmloader.load("data/"+entry.file.path+file,function(geo){geoParts.push(geo),deferGeo.resolve()},{useWorker:!1}),deferGeo.promise})},$q.resolve()).then(function(){ctmHandler(geoParts)})}else ctmloader.load("data/"+entry.file.path+entry.file.content,ctmHandler,{useWorker:!1})}function ctmHandler(geometry){if(Array.isArray(geometry)){var geometryParts=geometry;(geometry=geometryParts[0]).clearGroups(),geometry.addGroup(0,geometry.index.count,0);for(var i=1;i<geometryParts.length;i++){geometry.merge(geometryParts[i]);var count=geometryParts[i].index.count;geometry.addGroup(geometry.index.count-count,count,i),geometryParts[i].dispose()}geometry.name||(geometry.name=entry.file.content.reduce(function(acc,next){return acc+next}))}else geometry.clearGroups(),geometry.addGroup(0,geometry.index.count,0),geometry.name||(geometry.name=entry.file.content);if(geometry.name in geometries||(geometries[geometry.name]={mesh:geometry}),geometry.computeBoundingBox(),obj.geometry=geometry,entry.materials&&Array.isArray(entry.materials)?1!==entry.materials.length?(obj.material=entry.materials.map(prepareMaterial),obj.userData.originalMat=entry.materials.map(function(m){return m.id})):(obj.material=prepareMaterial(entry.materials[0]),obj.userData.originalMat=entry.materials[0].id):(obj.material=materials.defaultDoublesideMat,obj.userData.originalMat="defaultDoublesideMat"),entry.file.edges&&!Array.isArray(entry.file.edges))loadEdges("data/"+entry.file.path+entry.file.edges).then(function(edgesGeo){var edges=new THREE.LineSegments(edgesGeo,materials.edgesMat);edges.matrix=obj.matrixWorld,edges.matrixAutoUpdate=!1,scene.add(edges),geometries[geometry.name].edges=edgesGeo,objentry.addEdges(edges),animateThrottle500()}).catch(function(err){err&&Utilities.throwException("Loading Error","Some error occurred while loading objects. See console for details.",err)});else if(entry.file.edges&&Array.isArray(entry.file.edges)){var edgesParts=[];entry.file.edges.reduce(function(promise,file){return promise.then(function(){return loadEdges("data/"+entry.file.path+file).then(function(edgesGeo){return edgesParts.push(edgesGeo),$q.resolve()})})},$q.resolve()).then(function(){for(var edgesGeo=edgesParts[0],i=1;i<edgesParts.length;i++)edgesGeo.merge(edgesParts[i]),edgesParts[i].dispose();var edges=new THREE.LineSegments(edgesGeo,materials.edgesMat);edges.matrix=obj.matrixWorld,edges.matrixAutoUpdate=!1,scene.add(edges),geometries[geometry.name].edges=edgesGeo,objentry.addEdges(edges),animateThrottle500()}).catch(function(err){err&&Utilities.throwException("Loading Error","Some error occurred while loading objects. See console for details.",err)})}animateThrottle500()}return defer.resolve(),defer.promise}(node)}).then(function(){return loadHierarchyObjects(node.children)})},$q.resolve())}(entries).then(function(){$log.debug("objects loaded")}).catch(function(err){Utilities.throwException("Loading Error","An error occurred while loading objects. See concole for details.",err)})}),scope.$on("categoryActivate",function(event,category){console.log(category),viewportSettings.shading="custom",category.attributes.forEach(function(attr){if(0!==attr.id&&-1!==attr.id){var cValues=attr.color.match(/\d+(\.\d+)?/g),mat=materials[attr.id];mat?mat.color.setRGB(parseInt(cValues[0])/255,parseInt(cValues[1])/255,parseInt(cValues[2])/255):mat=new THREE.MeshLambertMaterial({name:attr.id,color:new THREE.Color(parseInt(cValues[0])/255,parseInt(cValues[1])/255,parseInt(cValues[2])/255),side:THREE.DoubleSide});var opacity=parseFloat(cValues[3]);1!==opacity?(mat.transparent=!0,mat.opacity=opacity):mat.transparent=!1,materials[attr.id]=mat}}),angular.forEach(objects,function(obj){var userData=obj.mesh.userData;"object"===userData.type&&(userData.categories[category.id]&&userData.categories[category.id].attrId?obj.mesh.material=materials[userData.categories[category.id].attrId]:obj.mesh.material=materials.defaultDoublesideMat)}),animate()}),webglInterface.callFunc.addPin=function(id,pinObj){if(!pins[id]){var pos3D,v,left,top,pin=new DV3D.Pin(3,.5),m=pinObj.pinMatrix;return pin.applyMatrix((new THREE.Matrix4).set(m[0],m[4],m[8],m[12],m[1],m[5],m[9],m[13],m[2],m[6],m[10],m[14],m[3],m[7],m[11],m[15])),scene.add(pin),pins[id]=pin,animate(),pos3D=new THREE.Vector3(m[12],m[13],m[14]),v=pos3D.project(camera),left=SCREEN_WIDTH*(v.x+1)/2,top=SCREEN_HEIGHT*(1-v.y)/2,new THREE.Vector2(left,top)}},webglInterface.callFunc.removePin=function(id){pins[id]&&(scene.remove(pins[id]),pins[id].dispose(),delete pins[id]),animate()},webglInterface.callFunc.removePins=function(){for(var key in pins)scene.remove(pins[key]),pins[key].dispose();pins=[],animate()},webglInterface.callFunc.resize=function(){resizeViewport()},webglInterface.callFunc.explodePlans=function(){if(selected[0]&&"plan"===selected[0].userData.type){var basePlan=selected[0];console.log(basePlan);var offset={top:[],bottom:[],left:[],right:[]},baseNormal=new THREE.Vector3(basePlan.mesh.geometry.attributes.normal.array[0],basePlan.mesh.geometry.attributes.normal.array[1],basePlan.mesh.geometry.attributes.normal.array[2]).applyQuaternion(basePlan.quaternion).normalize(),baseBbox=basePlan.mesh.geometry.boundingBox.clone().applyMatrix4(basePlan.matrixWorld);plans.forEach(function(plan){if(plan.object.id!==basePlan.id){var p=plan.object,pNormal=new THREE.Vector3(p.mesh.geometry.attributes.normal.array[0],p.mesh.geometry.attributes.normal.array[1],p.mesh.geometry.attributes.normal.array[2]).applyQuaternion(p.quaternion).normalize(),pBbox=p.mesh.geometry.boundingBox.clone().applyMatrix4(p.matrixWorld),height=(new THREE.Vector3).subVectors(pBbox.max,pBbox.min).multiply(baseNormal).length(),distance=height/2+5,subMin=(new THREE.Vector3).subVectors(baseBbox.min,p.position),subMax=(new THREE.Vector3).subVectors(baseBbox.max,p.position);pNormal.dot(subMin)>pNormal.dot(subMax)?distance+=subMin.projectOnVector(pNormal).length():distance+=subMax.projectOnVector(pNormal).length();var arrange="",directionVector=new THREE.Vector3;if(.9<pNormal.x?(arrange="right",directionVector.set(1,0,0)):pNormal.x<-.9?(arrange="left",directionVector.set(-1,0,0)):.9<pNormal.z?(arrange="bottom",directionVector.set(0,0,1)):pNormal.z<-.9&&(arrange="top",directionVector.set(0,0,-1)),arrange){for(var i=0;i<offset[arrange].length;i++)distance+=offset[arrange][i].height+5;offset[arrange].push({name:p.name,height:height})}var startPosition=p.position.clone(),endPosition=p.position.clone().add((new THREE.Vector3).copy(pNormal).multiplyScalar(distance));endPosition.add((new THREE.Vector3).subVectors(baseBbox.min,endPosition).multiply(baseNormal));var startQuaternion=p.quaternion.clone(),theta=baseNormal.angleTo(pNormal),endQuaternion=p.quaternion.clone().multiply((new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(1,0,0),theta));new TWEEN.Tween({t:0}).to({t:1,p:endPosition},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){p.position.lerpVectors(startPosition,endPosition,this.t),THREE.Quaternion.slerp(startQuaternion,endQuaternion,p.quaternion,this.t)}).start()}},!0),enableAnimationRequest()}},webglInterface.callFunc.resetPlans=function(){plans.forEach(function(plan){var p=plan.object,t=new THREE.Vector3,q=new THREE.Quaternion,s=new THREE.Vector3;p.userData.initMatrix.decompose(t,q,s);var startPosition=p.position.clone(),startQuaternion=p.quaternion.clone();new TWEEN.Tween({t:0}).to({t:1},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){p.position.lerpVectors(startPosition,t,this.t),THREE.Quaternion.slerp(startQuaternion,q,p.quaternion,this.t)}).start()}),enableAnimationRequest()},webglInterface.callFunc.focusObject=function(id){var objs=[objects[id].mesh],cc=[];!function collectChildren(children){for(var i=0;i<children.length;i++)collectChildren(children[i].children),"object"===children[i].userData.type&&cc.push(children[i])}(objs),focusObjects(cc)},scope.$on("viewportFocusStart",function(event,mode){if(!camera.inOrthographicMode)switch(mode){case"selected":focusSelection(selected);break;default:focusAll()}}),scope.$on("$destroy",function(){setSelected(null,!1,!0),clearMarked(),scope.spatialize&&clearMarkers(),delete SpatializeInterface.callFunc[cfId],controls.dispose();var windowElement=angular.element($window);windowElement.off("keydown",keydown),windowElement.off("keyup",keyup),windowElement.off("resize",resizeViewport),objects.forEach(function(entry){entry.removeEventListener("change",animateAsync),entry.removeEventListener("toggle",toggleObjectHandler),entry.removeEventListener("focus",focusHandler),entry.removeEventListener("select",selectHandler)}),spatialImages.forEach(function(entry){entry.removeEventListener("change",animateAsync),entry.removeEventListener("toggle",toggleSourceHandler),entry.removeEventListener("focus",focusHandler),entry.removeEventListener("select",selectHandler)}),$log.debug("destroy viewport directive")})}}}]),angular.module("dokuvis.viewport").factory("viewportSettings",[function(){var shadings=[{value:"color",label:"Color"},{value:"grey",label:"Grey"},{value:"transparent",label:"Transparent"},{value:"onlyEdges",label:"Only edges"},{value:"xray",label:"X-Ray"},{value:"custom",label:"Custom"}],cameras=[{value:"perspective",label:"Perspective"},{value:"top",label:"Top"},{value:"front",label:"Front"},{value:"back",label:"Back"},{value:"left",label:"Left"},{value:"right",label:"Right"},{value:"custom",label:"Custom"}];return{defaults:{NEAR:1,FAR:4e3,initWidth:800,initHeight:600,backgroundColor:6710886,selectionColor:16535082,highlightColor:16777028,objectColor:14540253,edgeColor:3355443},shadings:shadings,cameras:cameras,shading:shadings[0].value,camera:cameras[0].value,showEdges:!0}}]).factory("viewportCache",["viewportSettings",function(viewportSettings){var scene=new THREE.Scene;scene.fog=new THREE.Fog(viewportSettings.defaults.backgroundColor,viewportSettings.defaults.FAR-100,viewportSettings.defaults.FAR),scene.add(new THREE.GridHelper(100,10)),scene.add(new THREE.AmbientLight(8947848));var directionalLight=new THREE.DirectionalLight(16777215,.7);directionalLight.position.set(-2,8,4),scene.add(directionalLight);var geometries={};geometries.initGeo=new THREE.Geometry;var materials={};materials.defaultMat=new THREE.MeshLambertMaterial({name:"defaultMat",color:DV3D.Defaults.objectColor}),materials.defaultDoublesideMat=new THREE.MeshLambertMaterial({name:"defaultDoublesideMat",color:DV3D.Defaults.objectColor,side:THREE.DoubleSide}),materials.defaultUnsafeMat=new THREE.MeshLambertMaterial({name:"defaultUnsafeMat",color:11184810,transparent:!0,opacity:.5,depthWrite:!1}),materials.selectionMat=new THREE.MeshLambertMaterial({name:"selectionMat",color:DV3D.Defaults.selectionColor,side:THREE.DoubleSide}),materials.transparentMat=new THREE.MeshLambertMaterial({name:"transparentMat",color:13421772,transparent:!0,opacity:.5,depthWrite:!1}),materials.transparentSelectionMat=new THREE.MeshLambertMaterial({name:"transparentSelectionMat",color:DV3D.Defaults.selectionColor,transparent:!0,opacity:.5,depthWrite:!1}),materials.wireframeMat=new THREE.MeshBasicMaterial({name:"wireframeMat",color:DV3D.Defaults.edgeColor,wireframe:!0}),materials.wireframeSelectionMat=new THREE.MeshBasicMaterial({name:"wireframeSelectionMat",color:DV3D.Defaults.selectionColor,wireframe:!0}),materials.highlightMat=new THREE.MeshLambertMaterial({name:"highlightMat",color:16777028}),materials.transparentHighlightMat=new THREE.MeshLambertMaterial({name:"transparentHighlightMat",color:16777028,transparent:!0,opacity:.5}),materials.xrayMat=new THREE.ShaderMaterial({name:"xrayMat",side:THREE.DoubleSide,transparent:!0,depthWrite:!1,depthTest:!1,uniforms:{ambient:{type:"f",value:.05},edgefalloff:{type:"f",value:.1},intensity:{type:"f",value:1},vColor:{type:"c",value:new THREE.Color(0)}},vertexShader:THREE.XRayShader.vertexShader,fragmentShader:THREE.XRayShader.fragmentShader}),materials.xraySelectionMat=new THREE.ShaderMaterial({name:"xraySelectionMat",side:THREE.DoubleSide,transparent:!0,depthWrite:!1,depthTest:!1,uniforms:{ambient:{type:"f",value:.05},edgefalloff:{type:"f",value:.3},intensity:{type:"f",value:1.5},vColor:{type:"c",value:new THREE.Color(DV3D.Defaults.selectionColor)}},vertexShader:THREE.XRayShader.vertexShader,fragmentShader:THREE.XRayShader.fragmentShader}),materials.edgesMat=new THREE.LineBasicMaterial({name:"edgesMat",color:DV3D.Defaults.edgeColor}),materials.edgesSelectionMat=new THREE.LineBasicMaterial({name:"edgesSelectionMat",color:DV3D.Defaults.selectionColor}),materials.edgesHighlightMat=new THREE.LineBasicMaterial({name:"edgesHighlightMat",color:16777028});var fontLoader=new THREE.FontLoader,fonts={};return fontLoader.load("fonts/helvetiker_bold.typeface.json",function(font){fonts.HelvetikerBold=font}),THREE.DokuVisTray={scene:scene,directionalLight:directionalLight,geometries:geometries,materials:materials,standardGeometries:Object.keys(geometries),standardMaterials:Object.keys(materials),fonts:fonts,objects:new DV3D.ObjectCollection,plans:new DV3D.Collection,spatialImages:new DV3D.Collection},THREE.DokuVisTray}]),angular.module("dokuvis.viewport").directive("viewportNavigation",["viewportSettings",function(viewportSettings){return{templateUrl:"components/dokuvis.viewport/viewportNavigation.tpl.34935434.html",restrict:"E",link:function(scope){var triggerCameraEvent=!0,triggerShadingEvent=!0;function setNavigationMode(mode,triggerEvent){scope.navigation.default=!1,scope.navigation.rotate=!1,scope.navigation.pan=!1,scope.navigation.zoom=!1,mode&&mode in scope.navigation?scope.navigation[mode]=!0:scope.navigation.default=!0,scope.$applyAsync(),!1!==triggerEvent&&function(mode){scope.$emit("viewportNavigationChange",mode)}(mode)}scope.navigation={default:!0,rotate:!1,pan:!1,zoom:!1},scope.shadings=viewportSettings.shadings,scope.cameras=viewportSettings.cameras,scope.vpSettings=viewportSettings,scope.focus=function(mode){!function(mode){scope.$emit("viewportFocusStart",mode)}(mode)},scope.setNavigationMode=setNavigationMode,scope.$on("viewportNavigationChange",function(event,mode){event.targetScope!==scope&&setNavigationMode(mode,!1)}),scope.$on("viewportShadingChange",function(event,mode,lastMode){event.targetScope!==scope&&mode!==lastMode&&(scope.vpSettings.shading=mode,triggerShadingEvent=!1)}),scope.$watch("vpSettings.shading",function(mode,lastMode){triggerShadingEvent?function(mode,lastMode){scope.$emit("viewportShadingChange",mode,lastMode)}(mode,lastMode):triggerShadingEvent=!0}),scope.$on("viewportCameraChange",function(event,mode,lastMode){event.targetScope!==scope&&mode!==lastMode&&(scope.vpSettings.camera=mode,triggerCameraEvent=!1)}),scope.$watch("vpSettings.camera",function(mode,lastMode){triggerCameraEvent?function(mode,lastMode){scope.$emit("viewportCameraChange",mode,lastMode)}(mode,lastMode):triggerCameraEvent=!0})}}}]).directive("viewportAxis",["$timeout",function($timeout){return{restrict:"E",link:function(scope,element){var renderer,camera,scene,axis;function render(){renderer.render(scene,camera)}$timeout(function(){var width,height;width=element.width(),height=element.height(),(renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0})).setSize(width,height),element.append(renderer.domElement),(camera=new THREE.OrthographicCamera(-width/2,width/2,height/2,-height/2,1,100)).position.set(0,0,50),axis=new THREE.AxisHelper(50),(scene=new THREE.Scene).add(axis),render()});var cleanOnCameraMove=scope.$on("viewportCameraMove",function(event,cam){camera.rotation.copy(cam.rotation),camera.position.copy(cam.getWorldDirection().negate().setLength(50)),render()});scope.$on("$destroy",function(){axis.geometry.dispose(),axis.material.dispose(),cleanOnCameraMove()})}}}]).directive("viewportLoadprogress",function(){return{template:'<div class="loadprogress-bar ng-hide" ng-show="visible" ng-style="{ width: progress + \'%\' }"></div>\n<div class="loadprogress-label ng-hide" ng-show="visible">{{ item }} &ndash; {{ loaded }} / {{ total }}</div>',restrict:"E",link:function(scope){scope.visible=!1,scope.item="",scope.loaded=0,scope.total=0,scope.progress=0;var cleanOnLoadProgress=scope.$on("viewportLoadProgress",function(event,item,loaded,total){scope.visible||(scope.progress=loaded/total*100,scope.visible=!0,scope.$apply()),scope.item=item,scope.loaded=loaded,scope.total=total,scope.progress=loaded/total*100,100===scope.progress&&(scope.visible=!1)});scope.$on("$destroy",function(){cleanOnLoadProgress()})}}}).directive("viewportSpatializeManual",["$rootScope","Utilities",function($rootScope,Utilities){return{templateUrl:"/components/dokuvis.viewport/viewportSpatializeManual.tpl.f504e035.html",restrict:"E",link:function(scope,element){var camera=null;scope.opacity=50,scope.fov=scope.setCameraFOV().fov,scope.$on("viewportCameraMove",function(event,cam){scope.fov=cam.fov,camera=cam}),scope.changeFOV=function(){camera=scope.setCameraFOV(scope.fov)},scope.save=function(){scope.source&&(scope.source.spatialize={matrix:camera.matrixWorld.toArray(),offset:[0,0],ck:1/Math.tan(camera.fov/2*THREE.Math.DEG2RAD)*.5},scope.source.$spatialize({method:"manual"}).then(function(result){console.log(result),scope.closeSpatializeManual()}).catch(function(reason){Utilities.throwApiException("#Source.spatialize",reason)}))},element.on("$destroy",function(){scope.$destroy()})}}}]).directive("viewportSnapshot",["$rootScope","$timeout",function($rootScope,$timeout){return{templateUrl:"components/dokuvis.viewport/viewportSnapshot.tpl.555d36c3.html",restrict:"E",link:function(scope,element){function getPainting(){return element.find("#pwCanvasMain")[0].toDataURL("image/png")}scope.mode="paint",scope.paintOptions={opacity:1,color:"rgba(255,255,0,1.0)",backgroundColor:"rgba(255,255,255,0.0)",lineWidth:3,undo:!0,imageSrc:!1,width:scope.size.width,height:scope.size.height},scope.setMode=function(mode){"pin"===(scope.mode=mode)?scope.startPinning():scope.abortPinning()},$timeout(function(){$rootScope.$broadcast("snapshotSyncViewport",{getPainting:getPainting,getScreenshot:scope.getScreenshot,removeObjectFromMarked:scope.removeObjectFromMarked})},1e3),element.on("$destroy",function(){scope.$destroy()})}}}]).directive("viewportSnapshotView",function(){return{templateUrl:"components/dokuvis.viewport/viewportSnapshotView.tpl.829379c3.html",restrict:"E",link:function(scope,element){scope.screenOpacity=0,scope.paintOpacity=1,element.on("$destroy",function(){scope.$destroy()})}}}),angular.module("dokuvis.viewport").directive("viewportObjectTree",["viewportCache",function(viewportCache){return{templateUrl:"components/dokuvis.viewport/viewportObjectTree.tpl.03bd6b80.html",restrict:"E",link:function(scope){scope.objects=viewportCache.objects,scope.layers=viewportCache.objects.layers,scope.hierarchy=viewportCache.objects.hierarchy,scope.showLayers=!1,scope.showHierarchy=!0,scope.switchTo=function(type){switch(type){case"layers":scope.showLayers=!0,scope.showHierarchy=!1;break;default:scope.showLayers=!1,scope.showHierarchy=!0}}}}}]).directive("viewportPlanList",["viewportCache",function(viewportCache){return{templateUrl:"components/dokuvis.viewport/viewportPlanList.tpl.df662432.html",restrict:"E",link:function(scope){scope.plans=viewportCache.plans}}}]).directive("viewportImageList",["viewportCache",function(viewportCache){return{templateUrl:"components/dokuvis.viewport/viewportImageList.tpl.18bd03f3.html",restrict:"E",link:function(scope){scope.images=viewportCache.spatialImages}}}]),angular.module("dokuvis.imageViewer",[]).directive("imageViewer",["$document","$window","$timeout","SpatializeInterface","$debounce","$log",function($document,$window,$timeout,SpatializeInterface,$debounce,$log){return{restrict:"E",scope:{source:"=src",options:"=options"},link:function(scope,element,attrs){angular.element(element).css("overflow","hidden"),"spatialize"in attrs&&(scope.spatialize={markers:SpatializeInterface.markers2D});var SCREEN_WIDTH,SCREEN_HEIGHT,imageAspect,canvasAspect,angleX,angleY,scene,renderer,camera,canvas,plane,currentMarker,currentUV,readyViewer=!1,readyTexture=!1,readyAll=!1,isPanning=!1,isMarking=!1,panSpeed=.0015,zoomSpeed=.1,maxZoomIn=-.05,maxZoomOut=-1,loader=new THREE.TextureLoader;function resizeHandler(){scope.$applyAsync()}$document.on("mouseup",mouseup),angular.element($window).on("resize",resizeHandler);var resizeDebounce=$debounce(function(){resizeViewer()},200,!1,!1);function loadTexture(url){-1!==["jpg","png"].indexOf(url.split(".").pop())&&(readyTexture=!0,console.log("source:",url),readyViewer&&(readyAll||(scene.add(plane),readyAll=!0),loader.load(url,function(texture){imageAspect=scope.options&&scope.options.width&&scope.options.height?scope.options.width/scope.options.height:texture.image.width/texture.image.height,scope.spatialize&&(SpatializeInterface.imageWidth=scope.options.width||texture.image.width,SpatializeInterface.imageHeight=scope.options.height||texture.image.height),plane.geometry.dispose(),plane.geometry=new THREE.PlaneBufferGeometry(imageAspect,1,1,1),plane.material.map&&plane.material.map.dispose(),plane.material.map=texture,plane.material.needsUpdate=!0,resetView()},null,function(){console.error("ImageViewer: Couldn't load texture!")})))}function render(){renderer.render(scene,camera)}function mousedown(event){event.preventDefault(),(0===event.button&&!isMarking||1===event.button)&&(isPanning=!0)}function mouseup(event){if(!isPanning||0!==event.button&&1!==event.button){if(0===event.button&&isMarking){var uv=currentUV;currentMarker.setNumber(SpatializeInterface.markers2D.length+1),SpatializeInterface.markers2D.push({object:currentMarker,u:uv.x,v:uv.y,x:(uv.x-.5)*imageAspect,y:uv.y-.5}),isMarking=!1,currentMarker=null,render(),scope.$applyAsync()}}else isPanning=!1}function mousemove(event){if(event.preventDefault(),isPanning)plane.translateX(event.originalEvent.movementX*panSpeed*-plane.position.z),plane.translateY(event.originalEvent.movementY*panSpeed*plane.position.z),fitToBorders(),render();else if(isMarking){var mouse=new THREE.Vector2;mouse.x=event.offsetX/SCREEN_WIDTH*2-1,mouse.y=-event.offsetY/SCREEN_HEIGHT*2+1,function(mouse){var vector=new THREE.Vector3(mouse.x,mouse.y,.5).unproject(camera),intersects=new THREE.Raycaster(camera.position,vector.sub(camera.position).normalize()).intersectObject(plane);if(intersects[0]){var uv=intersects[0].uv;currentUV=uv,currentMarker.position.set(uv.x*imageAspect-imageAspect/2,uv.y-.5,0)}}(mouse),render()}}function zoom(event){if(0<event.deltaY){var delta=-zoomSpeed*plane.position.z;if(plane.position.z+delta>maxZoomIn)return;plane.translateZ(delta),fitToBorders(),render()}else event.deltaY<0&&(delta=zoomSpeed*plane.position.z,plane.position.z+delta<=maxZoomOut&&(delta=maxZoomOut-plane.position.z),plane.translateZ(delta),fitToBorders(),render())}function fitToBorders(){var xa=Math.abs(plane.position.z)*Math.tan(angleX),ya=Math.abs(plane.position.z)*Math.tan(angleY),cWidth=2*xa,cHeight=2*ya,iWidth=Math.abs(plane.position.x-imageAspect/2)+Math.abs(plane.position.x+imageAspect/2),iHeight=Math.abs(plane.position.y-.5)+Math.abs(plane.position.y+.5);imageAspect<canvasAspect&&iWidth<cWidth?(xa<plane.position.x+imageAspect/2&&plane.translateX(xa-(plane.position.x+imageAspect/2)),-xa>plane.position.x-imageAspect/2&&plane.translateX(-xa-(plane.position.x-imageAspect/2))):(xa>plane.position.x+imageAspect/2&&plane.translateX(xa-(plane.position.x+imageAspect/2)),-xa<plane.position.x-imageAspect/2&&plane.translateX(-xa-(plane.position.x-imageAspect/2))),canvasAspect<imageAspect&&iHeight<cHeight?(ya<plane.position.y+.5&&plane.translateY(ya-(plane.position.y+.5)),-ya>plane.position.y-.5&&plane.translateY(-ya-(plane.position.y-.5))):(ya>plane.position.y+.5&&plane.translateY(ya-(plane.position.y+.5)),-ya<plane.position.y-.5&&plane.translateY(-ya-(plane.position.y-.5)))}function resetView(){if(imageAspect<canvasAspect)plane.position.set(0,0,-1),maxZoomOut=-1;else{var z=imageAspect/2/Math.tan(angleX);plane.position.set(0,0,-z),maxZoomOut=-z}render()}function clearMarkers(){angular.forEach(SpatializeInterface.markers2D,function(marker){plane.remove(marker.object),marker.object.dispose()}),SpatializeInterface.markers2D.splice(0,SpatializeInterface.markers2D.length),render(),scope.$applyAsync()}function resizeViewer(width,height){SCREEN_WIDTH=width||element.width(),SCREEN_HEIGHT=height||element.height(),canvasAspect=SCREEN_WIDTH/SCREEN_HEIGHT,angleX=Math.atan(.5*canvasAspect),angleY=Math.atan(.5);var doResetView=plane&&plane.position.z===maxZoomOut;maxZoomOut=imageAspect&&canvasAspect<imageAspect?-imageAspect/2/Math.tan(angleX):-1,camera&&(camera.aspect=canvasAspect,camera.updateProjectionMatrix()),renderer&&(renderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT),plane&&doResetView?resetView():render())}scope.$watch(function(){resizeDebounce()}),scope.$watch("source",loadTexture),$timeout(function(){resizeViewer(),function(){scene=new THREE.Scene,(renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0})).setClearColor(16777215,0),renderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT),element.append(renderer.domElement),(camera=new THREE.PerspectiveCamera(2*angleY*180/Math.PI,canvasAspect,.01,500)).lookAt(new THREE.Vector3(0,0,-1));var pGeo=new THREE.PlaneBufferGeometry(1,1,1,1),pMat=new THREE.MeshBasicMaterial;(plane=new THREE.Mesh(pGeo,pMat)).position.set(0,0,-1),(canvas=angular.element(renderer.domElement)).on("mousedown",mousedown),canvas.on("mousemove",mousemove),canvas.on("mousewheel",zoom),canvas.on("DOMMouseScroll",zoom),canvas.on("contextmenu",function(event){event.preventDefault()}),readyViewer=!0,render()}(),readyTexture&&loadTexture(scope.source)}),scope.spatialize&&(scope.startMarking=function(){(currentMarker=new DV3D.TorusMarker(.008)).addEventListener("change",render),plane.add(currentMarker),isMarking=!0},scope.clearMarkers=clearMarkers),scope.$on("$destroy",function(){plane&&(plane.geometry.dispose(),plane.material.map&&plane.material.map.dispose(),plane.material.dispose()),renderer&&renderer.dispose(),scope.spatialize&&clearMarkers(),$document.off("mouseup",mouseup),angular.element($window).off("resize",resizeHandler),$log.debug("destroy imageViewer directive")})}}}]),angular.module("dokuvisApp").directive("graphSearch",["$state","$stateParams","GraphVis","CidocDict","Utilities","$compile",function($state,$stateParams,GraphVis,CidocDict,Utilities,$compile){return{restrict:"A",templateUrl:"app/directives/graphSearch/graphSearch.html",link:function(scope,element,attrs){scope.nodeTransparency=50;var history=[],historyIndex=0,stateForward=!1,graph=new function(){var link,node,fixedNodes=[],width=element.width(),height=element.height(),centerPos=new THREE.Vector2(width/2,height/2),clickPos=new THREE.Vector2(width/2-10,height/2),force=d3.layout.force().size([width,height]).charge(-2e3).friction(.7).gravity(.08).linkDistance(200).linkStrength(.5),nodes=force.nodes(),links=force.links(),drag=force.drag().on("dragstart",dragstart),svg=d3.select(element[0]).append("svg").attr("width",width).attr("height",height);function tick(){link.select(".linkPath").attr("d",function(d){return"M"+d.source.x+" "+d.source.y+"L"+d.target.x+" "+d.target.y}),link.select(".textPath").attr("d",function(d){return d.source.x<d.target.x?"M"+d.source.x+" "+d.source.y+"L"+d.target.x+" "+d.target.y:"M"+d.target.x+" "+d.target.y+"L"+d.source.x+" "+d.source.y}),node.attr("transform",function(d){return"translate("+d.x+","+d.y+")"})}function dragstart(d){d3.select(this).classed("fixed",d.fixed=!0),scope.selectedNode=d,-1===fixedNodes.indexOf(d.id)&&fixedNodes.push(d.id),fixLinks(),scope.$apply()}function fixLinks(){for(var i=0;i<links.length;i++){var link=links[i];-1!==fixedNodes.indexOf(link.source.id)&&-1!==fixedNodes.indexOf(link.target.id)?d3.select("#link"+link.id).classed("opaque",!0):d3.select("#link"+link.id).classed("opaque",!1)}}function onMouseover(d){d3.select(this).select("circle").attr("fill",d3.rgb(CidocDict.getNodeColor(d.labels[0])).darker(.2));for(var i=0;i<links.length;i++){var link=links[i];d.id!==link.source.id&&d.id!==link.target.id||(d3.select("#node"+link.source.id).classed("highlight",!0),d3.select("#node"+link.target.id).classed("highlight",!0),d3.select("#link"+link.id).classed("highlight",!0))}}function onMouseleave(d){d3.select(this).select("circle").attr("fill",d3.rgb(CidocDict.getNodeColor(d.labels[0]))),d3.selectAll(".node").classed("highlight",!1),d3.selectAll(".link").classed("highlight",!1)}function onContextmenu(d){d3.event.preventDefault(),d3.select(this).classed("fixed",d.fixed=!1),fixedNodes.splice(fixedNodes.indexOf(d.id),1),fixLinks()}function getNodeText(d){var text=d.properties[CidocDict.getNodePropertyName(d.labels[0])]||d.properties.content;return 20<text.length?text.substring(0,20)+"...":text}function getBBox(selection,bbox){selection.each(function(d){d[bbox]=this.getBBox()})}svg.append("defs").append("marker").attr({id:"arrow",viewBox:"0 -5 10 10",refX:35,refY:0,markerWidth:10,markerHeight:10,orient:"auto"}).append("path").attr("class","arrowHead").attr("d","M0,-5L10,0L0,5"),this.update=function(){var gLink=(link=svg.selectAll(".link").data(links)).enter().insert("g","g.node").attr("class","link").attr("ng-style","{opacity: nodeTransparency / 100}").attr("id",function(d){return"link"+d.id}).call(function(){$compile(this[0].parentNode)(scope)});gLink.append("path").attr("class","linkPath").attr("marker-end","url(#arrow)"),gLink.append("path").attr("class","textPath").attr("id",function(d){return"linkId_"+d.id}),gLink.append("text").attr("class","linkLabel").attr("text-anchor","middle").append("textPath").attr("xlink:href",function(d){return"#linkId_"+d.id}).attr("startOffset","50%").text(function(d){return CidocDict.getPropertyName(d.type)}),link.exit().remove();var gNode=(node=svg.selectAll(".node").data(nodes)).enter().append("g").attr("class","node").attr("ng-style","{opacity: nodeTransparency / 100}").attr("id",function(d){return"node"+d.id}).on("mouseover",onMouseover).on("mouseleave",onMouseleave).on("dblclick",this.onDblclick).on("contextmenu",onContextmenu).call(drag).call(function(){$compile(this[0].parentNode)(scope)});gNode.append("circle").attr("class","nodeChild").attr("fill",function(d){return CidocDict.getNodeColor(d.labels[0])}).attr("r",25),gNode.append("text").attr("text-anchor","middle").attr("dy","-.5em").attr("class","title").text(function(d){return CidocDict.getClassName(d.labels[0])}).call(getBBox,"bbox1"),gNode.insert("rect","text").attr("class","bg-text").attr("x",function(d){return d.bbox1.x}).attr("y",function(d){return d.bbox1.y}).attr("width",function(d){return d.bbox1.width}).attr("height",function(d){return d.bbox1.height}),gNode.append("text").attr("class","caption").attr("text-anchor","middle").attr("dy",".75em"),gNode.insert("rect","text").attr("class","bg-text bg-caption"),gNode.append("title").text(function(d){return d.properties.content}),node.exit().remove(),node.select(".caption").text(getNodeText).call(getBBox,"bbox2"),node.select(".bg-caption").attr("x",function(d){return d.bbox2.x}).attr("y",function(d){return d.bbox2.y}).attr("width",function(d){return d.bbox2.width}).attr("height",function(d){return d.bbox2.height}),force.drag().on("dragstart",dragstart),force.on("tick",tick),force.start()},this.getData=function(){return{nodes:nodes,links:links}},this.addNode=function(node){if(void 0===this.findNode(node.id)){var newPos=function(){var newPos=(new THREE.Vector2).subVectors(clickPos,centerPos);return newPos.setLength(200*Math.random()+100),newPos.rotateAround(new THREE.Vector2,Math.random()*Math.PI-Math.PI/2),newPos.add(clickPos)}();return console.log(newPos),node.x=newPos.x,node.y=newPos.y,nodes.push(node),history[historyIndex].nodes.push(node.id),!0}return!1},this.addLink=function(link){return void 0===this.findLink(link.id)&&(link.source||(link.source=this.findNode(link.startNode)),link.target||(link.target=this.findNode(link.endNode)),links.push(link),!0)},this.removeNode=function(nodeId){for(var i=0;i<nodes.length;i++)if(nodes[i].id===nodeId)return nodes.splice(i,1),!0;return!1},this.removeLink=function(linkId){for(var i in links)if(links[i].id===linkId)return links.splice(i,1),!0;return!1},this.findNode=function(id){for(var i in nodes)if(nodes[i].id===id)return nodes[i]},this.findLink=function(id){for(var i in links)if(links[i].id===id)return links[i]},this.findLinkByType=function(type,node){for(var i in links)if((links[i].source===node||links[i].target===node)&&links[i].type===type)return links[i]},this.findLinkByNodeId=function(nodeId){for(var i in links)if(links[i].source.id===nodeId||links[i].target.id===nodeId)return links[i]},this.setClickPosition=function(d){clickPos.set(d.x,d.y)}},waitingForUpdate=0;function getNodeNeighbours(id){waitingForUpdate++,GraphVis.getNodeNeighbours(id).then(function(response){if(response.data.results[0]){var data=response.data.results[0].data;console.log(data);for(var newNodes=0,newLinks=0,i=0;i<data.length;i++){for(var dataNodes=data[i].graph.nodes,dataLinks=data[i].graph.relationships,j=0;j<dataNodes.length;j++)graph.addNode(dataNodes[j])&&newNodes++;for(j=0;j<dataLinks.length;j++){var link=dataLinks[j],endNodeId=+link.startNode===id?link.endNode:link.startNode,endNode=graph.findNode(endNodeId);callRule(endNode.labels[0],endNode),callRule(link.type+"-"+endNode.labels[0],endNode,link)?newNodes--:graph.addLink(link)&&newLinks++}}waitingForUpdate--,(newNodes||newLinks)&&(0===waitingForUpdate&&graph.update(),scope.selectedNode||(scope.selectedNode=graph.findNode($stateParams.startNode))),console.log(graph.getData())}},function(err){Utilities.throwApiException("on GraphVis.getNodeNeighbours()",err)})}function callRule(key,node,link){return key in rules?rules[key](node,link):null}graph.onDblclick=function(d){graph.setClickPosition(d),stateForward=!0,$state.go("project.graph.node",{startNode:d.id})},$stateParams.startNode&&(history.push({stateNode:$stateParams.startNode,nodes:[]}),getNodeNeighbours(+$stateParams.startNode)),scope.$on("$stateChangeSuccess",function(event,toState,toParams){if(console.log("graph state changed",toParams),toParams.startNode&&stateForward)history.push({stateNode:toParams.startNode,nodes:[]}),historyIndex++,getNodeNeighbours(+toParams.startNode);else if(toParams.startNode&&!stateForward&&0<historyIndex){for(var i=0;i<history[historyIndex].nodes.length;i++){var nodeId=history[historyIndex].nodes[i];if(graph.findNode(nodeId)){for(var link;link=graph.findLinkByNodeId(nodeId);)graph.removeLink(link.id);graph.removeNode(nodeId),graph.update()}}history.splice(historyIndex,1),historyIndex--}stateForward=!1});var rules={};function getTitle(node,label,property){waitingForUpdate++,GraphVis.getNodeTitle(node.id,label).then(function(response){node.properties.title=response.data[property]||response.data.content,0==--waitingForUpdate&&graph.update()},function(err){Utilities.throwApiException("on GraphVis.getNodeTitle()",err)})}function setTitle(startNode,endNode,property){startNode.properties.title=endNode.properties[property]||endNode.properties.content,graph.removeNode(endNode.id)}rules.E21=function(node){node.properties.title||getTitle(node,"E82","value")},rules.E22=function(node){node.properties.title||(waitingForUpdate++,GraphVis.getE22Name(+node.id).then(function(response){console.log(response),node.properties.title=response.data.name||response.data.content,0==--waitingForUpdate&&graph.update()},function(err){Utilities.throwApiException("on GraphVis.getE22Name()",err)}))},rules.E31=function(node){getTitle(node,"E35","content")},rules.E40=function(node){getTitle(node,"E82","content")},rules.E52=function(node){getTitle(node,"E61","value")},rules.E53=function(node){getTitle(node,"E48","content")},rules.E78=function(node){getTitle(node,"E41","content")},rules["P1-E41"]=function(endNode,link){return graph.removeNode(endNode.id),!0},rules["P1-E75"]=function(endNode,link){return graph.removeNode(endNode.id),!0},rules["P82-E61"]=function(endNode,link){return setTitle(graph.findNode(link.startNode),endNode,"value"),!0},rules["P102-E35"]=function(endNode,link){return setTitle(graph.findNode(link.startNode),endNode,"content"),!0},rules["P131-E82"]=function(endNode,link){return setTitle(graph.findNode(link.startNode),endNode,"value"),!0},rules["P129-E33"]=function(node,link){waitingForUpdate++,GraphVis.getNodeNeighbours(+node.id).then(function(response){if(response.data.results[0]){for(var data=response.data.results[0].data,i=0;i<data.length;i++){for(var dataNodes=data[i].graph.nodes,dataLinks=data[i].graph.relationships,j=0;j<dataNodes.length;j++)graph.addNode(dataNodes[j]);for(j=0;j<dataLinks.length;j++){var link=dataLinks[j],endNodeId=link.startNode===node.id?link.endNode:link.startNode,endNode=graph.findNode(endNodeId);callRule(endNode.labels[0],endNode),graph.addLink(link)}}var linkP3=graph.findLinkByType("P3",node);linkP3&&(node.properties.value=linkP3.target.properties.value,graph.removeNode(linkP3.target.id),graph.removeLink(linkP3.id),0==--waitingForUpdate&&graph.update())}},function(err){Utilities.throwApiException("on GraphVis.getNodeNeighbours()",err)})},rules.E65=function(node){waitingForUpdate++,GraphVis.getNodeNeighbours(+node.id).then(function(response){if(response.data.results[0]){var data=response.data.results[0].data;console.log(data);for(var i=0;i<data.length;i++){for(var dataNodes=data[i].graph.nodes,dataLinks=data[i].graph.relationships,j=0;j<dataNodes.length;j++)graph.addNode(dataNodes[j]);for(j=0;j<dataLinks.length;j++){var link=dataLinks[j],endNodeId=link.startNode===node.id?link.endNode:link.startNode,endNode=graph.findNode(endNodeId);callRule(endNode.labels[0],endNode),graph.addLink(link)}}var linkP94=graph.findLinkByType("P94",node),linkP14=graph.findLinkByType("P14",node),linkP4=graph.findLinkByType("P4",node),linkP7=graph.findLinkByType("P7",node);linkP94&&linkP14&&graph.addLink({id:linkP94.id+linkP14.id,type:"P14a",startNode:linkP94.target.id,source:linkP94.target,endNode:linkP14.target.id,target:linkP14.target}),linkP94&&linkP4&&graph.addLink({id:linkP94.id+linkP4.id,type:"P4a",startNode:linkP94.target.id,source:linkP94.target,endNode:linkP4.target.id,target:linkP4.target}),linkP94&&linkP7&&graph.addLink({id:linkP94.id+linkP7.id,type:"P7a",startNode:linkP94.target.id,source:linkP94.target,endNode:linkP7.target.id,target:linkP7.target}),linkP94&&graph.removeLink(linkP94.id),linkP14&&graph.removeLink(linkP14.id),linkP4&&graph.removeLink(linkP4.id),linkP7&&graph.removeLink(linkP7.id),graph.removeNode(node.id),0==--waitingForUpdate&&graph.update(),console.log(graph.getData())}},function(err){Utilities.throwApiException("on GraphVis.getNodeNeighbours()",err)})},rules.E84=function(node){waitingForUpdate++,GraphVis.getNodeNeighbours(+node.id).then(function(response){if(response.data.results[0]){var data=response.data.results[0].data;console.log(data);for(var i=0;i<data.length;i++){for(var dataNodes=data[i].graph.nodes,dataLinks=data[i].graph.relationships,j=0;j<dataNodes.length;j++)graph.addNode(dataNodes[j]);for(j=0;j<dataLinks.length;j++){var link=dataLinks[j],endNodeId=link.startNode===node.id?link.endNode:link.startNode,endNode=graph.findNode(endNodeId);callRule(endNode.labels[0],endNode),graph.addLink(link)}}var linkP128=graph.findLinkByType("P128",node),linkP46=graph.findLinkByType("P46",node);linkP128&&linkP46&&graph.addLink({id:linkP128.id+linkP46.id,type:"P128a",startNode:linkP128.target.id,source:linkP128.target,endNode:linkP46.source.id,target:linkP46.source}),linkP128&&graph.removeLink(linkP128.id),linkP46&&graph.removeLink(linkP46.id),graph.removeNode(node.id),0==--waitingForUpdate&&graph.update(),console.log(graph.getData())}},function(err){Utilities.throwApiException("on GraphVis.getNodeNeighbours()",err)})},rules["P70-E33"]=function(node){waitingForUpdate++,GraphVis.getNodeNeighbours(+node.id).then(function(response){if(response.data.results[0]){var data=response.data.results[0].data;console.log(data);for(var i=0;i<data.length;i++){for(var dataNodes=data[i].graph.nodes,dataLinks=data[i].graph.relationships,j=0;j<dataNodes.length;j++)graph.addNode(dataNodes[j]);for(j=0;j<dataLinks.length;j++){var link=dataLinks[j],endNodeId=link.startNode===node.id?link.endNode:link.startNode,endNode=graph.findNode(endNodeId);callRule(endNode.labels[0],endNode),graph.addLink(link)}}var linkP70=graph.findLinkByType("P70",node),linkP72=graph.findLinkByType("P72",node);linkP70&&linkP72&&graph.addLink({id:linkP70.id+linkP72.id,type:"P72a",startNode:linkP70.source.id,source:linkP70.source,endNode:linkP72.target.id,target:linkP72.target}),linkP70&&graph.removeLink(linkP70.id),linkP72&&graph.removeLink(linkP72.id),graph.removeNode(node.id),0==--waitingForUpdate&&graph.update(),console.log(graph.getData())}},function(err){Utilities.throwApiException("on GraphVis.getNodeNeighbours()",err)})}}}}]),angular.module("dokuvisApp").directive("ngThumb",["$window",function($window){var helper_support=!(!$window.FileReader||!$window.CanvasRenderingContext2D),helper_isFile=function(item){return angular.isObject(item)&&item instanceof $window.File},helper_isImage=function(file){var type="|"+file.type.slice(file.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(type)};return{restrict:"A",template:"<canvas/>",link:function(scope,element,attributes){if(helper_support){var params=scope.$eval(attributes.ngThumb);if(helper_isFile(params.file)&&helper_isImage(params.file)){var canvas=element.find("canvas"),reader=new FileReader;reader.onload=function(event){var img=new Image;img.onload=onLoadImage,img.src=event.target.result},reader.readAsDataURL(params.file)}}function onLoadImage(){var width=params.width||this.width/this.height*params.height,height=params.height||this.height/this.width*params.width;canvas.attr({width:width,height:height}),canvas[0].getContext("2d").drawImage(this,0,0,width,height)}}}}]),angular.module("dokuvisApp").directive("rampSlider",["$document","$throttle",function($document,$throttle){return{require:"ngModel",template:"<div ng-style=\"{width: rsModel*100+'%'}\"></div>",link:function(scope,element,attrs,ngModelCtrl){var colorStart=attrs.rsColor||"#aaa",colorEnd=attrs.rsColorEnd||colorStart,rampSliderMousemove=$throttle(function(event){applyChange(event)},100);function rampSliderMouseup(event){applyChange(event),$document.off("mousemove",rampSliderMousemove),$document.off("mouseup",rampSliderMouseup)}function applyChange(event){scope.rsModel=parseFloat(((event.pageX-element.offset().left)/element[0].offsetWidth).toFixed(2)),.9<scope.rsModel?scope.rsModel=1:scope.rsModel<.1&&(scope.rsModel=0),ngModelCtrl.$setViewValue(scope.rsModel)}element.css("position","relative"),element.find("div").css({position:"absolute",top:0,bottom:0,background:"linear-gradient(to right, "+colorStart+", "+colorEnd+")"}),element.on("mousedown",function(event){event.preventDefault(),$document.on("mousemove",rampSliderMousemove),$document.on("mouseup",rampSliderMouseup)}),scope.$watch(function(){return ngModelCtrl.$modelValue},function(newValue){scope.rsModel=newValue})}}}]),angular.module("dokuvisApp").controller("navCtrl",["$scope","$state","UserAuthFactory","Utilities",function($scope,$state,UserAuthFactory,Utilities){$scope.user={email:"",password:""},$scope.login=function(){var email=$scope.user.email,password=$scope.user.password;0!==email.length?0!==password.length?UserAuthFactory.login(email,password).then(function(){$state.go("root.projectlist")}).catch(function(err){Utilities.throwException("Login","failed",err)}):Utilities.dangerAlert("Ungültiges Passwort!"):Utilities.dangerAlert("Ungültige Emailadresse!")},$scope.logout=function(){UserAuthFactory.logout(),$state.go("root.home",{},{reload:!0})}}]),angular.module("dokuvisApp").controller("registerCtrl",["$scope","$state","UserAuthFactory","Utilities",function($scope,$state,UserAuthFactory,Utilities){$scope.userRegister={email:"",name:"",password1:"",password2:""},$scope.register=function(){var email=$scope.userRegister.email,username=$scope.userRegister.name,password1=$scope.userRegister.password1;password1===$scope.userRegister.password2?0!==email.length?0!==username.length?password1.length<6?Utilities.dangerAlert("Passwort hat nicht genügend Zeichen (mind. 6)!"):UserAuthFactory.register(email,username,password1).then(function(){$state.go("root.projectlist")},function(err){Utilities.throwException("Register","failed",err)}):Utilities.dangerAlert("Bitte geben Sie einen Nutzernamen ein!"):Utilities.dangerAlert("Bitte geben Sie eine Emailadresse ein!"):Utilities.dangerAlert("Die Passwörter stimmen nicht überein!")}}]),angular.module("dokuvisApp").controller("projectlistCtrl",["$scope","$state","$window","Utilities","Project","$translate",function($scope,$state,$window,Utilities,Project,$translate){}]),angular.module("dokuvisApp").controller("projectCtrl",["$scope","$state","$window","UserAuthFactory",function($scope,$state,$window,UserAuthFactory){$scope.toProjectList=function(){var url=$state.href("root.projectlist");$window.open(url,"_blank")},$scope.logout=function(){UserAuthFactory.logout(),$state.go("root.home",{},{reload:!0})},$scope.$on("$stateChangeSuccess",function(event,toState){/^project.home/.test(toState.name)?$scope.pageName="menu_home":/^project.explorer/.test(toState.name)?$scope.pageName="menu_explorer":/^project.tasks/.test(toState.name)?$scope.pageName="menu_tasks":/^project.resources/.test(toState.name)?$scope.pageName="menu_resources":/^project.config/.test(toState.name)?$scope.pageName="menu_config":$scope.pageName="?"})}]),angular.module("dokuvisApp").controller("projHomeCtrl",["$scope","$stateParams","Utilities","Project","Subproject","$translatePartialLoader",function($scope,$stateParams,Utilities,Project,Subproject,$translatePartialLoader){$translatePartialLoader.addPart("projects"),$scope.isMaster="master"===$stateParams.subproject,"master"===$stateParams.subproject?Project.get({id:$stateParams.project}).$promise.then(function(result){$scope.projectName=result.name,$scope.projectDesc=result.description}).catch(function(err){Utilities.throwApiException("#Project.get",err)}):Subproject.get({id:$stateParams.subproject}).$promise.then(function(result){$scope.projectName=result.name,$scope.projectDesc=result.description}).catch(function(err){Utilities.throwApiException("#Subproject.get",err)})}]),angular.module("dokuvisApp").controller("explorerCtrl",["$scope","$rootScope","$state","$stateParams","$timeout","$sce","$q","APIRequest","neo4jRequest","Utilities","webglInterface","$modal","Source","Model","Comment","Category",function($scope,$rootScope,$state,$stateParams,$timeout,$sce,$q,APIRequest,neo4jRequest,Utilities,webglInterface,$modal,Source,Model,Comment,Category){$scope.project=$stateParams.project,$scope.wi=webglInterface,$scope.views={activeMain:"3dview",activeSide:"versions"},$scope.screenshots=[],$scope.screenshotPins={isVisible:!1},$scope.toggleSlice=!1,$scope.toggleCut=!1,$scope.unsafeSettings={},$scope.unsafeSettings.opacity=50,$scope.unsafeSettings.edges=!0,$scope.unsafeSettings.autoTransparent=!1,$scope.viewportSettings={},$scope.coords={},$scope.coords.x=$scope.coords.y=$scope.coords.z=0,$scope.coords.xError=$scope.coords.yError=$scope.coords.zError=!1,$scope.coords.enabled=!1,$scope.constructionPhases={},$scope.constructionPhases.select=0,$scope.fellYear={},$scope.fellYear=0,$scope.position={},$scope.position.minAge=1250,$scope.position.maxAge=1750,$scope.scrollConfig={theme:"dark",axis:"y",scrollInertia:500,advanced:{updateOnContentResize:!1}},$scope.colorMarkerArray=[],$scope.ramp={start:[49,29,5],end:[249,226,189]},$scope.markerID=0,$scope.lineThickness={value:5},$scope.lineColor={value:"#ff0000"},$scope.marksOpacity=50,$scope.categories=[],$scope.activeCategory=null,$scope.activeVersion=null,$scope.selectedObjects=[],$stateParams.initialComment&&($scope.views.activeSide="comments",$scope.activeCommentId=$stateParams.initialComment),$scope.$on("modelVersionActive",function(event,version){$scope.activeVersion=version}),$scope.$on("viewportSelectionChange",function(event,selected){$scope.selectedObjects=selected}),$scope.startModelComment=function(){$rootScope.$broadcast("snapshotStart"),$scope.enableSnapshotForm=!0},$scope.$on("snapshotEnd",function(){$scope.enableSnapshotForm=!1}),$scope.$on("commentActive",function(event,comment){comment&&($scope.activeCommentId="string"==typeof comment?comment:comment.id)}),$scope.closeCommentDetail=function(){$scope.activeCommentId=void 0,$rootScope.$broadcast("snapshotViewClose")},$scope.togglePins=function(){if($scope.screenshotPins.isVisible)for(var i=0;i<$scope.screenshots.length;i++)$scope.screenshots[i].pin.matrix&&webglInterface.callFunc.addPin($scope.screenshots[i].id,$scope.screenshots[i].pin);else webglInterface.callFunc.removePins()},$scope.addPin=function(id,pinObj,event){var targetHeight=$(event.delegateTarget).height(),target=$(event.delegateTarget).offset(),canvas=$("#svgViz").offset();target.left-=canvas.left,target.top-=canvas.top;var screenXY=webglInterface.callFunc.addPin(id,pinObj),d=["M"+target.left,target.top,"Q",screenXY.x+.75*Math.abs(screenXY.x-target.left),(screenXY.y+target.top+targetHeight/2)/2+",",screenXY.x,screenXY.y,"Q",screenXY.x+.75*Math.abs(screenXY.x-target.left),(screenXY.y+target.top+targetHeight/2)/2+",",target.left,target.top+100];$scope.path=d.join(" ")},$scope.removePin=function(id){$scope.line=null,$scope.path=null,webglInterface.callFunc.removePin(id)},$scope.open3DPlan=function(plan){neo4jRequest.getAttached3DPlan($stateParams.project,plan.eid,plan.plan3d).success(function(data,status){if(data){var edata=Utilities.extractNeo4jData(data)[0];console.log(edata),plan.plan3d=$scope.callDirFunc.loadCTMPlanIntoScene(plan.plan3d,edata.object,edata.file),console.log(plan)}else console.error("neo4jRequest failed")})},$scope.getPlansForObj=function(){neo4jRequest.getPlansFromObject($scope.selected.eid).success(function(data,status){$scope.sourceResults=Utilities.cleanNeo4jData(data),console.log($scope.sourceResults)})},$scope.highlightObj=function(plan){console.log(plan),Source.getLinks({id:plan.eid}).$promise.then(function(objIds){console.log(plan,objIds),webglInterface.callFunc.highlightObjects(objIds)},function(err){Utilities.throwApiException("on Source.getLinks()",err)})},$scope.connectPlanToObj=function(plan){var res=webglInterface.callFunc.getObjForPlans(plan.plan3d.meshId);console.log(res),plan.$link({targets:res.objs}).then(function(response){console.log("plan connected",response)},function(err){Utilities.throwApiException("on Source.links()",err)})},webglInterface.callFunc.highlightSources=function(obj){Model.getConnections(obj.name).then(function(response){console.log(response);for(var i=0;i<$scope.sourceResults.length;i++){$scope.sourceResults[i].selected=!1;for(var j=0;j<response.data.length;j++)$scope.sourceResults[i].eid!==response.data[j].sourceId||($scope.sourceResults[i].selected=!0,$scope.sourcesSettings.filterSelected=!0)}},function(err){Utilities.throwApiException("on Model.getConnections()",err)})},$scope.callDirFunc={},$scope.addSlider=function(event){var t=event.offsetX/event.delegateTarget.offsetWidth,newR=Math.round((1-t)*$scope.ramp.start[0]+t*$scope.ramp.end[0]),newG=Math.round((1-t)*$scope.ramp.start[1]+t*$scope.ramp.end[1]),newB=Math.round((1-t)*$scope.ramp.start[2]+t*$scope.ramp.end[2]);$scope.colorMarkerArray.push({position:event.offsetX,color:"rgb("+newR+","+newG+","+newB+")"})},$scope.updateCategoryAttr=function(c){if(-1!==c.selected){for(var e73ids=[],i=0;i<webglInterface.selected.length;i++)e73ids.push(webglInterface.selected[i].eid);APIRequest.assignCategoryToObjects(e73ids,c.selected).then(function(response){for(var i=0;i<webglInterface.selected.length;i++)c.selected?webglInterface.selected[i].categories[c.id]={catId:c.id,catValue:c.value,attrId:c.selected}:delete webglInterface.selected[i].categories[c.id];webglInterface.activeCategory===c&&webglInterface.callFunc.colorByCategory(webglInterface.activeCategory)},function(err){Utilities.throwApiException("on assignCategoryToObjects()",err)})}},$scope.$on("$destroy",function(){console.log("destroy explorerCtrl")})}]),angular.module("dokuvisApp").controller("tasksCtrl",["$scope",function($scope){$scope.views={activeSide:"details"},$scope.activeTask=null,$scope.$on("taskActivate",function(event,task){$scope.activeTask=task})}]),angular.module("dokuvisApp").controller("configCtrl",["$scope","Staff","Utilities",function($scope,Staff,Utilities){}]),angular.module("dokuvisApp").controller("resourcesCtrl",["$scope","$stateParams","$state","Utilities",function($scope,$stateParams,$state,Utilities){}]),angular.module("dokuvisApp").controller("modelModalCtrl",["$scope","$state","$stateParams","$timeout","Model","Utilities",function($scope,$state,$stateParams,$timeout,Model,Utilities){var initUpdate=!0;$scope.updated=!1,$scope.minicolors={control:"wheel",opacity:!0,position:"bottom left",format:"rgb",changeDelay:200};$scope.updateValue=function(value){console.log(value),$scope.updated=!0,initUpdate=!1},$scope.updateColor=function(){if(initUpdate)initUpdate=!1;else{var match=$scope.color.match(/([0-9]*\.[0-9]+|[0-9]+)/g);$scope.model.obj.materialColor=[+(match[0]/255).toFixed(7),+(match[1]/255).toFixed(7),+(match[2]/255).toFixed(7),+match[3]],console.log("color",$scope.model.obj.materialColor),$scope.updated=!0}},$scope.save=function(){Model.update($scope.model).then(function(response){console.log(response),$scope.close()},function(err){Utilities.throwApiException("on Model.update()",err)})},Model.get($stateParams.modelId).then(function(response){$scope.model=response.data,$scope.color="rgba("+Math.round(255*$scope.model.obj.materialColor[0])+","+Math.round(255*$scope.model.obj.materialColor[1])+","+Math.round(255*$scope.model.obj.materialColor[2])+","+$scope.model.obj.materialColor[3]+")",$scope.model.obj.materialColor,console.log($scope.model),console.log($scope.model.obj.materialColor)},function(err){Utilities.throwApiException("on Model.get()",err)}),$scope.close=function(){this.$hide(),this.$destroy(),$state.go("^.^")},$scope.$on("$stateChangeSuccess",function(){$timeout(function(){$scope.$hide(),$scope.$destroy()})})}]),angular.module("dokuvisApp").controller("spatializeModalCtrl",["$scope","$state","$stateParams","webglInterface","SpatializeInterface","Source","Utilities",function($scope,$state,$stateParams,webglInterface,SpatializeInterface,Source,Utilities){$scope.source=$stateParams.source,$scope.save=function(){$scope.source.dlt=SpatializeInterface.getDLTInputs(),$scope.source.dlt?Source.spatialize({id:$scope.source.eid,type:$scope.source.type,method:"DLT"},$scope.source).$promise.then(function(response){console.log(response),delete $scope.source.dlt,response.spatial.source=$scope.source,SpatializeInterface.callFunc.spatial.loadSpatializeImage(response.spatial,!0).then(function(entry){webglInterface.callFunc.spatial.setImageView(entry.object)})},function(err){Utilities.throwApiException("on Source.spatialize()",err)}):Utilities.dangerAlert("Missing markers!")},$scope.close=function(){this.$hide(),this.$destroy(),$state.go("^")},$scope.$on("$stateChangeSuccess",function(){$timeout(function(){$scope.$hide(),$scope.$destroy()})})}]),angular.module("dokuvisApp").controller("simpleModalCtrl",["$scope","$state",function($scope,$state){$scope.close=function(){$state.go("^")}}]);