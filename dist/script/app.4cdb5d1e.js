!function(){"use strict";function a(a,b){return function(c,d,e,f){function g(){h=this,i=arguments;var g=e&&!j;return j&&b.cancel(j),j=b(l,d,!1),g&&(f!==!1&&a.$applyAsync(),k=c.apply(h,i)),k}var h,i,j,k,l=function(){j=null,e!==!0&&(f!==!1&&a.$applyAsync(),k=c.apply(h,i))};return g.cancel=function(){b.cancel(j),j=null},g}}function b(a,b){return function(c,d,e,f,g){var h,i,j,k,l=0,m=function(){l=e===!1?0:(new Date).getTime(),j=null,g===!0&&a.$applyAsync(),k=c.apply(h,i),j||(h=i=null)},n=function(){h=this,i=arguments;var n=(new Date).getTime();l||e!==!1||(l=n);var o=d-(n-l);return o<=0||o>d?(j&&(b.cancel(j),j=null),l=n,g===!0&&a.$applyAsync(),k=c.apply(h,i),j||(h=i=null)):j||f===!1||(j=b(m,o,!1)),k};return n.cancel=function(){b.cancel(j),l=0,j=h=i=null},n}}angular.module("ngDebounceThrottle",[]).factory("$debounce",["$rootScope","$timeout",a]).factory("$throttle",["$rootScope","$timeout",b])}(),function(){"use strict";var a=angular.module("dokuvisApp",["ui.router","ct.ui.router.extras.sticky","ct.ui.router.extras.previous","ngResource","ngAnimate","ngSanitize","ngDebounceThrottle","truncate","xeditable","mgcrea.ngStrap","angularMoment","ngScrollbars","textAngular","ngTagsInput","minicolors","angularFileUpload","pw.canvas-painter","mm.acl","ngCookies","pascalprecht.translate","dokuvis.auth","dokuvis.utils","dokuvis.projects","dokuvis.subprojects","dokuvis.projinfos","dokuvis.sources","dokuvis.archives","dokuvis.authors","dokuvis.models","dokuvis.viewport","dokuvis.comments","dokuvis.categories","dokuvis.tasks","dokuvis.staff"]);a.constant("API","api/"),a.constant("ApiBase","api/"),a.constant("ApiAuth","api/auth/"),a.constant("ApiProject","api/auth/project"),a.constant("ApiSubproject","api/auth/project/:project/subproject"),a.constant("ApiSource","api/auth/project/:project/:subproject/source"),a.constant("ApiComment","api/auth/project/:project/:subproject/comment"),a.constant("ApiProjinfo","api/auth/project/:project/:subproject/projinfo"),a.constant("ApiArchive","api/auth/project/:project/archive"),a.constant("ApiAuthor","api/auth/project/:project/author"),a.constant("ApiCategory","api/auth/project/:project/category"),a.constant("ApiTask","api/auth/project/:project/task"),a.constant("ApiStaff","api/auth/project/:project/staff"),a.constant("ApiRoles","api/roles"),a.constant("ApiModelVersion","api/auth/project/:project/:subproject/model/version"),a.constant("ApiSoftware","api/auth/project/:project/software"),a.factory("ApiParams",["$stateParams",function(a){return{project:function(){return a.project},subproject:function(){return a.subproject}}}]),a.config(["$stateProvider","$urlRouterProvider","$httpProvider","$translateProvider","$translatePartialLoaderProvider","$modalProvider","$alertProvider","$tooltipProvider","$typeaheadProvider","$logProvider","$compileProvider",function(a,b,c,d,e,f,g,h,i,j,k){c.interceptors.push("TokenInterceptor"),b.otherwise("/home");var l={url:"/archive/:archiveId",resolve:{archiveModalInstance:["$modal",function(a){return a({templateUrl:"partials/modals/_modalTpl.173a23dd.html",contentTemplate:"components/dokuvis.archives/archiveModal.tpl.b35123ed.html",controller:"archiveModalCtrl",show:!1})}]},onEnter:["$translatePartialLoader","archiveModalInstance",function(a,b){a.addPart("archive"),b.$promise.then(b.show)}],onExit:["archiveModalInstance",function(a){a.hide(),a.destroy()}],params:{archiveId:"new"}};a.state("root",{template:'<div ui-view="header"></div><div class="rootContent" ui-view></div><div ui-view="footer"></div>'}).state("root.home",{url:"/home",views:{"":{templateUrl:"partials/home.976db1e1.html",controller:"homeCtrl"},header:{templateUrl:"partials/navbar.6fde8792.html",controller:"navCtrl"},footer:{templateUrl:"partials/footer.1d8e9e13.html"}},resolve:{validate:["ValidateResolve",function(a){return a()}]}}).state("root.impressum",{url:"/impressum",views:{"":{templateUrl:"partials/impressum.64bbc3f0.html"},header:{templateUrl:"partials/navbar.6fde8792.html",controller:"navCtrl"},footer:{templateUrl:"partials/footer.1d8e9e13.html"}},resolve:{validate:["ValidateResolve",function(a){return a()}]}}).state("root.register",{url:"/register",views:{"":{templateUrl:"partials/register.057ea8fb.html",controller:"registerCtrl"},header:{templateUrl:"partials/navbar.6fde8792.html",controller:"navCtrl"},footer:{templateUrl:"partials/footer.1d8e9e13.html"}},resolve:{skipIfLogged:["SkipResolve",function(a){return a()}]}}).state("root.projectlist",{url:"/list",views:{"":{templateUrl:"partials/projects.691b0d4f.html",controller:"projectlistCtrl"},header:{templateUrl:"partials/navbar.6fde8792.html",controller:"navCtrl"},footer:{templateUrl:"partials/footer.1d8e9e13.html"}},resolve:{authenticate:["AuthenticateResolve",function(a){return a()}]},onEnter:["$translatePartialLoader",function(a){a.addPart("projects")}]}).state("root.projectlist.project",{url:"/project/:projectId",resolve:{projectModalInstance:["$modal",function(a){return a({templateUrl:"partials/modals/_modalTpl.173a23dd.html",contentTemplate:"components/dokuvis.projects/projectModal.tpl.d257a701.html",controller:"projectModalCtrl",show:!1})}]},onEnter:["projectModalInstance",function(a){a.$promise.then(a.show)}],onExit:["projectModalInstance",function(a){a.hide(),a.destroy()}],params:{projectId:"new"}}).state("project",{url:"/:project/:subproject",templateUrl:"partials/project.469d3b50.html",controller:"projectCtrl",resolve:{authenticate:["AuthenticateResolve",function(a){return a()}],checkProject:["$stateParams","ProjectResolve",function(a,b){return b(a)}],checkSubproject:["$stateParams","SubprojectResolve",function(a,b){return b(a)}]},"abstract":!0}).state("project.home",{url:"/home",templateUrl:"partials/projHome.84b4eb9a.html",controller:"projHomeCtrl"}).state("project.home.subproject",{url:"/subproject/:subprojectId",resolve:{subprojectModalInstance:["$modal",function(a){return a({templateUrl:"partials/modals/_modalTpl.173a23dd.html",contentTemplate:"components/dokuvis.subprojects/subprojectModal.tpl.e65e8c16.html",controller:"subprojectModalCtrl",show:!1})}]},onEnter:["subprojectModalInstance",function(a){a.$promise.then(a.show)}],onExit:["subprojectModalInstance",function(a){a.hide(),a.destroy()}],params:{subprojectId:"new"}}).state("project.home.projinfo",{url:"/projinfo/:infoId",resolve:{projinfoModalInstance:["$modal",function(a){return a({templateUrl:"partials/modals/_modalLargeTpl.0d6d8ed7.html",contentTemplate:"components/dokuvis.projinfos/projinfoModal.tpl.2e458616.html",controller:"projinfoModalCtrl",show:!1})}]},onEnter:["projinfoModalInstance",function(a){a.$promise.then(a.show)}],onExit:["projinfoModalInstance",function(a){a.hide(),a.destroy()}],params:{infoId:"new"}}).state("project.explorer",{url:"/explorer?camera",templateUrl:"partials/explorer.a11beb80.html",controller:"explorerCtrl",reloadOnSearch:!1,onEnter:["$translatePartialLoader",function(a){a.addPart("model"),a.addPart("viewport"),a.addPart("category")}]}).state("project.explorer.source",{url:"/source",resolve:{sourceDetailModalInstance:["$translatePartialLoader","$modal",function(a,b){return a.addPart("source"),b({templateUrl:"partials/modals/_modalLargeTpl.0d6d8ed7.html",contentTemplate:"components/dokuvis.sources/sourceDetailModal.tpl.f07ae3cb.html",controller:"sourceDetailModalCtrl",show:!1})}]},onEnter:["sourceDetailModalInstance",function(a){a.$promise.then(a.show)}],onExit:["sourceDetailModalInstance",function(a){a.hide(),a.destroy()}],reloadOnSearch:!1,"abstract":!0}).state("project.explorer.source.id",{url:"/:sourceId"}).state("project.explorer.source.id.edit",{url:"/edit",resolve:{sourceEditModalInstance:["$modal",function(a){return a({templateUrl:"partials/modals/_modalTpl.173a23dd.html",contentTemplate:"components/dokuvis.sources/sourceEditModal.tpl.a766d443.html",controller:"sourceEditModalCtrl",show:!1})}]},onEnter:["sourceEditModalInstance",function(a){a.$promise.then(a.show)}],onExit:["sourceEditModalInstance",function(a){a.hide(),a.destroy()}]}).state("project.explorer.source.id.edit.archive",angular.copy(l)).state("project.explorer.model",{url:"/model",onEnter:["$modal",function(a){a({templateUrl:"partials/modals/_modalTpl.173a23dd.html",contentTemplate:"partials/modals/modelModal.82ea6fe0.html",controller:"modelModalCtrl",show:!0})}],"abstract":!0}).state("project.explorer.model.id",{url:"/:modelId"}).state("project.explorer.upload",{url:"/upload","abstract":!0}).state("project.explorer.upload.model",{url:"/model",resolve:{modelUploadModalInstance:["$translatePartialLoader","$modal",function(a,b){return a.addPart("source"),b({templateUrl:"partials/modals/_modalTpl.173a23dd.html",contentTemplate:"components/dokuvis.models/modelUploadModal.tpl.7203b9bf.html",controller:"modelUploadModalCtrl",show:!1})}]},onEnter:["modelUploadModalInstance",function(a){a.$promise.then(a.show)}],onExit:["modelUploadModalInstance","ModelUploader",function(a,b){a.hide(),a.destroy(),b.clearQueue()}],params:{parent:null}}).state("project.explorer.upload.source",{url:"/source",resolve:{sourceUploadModalInstance:["$translatePartialLoader","$modal",function(a,b){return a.addPart("source"),b({templateUrl:"partials/modals/_modalLargeTpl.0d6d8ed7.html",contentTemplate:"components/dokuvis.sources/sourceUploadModal.tpl.7eca870d.html",controller:"sourceUploadModalCtrl",show:!1})}]},onEnter:["sourceUploadModalInstance",function(a){a.$promise.then(a.show)}],onExit:["sourceUploadModalInstance","SourceUploader",function(a,b){a.hide(),a.destroy(),b.clearQueue()}]}).state("project.explorer.upload.source.archive",angular.copy(l)).state("project.explorer.category",{url:"/category",resolve:{categoryModalInstance:["$modal",function(a){return a({templateUrl:"partials/modals/_modalTpl.173a23dd.html",contentTemplate:"partials/modals/categoryConfigModal.225f0fd2.html",controller:"simpleModalCtrl",show:!1})}]},onEnter:["categoryModalInstance",function(a){a.$promise.then(a.show)}],onExit:["categoryModalInstance",function(a){a.hide(),a.destroy()}]}).state("project.explorer.spatialize",{url:"/spatialize",onEnter:["$modal",function(a){a({templateUrl:"partials/modals/_modalXLargeTpl.f0a04e68.html",contentTemplate:"partials/modals/spatializeModal.a408b643.html",controller:"spatializeModalCtrl",show:!0})}],params:{source:null},resolve:{check:["$q","$state","$stateParams","$timeout",function(a,b,c,d){return c.source?a.resolve():(d(function(){b.go("project.explorer",c)}),a.reject())}]}}).state("project.tasks",{url:"/tasks",templateUrl:"partials/tasks.a93235fc.html",controller:"tasksCtrl"}).state("project.tasks.detail",{url:"/:taskId",resolve:{taskModalInstance:["$modal",function(a){return a({templateUrl:"partials/modals/_modalTpl.173a23dd.html",contentTemplate:"components/dokuvis.tasks/taskModal.tpl.f9f4ce6a.html",controller:"taskModalCtrl",show:!1})}]},onEnter:["taskModalInstance",function(a){a.$promise.then(a.show)}],onExit:["taskModalInstance",function(a){a.hide(),a.destroy()}],params:{parent:null}}).state("project.graph",{url:"/graph",templateUrl:"partials/graph.782102ac.html"}).state("project.graph.node",{url:"/:startNode"}).state("project.resources",{url:"/resources?foo",templateUrl:"partials/resources.da91cf39.html",controller:"resourcesCtrl",onEnter:["$translatePartialLoader",function(a){a.addPart("archive"),a.addPart("author")}]}).state("project.resources.archive",l).state("project.resources.author",{url:"/author/:authorId",resolve:{authorModalInstance:["$modal",function(a){return a({templateUrl:"partials/modals/_modalTpl.173a23dd.html",contentTemplate:"components/dokuvis.authors/authorModal.tpl.a47f3849.html",controller:"authorModalCtrl",show:!1})}]},onEnter:["authorModalInstance",function(a){a.$promise.then(a.show)}],onExit:["authorModalInstance",function(a){a.hide(),a.destroy()}],params:{authorId:"new"}}).state("project.config",{url:"/config",templateUrl:"partials/config.d078f45a.html",controller:"configCtrl",onEnter:["$translatePartialLoader",function(a){a.addPart("config")}]}).state("project.config.staffedit",{url:"/staffedit",resolve:{staffModalInstance:["$modal",function(a){return a({templateUrl:"partials/modals/_modalTpl.173a23dd.html",contentTemplate:"components/dokuvis.staff/staffModal.tpl.f6387b47.html",controller:"staffModalCtrl",show:!1})}]},onEnter:["staffModalInstance",function(a){a.$promise.then(a.show)}],onExit:["staffModalInstance",function(a){a.hide(),a.destroy()}]}),d.useSanitizeValueStrategy("sanitize").useLoader("$translatePartialLoader",{urlTemplate:"/i18n/{part}/{lang}.json"}).preferredLanguage("en-US").fallbackLanguage("de-DE").registerAvailableLanguageKeys(["en-US","de-DE"],{"en_*":"en-US","de_*":"de-DE"}),d.useLocalStorage(),e.addPart("general"),angular.extend(f.defaults,{backdrop:"static",keyboard:!1}),angular.extend(g.defaults,{keyboard:!1}),angular.extend(h.defaults,{placement:"right",delay:{show:500,hide:100}}),angular.extend(i.defaults,{delay:{show:500,hide:0},minLength:3}),j.debugEnabled(!0),k.debugInfoEnabled(!0),k.commentDirectivesEnabled(!1),k.cssClassDirectivesEnabled(!1)}]),a.run(["$rootScope","$state","$previousState","AuthenticationFactory","AclService","$translate","amMoment","editableOptions","TypeaheadRequest",function(a,b,c,d,e,f,g,h,i){var j={guest:["login","register"],member:["logout","create_project"],visitor:[],historian:["upload_source"],modeler:["upload_model"],admin:["manage_content","edit_subproject","edit_staff"],superadmin:["edit_project"]};e.setAbilities(j),e.attachRole("guest"),a.can=e.can,a.$on("$translatePartialLoaderStructureChanged",function(){f.refresh()}),a.$on("$stateChangeSuccess",function(){a.isLogged=d.isLogged,a.userName=d.userName}),h.theme="bs3",a.availableLanguages=[{key:"en-US",shortKey:"en",label:"English"},{key:"de-DE",shortKey:"de",label:"Deutsch"}],a.currentLanguage=a.availableLanguages.find(function(a){return a.key===f.proposedLanguage()}),g.changeLocale(a.currentLanguage.shortKey),a.setLanguage=function(){f.use(a.currentLanguage.key),g.changeLocale(a.currentLanguage.shortKey)},a.setTypeahead=function(b,c,d){i.query(b,c,d).then(function(b){a.typeaheads=b.data},function(a){console.error(a)})}}])}(),angular.module("dokuvisApp").factory("APIRequest",["$http","API","$stateParams",function(a,b,c){var d={};return d.assignCategoryToObjects=function(d,e){return a.post(b+"auth/project/"+c.project+"/"+c.subproject+"/assignCategory",{objects:d,attrId:e})},d}]),angular.module("dokuvisApp").factory("neo4jRequest",["$http","Utilities",function(a,b){var c="php/neo4jrequest.php",d={};return d.getAttached3DPlan=function(b,d,e){return a.post(c,{query:"MATCH (:E31:"+b+" {content: {e31id}})<-[:P138]-(:E36:"+b+" {content: {e36id}})-[:P106]->(e73:E73)-[:P1]->(e75:E75) RETURN e73 AS object, e75 AS file",params:{e31id:d,e36id:e}})},d.attach3DPlan=function(b,d,e,f){var g="";return g+="MATCH (parent:E31:"+b+" {content: {parentid}})",g+=",(tmodel:E55:"+b+' {content: "model"})',g+=" CREATE (parent)<-[:P138]-(e36:E36:"+b+" {content: {contentid}})-[:P2]->(tmodel)",g+=" CREATE (e73:E73:"+b+" {e73content})-[:P1]->(e75:E75:"+b+" {e75content})",g+=" CREATE (e36)-[:P106]->(e73)",g+=" RETURN e73",a.post(c,{query:g,params:{contentid:"e36_"+d.pureNewFileName,parentid:f.eid,e73content:{content:"e73_"+d.pureNewFileName,name:e.name,type:e.type,materialName:e.materialName,materialMap:e.materialMap,materialMapPath:d.path+"maps/"},e75content:{content:e.file,path:d.path}}})},d.insertScreenshot=function(d,e,f,g,h,i){var j="";j+="MATCH (tscreen:E55:"+d+' {content: "screenshot"})',j+=",(tscomment:E55:"+d+' {content: "screenshotComment"})',j+=f.pinObject?",(e73:E73:"+d+" {content: {e73id}})<-[:P106]-(:E36)-[:P138]->(e22:E22)":",(e22:E22:"+d+" {content: {e22id}})",j+=" CREATE (e36:E36:"+d+" {e36content})-[:P2]->(tscreen)",j+=" CREATE (e36)-[:P1]->(e75:E75:"+d+" {e75content})",j+=" CREATE (e36)-[:P102]->(e35:E35:"+d+" {e35content})",j+=" CREATE (e36)-[:P138]->(e22)";for(var k=0;k<g.length;k++)j+=" CREATE (e36)-[:P106]->(:E90:"+d+' {content: "'+g[k].id+'", u: '+g[k].u+", v: "+g[k].v+"})-[:P3]->(:E62:"+d+' {content: "e62'+g[k].id+'", value: "'+g[k].comment+'"})-[:P3_1]->(tscomment)';return j+=" MERGE (tdraw:E55:"+d+' {content: "userDrawing"})',j+=" CREATE (e36)-[:P106]->(paint:E36:"+d+" {content: {paintid}})-[:P1]->(:E75:"+d+" {painte75content})",j+=",(paint)-[:P2]->(tdraw)",j+=" RETURN e36",a.post(c,{query:j,params:{e22id:"e22_root_"+e,e73id:f.pinObject,e36content:{content:"e36_"+f.filename,cameraCenter:f.cameraCenter,cameraFOV:f.cameraFOV,cameraMatrix:f.cameraMatrix,pinMatrix:f.pinMatrix},e75content:{content:f.filename,path:f.path,width:f.width,height:f.height},e35content:{content:b.getUniqueId()+"_screenshotTitle",value:h},paintid:"e36_"+i,painte75content:{content:i,path:f.path,width:f.width,height:f.height}}})},d.insertScreenshotMarkers=function(b,d,e){var f="";f+="MATCH (e36:E36:"+b+" {content: {e36id}})",f+=",(tscomment:E55:"+b+' {content: "screenshotComment"})';for(var g=0;g<e.length;g++)f+=" CREATE (e36)-[:P106]->(:E90:"+b+' {content: "'+e[g].id+'", u: '+e[g].u+", v: "+e[g].v+"})-[:P3]->(:E62:"+b+' {content: "'+e[g].comment+'"})-[:P3_1]->(tscomment)';return f+=" RETURN e36",a.post(c,{query:f,params:{e36id:d.data.id}})},d.getScreenshotsWithMarkers=function(b){var d="";return d+="MATCH (e22:E22:"+b+")<-[:P138]-(e36:E36:"+b+')-[:P2]->(:E55 {content: "screenshot"})',d+=",(e36)-[:P1]->(e75:E75)",d+=",(e36)-[:P102]->(e35:E35)",d+=",(e36)-[:P106]->(marker:E90)-[:P3]->(comment:E62)",d+=",(e36)-[:P106]->(:E36)-[:P1]->(paint:E75)",d+=" RETURN e36.content AS id, \t\t\t\te75.content AS file, \t\t\t\te75.path AS path, \t\t\t\te75.width AS width, \t\t\t\te75.height AS height, \t\t\t\te35.value AS title, \t\t\t\t{object: e22.content, matrix: e36.pinMatrix} AS pin, \t\t\t\t{center: e36.cameraCenter, matrix: e36.cameraMatrix, fov: e36.cameraFOV} AS camera, \t\t\t\tcollect({id: marker.content, u: marker.u, v: marker.v, comment: comment.value}) AS markers, \t\t\t\t{file: paint.content, path: paint.path, width: paint.width, height: paint.height} AS drawing",a.post(c,{query:d,params:{}})},d.getAllTags=function(b){return a.post(c,{query:"MATCH (n:TAG:"+b+") RETURN n.content as tags",params:{}})},d.searchTags=function(b,d){return a.post(c,{query:"MATCH (n:TAG:"+b+') \t\t\t\t\tWHERE n.content =~ ".*'+d+'.*" \t\t\t\t\tRETURN n.content as tag ORDER BY tag',params:{}})},d}]),angular.module("dokuvisApp").factory("phpRequest",["$http",function(a){var b={};return b.indexDocuments=function(b){return a.post("php/indexText.php",{project:b})},b.getIndex=function(b){return a.post("php/getIndex.php",{project:b})},b.searchText=function(b,c){return a.post("php/searchText.php",{project:b,search:c})},b.setNewBlacklist=function(b,c){return a.post("php/setBlackWhitelist.php",{project:b,file:"blacklist.txt",words:c})},b.setNewWhitelist=function(b,c){return a.post("php/setBlackWhitelist.php",{project:b,file:"whitelist.txt",words:c})},b.getBlacklist=function(b){return a.post("php/getBlackWhitelist.php",{project:b,file:"blacklist.txt"})},b.getWhitelist=function(b){return a.post("php/getBlackWhitelist.php",{project:b,file:"whitelist.txt"})},b}]),angular.module("dokuvisApp").directive("horizontalScroll",function(){return{restrict:"A",link:function(a,b){function c(a){var c=-a.originalEvent.deltaY||a.originalEvent.wheelDelta||0,d=b.scrollLeft();c>0?b.scrollLeft(d-100):c<0&&b.scrollLeft(d+100)}b.on("wheel",c)}}}),angular.module("dokuvisApp").directive("alert",["$timeout",function(a){return{restrict:"A",scope:{alert:"="},template:'<span class="glyphicon glyphicon-exclamation-sign"></span> {{alert.message}}',link:function(b,c){c.hide().fadeIn(300),a(function(){c.fadeOut({duration:1e3,done:function(){b.$parent.alert.showing=!1,b.$apply()}})},5e3)}}}]),angular.module("dokuvisApp").directive("resizer",["$document",function(a){return{scope:{resizerEnd:"=",resizerAnim:"="},link:function(b,c,d){function e(){if("vertical"===d.resizer){var a=$(d.resizerRight).css("left");c.css({left:a}),$(d.resizerLeft).css({width:a}),$(d.resizerRight).css({left:a})}}function f(a){if("vertical"===d.resizer){var b=a.pageX-h;d.resizerLeftMin&&b<d.resizerLeftMin&&(b=parseInt(d.resizerLeftMin)),d.resizerRightMin&&b>i-d.resizerRightMin&&(b=i-parseInt(d.resizerRightMin)),c.css({left:b+"px"}),$(d.resizerLeft).css({width:b+"px"}),$(d.resizerRight).css({left:b+c.width()+"px"}),j=b}else{var e=i-a.pageY-h;d.resizerTopMin&&e>i-d.resizerTopMin&&(e=i-parseInt(d.resizerTopMin)),d.resizerBottomMin&&e<d.resizerBottomMin&&(e=parseInt(d.resizerBottomMin)),c.css({bottom:e+"px"}),$(d.resizerTop).css({bottom:e+c.height()+"px"}),$(d.resizerBottom).css({height:e+"px"}),j=e}}function g(){a.unbind("mousemove",f),a.unbind("mouseup",g),b.resizerEnd&&b.resizerEnd()}var h=0,i=0,j=0;c.on("mousedown",function(b){b.preventDefault(),"vertical"!==d.resizer&&"horizontal"!==d.resizer||(a.bind("mousemove",f),a.bind("mouseup",g),"vertical"===d.resizer?(h=b.pageX-b.offsetX-b.delegateTarget.offsetLeft,i=c.parent()[0].offsetWidth):(h=b.pageY-b.offsetY-b.delegateTarget.offsetTop,i=c.parent()[0].offsetHeight))}),e(),b.$watch("resizerAnim",function(a,b){if("vertical"===d.resizer){i=c.parent()[0].offsetWidth;var e=a;d.resizerLeftMin&&e<d.resizerLeftMin&&(e=parseInt(d.resizerLeftMin)),d.resizerRightMin&&e>i-d.resizerRightMin&&(e=i-parseInt(d.resizerRightMin)),c.animate({left:e+"px"},500),$(d.resizerLeft).animate({width:e+"px"},500),$(d.resizerRight).animate({left:e+c.width()+"px"},500)}else{i=c.parent()[0].offsetHeight;var f=a;d.resizerTopMin&&f>i-d.resizerTopMin&&(f=i-parseInt(d.resizerTopMin)),d.resizerBottomMin&&f<d.resizerBottomMin&&(f=parseInt(d.resizerBottomMin)),c.animate({bottom:f+"px"},500),$(d.resizerTop).animate({bottom:f+c.height()+"px"},500),$(d.resizerBottom).animate({height:f+"px"},500)}})}}}]),angular.module("dokuvisApp").directive("ngWheel",["$parse",function(a){return{restrict:"A",link:function(b,c,d){function e(a){b.$apply(function(){f(b,{$event:a})})}var f=a(d.ngWheel);c.bind("mousewheel",e),c.bind("DOMMouseScroll",e)}}}]),angular.module("dokuvisApp").directive("syncScroll",function(){return{restrict:"A",replace:!1,link:function(a,b,c){var d=0,e=0,f=0,g=b.find("."+c.syncScroll);g.on("scroll",function(a){a.isTrigger?a.target.scrollTop=Math.round(d*(a.target.scrollHeight-a.target.offsetHeight)/(e-f)):(d=a.target.scrollTop,e=a.target.scrollHeight,f=a.target.offsetHeight,g.each(function(b){this.isSameNode(a.target)||$(this).trigger("scroll")}))})}}}),angular.module("dokuvisApp").directive("convertToNumber",function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.push(function(a){return parseInt(a,10)}),d.$formatters.push(function(a){return""+a})}}}),angular.module("dokuvisApp").directive("noContextMenu",function(){return{compile:function(a){a.bind("contextmenu",function(a){a.preventDefault()})}}}),angular.module("dokuvisApp").filter("filterEditor",function(){return function(a,b){return b?a.filter(function(a){return a.editors.indexOf(b)!==-1}):a}}),angular.module("dokuvisApp").filter("amJSDate",["moment",function(a){return function(b){return console.log(b),a.isMoment(b)?b.toDate():a.isDate(b)?b:a(b).toDate()}}]),angular.module("dokuvisApp").filter("asList",function(){return function(a,b,c,d){if(Array.isArray(a)){if(!d)return a.sort(),a.join(b);var e=[];return a.forEach(function(a){e.push(a[d])}),c&&e.sort(),e.join(b)}}}),angular.module("dokuvisApp").animation(".fadeLoadprogress",[function(){return{addClass:function(a,b,c){"ng-hide"===b&&jQuery(a).delay(2e3).fadeOut(2e3)},removeClass:function(a,b,c){"ng-hide"===b&&jQuery(a).show()}}}]),angular.module("dokuvisApp").factory("Utilities",["$alert","$translate",function(a,b){function c(a,b){if(a.content===b)return a;for(var d=0,e=a.children.length;d<e;d++){var f=c(a.children[d],b);if(void 0!==f)return f}}var d={};return d.Base62=function(){this.characterSet="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"},d.Base62.prototype.encode=function(a){if(0===a)return"0";for(var b="";a>0;)b=this.characterSet[a%62]+b,a=Math.floor(a/62);return b},d.Base62.prototype.decode=function(a){var b=0,c=a.split("").reverse();return c.forEach(function(a,c){b+=this.characterSet.indexOf(a)*Math.pow(62,c)}),b},d.Base62.prototype.setCharacterSet=function(a){var b=a.split(""),c=[];if(62!=b.length)throw Error("You must supply 62 characters");if(b.forEach(function(a){~c.indexOf(a)||c.push(a)}),62!=c.length)throw Error("You must use unique characters.");this.characterSet=b},d.getUniqueId=function(){return(new d.Base62).encode((new Date).getTime())},d.sleep=function(a){for(var b=(new Date).getTime(),c=0;c<1e7&&!((new Date).getTime()-b>a);c++);},d.waitfor=function(a,b,c,e,f){return a()!==b?void setTimeout(function(){d.waitfor(a,b,c,e,f)},c):void f(e)},d.extractNeo4jData=function(a){for(var b=[],c=0;c<a.data.length;c++){for(var d=new Object,e=0;e<a.columns.length;e++)null==a.data[c][e]?d[a.columns[e]]=null:d[a.columns[e]]=a.data[c][e].data;b.push(d)}return b},d.cleanNeo4jData=function(a,b){b=b||!1;for(var c=[],d=0;d<a.data.length;d++){for(var e=new Object,f=0;f<a.columns.length;f++)null==a.data[d][f]?e[a.columns[f]]=null:e[a.columns[f]]=a.data[d][f];b&&(e.selected=!1),c.push(e)}return c},d.extractNeo4jTransactData=function(a){for(var b=[],c=0,d=a.data.length;c<d;c++){for(var e={},f=0;f<a.columns.length;f++)e[a.columns[f]]=a.data[c].row[f];b.push(e)}return b},d.extractArrayFromNeo4jData=function(a){for(var b=[],c=0;c<a.data.length;c++)b.push(a.data[c][0]);return b},d.createHierarchy=function(a,b,d){for(var e=[],f=0,g=a.data.length;f<g;f++){var h={};h.content=a.data[f][0].parent.data.content,h.children=[];for(var i=0,j=a.data[f][1].length;i<j;i++){for(var k={},l=0;l<b.length;l++)d?k[b[l]]=a.data[f][1][i][b[l]].data:k[b[l]]=a.data[f][1][i][b[l]];k.content=a.data[f][1][i].child.data.content,k.children=[],h.children.push(k)}e.push(h)}for(var f=0;f<e.length;f++)for(var i=0,j=e.length;i<j;i++)if(f!==i){var m=c(e[i],e[f].content);if(void 0!==m){m.children=e[f].children,e.splice(f,1),f--;break}}return e},d.setUrlParams=function(a,b){for(var c,d=a,e=/:([^:\/]+)/g;null!==(c=e.exec(a));)d="function"==typeof b[c[1]]?d.replace(c[0],b[c[1]]()):d.replace(c[0],b[c[1]]);return d},d.dangerAlert=function(c){b(c).then(function(b){a({content:b,type:"danger",duration:5})},function(b){a({content:b,type:"danger",duration:5})})},d.throwException=function(b,c,d){a({title:b+":",content:c,type:"danger",duration:5}),console.error(b+": "+c,d,"\n"+(new Error).stack.split("\n")[2])},d.throwNeo4jException=function(b,c){a({title:"Neo4jException:",content:b,type:"danger",duration:5}),console.error("Neo4jException: "+b,c)},d.throwApiException=function(b,c){403===c.status&&(b="Access denied "+b+" ("+c.statusText+" "+c.status+")"),a({title:"API Exception:",content:b,type:"danger",duration:5}),console.error("API Exception: "+b,c,"\n"+(new Error).stack.split("\n")[2])},d}]),angular.module("dokuvisApp").factory("webglInterface",["$rootScope","$anchorScroll","$debounce",function(a,b,c){function d(a){var b=f(i.hierarchList,a.parent);void 0!==b?(a.parent=b,b.children.push(a)):(a.parent=null,i.hierarchList.push(a))}function e(a){i.layerList.push(a),a.layer in j?j[a.layer].count++:(j[a.layer]={count:1},i.layers.push({name:a.layer,visible:!0,expand:!1}))}function f(a,b){for(var c=0,d=a.length;c<d;c++){var e=a[c];if(e.id===b)return e;var g=f(e.children,b);if(void 0!==g)return g}}function g(a){for(var b=0;b<i.plans.length;b++)if(i.plans[b].id===a)return i.plans[b]}function h(a){a.expand=!0,a.parent&&h(a.parent)}var i={};i.callFunc={},DV3D.callFunc=i.callFunc,i.viewportSettings={shading:["color","grey","transparent","onlyEdges","xray","Custom"],camera:["Perspective","Top","Front","Back","Left","Right","Custom"],edges:!0,ssao:"aa"},i.viewportSettings.shadingSel=i.viewportSettings.shading[0],i.viewportSettings.cameraSel=i.viewportSettings.camera[0],i.unsafeSettings={},i.categories=[],i.activeCategory=null,i.vPanel={},i.vPanel.expand=!1,i.vPanel.activeTab=0,i.vizSettings={opacitySelected:100,edges:!0,edgesOpacity:100,edgesColor:100},i.snapshot={active:!1,mode:"paint",text:"",title:"",refObj:[],refSrc:[],screenshots:[]},i.snapshot.paintOptions={opacity:1,color:"rgba(255,255,0,1.0)",backgroundColor:"rgba(255,255,255,0.0)",lineWidth:3,undo:!0,imageSrc:!1},i.spatialize={active:!1,opacity:50,image:null,fov:35},i.listProperties={plans:{visible:!0,opacity:1},images:{visible:!0,scale:10,opacity:1}},i.objects=[],i.layerList=[],i.layers=[],i.hierarchList=[],i.selected=[],i.plans=new DV3D.Collection,i.spatialImages=new DV3D.Collection,i.spatialImages.setScale(10);var j={};i.insertIntoLists=function(b){var c=new i.ObjectEntry(b);d(c),e(c),a.$applyAsync()},i.insertIntoPlanlist=function(b){b.visible=!0,b.selected=!1,b.opacity=1,i.plans.push(b),a.$applyAsync()},i.clearLists=function(){console.log("clearList"),i.layerLists=[],i.layers=[],i.hierarchList=[]},i.ObjectEntry=function(a){this.id=a.id,this.name=a.name,this.title=a.title,this.type=a.type,this.layer=a.layer||0,this.parent=a.parent||null,this.children=[],this.parentVisible=!0,this.visible=!0,this.selected=!1,this.expand=!1,this.opacity=1;var b=this;this.toggle=function(){b.visible=!b.visible,!b.visible&&b.selected&&i.callFunc.selectObject(b.id,!1,!0),i.callFunc.toggleObject(b,b.visible)},this.select=function(a){b.visible&&a&&i.callFunc.selectObject(b.id,a.ctrlKey,!1)},this.setOpacity=function(a){i.callFunc.setObjectOpacity(b,a)},this.focus=function(){i.callFunc.focusObject(b.id)},this.showSources=function(){i.callFunc.highlightSources(b)}},i.selectListEntry=function(b,c){var d="plan"===c.type?g(b):f(i.hierarchList,b);d&&(d.selected=!0,i.selected.push(c),d.parent&&h(d.parent),k(d.id),a.$applyAsync())},i.deselectListEntry=function(b,c){var d="plan"===c.type?g(b):f(i.hierarchList,b);d&&(d.selected=!1,i.selected.splice(i.selected.indexOf(c),1),a.$applyAsync())};var k=c(function(a){console.log("anchorScroll called","list"+a),b("list"+a)},200,!0);return i}]),angular.module("dokuvisApp").factory("CidocDict",function(){var a={};a.E21={de:"Person",prefProp:"title",color:"#ffa992"},a.E22={de:"Objekt",prefProp:"title"},a.E31={de:"Dokument",prefProp:"title",color:"#cbf09a"},a.E33={de:"Kommentar",prefProp:"value",color:"#cae4e8"},a.E35={de:"Titel",prefProp:"value",color:"#cae4e8"},a.E40={de:"Institution",prefProp:"title"},a.E42={de:"Kennung"},a.E52={de:"Zeit",prefProp:"title",color:"#ffffbf"},a.E53={de:"Ort",prefProp:"title",color:"#ffffbf"},a.E55={de:"Typus",color:"#e5e5e5"},a.E56={de:"Sprache",color:"#e5e5e5"},a.E62={de:"Zeichenkette",prefProp:"value",color:"#ffe866"},a.E65={de:"Begriffliche Schöpfung"},a.E78={de:"Sammlung",prefProp:"title"},a.E82={de:"Akteurbenennung",color:"#cae4e8"},a.E84={de:"Informationsträger"};var b={};b.P1={de:"wird bezeichnet als",en:"is identified by"},b.P2={de:"hat den Typus",en:"has type"},b.P3={de:"hat Anmerkung",en:"has note"},b.P14={de:"wurde ausgeführt von",en:"carried out by"},b.P15={de:"wurde beeinflusst durch",en:"was influenced by"},b.P52={de:"im Besitz von",en:"has current owner"},b.P70={de:"belegt",en:"documents"},b.P94={de:"hat erschaffen",en:"has produced"},b.P4a={de:"wurde erstellt während",en:"produced during"},b.P7a={de:"wurde erstellt in",en:"produced in"},b.P14a={de:"wurde erstellt durch",en:"produced by"},b.P72a={de:"hat Sprache",en:"has language"},b.P128a={de:"archiviert in",en:"archived in"};var c={};return c.getClassName=function(b){return b in a?a[b].de:b},c.getPropertyName=function(a){return a in b?b[a].de:a},c.getNodePropertyName=function(b){return b in a&&a[b].prefProp?a[b].prefProp:"content"},c.getNodeColor=function(b){return b in a&&a[b].color?a[b].color:"#fff"},c}),angular.module("dokuvisApp").factory("GraphVis",["$http","API","$stateParams",function(a,b,c){return{getNodeNeighbours:function(d){return a.get(b+"auth/project/"+c.project+"/graph/"+d)},getNodeTitle:function(d,e){return a.get(b+"auth/project/"+c.project+"/graph/"+d+"/"+e)},getE22Name:function(d){return a.get(b+"auth/project/"+c.project+"/graph/"+d+"/e22")}}}]),angular.module("dokuvisApp").factory("ConfirmService",["$alert","$q","$translate",function(a,b,c){function d(c,d){var g={},h={};angular.extend(g,e,d),angular.extend(h,f,c),g.alertOptions=h;var i=b.defer();return g.controller=function(a){a.alertOptions=h,a.alertOptions.ok=function(){a.$hide(),i.resolve()},a.alertOptions.abort=function(){a.$hide(),i.reject()}},a(g),i.promise}var e={backdrop:"static",templateUrl:"partials/alerts/confirmAlert.7ca51873.html",show:!0},f={abortButtonText:"Abbrechen",actionButtonText:"OK",headerText:"Fortfahren?",bodyText:"Sind Sie sicher?",type:"warning"
};return c("abort").then(function(a){f.abortButtonText=a}),function(a,b){return b||(b={}),d(a,b)}}]),angular.module("dokuvisApp").factory("TypeaheadRequest",["$http","API","$stateParams",function(a,b,c){return{query:function(d,e,f){var g=b+"auth/project/"+c.project+"/typeahead/"+d+"/"+f+"/"+e;return a.get(g)},queryTags:function(d){return a.get(b+"auth/project/"+c.project+"/typeahead/tag",{params:{search:d}}).then(function(a){for(var b=a.data,c=[],d=0;d<b.length;d++)c.push(b[d].tag);return c})}}}]),angular.module("dokuvisApp").factory("SpatializeInterface",function(){var a={};return a.callFunc={},a.markers2D=[],a.markers3D=[],a.imageWidth=0,a.imageHeight=0,a.getDLTInputs=function(){if(a.markers2D.length!==a.markers3D.length)return console.warn("Missing markers!"),void console.log(a.markers2D,a.markers3D);for(var b="",c=0,d=a.markers2D.length;c<d;c++)b+=[c+1,a.markers3D[c].x,a.markers3D[c].y,a.markers3D[c].z,1e3*a.markers2D[c].x,1e3*a.markers2D[c].y,"\n"].join(" ");return console.log(b),b},a}),angular.module("dokuvis.auth",["ui.router","mm.acl"]).service("AuthenticationFactory",["$window","$http","$q","API",function(a,b,c,d){var e=this;this.isLogged=!1,this.check=function(){return a.localStorage.token&&a.localStorage.user?b.get(d+"auth/check").then(function(){return e.set(),c.resolve()})["catch"](function(){return e.flush(),c.reject("Invalid token")}):(this.flush(),c.reject("$window.localStorage not set"))},this.set=function(b){b&&(a.localStorage.token=b.token,a.localStorage.user=b.user.email,a.localStorage.userName=b.user.name),a.localStorage.token&&a.localStorage.user&&(this.isLogged=!0,this.user=a.localStorage.user,this.userName=a.localStorage.userName)},this.flush=function(){this.isLogged=!1,delete this.user,delete this.userName,delete a.localStorage.token,delete a.localStorage.user,delete a.localStorage.userName}}]).factory("UserAuthFactory",["$http","AuthenticationFactory","API","AclService",function(a,b,c,d){return{login:function(d,e){return a.post(c+"login",{email:d,password:e}).then(function(a){b.set(a.data)})},logout:function(){b.isLogged&&(b.flush(),d.flushRoles(),d.attachRole("guest"))},register:function(d,e,f){return a.post(c+"register",{email:d,username:e,password:f}).then(function(a){b.set(a.data)})}}}]).factory("TokenInterceptor",["$q","$window",function(a,b){return{request:function(c){return c.headers=c.headers||{},b.localStorage.token&&(c.headers["X-Access-Token"]=b.localStorage.token,c.headers["X-Key"]=b.localStorage.user,c.headers["Content-Type"]="application/json"),c||a.when(c)},response:function(b){return b||a.when(b)}}}]).factory("ValidateResolve",["$q","AuthenticationFactory","AclService","$log",function(a,b,c,d){return function(){var e=a.defer();return b.check().then(function(){c.flushRoles(),c.attachRole("member"),e.resolve()})["catch"](function(a){d.debug(a),e.resolve()}),e.promise}}]).factory("AuthenticateResolve",["$state","$q","$timeout","AuthenticationFactory","ValidateResolve",function(a,b,c,d,e){return function(){var f=b.defer();return e().then(function(){d.isLogged?f.resolve():(f.reject(),c(function(){a.go("root.home")}))}),f.promise}}]).factory("SkipResolve",["$state","$q","$timeout","AuthenticationFactory","ValidateResolve",function(a,b,c,d,e){return function(){var f=b.defer();return e().then(function(){d.isLogged?(f.reject(),c(function(){a.go("root.home")})):f.resolve()}),f.promise}}]),angular.module("dokuvis.utils",["mgcrea.ngStrap","pascalprecht.translate"]).factory("Utilities2",["$alert",function(a){var b={};return b.waitfor=function(a,c,d,e,f){return a()!==c?void setTimeout(function(){b.waitfor(a,c,d,e,f)},d):void f(e)},b.dangerAlert=function(b){a({content:b,type:"danger",duration:5})},b.throwException=function(b,c,d){a({title:b+":",content:c,type:"danger",duration:5}),console.error(b+": "+c,d,"\n"+(new Error).stack.split("\n")[2])},b.throwApiException=function(b,c){403===c.status&&(b="Access denied "+b+" ("+c.statusText+" "+c.status+")"),a({title:"API Exception:",content:b,type:"danger",duration:5}),console.error("API Exception: "+b,c,"\n"+(new Error).stack.split("\n")[2])},b}]).factory("ConfirmDialog",["$q","$alert",function(a,b){function c(c,f){var g={},h={};angular.extend(g,d,f),angular.extend(h,e,c),g.alertOptions=h;var i=a.defer();return g.controller=function(a){a.alertOptions=h,a.alertOptions.ok=function(){a.$hide(),i.resolve()},a.alertOptions.abort=function(){a.$hide(),i.reject()}},b(g),i.promise}var d={backdrop:"static",templateUrl:"components/dokuvis.utils/confirmAlert.tpl.4e097c8c.html",show:!0},e={abortButtonText:"abort",actionButtonText:"OK",headerText:"continue?",bodyText:"Sind Sie sicher?",type:"warning",translationData:{}};return function(a,b){return b||(b={}),c(a,b)}}]).directive("fileDropArea",["$timeout","$state",function(a,b){return{restrict:"AE",scope:{uploader:"=",label:"@"},link:function(c,d,e){a(function(){var a=angular.element(d);"uiSref"in e&&(a.find("input").remove(),c.uploader.onAfterAddingAll=function(){b.includes(e.uiSref)||b.includes("**"+e.uiSref)||b.go(e.uiSref)}),"multiple"in e&&a.find("input").attr("multiple",!0),"column"in e&&a.children().css("flex-direction","column")}),c.openFileDialog=function(){a(function(){angular.element(d).find("input").trigger("click")})}},template:'<div ng-if="uploader" data-uploader="uploader" nv-file-drop nv-file-over ng-click="openFileDialog()">\n\t<input type="file" ng-hide="1" data-uploader="uploader" nv-file-select ng-click="$event.stopPropagation()"/>\n\t<svg x="0px" y="0px" viewBox="0 0 10 10" enable-background="new 0 0 10 10" xml:space="preserve">\n\t\t<path d="M3.746,10V6.283H0V3.717h3.746V0h2.497v3.717H10v2.566H6.243V10H3.746z"/>\n\t</svg>\n\t<div>{{label|translate}}</div>\n</div>'}}]),angular.module("dokuvis.projects",["ngResource","ui.router","mm.acl"]).factory("Project",["$resource","ApiProject",function(a,b){return a(b+"/:id",{id:"@proj"},{update:{method:"PUT"}})}]).directive("projectList",["$window","$state","Project","Utilities","ConfirmDialog","$log",function(a,b,c,d,e,f){return{restrict:"E",templateUrl:"components/dokuvis.projects/projectList.tpl.d33c4d94.html",scope:{},link:function(g){function h(){c.query().$promise.then(function(a){g.projects=a})["catch"](function(a){d.throwApiException("#Project.query",a)})}g.projects=[],g.openProject=function(c){var d=b.href("project.home",{project:c,subproject:"master"});a.open(d,"_blank")},g.deleteProject=function(a){f.log("delete ",a),e({headerText:"Projekt löschen",bodyText:"Soll Projekt "+a.name+" wirklich gelöscht werden?"}).then(function(){a.$delete().then(function(a){f.debug(a),h()})["catch"](function(a){d.throwApiException("Project#delete",a)})})},h(),g.$on("projectsUpdate",function(){h()})}}}]).controller("projectModalCtrl",["$scope","$rootScope","$state","$stateParams","Project","Utilities","$log",function(a,b,c,d,e,f,g){function h(){e.get({id:d.projectId}).$promise.then(function(b){a.project=b})["catch"](function(a){f.throwApiException("#Project.get",a)})}function i(a){b.$broadcast("projectsUpdate",a)}a.project={name:"",description:""},"new"===d.projectId?a.title="project_new":(a.title="project_edit",h()),a.save=function(){return a.project.name.length?void("new"!==d.projectId?a.project.$update().then(function(){i(a.project),a.close()})["catch"](function(a){f.throwApiException("#Project.update",a)}):e.save(a.project).$promise.then(function(b){g.log(b),i(b),a.close()})["catch"](function(a){f.throwApiException("#Project.save",a)})):void f.dangerAlert("Geben sie dem Projekt einen Namen!")},a.close=function(){c.go("^")}}]).factory("ProjectResolve",["$q","$state","$rootScope","Project","AclService","$log",function(a,b,c,d,e,f){return function(g){return d.get({id:g.project}).$promise.then(function(d){return"NO_ENTRY"===d.status?(b.go("root.projectlist"),a.reject(d.status)):(c.userRole=d.role,e.attachRole("visitor"),"superadmin"===d.role?(e.attachRole("superadmin"),e.attachRole("admin"),e.attachRole("historian"),e.attachRole("modeler")):"admin"===d.role?e.attachRole("admin"):"historian"===d.role?e.attachRole("historian"):"modeler"===d.role&&e.attachRole("modeler"),void f.debug(e.getRoles()))})["catch"](function(b){return console.error("API Exception on Project.get()",b),a.reject(b)})}}]),angular.module("dokuvis.subprojects",["ngResource","mm.acl"]).factory("Subproject",["$resource","ApiParams","ApiSubproject",function(a,b,c){return a(c+"/:id",angular.extend({id:"@id"},b),{get:{method:"GET",cache:!0},update:{method:"PUT"}})}]).directive("subprojectList",["Subproject","Utilities","AclService",function(a,b,c){return{restrict:"E",templateUrl:"components/dokuvis.subprojects/subprojectList.tpl.9a582b8b.html",scope:{},link:function(d){function e(){a.query().$promise.then(function(a){d.subprojects=a})["catch"](function(a){b.throwApiException("#Subproject.query",a)})}d.can=c.can,d.subprojects=[],e(),d.$on("subprojectsUpdate",function(){e()})}}}]).controller("subprojectModalCtrl",["$scope","$rootScope","$state","$stateParams","Subproject","Utilities",function(a,b,c,d,e,f){function g(){e.get({id:d.subprojectId}).$promise.then(function(b){a.subproject=b})["catch"](function(a){f.throwApiException("#Subproject.get",a)})}function h(a){b.$broadcast("subprojectsUpdate",a)}a.subproject={name:"",description:""},"new"===d.subprojectId?a.title="subproject_new":(a.title="subproject_edit",g()),a.save=function(){return a.subproject.name.length?void("new"!==d.subprojectId?a.subproject.$update().then(function(b){h(b),a.close()})["catch"](function(a){f.throwApiException("#Subproject.update",a)}):e.save(a.subproject).$promise.then(function(b){h(b),a.close()})["catch"](function(a){f.throwApiException("#Subproject.save",a)})):void f.dangerAlert("Keinen Namen angegeben!")},a.close=function(){c.go("^")}}]).factory("SubprojectResolve",["$q","$state","Subproject",function(a,b,c){return function(d){return"master"===d.subproject?a.resolve():c.get({id:d.subproject,project:d.project}).$promise.then(function(c){if(!c.id)return b.go("project.home",{project:d.project,subproject:"master"}),a.reject("Subproject does not exist!")})["catch"](function(b){return console.error("API Exception on Subproject.check()",b),a.reject(b)})}}]),angular.module("dokuvis.projinfos",["ngResource","ui.router"]).factory("ProjInfo",["$resource","ApiParams","ApiProjinfo",function(a,b,c){return a(c+"/:id",angular.extend({id:"@id"},b),{update:{method:"PUT"},swap:{method:"PUT"}})}]).directive("projinfoList",["$rootScope","ProjInfo","Utilities","ConfirmDialog",function(a,b,c,d){return{restrict:"E",templateUrl:"components/dokuvis.projinfos/projinfoList.tpl.e64843c8.html",scope:{},link:function(e){function f(){b.query().$promise.then(function(a){e.infos=a})["catch"](function(a){c.throwApiException("#ProjInfo.query",a)})}function g(b){a.$broadcast("projinfosUpdate",b)}e.infos=[],e.filteredInfos=[],f(),e.removeProjInfo=function(a){d({headerText:"Info löschen",bodyText:"Soll die Info gelöscht werden?"}).then(function(){a.$delete().then(function(){g()})["catch"](function(a){c.throwApiException("#ProjInfo.delete",a)})})},e.swapInfoOrder=function(a,d){b.swap({from:e.filteredInfos[a].id,to:e.filteredInfos[d].id}).$promise.then(function(a){console.log(a),g()})["catch"](function(a){c.throwApiException("#ProjInfo.swap",a)})},e.$on("projinfosUpdate",function(){f()})}}}]).controller("projinfoModalCtrl",["$scope","$rootScope","$state","$stateParams","ProjInfo","Utilities",function(a,b,c,d,e,f){function g(){e.get({id:d.infoId}).$promise.then(function(b){i=b,a.input=b.value})["catch"](function(a){f.throwApiException("#ProjInfo.get",a)})}function h(a){b.$broadcast("projinfosUpdate",a)}a.input="";var i=null;"new"===d.infoId?a.title="Neue Info":(a.title="Info bearbeiten",g()),a.save=function(){return a.input.length?void(i?(i.value=a.input,i.$update().then(function(){h(),a.close()})["catch"](function(a){f.throwApiException("#ProjInfo.update",a)})):e.save({value:a.input}).$promise.then(function(){h(),a.close()})["catch"](function(a){f.throwApiException("#ProjInfo.save",a)})):void f.dangerAlert("Bitte geben Sie Text ein!")},a.close=function(){this.$hide(),this.$destroy(),c.go("^")}}]),angular.module("dokuvis.sources",["ngResource","ui.router","angularFileUpload","angularMoment","dokuvis.archives"]).factory("Source",["$resource","ApiParams","ApiSource","moment",function(a,b,c,d){return a(c+"/:id",angular.extend({id:"@id",type:"@type"},b),{save:{method:"POST",transformRequest:function(a){return angular.toJson(angular.extend(a,{date:d().format()}))}},update:{method:"PUT",transformRequest:function(a){return angular.toJson(angular.extend(a,{modificationDate:d().format()}))}},link:{method:"POST",url:c+"/connect"},getLinks:{method:"GET",url:c+"/connect",isArray:!0},spatialize:{method:"PUT",url:c+"/:id/spatial"},getSpatial:{method:"GET",url:c+"/:type/spatial"}})}]).factory("SourceUploader",["$window","$rootScope","ApiParams","ApiSource","FileUploader","Utilities","moment",function(a,b,c,d,e,f,g){function h(){b.$broadcast("sourcesUpdate")}var i={};a.localStorage.token&&(i["X-Access-Token"]=a.localStorage.token,i["X-Key"]=a.localStorage.user);var j=new e({headers:i,alias:"uploadSourceFile"}),k=["jpg","png","jpeg","bmp","gif","tiff"],l=["pdf"];return j.filters.push({name:"sourceFilter",fn:function(a){var b=a.type.slice(a.type.lastIndexOf("/")+1).toLowerCase();return k.concat(l).indexOf(b)!==-1}}),j.onWhenAddingFileFailed=function(a,b,c){console.warn("onWhenAddingFileFailed",a,b,c),f.dangerAlert("Nicht unterstütztes Format!")},j.onAfterAddingFile=function(a){console.info("onAfterAddingFile",a);var b=a.file.type.slice(a.file.type.lastIndexOf("/")+1);k.indexOf(b)!==-1?a.sourceType="plan":l.indexOf(b)!==-1&&(a.sourceType="text",a.language="de"),a.title="",a.author="",a.creationDate="",a.repros="",a.note="",a.formExtend=!1,a.creationPlace="",a.archive="",a.archiveNr="",a.primary=!1,a.tags=[],a.ocr=!1,a.resample=!1,a.errorInput=!1,a.isProcessing=!1},j.onProgressItem=function(a,b){100===b&&(a.isProcessing=!0)},j.onBeforeUploadItem=function(a){a.url=f.setUrlParams(d,c),a.formData=[],a.formData.push({sourceType:a.sourceType,date:g().format(),title:a.title,author:a.author,creationDate:a.creationDate,repros:a.repros,note:a.note,creationPlace:a.creationPlace,archive:a.archive,archiveNr:a.archiveNr,primary:a.primary,tags:a.tags.map(function(a){return a.text}),language:a.language,ocr:a.ocr,resample:a.resample})},j.onSuccessItem=function(a,b){console.log(a,b),a.isProcessing=!1,b instanceof Object&&!b.error||(console.error(b),a.isSuccess=!1,a.isError=!0,a.isUploaded=!1)},j.onErrorItem=function(a,b,c,d){console.error("onErrorItem",a,b,c,d),a.isProcessing=!1,a.isUploaded=!1,f.throwApiException("#source.create",b)},j.onCancelItem=function(a,b,c,d){console.warn("onCancelItem",a,b,c,d),a.isProcessing=!1},j.onCompleteAll=function(){h()},j}]).controller("sourceUploadModalCtrl",["$scope","$state","$stateParams","$timeout","API","SourceUploader","Archive","TypeaheadRequest","Utilities",function(a,b,c,d,e,f,g,h,i){function j(){g.query().$promise.then(function(b){a.archives=b})["catch"](function(a){i.throwApiException("#Archive.query",a)})}var k=a.uploader=f;a.checkAndUploadAll=function(){d(function(){for(var a=0,b=k.queue.length;a<b;a++){var c=k.queue[a];c.title.length?(c.errorInput=!1,c.isSuccess||c.upload()):(c.errorInput=!0,i.dangerAlert("Geben Sie mindestens einen Titel ein!"))}},1e3)},a.openFileDialog=function(a){d(function(){angular.element(a.delegateTarget).find("input").trigger("click")})},a.onTagAdded=function(a){a.text=a.text.toLowerCase()},a.getTags=function(a){return h.queryTags(a).then(function(a){return a})["catch"](function(a){i.throwApiException("#TypeaheadRequest.queryTags",a)})},a.archives=[],a.$on("archivesUpdate",function(){j()}),j(),a.close=function(){b.go("^.^")}}]).directive("sourcesList",["$rootScope","$state","SourcesCache","SourceUploader",function(a,b,c,d){return{templateUrl:"components/dokuvis.sources/sourcesList.tpl.102aeec3.html",restrict:"E",scope:{showUpload:"="},link:function(e){function f(b){a.$broadcast("spatialImageLoad",b)}e.options={orderBy:"title",filterBy:"",reverse:!1,listSize:"normal",activeTab:""},e.sc=c,c.reload(),e.sourceUploader=d,e.sourceUploader.onAfterAddingAll=function(){b.includes("**.upload.source")||b.includes("**.source.edit")||b.go(".upload.source")},e.selectSource=function(a,b){var c=angular.element(a.delegateTarget).find(".btn-bar"),d=angular.element(a.target);d.parent().is(c)||d.parent().parent().is(c)||(a.ctrlKey?a.delegateTarget!==a.target&&(b.selected=!b.selected):(e.sc.sources.forEach(function(a){a.selected=!1}),a.delegateTarget!==a.target&&(b.selected=!0)))},e.openSource=function(a,c){var d=angular.element(a.delegateTarget).find(".btn-bar"),e=angular.element(a.target);e.parent().is(d)||e.parent().parent().is(d)||b.go(".source.id",{sourceId:c.id})},e.load3DImage=function(a){f(a)}}}}]).factory("SourcesCache",["$rootScope","Source","Utilities",function(a,b,c){function d(a,b){for(var c=e.filtered.length,d=0;e.filtered[d].id!==a;)if(d++,d===c)return;return((d+b)%c+c)%c}var e={};return e.sources=[],e.filtered=[],e.reload=function(){b.query().$promise.then(function(a){a.forEach(function(a){a.selected=!1}),e.sources=a})["catch"](function(a){c.throwApiException("#Source.query",a)})},e.getPredecessorId=function(a){return e.filtered[d(a,-1)].id},e.getSuccessorId=function(a){return e.filtered[d(a,1)].id},a.$on("sourcesUpdate",function(){e.reload()}),e}]).controller("sourceDetailModalCtrl",["$scope","$rootScope","$state","$stateParams","$timeout","$http","Source","SourcesCache","Utilities","ConfirmDialog","$log",function(a,b,c,d,e,f,g,h,i,j,k){function l(b){g.get({id:b}).$promise.then(function(b){k.debug(b),b.id?(a.item=b,a.pageNr=0):a.close()})["catch"](function(a){i.throwApiException("#Source.get",a)})}function m(a){b.$broadcast("spatializeManualStart",a)}function n(a){b.$broadcast("sourcesUpdate",a)}a.iterable=!1,a.$watch(function(){return d.sourceId},function(b){b?l(b):e(function(){a.close()})}),a.$watch(function(){return h.filtered.length},function(b){a.iterable=c.includes("project.explorer")&&b>1}),a.prev=function(){c.go(c.current,{sourceId:h.getPredecessorId(a.item.id)},{notify:!1})},a.next=function(){c.go(c.current,{sourceId:h.getSuccessorId(a.item.id)},{notify:!1})},a.pageNr=0,a.nextPage=function(b){a.pageNr=((a.pageNr+b)%a.item.file.preview.length+a.item.file.preview.length)%a.item.file.preview.length},a.highlight=function(a){if("ocrx_word"===a.target.className){var b=$(".displayText").find(".ocr_page")[0].attributes.title.value.match(/bbox (\d+) (\d+) (\d+) (\d+);/),c=[b[1],b[2],b[3],b[4]];b=a.target.attributes.title.value.match(/^bbox (\d+) (\d+) (\d+) (\d+); x_wconf (\d+)$/);var d=[b[1],b[2],b[3],b[4]],e=$(".displayText").find("img"),f=Math.floor(d[0]*e.width()/c[2]),g=Math.ceil(d[2]*e.width()/c[2])-f+1,h=Math.floor(d[1]*e.height()/c[3]),i=Math.ceil(d[3]*e.height()/c[3])-h+1;$("#wordRect").css({left:f+"px",top:h+"px",width:g+"px",height:i+"px"})}},a.toggleConfidence=function(){a.showConfidence=!a.showConfidence;for(var b=$(".displayText").find(".ocrx_word"),c=0,d=b.length;c<d;c++)if(a.showConfidence){var e=b[c].attributes.title.value.match(/^bbox (\d+) (\d+) (\d+) (\d+); x_wconf (\d+)$/),f=e[5],g=Math.floor((f-50)/50*120);$(b[c]).css("background","hsl("+g+",100%,85%)")}else $(b[c]).css("background","none")},a.editText=function(){f.get("data/"+a.item.file.path+a.item.file.preview[a.pageNr]).then(function(b){console.log(b),a.editorInput=b.data,a.textEdit=!0})},a.saveText=function(){console.log(a.editorInput)},a.startSpatialize=function(){c.go("project.explorer"),m(a.item)},a["delete"]=function(){j({headerText:"Quelle löschen",bodyText:"Soll die Quelle wirklich gelöscht werden? Jegliche Metadaten, Referenzen und sich darauf beziehende Kommentare werden gelöscht."}).then(function(){a.item.$delete().then(function(b){k.debug(b),n(),a.close()})["catch"](function(a){i.throwApiException("#Source.delete",a)})})},a.$on("sourcesUpdate",function(b,c){c&&a.item.id===c.id&&l(c.id)}),a.close=function(){c.go("^.^")}}]).controller("sourceEditModalCtrl",["$scope","$rootScope","$window","$state","$stateParams","$timeout","FileUploader","moment","Source","Archive","ApiSource","ApiParams","Utilities","$log",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(){i.get({id:e.sourceId}).$promise.then(function(b){a.item=b})["catch"](function(a){m.throwApiException("#Source.get",a)})}function p(){j.query().$promise.then(function(b){n.debug(b),a.archives=b})["catch"](function(a){m.throwApiException("#Archive.query",a)})}function q(a){b.$broadcast("sourcesUpdate",a)}var r=["jpg","JPG","png","PNG","jpeg","bmp","gif","tiff"],s=["pdf"],t=a.uploader=new g({headers:{"X-Access-Token":c.localStorage.token,"X-Key":c.localStorage.user},alias:"updateSourceFile",url:m.setUrlParams(k,l)+"/"+e.sourceId+"/file",autoUpload:!0,removeAfterUpload:!0,queueLimit:1,filters:[{name:"sourceFilter",fn:function(a){var b=a.type.slice(a.type.lastIndexOf("/")+1);return r.concat(s).indexOf(b)!==-1}}],formData:[{date:h().format()}]});t.onWhenAddingFileFailed=function(a,b,c){console.warn("onWhenAddingFileFailed",a,b,c),m.dangerAlert("Nicht unterstütztes Format!")},t.onSuccessItem=function(b,c){a.item.file=c.file,q({id:e.sourceId})},t.onErrorItem=function(a,b){m.throwApiException("#Source.updateFile",b)},o(),p(),a.save=function(){if(n.debug(a.item),a.item){if(!a.item.title.length)return m.dangerAlert("Geben Sie der Quelle einen Titel"),void(a.titleError=!0);a.titleError=!1,a.item.tags=a.item.tags.map(function(a){return a.text}),a.item.$update().then(function(b){q(b),a.close()})["catch"](function(a){m.throwApiException("#Source.update",a)})}},a.openFileDialog=function(a){f(function(){angular.element(a.delegateTarget).find("input").trigger("click")})},a.onTagAdded=function(a){a.text=a.text.toLowerCase()},a.getTags=function(a){return TypeaheadRequest.queryTags(a).then(function(a){return a})["catch"](function(a){m.throwApiException("#TypeaheadRequest.queryTags",a)})},a.$on("archivesUpdate",function(){p()}),a.close=function(){t.clearQueue(),d.go("^")}}]),angular.module("dokuvis.archives",["ngResource","ui.router"]).factory("Archive",["$resource","ApiParams","ApiArchive",function(a,b,c){return a(c+"/:id",angular.extend({id:"@collection.id"},b),{update:{method:"PUT"}})}]).controller("archiveModalCtrl",["$scope","$rootScope","$state","$stateParams","Archive","Utilities","ConfirmDialog","$log",function(a,b,c,d,e,f,g,h){function i(){e.get({id:d.archiveId}).$promise.then(function(b){h.debug(b),a.archive.institution=b.institution.name,a.archive.abbr=b.institution.abbr,a.archive.collection=b.collection.name,k=b})["catch"](function(a){f.throwApiException("#Archive.get",a)})}function j(a){b.$broadcast("archivesUpdate",a)}a.archive={institution:"",abbr:"",collection:""};var k=null;"new"===d.archiveId?(a.title="archive_new",a["new"]=!0):(a.title="archive_edit",a["new"]=!1,i()),a.save=function(){return a.archive.institution.length?a.archive.collection.length?void("new"!==d.archiveId?(k.institution.name=a.archive.institution,k.institution.abbr=a.archive.abbr,k.collection.name=a.archive.collection,k.$update().then(function(){j(k),a.close()})["catch"](function(a){f.throwApiException("#Archive.update",a)})):e.save(a.archive).$promise.then(function(b){j(b),a.close()})["catch"](function(a){f.throwApiException("#Archive.save",a)})):void f.dangerAlert("Geben Sie der Kollektion einen Namen!"):void f.dangerAlert("Geben Sie der Institution einen Namen!")},a["delete"]=function(){g({headerText:"Archiv löschen",bodyText:"Soll das Archiv wirklich gelöscht werden? Verknüpfungen zu anderen Quellen werden ebenfalls gelöscht. Die Institution wird ebenfalls gelöscht, sollten es keine weiteren Kollektionen damit verknüpft sein."}).then(function(){k.$delete().then(function(b){h.debug(b),j(),a.close()})["catch"](function(a){f.throwApiException("#Archive.delete",a)})})},a.close=function(){c.go("^")}}]).component("archivesList",{bindings:{},templateUrl:"components/dokuvis.archives/archivesList.tpl.034d1b45.html",controller:["$scope","Archive","Utilities",function(a,b,c){function d(){b.query().$promise.then(function(b){a.archives=b})["catch"](function(a){c.throwApiException("#Archive.query",a)})}a.archives=[],this.$onInit=function(){d()},a.$on("archivesUpdate",function(){d()})}]}),angular.module("dokuvis.models",["ngResource","ui.router","angularFileUpload","angularMoment","pascalprecht.translate","ngTagsInput"]).factory("Model",["$http","API","$stateParams",function(a,b,c){return{getModels:function(){return a.get(b+"auth/project/"+c.project+"/"+c.subproject+"/models")},insert:function(d,e){return a.post(b+"auth/project/"+c.project+"/"+c.subproject+"/models",{formData:d,objDatas:e})},getConnections:function(d){return a.get(b+"auth/project/"+c.project+"/"+c.subproject+"/model/"+d+"/connect")},get:function(d){return a.get(b+"auth/project/"+c.project+"/model/"+d)},update:function(d){return a.put(b+"auth/project/"+c.project+"/model/"+d.obj.content,d)}}}]).factory("ModelVersion",["$resource","ApiParams","ApiModelVersion",function(a,b,c){return a(c+"/:id",angular.extend({id:"@id"},b),{queryModels:{url:c+"/:id/object",methed:"GET",isArray:!0}})}]).factory("DigitalObject",["$resource","ApiParams","ApiModelVersion",function(a,b,c){function d(a){for(var b=0;b<a.length;b++){var c=a[b];if(c.children||(c.children=[]),c.parent){var d=e(a,c.parent);d&&(d.children||(d.children=[]),d.children.push(new f(c)),a.splice(b,1),b--)}}return a}function e(a,b){for(var c=0;c<a.length;c++){if(a[c].id===b)return a[c];if(a[c].children){var d=e(a[c].children,b);if(void 0!==d)return d}}}var f=a(c+"/:versionId/object/:id",angular.extend({id:"@id",versionId:"@versionId"},b),{query:{method:"GET",isArray:!0,transformResponse:function(a){return d(angular.fromJson(a))}},update:{method:"PUT"}});return f}]).factory("Software",["$resource","ApiParams","ApiSoftware",function(a,b,c){return a(c+"/:id",angular.extend({id:"@id"},b))}]).factory("ModelUploader",["$window","$rootScope","ApiParams","ApiModelVersion","FileUploader","Utilities","moment",function(a,b,c,d,e,f,g){function h(a){b.$broadcast("modelUploadSuccess",a)}function i(a){b.$broadcast("modelUploadError",a)}var j={};a.localStorage.token&&(j["X-Access-Token"]=a.localStorage.token,j["X-Key"]=a.localStorage.user);var k=new e({headers:j,alias:"uploadModelFile",queueLimit:1}),l=["dae","zip"];return k.filters.push({name:"modelFilter",fn:function(a){var b=a.name.slice(a.name.lastIndexOf(".")+1).toLowerCase();return l.indexOf(b)!==-1}}),k.onWhenAddingFileFailed=function(a,b,c){"queueLimit"===b.name?(k.clearQueue(),k.addToQueue(a)):"modelFilter"===b.name?f.dangerAlert("error_file_nosupport"):(console.warn("onWhenAddingFileFailed",a,b,c),f.dangerAlert("error_unknown"))},k.onAfterAddingFile=function(a){a.isProcessing=!1},k.onProgressItem=function(a,b){100===b&&(a.isProcessing=!0)},k.onBeforeUploadItem=function(a){a.url=f.setUrlParams(d,c),a.formData=[],a.formData.push({date:g().format(),summary:a.commit.summary,note:a.commit.note,software:a.commit.software.map(function(a){return a.name}),predecessor:a.commit.parent}),a.showProgress=!0},k.onSuccessItem=function(a,b){a.isProcessing=!1,b instanceof Object&&!b.error?h(b):(a.isSuccess=!1,a.isError=!0,a.isUploaded=!1,f.throwApiException("#ModelVersion.upload",b),i(b))},k.onErrorItem=function(a,b,c,d){console.error("onErrorItem",a,b,c,d),a.isProcessing=!1,a.isUploaded=!1,f.throwApiException("#ModelVersion.upload",b),i(b)},k.onCancelItem=function(a,b,c,d){console.warn("onCancelItem",a,b,c,d),a.isProcessing=!1},k}]).controller("modelUploadModalCtrl",["$scope","$state","$stateParams","$timeout","ModelUploader","Software","Utilities",function(a,b,c,d,e,f,g){a.uploader=e,a.commit={summary:"",note:"",software:[]},a.parent=c.parent,a.$watch(function(){return e.queue[0]},function(b){b?a.fileitem=e.queue[0]:a.fileitem=null}),a.checkAndUpload=function(){if(a.fileitem){if(!a.commit.summary.length)return void g.dangerAlert("model_form_summary_missing");a.fileitem.commit=a.commit,a.fileitem.commit.parent=a.parent&&"root"!==a.parent.id?a.parent.id:null,a.fileitem.upload()}},a.searchSoftware=function(a){return f.query({search:a}).$promise.then(function(a){return a})["catch"](function(a){return g.throwApiException("#Software.query",a),[]})},a.close=function(){b.go("^.^")}}]).directive("versionGraph",["$rootScope","$state","ModelVersion","Utilities","moment","$log",function(a,b,c,d,e,f){return{templateUrl:"components/dokuvis.models/versionGraph.tpl.5fda3f2f.html",restrict:"E",scope:{},link:function(g){function h(){c.query().$promise.then(function(a){f.debug("versions:",a),a.unshift({id:"root",predecessor:null,summary:"root",created:{date:0}}),k=a,g.select(k[k.length-1])})["catch"](function(a){d.throwApiException("#ModelVersion.query",a)})}function i(a){var b=[].concat(a);b.push({id:"blind",predecessor:l?l.id:b[b.length-1].id,summary:"model_version_new",created:{date:e().format()}});var c=d3.stratify().id(function(a){return a.id}).parentId(function(a){return"root"===a.id?null:a.predecessor||"root"})(b),d=c.descendants().sort(function(a,b){return a.data.created.date?b.data.created.date&&a.data.created.date<b.data.created.date?-1:1:-1}),f=0,h={},i=0;d.forEach(function(a,b){var c=0,d=-1,e=0;if(a.parent){d=a.parent.index.row,e=a.parent.index.col,a.parent.children[0]===a&&(c=e);for(var g=1;g<a.parent.children.length;g++)a.parent.children[g]===a&&(c=e+ ++f,h[c]||(h[c]={}),h[c].start=d)}h[c]||(h[c]={start:b}),h[c].end=b,a.index={row:b,col:c,parentRow:d,parentCol:e},"blind"===a.data.id&&(i=a.index)});var j=Object.keys(h).length+(i.col===i.parentCol?1:0),k=[];c.each(function(a){for(var b=!1,c=[],d=0;d<j;d++)c.push([]);b="blind"===a.data.id,c[a.index.col].push({type:"node",css:"root"===a.data.id?"bg-root":b?"bg-blind":"bg-"+a.index.col%5}),"root"!==a.data.id&&c[a.index.col].push({type:"downtick",css:b?"line-blind":"line-"+a.index.col%5});var e=a.children||[];e.forEach(function(d){if(b="blind"===d.data.id,a.index.col===d.index.col)c[a.index.col].push({type:"uptick",css:b?"line-blind":"line-"+d.index.col%5});else{c[a.index.col].push({type:"sidetick",css:b?"line-blind":"line-"+d.index.col%5}),c[d.index.col].push({type:"corner",css:b?"line-blind":"line-"+d.index.col%5});for(var e=a.index.col+1;e<d.index.col;e++)c[e].push({type:"hline",css:b?"line-blind":"line-"+d.index.col%5})}});for(var f in h)+f!==a.index.col&&a.index.row>h[f].start&&a.index.row<h[f].end&&(b=i.col===+f&&i.parentRow<a.index.row,c[f].push({type:"vline",css:b?"line-blind":"line-"+f%5}));k.push({data:a.data,order:a.data.created.date||0,parent:a.parent,children:a.children,index:a.index,cells:c})}),g.versions=k}function j(b){a.$broadcast("modelVersionActive",b)}var k=null,l=null;h(),g.$on("modelUploadSuccess",function(){h()}),g.select=function(a){return f.debug(a),"blind"===a.id?void b.go(".upload.model",{parent:l}):(l&&(l.active=!1),l=a,l.active=!0,i(k),void j(a))}}}}]).directive("versionDetail",["$rootScope","DigitalObject","Utilities","$log",function(a,b,c,d){return{templateUrl:"components/dokuvis.models/versionDetail.tpl.e905822e.html",restrict:"E",scope:{},link:function(e){function f(b){a.$broadcast("modelQuerySuccess",b)}e.version=null,e.$on("modelVersionActive",function(a,b){e.version=b}),e.load=function(){(e.version||"root"!==e.version.id)&&b.query({versionId:e.version.id}).$promise.then(function(a){d.debug(a),f(a)})["catch"](function(a){c.throwApiException("#DigitalObject.query",a)})}}}}]),angular.module("dokuvis.comments",["ngResource","angularMoment"]).factory("Comment",["$resource","ApiParams","ApiComment","moment",function(a,b,c,d){return a(c+"/:id",angular.extend({id:"@id"},b),{save:{method:"POST",transformRequest:function(a){return angular.toJson(angular.extend(a,{date:d().format()}))}},queryTarget:{method:"GET",url:c+"/target/:targetId",isArray:!0}})}]).directive("commentSection",["Comment","Utilities",function(a,b){return{restrict:"E",templateUrl:"components/dokuvis.comments/commentSection.tpl.9704e136.html",scope:{target:"=",type:"="},link:function(c){function d(d){d&&c.type&&a.queryTarget({targetId:d}).$promise.then(function(a){console.log(a),c.comments=a})["catch"](function(a){
b.throwApiException("#Comment.queryTarget",a)})}c.commentInput="",c.$watch("target",d),c.postComment=function(){if(!(c.newCommentInput.length<1)){var d=c.type;["picture","plan","text"].indexOf(d)!==-1&&(d="source"),a.save({type:d,text:c.newCommentInput,targets:c.target}).$promise.then(function(a){console.log("newComment",a),c.newCommentInput="",a&&(a.answers=[],c.comments.push(a))})["catch"](function(a){b.throwApiException("#Comment.save",a)})}},c.postAnswer=function(c){c.newAnswerInput.length<1||a.save({type:"answer",text:c.newAnswerInput,targets:c.id}).$promise.then(function(a){c.newAnswerInput="",c.answering=!1,a&&c.answers.push(a)})["catch"](function(a){b.throwApiException("#Comment.save",a)})}}}}]),angular.module("dokuvis.categories",["ngResource","ngAnimate","ui.router","xeditable","minicolors"]).factory("Category",["$resource","ApiParams","ApiCategory","CategoryAttribute",function(a,b,c,d){function e(a){for(var b=angular.fromJson(a),c=0;c<b.length;c++)for(var e=0;e<b[c].attributes.length;e++)b[c].attributes[e]=new d(b[c].attributes[e]),b[c].attributes[e].cid=b[c].id;return b}return a(c+"/:cid",angular.extend({cid:"@id"},b),{query:{method:"GET",isArray:!0,transformResponse:e},update:{method:"PUT"}})}]).factory("CategoryAttribute",["$resource","ApiParams","ApiCategory",function(a,b,c){return a(c+"/:cid/attribute/:aid",angular.extend({cid:"@cid",aid:"@id"}),{update:{method:"PUT"}})}]).directive("categoryList",["$rootScope","Category","Utilities",function(a,b,c){return{restrict:"E",templateUrl:"components/dokuvis.categories/categoryList.tpl.038bc95c.html",scope:{},link:function(d){function e(){b.query().$promise.then(function(a){for(var b=0;b<a.length;b++)a[b].attributes.push({id:0,value:"<Nicht zugewiesen>"}),a[b].attributes.push({id:-1,value:"<Beibehalten>"});d.categories=a})["catch"](function(a){c.throwApiException("#Category#query",a)})}function f(b){a.$broadcast("categoryActivate",b)}d.categories=[];var g=!1;e(),d.assignAttribute=function(){},d.activateCategory=function(a){f(a),g=!0},d.$on("categoryUpdate",function(){e()})}}}]).directive("categoryConfig",["$rootScope","Category","CategoryAttribute","Utilities",function(a,b,c,d){return{restrict:"E",templateUrl:"components/dokuvis.categories/categoryConfig.tpl.838ee18b.html",scope:{},link:function(e){function f(){b.query().$promise.then(function(a){e.categories=a})["catch"](function(a){d.throwApiException("#Category.query",a)})}function g(b){a.$broadcast("categoryUpdate",b)}e.categories=[],e.minicolors={control:"wheel",opacity:!0,position:"bottom left",format:"rgb",changeDelay:200},f(),e.addCategory=function(){e.newCategory&&b.save({value:e.newCategory}).$promise.then(function(a){e.categories.push(a),e.newCategory="",g(a)})["catch"](function(a){d.throwApiException("#Category.save",a)})},e.updateCategory=function(a){a.$update().then(function(){g(a)})["catch"](function(a){d.throwApiException("#Category.update",a)})},e.removeCategory=function(a){a.$delegate().then(function(){e.categories.splice(e.categories.indexOf(a),1),g()})["catch"](function(a){d.throwApiException("#Category.delete",a)})},e.addAttribute=function(a){a.newAttribute&&c.save({cid:a.id,value:a.newAttribute,color:h()}).$promise.then(function(b){a.attributes.push(b),a.newAttribute="",g(a)})["catch"](function(a){d.throwApiException("#CategoryAttribute.save",a)})},e.updateAttribute=function(a){a.$update().then(function(){g()})["catch"](function(a){d.throwApiException("#CategoryAttribute.update",a)})},e.removeAttribute=function(a,b){b.$delete().then(function(){a.attributes.splice(a.attributes.indexOf(b),1),g()})["catch"](function(a){d.throwApiException("#CategoryAttribute.delete",a)})};var h=function(){for(var a="0123456789ABCDEF".split(""),b="#",c=0;c<6;c++)b+=a[Math.round(15*Math.random())];return b}}}}]).directive("categoryLegend",[function(){return{restrict:"E",templateUrl:"components/dokuvis.categories/categoryLegend.tpl.badbd329.html",scope:{},link:function(a,b,c){c.$addClass("ng-hide"),console.log("link",b,c),a.$on("categoryActivate",function(b,d){c.$removeClass("ng-hide"),a.category=d,console.log(d,a)}),a.$on("categoryDeactivate",function(){c.$addClass("ng-hide")}),a.hide=function(){c.$addClass("ng-hide")},a.show=function(){c.$removeClass("ng-hide")}}}}]),angular.module("dokuvis.tasks",["ngResource","ui.router","angularMoment","gantt","gantt.table","gantt.tree","gantt.groups","gantt.movable","gantt.tooltips","gantt.sortable"]).factory("Task",["$resource","ApiParams","ApiTask","moment",function(a,b,c,d){return a(c+"/:id",angular.extend({id:"@id"},b),{save:{method:"POST",transformRequest:function(a){return angular.toJson(angular.extend(a,{date:d().format()}))}},update:{method:"PUT",transformRequest:function(a){return angular.toJson(angular.extend(a,{date:d().format()}))}}})}]).directive("tasksGantt",["$rootScope","$timeout","$q","moment","Task","Subproject","Staff","Utilities","$log",function(a,b,c,d,e,f,g,h,i){return{restrict:"E",templateUrl:"components/dokuvis.tasks/tasksGantt.tpl.a18b596f.html",scope:{},link:function(j){function k(){if("task"===j.config.sort.primary)for(var a=0,c=j.data.length;a<c;a++)"staff"!==j.data[a].data.type&&(j.data[a].data.editors=u(j.data[a]));i.debug("final",j.data),b(function(){E.side.setWidth()})}function l(a){var b=[K.promise];a&&(b.push(m()),b.push(n()),b.push(o())),c.all(b).then(function(){j.data=[],J=null,"staff"===j.config.sort.primary&&t(),"task"===j.config.sort.primary&&p(),q()})}function m(){return f.query().$promise.then(function(a){i.debug("Projects",a),H=a})["catch"](function(a){h.throwApiException("#Subproject.query",a)})}function n(){return e.query().$promise.then(function(a){i.debug("Tasks",a),G=a})["catch"](function(a){h.throwApiException("#Task.query",a)})}function o(){g.query().$promise.then(function(a){i.debug("Staff",a),I=a,j.staff=I})["catch"](function(a){h.throwApiException("#Staff.query",a)})}function p(){H.forEach(function(a){var b={id:a.id,name:a.name,parent:void 0,data:{type:"project",resource:a},classes:[],active:!1};j.data.push(b)})}function q(){"task"===j.config.sort.primary?G.forEach(function(a){r(a,a.id,a.parent)}):"staff"===j.config.sort.primary&&I.forEach(function(a){G.forEach(function(b){for(var c=!1,d=0;d<b.editors.length;d++)if(b.editors[d].id===a.email){c=!0;break}if(c){var e=b.id+"_"+a.email;v(e)||(r(b,e,b.parent+"_"+a.email),s(b.parent,a.email))}})})}function r(a,b,c){var d={type:a.type,priority:a.priority,status:a.status,editors:[],resource:a},e={id:b,name:a.title,parent:c,data:d,classes:["task-group"],tasks:[],active:!1},f=[];f.push(y("priority",a.priority)),f.push(y("status",a.status));var g={id:b,name:a.title,from:a.from,to:a.to,data:d,classes:f,row:e,progress:40};e.tasks.push(g),j.data.push(e)}function s(a,b){var c=a+"_"+b;if(!v(c)){var d=w(a);if(d){var e={id:c,name:d.name,parent:b,data:{type:"project",resource:d},classes:[],active:!1};return void j.data.push(e)}d=x(a),d&&(r(d,c,d.parent+"_"+b),s(d.parent,b))}}function t(){I.forEach(function(a){var b={id:a.email,name:a.name,data:{type:"staff",resource:a},classes:["staff-row"]};j.data.push(b)})}function u(a){var b=[];a.data.resource&&a.data.resource.editors&&(b=b.concat(a.data.resource.editors));for(var c=F.descendants({model:a}),d=0,e=c.length;d<e;d++)c[d].model.data.resource&&c[d].model.data.resource.editors&&(b=b.concat(c[d].model.data.resource.editors));for(var f=0;f<b.length;f++)for(var g=f+1;g<b.length;g++)b[f].id===b[g].id&&b.splice(g--,1);return b}function v(a){for(var b=0,c=j.data.length;b<c;b++)if(j.data[b].id===a)return j.data[b]}function w(a){for(var b=0;b<H.length;b++)if(H[b].id===a)return H[b]}function x(a){for(var b=0;b<G.length;b++)if(G[b].id===a)return G[b]}function y(a,b){if("priority"===a)switch(b){case 1:return"task-priority-medium";case 2:return"task-priority-high";default:return"task-priority-low"}else if("status"===a)switch(b){case 1:return"task-status-done";default:return"task-status-todo"}}function z(a){i.debug(a);var b=a.model.data.resource,c=d(a.model.from).format(),e=d(a.model.to).format();b.from===c&&b.to===e||(b.from=c,b.to=e,i.debug(b.from,b.to),i.debug(b),b.$update()["catch"](function(a){h.throwApiException("#Task.update",a)}),"staff"===j.config.sort.primary&&l())}function A(a){a.active=!0,J=a,D(a.data.resource,a),C(a)}function B(a){a&&(a.active=!1,J=null,D(),C(a),j.$applyAsync())}function C(a){var b=a.classes.indexOf("active");if(a.active&&b===-1?a.classes.push("active"):a.active||b===-1||a.classes.splice(b,1),a.tasks)for(var c=0;c<a.tasks.length;c++){var d=a.tasks[c].classes.indexOf("active");a.active&&d===-1?a.tasks[c].classes.push("active"):a.active||d===-1||a.tasks[c].classes.splice(d,1);var e=a.tasks[c].classes.indexOf("task-status-done");a.data.status&&e===-1?a.tasks[c].classes.push("task-status-done"):a.data.status||e===-1||a.tasks[c].classes.splice(e,1)}}function D(b,c){a.$broadcast("taskActivate",b,c)}var E,F,G=[],H=[],I=[],J=null,K=c.defer(),L=void 0;j.data=[],j.config={date:{from:d().subtract(2,"weeks"),to:d().add(2,"weeks"),viewScale:"day"},filter:{row:""},sort:{primary:"task",secondary:[{name:"Name",value:"model.name"},{name:"Priority",value:["model.data.status","-model.data.priority","model.name"]},{name:"Von",value:["model.data.resource.from","model.name"]},{name:"Bis",value:["model.data.resource.to","model.name"]}],sortMode:"model.name"},gantt:{allowSideResizing:!0,autoExpand:"both",currentDate:"line",currentDateValue:d(),daily:!0,expandToWidth:!0,sideWidth:"min-width",taskOutOfRange:"truncate",rowContent:'\t\t\t\t\t<span ng-switch="row.model.data.type">\t\t\t\t\t\t<span ng-switch-when="project">\t\t\t\t\t\t\t<i class="btn-row fa fa-folder-open" ng-click="scope.openDescAndComments"></i>\t\t\t\t\t\t\t<b class="label-highlight" ng-click="scope.activateRow(row.model)">{{row.model.name | characters:30}}</b>\t\t\t\t\t\t\t<i class="btn-row fa fa-plus" bs-tooltip="tooltip[1]" ui-sref=".detail({taskId: \'new\', parent: {id: row.model.data.resource.id, name: row.model.name}})"></i>\t\t\t\t\t\t</span>\t\t\t\t\t\t<span ng-switch-when="task">\t\t\t\t\t\t\t<i class="btn-row" ng-class="row.model.hasData ? \'fa fa-envelope\' : \'glyphicon glyphicon-file\'" ng-click="scope.openDescAndComments(row)"></i>\t\t\t\t\t\t\t<span class="label-highlight" ng-click="scope.activateRow(row.model)">{{row.model.name | characters:30}}</span>\t\t\t\t\t\t\t<i class="btn-row fa fa-plus" bs-tooltip="tooltip[1]" ui-sref=".detail({taskId: \'new\', parent: {id: row.model.data.resource.id, name: row.model.name}})"></i>\t\t\t\t\t\t</span>\t\t\t\t\t\t<span ng-switch-when="staff">\t\t\t\t\t\t\t<i class="btn-row fa fa-user"></i>\t\t\t\t\t\t\t<b><u>{{row.model.name | characters:30}}</u></b>\t\t\t\t\t\t</span>\t\t\t\t\t</span>',taskContent:"{{task.model.name}}"},tree:{header:"Projektstruktur"},table:{columns:["model.data.editors"],headers:{"model.data.editors":"Bearbeiter"},headerContents:{"model.data.editors":'<i class="fa fa-users"></i>'},contents:{"model.data.editors":"{{ getValue() | asList:', ':true:'name' }}"}},groups:{display:"overview"},tooltips:{content:'{{task.model.name}}</br><small>{{task.isMilestone() === true && task.model.from.format("ll") || task.model.from.format("ll") + \' - \' + task.model.to.format("ll")}}</small>'}},j.registerApi=function(a){E=a,a.core.on.ready(j,function(){i.debug(a),F=a.tree.getHierarchy(),K.resolve(),a.data.on.change(j,k),a.tasks.on.moveEnd(j,z),a.tasks.on.resizeEnd(j,z)}),a.directives.on["new"](j,function(a,b,d){"ganttBody"===a?d.on("click",function(){B(J),L&&L.resolve()}):"ganttTask"===a?d.on("click",function(){L||(L=c.defer()),L.promise.then(function(){A(b.task.model.row),L=void 0})}):"ganttRow"===a&&d.on("click",function(){})})},j.activateRow=function(a){B(J),A(a)},j.updateSort=function(a){j.config.sort.primary=a,l()},j.updateViewScale=function(){var a=d(j.config.date.from),b=d(j.config.date.to);b.diff(a,"days")<35?j.config.date.viewScale="day":b.diff(a,"weeks")<20?j.config.date.viewScale="week":j.config.date.viewScale="month"},j.$on("tasksUpdate",function(){i.debug("event tasksUpdate"),l(!0)}),j.$on("taskStatusUpdate",function(a,b,c){C(c)}),l(!0)}}}]).directive("taskDetail",["$rootScope","Utilities","$log",function(a,b,c){return{restrict:"E",templateUrl:"components/dokuvis.tasks/taskDetail.tpl.5f89f0a9.html",scope:{},link:function(d){function e(b,c){a.$broadcast("taskStatusUpdate",b,c)}d.task=null;var f=null;d.setTaskStatus=function(a){var g=d.task;g&&f&&(a?g.status=1:g.status=0,g.$update().then(function(a){c.debug(a),f.data.status=g.status;for(var b=0;b<f.tasks.length;b++)f.tasks[b].status=g.status;e(g,f)})["catch"](function(a){b.throwApiException("#Task.update",a)}))},d.$on("taskActivate",function(a,b,e){c.debug(b,e),d.task=b,f=e})}}}]).controller("taskModalCtrl",["$scope","$state","$stateParams","moment","Task","Staff","Utilities","ConfirmService","$log",function(a,b,c,d,e,f,g,h,i){function j(){c.parent?(a.parentName=c.parent.name,m=c.parent.id):"master"===c.subproject?(a.attachNote="Aufgabe wird als Aufgabe des Hauptprojektes erstellt.",m=c.project):(a.attachNote="Aufgabe wird als Aufgabe des Unterprojektes erstellt.",m=c.subproject),a.task={title:"",description:"",from:d().format("YYYY-MM-DD"),to:d().add(1,"days").format("YYYY-MM-DD"),priority:0,editors:[]}}function k(){e.get({id:c.taskId}).$promise.then(function(b){i.debug(b),a.task={title:b.title,description:b.description,from:d(b.from).format("YYYY-MM-DD"),to:d(b.to).format("YYYY-MM-DD"),priority:b.priority,editors:b.editors,created:b.created,modified:b.modified},n=b})["catch"](function(a){g.throwApiException("#Task.get",a)})}function l(b){a.$root.$broadcast("tasksUpdate",b)}var m=null,n=null;"new"===c.taskId?(a.title="Neue Aufgabe",a.newTask=!0,j()):(a.title="Aufgabe bearbeiten",a.newTask=!1,k()),a.save=function(){if(!a.task.title.length)return void g.dangerAlert("Geben Sie der Aufgabe einen Namen!");if(!(a.task.from.length&&a.task.to.length&&d(a.task.from).isValid()&&d(a.task.to).isValid()))return void g.dangerAlert("Geben Sie ein korrektes Datum an!");if(n)n.title=a.task.title,n.description=a.task.description,n.from=d(a.task.from).format(),n.to=d(a.task.to).format(),n.priority=a.task.priority,n.editors=a.task.editors.map(function(a){return a.email||a.id}),n.$update().then(function(b){i.debug(b),l(n),a.close()})["catch"](function(a){g.throwApiException("#Task.update",a)});else{if(!m)return void g.throwException("Controller Exception",'"parent" is not set!');e.save({title:a.task.title,description:a.task.description,from:d(a.task.from).format(),to:d(a.task.to).format(),priority:a.task.priority,editors:a.task.editors.map(function(a){return a.email||a.id}),parent:m}).$promise.then(function(b){i.debug(b),l(b),a.close()})["catch"](function(a){g.throwApiException("#Task.save",a)})}},a["delete"]=function(){h({headerText:"Aufgabe löschen",bodyText:"Soll die Aufgabe <b>"+n.title+"</b> wirklich gelöscht werden? <br/> \t\t\t\t\tAlle Unteraufgaben gehen an die Oberaufgabe."}).then(function(){n.$delete().then(function(b){i.debug(b),l(),a.close()})["catch"](function(a){g.throwApiException("#Task.delete",a)})})},a.searchEditors=function(a){return f.query({search:a}).$promise.then(function(a){return a})["catch"](function(a){return g.throwApiException("#Staff.query",a),[]})},a.checkEditor=function(a){return!(!a.email&&!a.id)&&f.get({id:a.email||a.id}).$promise.then(function(a){return!!a.email})["catch"](function(a){return g.throwApiException("#Staff.get",a),!1})},a.close=function(){b.go("^")}}]),angular.module("dokuvis.staff",["ngResource"]).factory("Staff",["$resource","ApiParams","ApiStaff","ApiRoles",function(a,b,c,d){return a(c+"/:id",angular.extend({id:"@email"},b),{queryRoles:{url:d,method:"GET",isArray:!0}})}]).directive("staffList",["Staff","Utilities",function(a,b){return{restrict:"E",templateUrl:"components/dokuvis.staff/staffList.tpl.e6d79774.html",scope:{configArray:"<config"},link:function(c){function d(){a.query().$promise.then(function(a){c.staff=a})["catch"](function(a){b.throwApiException("#Task.query",a)})}c.config={edit:!1,remove:!1},angular.forEach(c.configArray,function(a){c.config[a]=!0}),c.staff=[],d(),c.$on("staffUpdate",function(){d()})}}}]).controller("staffModalCtrl",["$scope","$rootScope","$state","Staff","Utilities",function(a,b,c,d,e){function f(){d.queryRoles().$promise.then(function(b){a.roles=b})["catch"](function(a){e.throwApiException("#Staff.queryRoles",a)})}function g(a){b.$broadcast("staffUpdate",a)}a.title="Mitarbeiter/Beobachter hinzufügen",a.user="",a.role="visitor",a.save=function(){return a.user.length?void d.save({user:a.user,role:a.role}).$promise.then(function(b){console.log(b),g(b),a.close()})["catch"](function(a){if(a.data&&"string"==typeof a.data.originalErr)var b=a.data.originalErr;else b="#Staff.save";e.throwApiException(b,a)}):void e.dangerAlert("Geben sie dem Projekt einen Namen!")},f(),a.close=function(){c.go("^")}}]),angular.module("dokuvis.authors",["ngResource","pascalprecht.translate"]).factory("Author",["$resource","ApiParams","ApiAuthor",function(a,b,c){return a(c+"/:id",angular.extend({id:"@id"},b),{update:{method:"PUT"}})}]).directive("authorList",["Author","Utilities",function(a,b){return{restrict:"E",templateUrl:"components/dokuvis.authors/authorList.tpl.4bdacbb0.html",scope:{},link:function(c){function d(){a.query().$promise.then(function(a){c.authors=a})["catch"](function(a){b.throwApiException("#Author.query",a)})}c.authors=[],d(),c.$on("authorsUpdate",function(){d()})}}}]).controller("authorModalCtrl",["$scope","$rootScope","$state","$stateParams","Author","Utilities","ConfirmDialog",function(a,b,c,d,e,f,g){function h(){e.get({id:d.authorId}).$promise.then(function(b){a.name=b.name,j=b})["catch"](function(a){f.throwApiException("#Author.get",a)})}function i(a){b.$broadcast("authorsUpdate",a)}a.name="";var j=null;"new"===d.authorId?(a.title="author_new",a["new"]=!0):(a.title="author_delete",a["new"]=!1,h()),a.save=function(){return a.name.length?void(a["new"]?e.save({name:a.name}).$promise.then(function(b){i(b),a.close()})["catch"](function(a){f.throwApiException("#Author.save",a)}):(j.name=a.name,j.$update().then(function(){i(j),a.close()})["catch"](function(a){f.throwApiException("#Author.update",a)}))):void f.dangerAlert("Geben Sie dem Author einen Namen!")},a["delete"]=function(){g({headerText:"author_delete",bodyText:"author_delete_confirm",translationData:{name:j.name}}).then(function(){j.$delete().then(function(b){console.log(b),i(),a.close()})["catch"](function(a){f.throwApiException("#Author.delete",a)})})},a.close=function(){c.go("^")}}]),angular.module("dokuvis.viewport",["pascalprecht.translate","ngDebounceThrottle"]).directive("viewport",["$state","$window","$timeout","viewportCache","viewportSettings","webglInterface","$rootScope","$q","Utilities","Comment","ConfirmService","$debounce","$throttle","SpatializeInterface","$log","$compile","$animate",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){function r(a,r,s){function t(){Ca=r.width(),Da=r.height(),console.log("viewport size: ",Ca,Da),Ia=new THREE.CombinedCamera(Ca,Da,35,Sa,Ta,Sa,Ta),Ia.position.set(-100,60,100),Ga=d.scene,Ea=r.find("canvas"),Fa=new THREE.WebGLRenderer({antialias:!0,alpha:!1,preserveDrawingBuffer:!0,canvas:Ea.get(0)}),Fa.setClearColor(DV3D.Defaults.backgroundColor,1),Fa.setSize(Ca,Da),r.append(Fa.domElement),Ha=new THREE.OrbitControls(Ia,Fa.domElement),Ha.zoomSpeed=1,Ia.target=Ha.center,Ha.addEventListener("change",function(){rb(),v(Ia)}),Ja=d.directionalLight;var a=new THREE.LoadingManager;a.onProgress=u,a.onLoad=function(){ya()},Ka=new THREE.CTMLoader(a),La=new THREE.TextureLoader(a),Ea.on("mousedown",W),Ea.on("mousemove",X),Ea.on("mouseup",Y),r.on("mouseleave",Z),Ea.on("wheel",$),Ea.on("contextmenu",function(a){a.preventDefault()});var c=angular.element(b);c.on("keydown",_),c.on("keyup",aa),c.on("resize",Aa),Na=new DV3D.GizmoMove(10,2.5,1.2),Na.addEventListener("change",z),Oa=new DV3D.GizmoRotate(10),Oa.addEventListener("change",z),kb.forEach(function(a){a.addEventListener("change",qb),a.addEventListener("toggle",oa),a.addEventListener("focus",pa),a.addEventListener("select",qa)}),nb.forEach(function(a){a.addEventListener("change",qb),a.addEventListener("toggle",ha),a.addEventListener("select",qa),a.addEventListener("focus",pa)}),z(),v(Ia)}function u(b,c,d){a.$broadcast("viewportLoadProgress",b,c,d)}function v(b){a.$broadcast("viewportCameraMove",b)}function w(){for(var a=0,b=0,c=0,d=0;d<lb.length;d++){var e=lb[d];Potree.utils.computeTransformedBoundingBox(e.boundingBox,e.matrixWorld);if(!e.material._defaultIntensityRangeChanged){var f=e.pcoGeometry.root;if(null!==f&&f.loaded){var g=e.pcoGeometry.root.geometry.attributes;if(g.intensity){for(var h=g.intensity.array,i=[],j=0;j<h.length;j++)i.push(h[j]);i.sort();var k=parseInt(.75*(i.length-1)),l=i[k];l<=1?e.material.intensityRange=[0,1]:l<=256?e.material.intensityRange=[0,255]:e.material.intensityRange=[0,l]}}}e.material.clipMode=Za.clipMode,e.generateDEM=Za.generateDEM,e.minimumNodePixelSize=Za.minNodeSize,a+=e.numVisibleNodes,b+=e.numVisiblePoints,c+=e.progress;var m=e.material.classification,n=!1;for(var o in Za.classifications){var p=Za.classifications[o].visible?1:0;m[o]?m[o].w!==p&&(m[o].w=p,n=!0):m.DEFAULT?(m[o]=m.DEFAULT,n=!0):(m[o]=new THREE.Vector4(.3,.6,.6,.5),n=!0),n&&e.material.recomputeClassification()}}var q=Potree.updatePointClouds(lb,Ia,Fa);a=q.visibleNodes.length,b=q.numVisiblePoints}function x(){$a||(Ha.removeEventListener("change",z),$a=!0,z())}function y(){$a||(Ha.removeEventListener("change",z),$a=!0,z())}function z(){if($a&&(TWEEN.getAll().length?requestAnimationFrame(z):($a=!1,Ha.addEventListener("change",z))),TWEEN.update(),Ha&&Ha.update(),nb.forEach(function(a){a.object.updateTexture(a.object.withinLODRange(Ia.position))},!0),Ja){Ja.position.set(4,4,4);var b=(new THREE.Matrix4).makeRotationFromQuaternion(Ia.quaternion);Ja.position.applyMatrix4(b)}if(a.hud.spatialize&&n.markers3D.length)for(var c=0,d=n.markers3D.length;c<d;c++)n.markers3D[c].object.lookAt(Ia.position);A()}function A(){Fa&&Fa.render(Ga,Ia)}function B(a,b,c){c=c||!1;var d=new THREE.Vector3(a.x,a.y,Sa).unproject(Ia).sub(Ia.position).normalize();Ua.set(Ia.position,d);var e=Ua.intersectObjects(b,c);return e.length?e[0]:null}function C(a,b){var c=[];kb.forEach(function(a){"object"===a.type&&c.push(a.object)},!0),mb.forEach(function(a){c.push(a.object.mesh)},!0),nb.forEach(function(a){c.push(a.object.collisionObject)},!0);var d=B(a,c,!0);d?(o.debug(d),o.debug(kb.get(d.object.id)),d.object.entry instanceof DV3D.Entry?E(d.object.entry,b):d.object.parent.entry instanceof DV3D.Entry?E(d.object.parent.entry,b):o.warn("Raycast hit unknown object",d)):E(null,b)}function D(a,b,c){var d=new THREE.Vector3(a.x,a.y,.5).unproject(Ia),e=new THREE.Vector3(a.x,b.y,.5).unproject(Ia),f=new THREE.Vector3(b.x,b.y,.5).unproject(Ia),g=new THREE.Vector3(b.x,a.y,.5).unproject(Ia),h=new THREE.Vector3(0,0,.5).unproject(Ia),i=(new THREE.Vector3).subVectors(d,Ia.position),j=(new THREE.Vector3).subVectors(e,Ia.position),k=(new THREE.Vector3).subVectors(f,Ia.position),l=(new THREE.Vector3).subVectors(g,Ia.position),m=(new THREE.Vector3).subVectors(h,Ia.position),n=new THREE.Vector3(0,0,.5).unproject(Ia).add(m.clone().setLength(Ta)),o=(new THREE.Vector3).subVectors(n,Ia.position),p=(new THREE.Vector3).crossVectors(j,i).normalize(),q=(new THREE.Vector3).crossVectors(k,j).normalize(),r=(new THREE.Vector3).crossVectors(l,k).normalize(),s=(new THREE.Vector3).crossVectors(i,l).normalize(),t=m.clone().normalize(),u=o.clone().negate().normalize(),v=-p.dot(d),w=-q.dot(e),x=-r.dot(f),y=-s.dot(g),z=-t.dot(h),A=-u.dot(n),B=new THREE.Plane(p,v),C=new THREE.Plane(q,w),D=new THREE.Plane(r,x),F=new THREE.Plane(s,y),G=new THREE.Plane(t,z),H=new THREE.Plane(u,A),I=new THREE.Frustum(B,C,D,F,G,H);c||E(null,!1,!0),kb.forEach(function(a){if("object"===a.type&&Va.indexOf(a.object)===-1&&I.intersectsObject(a.object)){console.log("first check");for(var b=a.object.geometry.attributes.position.array,c=a.object.matrixWorld,d=0,e=b.length;d<e;d+=3){var f=new THREE.Vector3(b[d],b[d+1],b[d+2]);if(f.applyMatrix4(c),I.containsPoint(f)){console.log("second check"),E(a,!0);break}}}},!0)}function E(a,b,c){b=b||!1,c=c||!1,Va.length&&!b&&(Va.forEach(function(a){H(a)}),ia(),Va=[]),a&&!c&&Va.indexOf(a)===-1?(G(a),Va.push(a),a instanceof DV3D.PlanEntry&&ia(a.object,"move")):a&&!c&&Va.indexOf(a)!==-1&&(H(a),Va.splice(Va.indexOf(a),1),Ma&&Ma.object===a.object&&ia()),g.$applyAsync(),qb()}function F(){g.$broadcast("viewportSelectionChange",Va)}function G(a){a instanceof DV3D.ObjectEntry?(I(a),a.children.forEach(function(a){G(a)})):a instanceof DV3D.PlanEntry?a.object.select():a instanceof DV3D.ImageEntry&&a.object.select(),a.select(null,!0)}function H(a){a instanceof DV3D.ObjectEntry?(J(a),a.children.forEach(function(a){H(a)})):a instanceof DV3D.PlanEntry?a.object.deselect():a instanceof DV3D.ImageEntry&&a.object.deselect(),a.select(null,!1)}function I(a){if("object"===a.type){switch(e.shading){case"xray":a.object.material=pb.xraySelectionMat}a.edges&&(a.edges.material===pb.edgesMat?a.edges.material=pb.edgesSelectionMat:a.edges.material.color=pb.edgesSelectionMat.color)}}function J(a){if("object"===a.type){switch(e.shading){case"xray":a.object.material=pb.xrayMat}a.edges&&(a.edges.material===pb.edgesSelectionMat?a.edges.material=pb.edgesMat:a.edges.material.color=pb.edgesMat.color)}}function K(a){for(var b=0;b<Wa.length;b++)Wa[b]!==a&&(M(Wa[b]),Wa.splice(b,1),--b);a&&Wa.indexOf(a)===-1&&("object"===a.userData.type&&L(a),Wa.push(a))}function L(a){a.material=a.material.clone();var b=new THREE.Color(16776960);a.material.color.lerp(b,.2)}function M(a){switch(a.material.dispose(),Ya){case"grey":a.material=pb.defaultDoublesideMat;break;default:a.material=pb[a.userData.originalMat]}}function N(a,b){if(a!==b){var c="onlyEdges"===a&&"onlyEdges"!==b,d="onlyEdges"===b&&"onlyEdges"!==a,f="xray"===a&&"xray"!==b,g=e.showEdges&&"xray"===b;"custom"===b&&ta(),kb.forEach(function(b){switch(b.visible&&(c&&(b.parent?b.parent.object.remove(b.object):Ga.remove(b.object)),d&&(b.parent?b.parent.object.add(b.object):Ga.add(b.object)),f&&b.edges&&Ga.remove(b.edges),g&&b.edges&&Ga.add(b.edges)),a){case"color":b.object.material=pb[b.object.userData.originalMat];break;case"grey":b.object.material=pb.defaultDoublesideMat;break;case"transparent":b.object.material=pb.transparentMat;break;case"xray":Va.indexOf(b)!==-1?b.object.material=pb.xraySelectionMat:b.object.material=pb.xrayMat;break;default:b.object.material=pb[b.object.userData.originalMat]}}),z()}}function O(a){if(Ia){switch(a){case"perspective":Ia.toPerspective(),Ia.setZoom(1);break;case"top":Ia.toOrthographic(Ha.center),Ia.toTopView();break;case"front":Ia.toOrthographic(Ha.center),Ia.toFrontView();break;case"back":Ia.toOrthographic(Ha.center),Ia.toBackView();break;case"left":Ia.toOrthographic(Ha.center),Ia.toLeftView();break;case"right":Ia.toOrthographic(Ha.center),Ia.toRightView()}z()}}function P(a,b){Pa&&(Ga.remove(Pa),Pa.dispose(),Pa=null),Qa&&(Ga.remove(Qa),Qa.dispose(),Qa=null,ib=!1,K(null)),gb["default"]=!1,gb.rotate=!1,gb.pan=!1,gb.zoom=!1,a&&a in gb?gb[a]=!0:gb["default"]=!0,b!==!1&&Q(a),z()}function Q(b){a.$broadcast("viewportNavigationChange",b)}function R(a,b){for(var c=0;c<a.length;c++){var d=a[c].id,e=kb[d].mesh,f=kb[d].edges;"object"===a[c].type&&S(e,f,b),a[c].opacity=b,R(a[c].children,b)}}function S(a,b,c){1===c?(Va.indexOf(a)===-1?(a.material=pb[a.userData.originalMat],b&&(b.material=pb.edgesMat)):(a.material=pb.selectionMat,b&&(b.material=pb.edgesSelectionMat)),a.userData.modifiedMat=!1):a.userData.modifiedMat||(a.material=a.material.clone(),a.material.transparent=!0,a.material.depthWrite=!1,a.material.needsUpdate=!0,b&&(b.material=b.material.clone(),b.material.transparent=!0,b.material.depthWrite=!1,b.material.needsUpdate=!0),a.userData.modifiedMat=!0),a.material.opacity=c,b&&(b.material.opacity=c)}function T(a){var b=new THREE.Vector2;return b.x=a.offsetX/Ca*2-1,b.y=2*-(a.offsetY/Da)+1,b}function U(a){var b=Ca*(a.x+1)/2,c=Da*(-a.y+1)/2;return new THREE.Vector2(b,c)}function V(a,b){var c=U(a),d=U(b),e={};return b.x>a.x?(e.left=c.x,e.width=d.x-c.x):(e.left=d.x,e.width=c.x-d.x),b.y<a.y?(e.top=c.y,e.height=d.y-c.y):(e.top=d.y,e.height=c.y-d.y),e}function W(a){if(bb=a.button,_a=T(a),ab=a,gb["default"])if(0===a.button)if(a.shiftKey){var b=angular.element("<div/>",{id:"select-rectangle","class":"select-rectangle"});r.append(b),hb=!0}else Ia.inPerspectiveMode;else 1===a.button&&(Ha.onMouseDown(a.originalEvent,2),Ea.addClass("cursor_pan"),eb=!0);else gb.rotate?0===a.button&&Ia.inPerspectiveMode&&(Ha.onMouseDown(a.originalEvent,0),cb=!0):gb.pan?0===a.button&&(Ha.onMouseDown(a.originalEvent,2),eb=!0):gb.zoom&&0===a.button&&(Ha.onMouseDown(a.originalEvent,1),db=!0)}function X(a){a.preventDefault();var b=T(a);if(bb!==-1){new THREE.Vector2(a.originalEvent.movementX||a.originalEvent.mozMovementX||a.originalEvent.webkitMovementX||0,a.originalEvent.movementY||a.originalEvent.mozMovementY||a.originalEvent.webkitMovementY||0);cb||eb||db?Ha.onMouseMove(a.originalEvent):hb?r.find("#select-rectangle").css(V(_a,b)):0===bb&&Ia.inPerspectiveMode&&!_a.equals(b)&&(Ha.onMouseDown(ab.originalEvent,0),Ea.addClass("cursor_orbit"),cb=!0)}}function Y(a){bb=-1;var b=T(a);if(gb["default"])if(cb)Ha.onMouseUp(a.originalEvent),Ea.removeClass("cursor_orbit"),cb=!1;else if(eb)Ha.onMouseUp(a.originalEvent),Ea.removeClass("cursor_pan"),eb=!1;else if(db)Ha.onMouseUp(a.originalEvent),Ea.removeClass("cursor_zoom"),db=!1;else if(hb){if(r.find("#select-rectangle").remove(),hb=!1,0!==a.button)return;var c,d;b.x>_a.x&&b.y<_a.y||b.x<_a.x&&b.y>_a.y?(c=_a,d=b):(c=new THREE.Vector2(_a.x,b.y),d=new THREE.Vector2(b.x,_a.y)),D(c,d,a.ctrlKey),z()}else b.equals(_a)&&(C(b,a.ctrlKey),z());else(gb.rotate||gb.pan||gb.zoom)&&(2===a.button&&P(),(cb||eb||db)&&(Ha.onMouseUp(a.originalEvent),cb=eb=db=!1))}function Z(a){bb=-1,gb["default"]?cb?(Ha.onMouseUp(a.originalEvent),Ea.removeClass("cursor_orbit"),cb=!1):eb?(Ha.onMouseUp(a.originalEvent),Ea.removeClass("cursor_pan"),eb=!1):db?(Ha.onMouseUp(a.originalEvent),Ea.removeClass("cursor_zoom"),db=!1):hb&&(r.find("#select-rectangle").remove(),hb=!1):(gb.rotate||gb.pan||gb.zoom)&&(cb||eb||db)&&(Ha.onMouseUp(a.originalEvent),cb=eb=db=!1)}function $(a){a.preventDefault(),Ha.onMouseWheel(a.originalEvent)}function _(a){["INPUT","TEXTAREA"].indexOf(a.target.tagName)===-1&&Ha.onKeyDown(a.originalEvent)}function aa(a){if(["INPUT","TEXTAREA"].indexOf(a.target.tagName)===-1)switch(a.keyCode){case 70:O("front");break;case 76:O("left");break;case 80:O("perspective");break;case 84:O("top")}}function ba(){return{sData:Fa.domElement.toDataURL("image/jpeg"),cameraMatrix:Ia.matrix.toArray(),cameraFOV:Ia.fov,cameraCenter:Ha.center.toArray(),width:Ca,height:Da}}function ca(){fb=new DV3D.TorusMarker(.5),fb.addEventListener("change",z),Ga.add(fb),jb=!0}function da(){angular.forEach(n.markers3D,function(a){Ga.remove(a.object),a.object.dispose()}),n.markers3D.splice(0,n.markers3D.length),A(),a.$applyAsync()}function ea(a,b){if(!a.spatial)return h.reject("No spatial information");var c=nb.getByName(a.content);if(c&&b)nb.remove(c),Ga.remove(c.object),c.object.dispose();else if(c&&!b)return h.reject("Already loaded");o.debug(a);var d=h.defer(),e=new DV3D.ImagePane("data/"+a.file.path+a.file.texture,{width:a.file.width,height:a.file.height,ck:a.spatial.ck,offset:a.spatial.offset,preview:"data/"+a.file.path+a.file.texturePreview},10);e.onComplete=function(){qb(),d.resolve(g)};var f=(new THREE.Matrix4).fromArray(a.spatial.matrix);e.applyMatrix(f),Ga.add(e),e.name=a.spatial.content,e.userData.source=a,e.userData.type="image";var g=new DV3D.ImageEntry(e,a.title);return g.addEventListener("change",qb),g.addEventListener("toggle",ha),g.addEventListener("select",qa),g.addEventListener("focus",pa),nb.add(g),o.debug("ImagePane",e),d.promise}function fa(a){var b=new THREE.Vector3(0,0,(-100));b.applyQuaternion(a.quaternion),b.add(a.position),new TWEEN.Tween(Ia.position.clone()).to(a.position,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){Ia.position.copy(this)}).start(),new TWEEN.Tween(Ha.center.clone()).to(b,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){
Ha.center.copy(this)}).start(),new TWEEN.Tween({fov:Ia.fov}).to({fov:a.fov},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){Ia.fov=this.fov,Ia.updateProjectionMatrix()}).start(),y()}function ga(b){var c=b.mesh.geometry,d=b.mesh.matrixWorld,e=(new THREE.Quaternion).setFromRotationMatrix(d),g=new THREE.Vector3(c.attributes.normal.array[0],c.attributes.normal.array[1],c.attributes.normal.array[2]).applyQuaternion(e),h=c.boundingBox.clone().applyMatrix4(d),i=Ca/Da,j=Math.sqrt(Math.pow(h.max.x-h.min.x,2)+Math.pow(h.max.z-h.min.z,2))/2,k=(h.max.y-h.min.y)/2;(g.y>.707||g.y<-.707)&&(j=Math.sqrt(Math.pow(h.max.x-h.min.x,2)+Math.pow(h.max.y-h.min.y,2))/2,k=(h.max.z-h.min.z)/2),i<j/k&&(k=1/i*j);var l=k/Math.tan(Ia.fov/2*Math.PI/180),m=c.boundingSphere.center.clone().applyMatrix4(d),n=new THREE.Vector3;n.addVectors(m,g.setLength(l)),new TWEEN.Tween(Ia.position.clone()).to(n,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){Ia.position.copy(this)}).start(),new TWEEN.Tween(Ha.center.clone()).to(m,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){Ha.center.copy(this)}).onComplete(function(){Ia.toOrthographic(Ha.center),f.viewportSettings.cameraSel="Custom",a.$apply()}).start(),x()}function ha(a){var b=a.target;if(a.visible){if(Ga.getObjectById(b.object.id))return;Ga.add(b.object)}else Ga.remove(b.object),E(b,!1,!0);qb()}function ia(a,b,c){switch(Ma&&Ma.attachToObject(null),b){case"move":Ma=Na;break;case"rotate":Ma=Oa;break;default:Ma=null}Ma&&Ma.attachToObject(a,c)}function ja(a){return a.reduce(function(a,b){return a.then(function(){return ka(b)}).then(function(){return ja(b.children)})},h.resolve())}function ka(a){function b(b){if(Array.isArray(b)){var d=b;b=d[0],b.clearGroups(),b.addGroup(0,b.index.count,0);for(var e=1;e<d.length;e++){b.merge(d[e]);var f=d[e].index.count;b.addGroup(b.index.count-f,f,e),d[e].dispose()}b.name||(b.name=a.file.content.reduce(function(a,b){return a+b}))}else b.clearGroups(),b.addGroup(0,b.index.count,0),b.name||(b.name=a.file.content);if(b.name in ob||(ob[b.name]={mesh:b}),b.computeBoundingBox(),c.geometry=b,a.materials&&Array.isArray(a.materials)?1!==a.materials.length?(c.material=a.materials.map(la),c.userData.originalMat=a.materials.map(function(a){return a.id})):(c.material=la(a.materials[0]),c.userData.originalMat=a.materials[0].id):(c.material=pb.defaultDoublesideMat,c.userData.originalMat="defaultDoublesideMat"),a.file.edges&&!Array.isArray(a.file.edges))ma("data/"+a.file.path+a.file.edges).then(function(a){var d=new THREE.LineSegments(a,pb.edgesMat);d.matrix=c.matrixWorld,d.matrixAutoUpdate=!1,Ga.add(d),ob[b.name].edges=a,n.addEdges(d),sb()})["catch"](function(a){a&&i.throwException("Loading Error","Some error occurred while loading objects. See console for details.",a)});else if(a.file.edges&&Array.isArray(a.file.edges)){var g=[];a.file.edges.reduce(function(b,c){return b.then(function(){return ma("data/"+a.file.path+c).then(function(a){return g.push(a),h.resolve()})})},h.resolve()).then(function(){for(var a=g[0],d=1;d<g.length;d++)a.merge(g[d]),g[d].dispose();var e=new THREE.LineSegments(a,pb.edgesMat);e.matrix=c.matrixWorld,e.matrixAutoUpdate=!1,Ga.add(e),ob[b.name].edges=a,n.addEdges(e),sb()})["catch"](function(a){a&&i.throwException("Loading Error","Some error occurred while loading objects. See console for details.",a)})}sb()}var c,d=h.defer();switch(a.obj.type){case"group":c=new THREE.Group;break;case"object":c=new THREE.Mesh(ob.initGeo,pb.defaultMat);break;default:return d.reject("Unsupported type"),d.promise}var e=new THREE.Matrix4;if(e.fromArray(a.obj.matrix),"Z"===a.obj.up&&!a.parent){var f=new THREE.Matrix4;f.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),e.multiplyMatrices(f,e)}var g=new THREE.Vector3,j=new THREE.Quaternion,k=new THREE.Vector3;e.decompose(g,j,k);var l="number"==typeof a.obj.unit?a.obj.unit:1;a.parent||(g.multiplyScalar(l),k.multiplyScalar(l)),e.compose(g,j,k),c.applyMatrix(e),c.matrixAutoUpdate=!1,c.name=a.obj.content,c.userData.id=a.obj.content,c.userData.name=a.obj.name,c.userData.type=a.obj.type,c.userData.layer=a.obj.layer;var m=null;a.parent&&(m=Ga.getObjectByName(a.parent,!0)),m?m.add(c):Ga.add(c);var n=new DV3D.ObjectEntry(c);if(n.addEventListener("change",qb),n.addEventListener("toggle",oa),n.addEventListener("focus",pa),n.addEventListener("select",qa),kb.add(n),"object"===a.obj.type){var o=Array.isArray(a.file.content)?a.file.content.reduce(function(a,b){return a+b}):a.file.content;if(o in ob&&b(ob[o].mesh),Array.isArray(a.file.content)){var p=[];a.file.content.reduce(function(b,c){return b.then(function(){var b=h.defer();return Ka.load("data/"+a.file.path+c,function(a){p.push(a),b.resolve()},{useWorker:!1}),b.promise})},h.resolve()).then(function(){b(p)})}else Ka.load("data/"+a.file.path+a.file.content,b,{useWorker:!1})}return d.resolve(),d.promise}function la(a){if(a.name in pb)return pb[a.name];var b=new THREE.MeshLambertMaterial;return b.name=a.id,Array.isArray(a.diffuse)?(b.color=new THREE.Color(a.diffuse[0],a.diffuse[1],a.diffuse[2]),b.color.convertLinearToGamma()):"string"==typeof a.diffuse&&La.load("data/"+a.path+a.diffuse,function(a){b.map=a,b.needsUpdate=!0},null,function(a){o.warn("Couldn't load texture",a.path[0].src)}),a.alpha&&La.load("data/"+a.path+a.alpha,function(a){b.alphaMap=a,b.transparent=!0,b.needsUpdate=!0},null,function(a){o.warn("Couldn't load texture",a.path[0].src)}),b.side=THREE.DoubleSide,pb[a.name]=b,b}function ma(a){var b=h.defer();return JSZipUtils.getBinaryContent(a,function(a,c){return a?void b.reject(a):void JSZip.loadAsync(c).then(function(a){var b=a.file(/.+\.json$/i);return b[0].async("text")}).then(function(a){a=JSON.parse(a);var c=new Float32Array(a.data.attributes.position.array),d=new THREE.BufferGeometry;d.addAttribute("position",new THREE.BufferAttribute(c,3)),b.resolve(d)})["catch"](function(a){i.throwException("JSZip Error","Failed to load or extract zip file.",a),b.reject()})}),b.promise}function na(){[].concat(kb.list).forEach(function(a){a.object.parent.remove(a.object),a.edges&&Ga.remove(a.edges),kb.remove(a),a.dispose()});for(var a in ob)ob.hasOwnProperty(a)&&d.standardGeometries.indexOf(a)===-1&&(ob[a].mesh&&ob[a].mesh.dispose(),ob[a].edges&&ob[a].edges.dispose(),delete ob[a]);for(a in pb)pb.hasOwnProperty(a)&&d.standardMaterials.indexOf(a)===-1&&(pb[a].map&&pb[a].map.dispose(),pb[a].alphaMap&&pb[a].alphaMap.dispose(),pb[a].dispose(),delete pb[a]);z()}function oa(a){var b=a.target,c=b.parent?b.parent.object:Ga;if(a.visible&&b.parent&&!b.parent.visible&&(b.parent.visible=!0,oa({target:b.parent,visible:!0})),a.visible){if(c.getObjectById(b.object.id))return;c.add(b.object),e.showEdges&&b.edges&&Ga.add(b.edges)}else c.remove(b.object),e.showEdges&&b.edges&&Ga.remove(b.edges),E(b,!1,!0);qb()}function pa(a){if(a.target.object){var b=a.target.object;b instanceof DV3D.ImagePane?fa(b):b instanceof DV3D.Plan?ga(b):xa([a.target.object])}}function qa(a){E(a.target,a.originalEvent.ctrlKey)}function ra(a){for(var b=0;b<a.length;b++){var c=a[b].id;Ga.add(kb[c].edges),kb[c].visible=!0,ra(a[b].children)}}function sa(a){for(var b=0;b<a.length;b++){var c=a[b].id;Ga.remove(kb[c].edges),kb[c].visible=!1,sa(a[b].children)}}function ta(){g.$broadcast("categoryDeactivate")}function ua(a){var b=a.project(Ia),c=Ca*(b.x+1)/2,d=Da*(-b.y+1)/2;return new THREE.Vector2(c,d)}function va(){if(Va[0]&&"plan"===Va[0].userData.type){var a=Va[0];console.log(a);var b=5,c={top:[],bottom:[],left:[],right:[]},d=new THREE.Vector3(a.mesh.geometry.attributes.normal.array[0],a.mesh.geometry.attributes.normal.array[1],a.mesh.geometry.attributes.normal.array[2]).applyQuaternion(a.quaternion).normalize(),e=a.mesh.geometry.boundingBox.clone().applyMatrix4(a.matrixWorld);mb.forEach(function(f){if(f.object.id!==a.id){var g=f.object,h=new THREE.Vector3(g.mesh.geometry.attributes.normal.array[0],g.mesh.geometry.attributes.normal.array[1],g.mesh.geometry.attributes.normal.array[2]).applyQuaternion(g.quaternion).normalize(),i=g.mesh.geometry.boundingBox.clone().applyMatrix4(g.matrixWorld),j=(new THREE.Vector3).subVectors(i.max,i.min).multiply(d).length(),k=j/2+b,l=(new THREE.Vector3).subVectors(e.min,g.position),m=(new THREE.Vector3).subVectors(e.max,g.position);k+=h.dot(l)>h.dot(m)?l.projectOnVector(h).length():m.projectOnVector(h).length();var n="",o=new THREE.Vector3;if(h.x>.9?(n="right",o.set(1,0,0)):h.x<-.9?(n="left",o.set(-1,0,0)):h.z>.9?(n="bottom",o.set(0,0,1)):h.z<-.9&&(n="top",o.set(0,0,-1)),n){for(var p=0;p<c[n].length;p++)k+=c[n][p].height+b;c[n].push({name:g.name,height:j})}var q=g.position.clone(),r=g.position.clone().add((new THREE.Vector3).copy(h).multiplyScalar(k));r.add((new THREE.Vector3).subVectors(e.min,r).multiply(d));var s=g.quaternion.clone(),t=d.angleTo(h),u=g.quaternion.clone().multiply((new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(1,0,0),t));new TWEEN.Tween({t:0}).to({t:1,p:r},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){g.position.lerpVectors(q,r,this.t),THREE.Quaternion.slerp(s,u,g.quaternion,this.t)}).start()}},!0),x()}}function wa(){mb.forEach(function(a){var b=a.object,c=new THREE.Vector3,d=new THREE.Quaternion,e=new THREE.Vector3;b.userData.initMatrix.decompose(c,d,e);var f=b.position.clone(),g=b.quaternion.clone();new TWEEN.Tween({t:0}).to({t:1},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){b.position.lerpVectors(f,c,this.t),THREE.Quaternion.slerp(g,d,b.quaternion,this.t)}).start()}),x()}function xa(a){function b(a){for(var d=0;d<a.length;d++)b(a[d].children),"object"!==a[d].userData.type&&"plan"!==a[d].userData.type||c.push(a[d])}if(!(a.length<1)){var c=[];b(a),za(c)}}function ya(){var a=[];kb.forEach(function(b){"object"===b.type&&a.push(b.object)},!0),a.length<1||za(a)}function za(a){var b=0,c=0,d=0,e=0,f=0,g=0;a.forEach(function(a,h){var i=a.geometry.boundingBox.min.clone().applyMatrix4(a.matrixWorld),j=a.geometry.boundingBox.max.clone().applyMatrix4(a.matrixWorld);return 0===h?(b=i.x,d=i.y,f=i.z,c=j.x,e=j.y,void(g=j.z)):(i.x<b&&(b=i.x),i.y<d&&(d=i.y),i.z<f&&(f=i.z),j.x>c&&(c=j.x),j.y>e&&(e=j.y),void(j.z>g&&(g=j.z)))});var h=new THREE.Geometry;h.vertices.push(new THREE.Vector3(b,d,f)),h.vertices.push(new THREE.Vector3(c,e,g)),h.computeBoundingSphere();var i=(new THREE.Vector3).subVectors(Ia.position,Ha.center),j=h.boundingSphere.radius/Math.tan(Ia.fov/2*THREE.Math.DEG2RAD),k=(new THREE.Vector3).addVectors(h.boundingSphere.center,i.setLength(j));new TWEEN.Tween(Ia.position.clone()).to(k,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){Ia.position.copy(this)}).start(),new TWEEN.Tween(Ha.center.clone()).to(h.boundingSphere.center,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){Ha.center.copy(this)}).start(),y()}function Aa(){Ca=r.width(),Da=r.height(),o.debug("resize called",Ca,Da),Ia.setSize(Ca,Da),Ia.cameraP.updateProjectionMatrix(),Fa.setSize(Ca,Da),z()}var Ba=s.id||0;f.callFunc[Ba]={},n.callFunc[Ba]={},a.hud={navigation:"navToolbar"in s,axis:"axis"in s,focus:!1,move:!1,shading:!1,camera:!1,options:"optionToolbar"in s,spatialize:"spatialize"in s},angular.forEach(a.navToolbar,function(b){a.hud[b]=!0});var Ca,Da,Ea,Fa,Ga,Ha,Ia,Ja,Ka,La,Ma,Na,Oa,Pa,Qa,Ra="spatializeManual"in s,Sa=e.defaults.NEAR,Ta=e.defaults.FAR,Ua=new THREE.Raycaster,Va=[],Wa=[],Xa=[],Ya=f.viewportSettings.shadingSel,Za={clipMode:Potree.ClipMode.HIGHLIGHT_INSIDE,isFlipYZ:!1,useDEMCollisions:!1,generateDEM:!1,minNodeSize:100,edlStrength:1,edlRadius:1.4,useEDL:!1,classifications:{0:{visible:!0,name:"never classified"},1:{visible:!0,name:"unclassified"},2:{visible:!0,name:"ground"},3:{visible:!0,name:"low vegetation"},4:{visible:!0,name:"medium vegetation"},5:{visible:!0,name:"high vegetation"},6:{visible:!0,name:"building"},7:{visible:!0,name:"low point(noise)"},8:{visible:!0,name:"key-point"},9:{visible:!0,name:"water"},12:{visible:!0,name:"overlap"}}};Potree.pointBudget=5e5;var $a=!1,_a=new THREE.Vector2,ab=null,bb=-1,cb=!1,db=!1,eb=!1;a.navigation={"default":!0,rotate:!1,pan:!1,zoom:!1};var fb,gb=a.navigation,hb=!1,ib=!1,jb=!1,kb=d.objects,lb=[],mb=d.plans,nb=d.spatialImages,ob=d.geometries,pb=d.materials;c(function(){t()});m(w,500,!1,!0);f.callFunc.animate=function(){z()};var qb=l(z,50),rb=m(z,20),sb=m(z,500);if(a.$watch(function(){return Va.length},function(){F()}),f.callFunc.setSelected=function(a,b,c){E(a,b,c),z()},a.$on("viewportShadingChange",function(a,b,c){a.stopPropagation(),N(b,c)}),a.$on("viewportCameraChange",function(a,b){a.stopPropagation(),O(b)}),a.$on("viewportNavigationChange",function(b,c){b.targetScope!==a&&(b.stopPropagation(),P(c,!1))}),g.$watch(function(){return f.vizSettings.opacitySelected},function(a){for(var b=0;b<Va.length;b++){var c,d=Va[b];c="plan"===d.userData.type?mb[d.id].edges:kb[d.id].edges,d.userData.modifiedMat||(d.material=d.material.clone(),d.material.transparent=!0,d.material.depthWrite=!1,d.material.needsUpdate=!0,c.material=c.material.clone(),c.material.transparent=!0,c.material.needsUpdate=!0,d.userData.modifiedMat=!0),d.material.opacity=a/100,c.material.opacity=a/100}}),f.callFunc.setObjectOpacity=function(a,b){var c=kb[a.id].mesh,d=kb[a.id].edges;"object"===a.type&&S(c,d,b),a.opacity=b,R(a.children,b),z()},a.mousemoveOnPinLayer=function(a){if(ib&&Qa){var b=T(a),c=[];for(var d in kb)kb[d].visible&&c.push(kb[d].mesh);var e=Qa.mousehit(b.x,b.y,Ia,c);K(e)}},a.mouseupOnPinLayer=function(b){if(b.preventDefault(),ib&&Qa&&0===b.button){if(Wa[0]){for(var c=!1,d=0;d<a.snapshot.refObj.length;d++)if(a.snapshot.refObj[d].eid===Wa[0].userData.eid){c=!0;break}c||a.snapshot.refObj.push({eid:Wa[0].userData.eid,name:Wa[0].userData.name,pinMatrix:Qa.matrixWorld.toArray()})}console.log(a.snapshot.refObj)}0!==b.button&&2!==b.button||(a.setNavigationMode("select"),a.snapshot.mode="paint",a.$applyAsync())},f.callFunc.openSnapshot=function(){a.openSnapshot()},a.openSnapshot=function(){a.snapshot.paintOptions.width=Ca,a.snapshot.paintOptions.height=Da,a.snapshot.active=!0,a.snapshot.sIndex=0,a.snapshot.screenshots.push(ba())},f.callFunc.abortSnapshot=function(){k({headerText:"Vorgrang abbrechen",bodyText:"Snapshot nicht gespeichert! Fortfahren?"}).then(function(){a.snapshot.active=!1,a.snapshot.text="",a.snapshot.title="",a.snapshot.refObj=[],a.snapshot.refSrc=[],a.snapshot.screenshots=[],a.setNavigationMode("select")})},f.callFunc.saveSnapshot=function(){return a.snapshot.text.length?a.snapshot.title.length?(a.snapshot.screenshots[a.snapshot.sIndex].pData=r.find("#pwCanvasMain")[0].toDataURL("image/png"),void j.save({type:"model",text:a.snapshot.text,title:a.snapshot.title,targets:a.snapshot.refObj,refs:a.snapshot.refSrc,screenshots:a.snapshot.screenshots}).$promise.then(function(b){console.log("Comment.save",b),a.snapshot.active=!1,a.snapshot.text="",a.snapshot.title="",a.snapshot.refObj=[],a.snapshot.refSrc=[],a.snapshot.screenshots=[],a.setNavigationMode("select"),f.callFunc.updateComments()},function(a){i.throwApiException("on Comment.save()",a)})):void i.dangerAlert("Bitte geben Sie dem Kommentar einen Titel!"):void i.dangerAlert("Bitte geben Sie einen Text ein!")},f.callFunc.makeScreenshot=function(){var b=ba();a.screenshotCallback(b)},a.startMarking=function(){a.setNavigationMode(),a.snapshot.mode="pin",Qa=new DV3D.Pin(3,.5),Qa.addEventListener("change",z),Ga.add(Qa),ib=!0},a.startMeasuring=function(){a.setNavigationMode(),Pa=new DV3D.Measure(2),Pa.addEventListener("change",z),Ga.add(Pa),Pa.onComplete=function(b){a.measureDistance=b,a.$applyAsync()}},Ra){var tb=null;a.$on("spatializeManualStart",function(b,c){if(!angular.element(r).find("viewport-spatialize-manual").length){var d=a.$new(!1);d.source=c,tb=p("<viewport-spatialize-manual></viewport-spatialize-manual>")(d),q.enter(tb,r)}}),a.closeSpatializeManual=function(){q.leave(tb),tb=null}}a.setCameraFOV=function(a){return a&&(Ia.fov=a,Ia.updateProjectionMatrix(),rb()),Ia},a.$on("spatialImageLoad",function(a,b){Array.isArray(b)?b.forEach(function(a){ea(a)}):ea(b)}),f.callFunc[Ba].setImageView=fa,a.hud.spatialize&&(n.callFunc[Ba].loadSpatializeImage=loadSpatializeImage,n.callFunc[Ba].setImageView=fa,a.spatialize={markers:n.markers3D},a.startMarking=ca,a.clearMarkers=da),f.callFunc.load3DPlan=function(a){if(!mb.getByName(a.info.content)){var b=new DV3D.Plan("data/"+a.file.path+a.file.content,"data/"+a.info.materialMapPath+a.info.materialMap,a.info.scale);b.onComplete=function(){z()},Ga.add(b),b.name=a.info.content,b.userData.name=a.info.materialName,b.userData.source=a.source,b.userData.type="plan";var c=new DV3D.PlanEntry(b);b.entry=c,mb.add(c),console.log("Plan",b)}},f.callFunc.viewOrthoPlan=ga,f.callFunc.toggle=function(a,b){b?Ga.add(a):Ga.remove(a),qb()},a.internalCallFunc=a.callFunc||{},f.callFunc.getObjForPlans=function(a){if(mb.get(a)){for(var b=mb.get(a).mesh.geometry,c=mb.get(a).mesh.matrixWorld,d=[],e=b.index.count*b.index.itemSize,f=0;f<e;f+=3){for(var g=new THREE.Geometry,h=0;h<3;h++){var i=b.index.array[f+h]*b.attributes.position.itemSize,j=new THREE.Vector3(b.attributes.position.array[i],b.attributes.position.array[i+1],b.attributes.position.array[i+2]);g.vertices.push(j)}g.applyMatrix(c),g.computeBoundingBox();var k=new THREE.Mesh(g,pb.defaultMat);for(var l in kb)"group"!=kb[l].mesh.userData.type&&overlapAABB(kb[l].mesh,k)&&d.push(kb[l].mesh.userData.eid);g.dispose()}return{plan:mb.get(a).mesh.name,objs:d}}},f.callFunc.highlightObjects=function(a){E(null,!1,!0);for(var b=0;b<a.length;b++)for(var c in kb)if(kb[c].mesh.userData.eid===a[b].meshId){kb[c].mesh;E(kb[c].mesh,!0)}z()},a.$on("modelQuerySuccess",function(a,b){na(),Ka.manager.reset(),ja(b).then(function(){o.debug("objects loaded")})["catch"](function(a){i.throwException("Loading Error","An error occurred while loading objects. See concole for details.",a)})}),f.callFunc.resetScene=function(){for(var a in kb)if(kb.hasOwnProperty(a)){var b=kb[a],c=b.mesh.parent;c.remove(b.mesh),b.edges&&Ga.remove(b.edges),delete kb[a]}for(var a in ob)ob.hasOwnProperty(a)&&(ob[a].meshGeo&&ob[a].meshGeo.dispose(),ob[a].edgesGeo&&ob[a].edgesGeo.dispose(),delete ob[a]);z(),f.clearLists()},f.callFunc.selectObject=function(a,b,c){kb[a].visible&&E(kb[a].mesh,b,c),z()},f.callFunc.toggleObject=function(a,b){var c;c=a.parent?kb[a.parent.id].mesh:Ga;var d=c.getObjectById(a.id);b&&!d?(c.add(kb[a.id].mesh),Ga.add(kb[a.id].edges),kb[a.id].visible=!0,ra(a.children)):b||(c.remove(kb[a.id].mesh),Ga.remove(kb[a.id].edges),kb[a.id].visible=!1,sa(a.children)),z()},a.$on("categoryActivate",function(a,b){console.log(b),e.shading="custom",b.attributes.forEach(function(a){if(0!==a.id&&a.id!==-1){var b=a.color.match(/\d+(\.\d+)?/g),c=pb[a.id];c?c.color.setRGB(parseInt(b[0])/255,parseInt(b[1])/255,parseInt(b[2])/255):c=new THREE.MeshLambertMaterial({name:a.id,color:new THREE.Color(parseInt(b[0])/255,parseInt(b[1])/255,parseInt(b[2])/255),side:THREE.DoubleSide});var d=parseFloat(b[3]);1!==d?(c.transparent=!0,c.opacity=d):c.transparent=!1,pb[a.id]=c}}),angular.forEach(kb,function(a){var c=a.mesh.userData;"object"===c.type&&(c.categories[b.id]&&c.categories[b.id].attrId?a.mesh.material=pb[c.categories[b.id].attrId]:a.mesh.material=pb.defaultDoublesideMat)}),z()}),f.callFunc.addPin=function(a,b){if(!Xa[a]){var c=new DV3D.Pin(3,.5),d=b.pinMatrix;return c.applyMatrix((new THREE.Matrix4).set(d[0],d[4],d[8],d[12],d[1],d[5],d[9],d[13],d[2],d[6],d[10],d[14],d[3],d[7],d[11],d[15])),Ga.add(c),Xa[a]=c,z(),ua(new THREE.Vector3(d[12],d[13],d[14]))}},f.callFunc.removePin=function(a){Xa[a]&&(Ga.remove(Xa[a]),Xa[a].dispose(),delete Xa[a]),z()},f.callFunc.removePins=function(){for(var a in Xa)Ga.remove(Xa[a]),Xa[a].dispose();Xa=[],z()},f.callFunc.setScreenshotView=function(a){new TWEEN.Tween(Ia.position.clone()).to(new THREE.Vector3(a.cameraMatrix[12],a.cameraMatrix[13],a.cameraMatrix[14]),500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){Ia.position.copy(this)}).start(),new TWEEN.Tween(Ha.center.clone()).to(new THREE.Vector3(a.cameraCenter[0],a.cameraCenter[1],a.cameraCenter[2]),500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){Ha.center.copy(this)}).start(),x()},f.callFunc.resize=function(){Aa()},f.callFunc.explodePlans=va,f.callFunc.resetPlans=wa,f.callFunc.focusObject=function(a){function b(a){for(var c=0;c<a.length;c++)b(a[c].children),"object"===a[c].userData.type&&d.push(a[c])}var c=[kb[a].mesh],d=[];b(c),za(d)},a.$on("viewportFocusStart",function(a,b){if(!Ia.inOrthographicMode)switch(b){case"selected":xa(Va);break;default:ya()}}),a.$on("$destroy",function(){E(null,!1,!0),a.spatialize&&da(),delete n.callFunc[Ba],Ha.dispose();var c=angular.element(b);c.off("keydown",_),c.off("keyup",aa),c.off("resize",Aa),kb.forEach(function(a){a.removeEventListener("change",qb),a.removeEventListener("toggle",oa),a.removeEventListener("focus",pa),a.removeEventListener("select",qa)}),nb.forEach(function(a){a.removeEventListener("change",qb),a.removeEventListener("toggle",ha),a.removeEventListener("focus",pa),a.removeEventListener("select",qa)}),o.debug("destroy viewport directive")})}return{restrict:"E",replace:!1,transclude:!0,template:"<canvas ng-class=\"{'cursor_orbit': navigation.rotate, 'cursor_pan': navigation.pan, 'cursor_zoom': navigation.zoom}\"></canvas>\n<div class=\"viewport-extras\" ng-transclude></div>",scope:{callFunc:"=",screenshotCallback:"="},link:r}}]),angular.module("dokuvis.viewport").factory("viewportSettings",[function(){var a=[{value:"color",label:"Color"},{value:"grey",label:"Grey"},{value:"transparent",label:"Transparent"},{value:"onlyEdges",label:"Only edges"},{value:"xray",label:"X-Ray"},{value:"custom",label:"Custom"}],b=[{value:"perspective",label:"Perspective"},{value:"top",label:"Top"},{value:"front",label:"Front"},{value:"back",label:"Back"},{value:"left",label:"Left"},{value:"right",label:"Right"},{value:"custom",label:"Custom"}];return{defaults:{NEAR:1,FAR:4e3,initWidth:800,initHeight:600,backgroundColor:6710886,selectionColor:16535082,highlightColor:16777028,objectColor:14540253,edgeColor:3355443},shadings:a,cameras:b,shading:a[0].value,camera:b[0].value,showEdges:!0}}]).factory("viewportCache",["viewportSettings",function(a){var b=new THREE.Scene;b.fog=new THREE.Fog(a.defaults.backgroundColor,a.defaults.FAR-100,a.defaults.FAR),b.add(new THREE.GridHelper(100,10)),b.add(new THREE.AmbientLight(8947848));var c=new THREE.DirectionalLight(16777215,.7);c.position.set(-2,8,4),b.add(c);var d={};d.initGeo=new THREE.Geometry;var e={};e.defaultMat=new THREE.MeshLambertMaterial({name:"defaultMat",color:DV3D.Defaults.objectColor}),e.defaultDoublesideMat=new THREE.MeshLambertMaterial({name:"defaultDoublesideMat",color:DV3D.Defaults.objectColor,side:THREE.DoubleSide}),e.defaultUnsafeMat=new THREE.MeshLambertMaterial({name:"defaultUnsafeMat",color:11184810,transparent:!0,opacity:.5,depthWrite:!1}),e.selectionMat=new THREE.MeshLambertMaterial({name:"selectionMat",color:DV3D.Defaults.selectionColor,side:THREE.DoubleSide}),e.transparentMat=new THREE.MeshLambertMaterial({name:"transparentMat",color:13421772,transparent:!0,opacity:.5,depthWrite:!1}),e.transparentSelectionMat=new THREE.MeshLambertMaterial({name:"transparentSelectionMat",color:DV3D.Defaults.selectionColor,transparent:!0,opacity:.5,depthWrite:!1}),e.wireframeMat=new THREE.MeshBasicMaterial({name:"wireframeMat",color:DV3D.Defaults.edgeColor,wireframe:!0}),e.wireframeSelectionMat=new THREE.MeshBasicMaterial({name:"wireframeSelectionMat",color:DV3D.Defaults.selectionColor,wireframe:!0}),e.highlightMat=new THREE.MeshLambertMaterial({name:"highlightMat",color:16777028}),e.transparentHighlightMat=new THREE.MeshLambertMaterial({name:"transparentHighlightMat",color:16777028,transparent:!0,opacity:.5}),e.xrayMat=new THREE.ShaderMaterial({name:"xrayMat",side:THREE.DoubleSide,transparent:!0,depthWrite:!1,depthTest:!1,uniforms:{ambient:{type:"f",value:.05},edgefalloff:{type:"f",value:.1},intensity:{type:"f",value:1},vColor:{type:"c",value:new THREE.Color(0)}},vertexShader:THREE.XRayShader.vertexShader,fragmentShader:THREE.XRayShader.fragmentShader}),e.xraySelectionMat=new THREE.ShaderMaterial({name:"xraySelectionMat",side:THREE.DoubleSide,transparent:!0,depthWrite:!1,depthTest:!1,uniforms:{ambient:{type:"f",value:.05},edgefalloff:{type:"f",value:.3},intensity:{type:"f",value:1.5},vColor:{type:"c",value:new THREE.Color(DV3D.Defaults.selectionColor)}},vertexShader:THREE.XRayShader.vertexShader,fragmentShader:THREE.XRayShader.fragmentShader}),e.edgesMat=new THREE.LineBasicMaterial({name:"edgesMat",color:DV3D.Defaults.edgeColor}),e.edgesSelectionMat=new THREE.LineBasicMaterial({name:"edgesSelectionMat",color:DV3D.Defaults.selectionColor}),e.edgesHighlightMat=new THREE.LineBasicMaterial({name:"edgesHighlightMat",color:16777028});var f=new THREE.FontLoader,g={};return f.load("fonts/helvetiker_bold.typeface.json",function(a){g.HelvetikerBold=a}),THREE.DokuVisTray={scene:b,directionalLight:c,geometries:d,materials:e,standardGeometries:Object.keys(d),standardMaterials:Object.keys(e),fonts:g,objects:new DV3D.ObjectCollection,plans:new DV3D.Collection,spatialImages:new DV3D.Collection},THREE.DokuVisTray}]),angular.module("dokuvis.viewport").directive("viewportNavigation",["viewportSettings",function(a){return{templateUrl:"components/dokuvis.viewport/viewportNavigation.tpl.7c4de93d.html",restrict:"E",link:function(b){function c(a){b.$emit("viewportFocusStart",a)}function d(a,c){b.navigation["default"]=!1,b.navigation.rotate=!1,b.navigation.pan=!1,b.navigation.zoom=!1,a&&a in b.navigation?b.navigation[a]=!0:b.navigation["default"]=!0,b.$applyAsync(),c!==!1&&e(a)}function e(a){b.$emit("viewportNavigationChange",a)}function f(a,c){b.$emit("viewportShadingChange",a,c)}function g(a,c){b.$emit("viewportCameraChange",a,c)}var h=!0,i=!0;b.navigation={"default":!0,rotate:!1,pan:!1,zoom:!1},b.shadings=a.shadings,b.cameras=a.cameras,b.vpSettings=a,b.focus=function(a){c(a)},b.setNavigationMode=d,b.$on("viewportNavigationChange",function(a,c){a.targetScope!==b&&d(c,!1)}),b.$on("viewportShadingChange",function(a,c,d){a.targetScope!==b&&c!==d&&(b.vpSettings.shading=c,i=!1)}),b.$watch("vpSettings.shading",function(a,b){i?f(a,b):i=!0}),b.$on("viewportCameraChange",function(a,c,d){a.targetScope!==b&&c!==d&&(b.vpSettings.camera=c,h=!1)}),b.$watch("vpSettings.camera",function(a,b){h?g(a,b):h=!0})}}}]).directive("viewportAxis",["$timeout",function(a){return{restrict:"E",link:function(b,c){function d(){var a=c.width(),b=c.height();f=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),f.setSize(a,b),c.append(f.domElement),g=new THREE.OrthographicCamera(-a/2,a/2,b/2,-b/2,1,100),g.position.set(0,0,50),i=new THREE.AxisHelper(50),h=new THREE.Scene,h.add(i),e()}function e(){f.render(h,g)}var f,g,h,i;a(function(){d()});var j=b.$on("viewportCameraMove",function(a,b){g.rotation.copy(b.rotation),g.position.copy(b.getWorldDirection().negate().setLength(50)),e()});b.$on("$destroy",function(){i.geometry.dispose(),i.material.dispose(),j()})}}}]).directive("viewportLoadprogress",function(){return{template:'<div class="loadprogress-bar ng-hide" ng-show="visible" ng-style="{ width: progress + \'%\' }"></div>\n<div class="loadprogress-label ng-hide" ng-show="visible">{{ item }} &ndash; {{ loaded }} / {{ total }}</div>',restrict:"E",link:function(a){a.visible=!1,a.item="",a.loaded=0,a.total=0,a.progress=0;var b=a.$on("viewportLoadProgress",function(b,c,d,e){a.visible||(a.progress=d/e*100,a.visible=!0,a.$apply()),a.item=c,a.loaded=d,a.total=e,a.progress=d/e*100,100===a.progress&&(a.visible=!1)});a.$on("$destroy",function(){b()})}}}).directive("viewportSpatializeManual",["$rootScope","Utilities",function(a,b){return{templateUrl:"/components/dokuvis.viewport/viewportSpatializeManual.tpl.a378d1b6.html",restrict:"E",link:function(a,c){var d=null;a.opacity=50,a.fov=a.setCameraFOV().fov,a.$on("viewportCameraMove",function(b,c){a.fov=c.fov,d=c}),a.changeFOV=function(){d=a.setCameraFOV(a.fov)},a.save=function(){a.source&&(a.source.spatialize={matrix:d.matrixWorld.toArray(),offset:[0,0],ck:1/Math.tan(d.fov/2*THREE.Math.DEG2RAD)*.5},a.source.$spatialize({method:"manual"}).then(function(b){console.log(b),a.closeSpatializeManual()})["catch"](function(a){b.throwApiException("#Source.spatialize",a)}))},c.on("$destroy",function(){a.$destroy()})}}}]),angular.module("dokuvis.viewport").directive("viewportObjectTree",["viewportCache",function(a){return{templateUrl:"components/dokuvis.viewport/viewportObjectTree.tpl.470c308c.html",restrict:"E",link:function(b){b.objects=a.objects,b.layers=a.objects.layers,b.hierarchy=a.objects.hierarchy,b.showLayers=!1,b.showHierarchy=!0,b.switchTo=function(a){switch(a){case"layers":b.showLayers=!0,b.showHierarchy=!1;break;default:b.showLayers=!1,b.showHierarchy=!0}}}}}]).directive("viewportPlanList",["viewportCache",function(a){return{templateUrl:"components/dokuvis.viewport/viewportPlanList.tpl.045b9cac.html",restrict:"E",link:function(b){b.plans=a.plans}}}]).directive("viewportImageList",["viewportCache",function(a){return{templateUrl:"components/dokuvis.viewport/viewportImageList.tpl.383d7e29.html",restrict:"E",link:function(b){b.images=a.spatialImages}}}]),angular.module("dokuvisApp").directive("graphSearch",["$state","$stateParams","GraphVis","CidocDict","Utilities","$compile",function(a,b,c,d,e,f){function g(g,h,i){function j(){function a(){n.select(".linkPath").attr("d",function(a){return"M"+a.source.x+" "+a.source.y+"L"+a.target.x+" "+a.target.y}),n.select(".textPath").attr("d",function(a){return a.source.x<a.target.x?"M"+a.source.x+" "+a.source.y+"L"+a.target.x+" "+a.target.y:"M"+a.target.x+" "+a.target.y+"L"+a.source.x+" "+a.source.y}),q.attr("transform",function(a){return"translate("+a.x+","+a.y+")"})}function b(a){d3.select(this).classed("fixed",a.fixed=!0),g.selectedNode=a,r.indexOf(a.id)===-1&&r.push(a.id),c(),g.$apply()}function c(){for(var a=0;a<y.length;a++){var b=y[a];r.indexOf(b.source.id)!==-1&&r.indexOf(b.target.id)!==-1?d3.select("#link"+b.id).classed("opaque",!0):d3.select("#link"+b.id).classed("opaque",!1)}}function e(a){d3.select(this).select("circle").attr("fill",d3.rgb(d.getNodeColor(a.labels[0])).darker(.2));for(var b=0;b<y.length;b++){var c=y[b];a.id!==c.source.id&&a.id!==c.target.id||(d3.select("#node"+c.source.id).classed("highlight",!0),d3.select("#node"+c.target.id).classed("highlight",!0),d3.select("#link"+c.id).classed("highlight",!0))}}function i(a){d3.select(this).select("circle").attr("fill",d3.rgb(d.getNodeColor(a.labels[0]))),d3.selectAll(".node").classed("highlight",!1),d3.selectAll(".link").classed("highlight",!1)}function j(a){d3.event.preventDefault(),d3.select(this).classed("fixed",a.fixed=!1),r.splice(r.indexOf(a.id),1),c()}function k(a){var b=a.properties[d.getNodePropertyName(a.labels[0])]||a.properties.content;return b.length>20?b.substring(0,20)+"...":b}function l(a,b){a.each(function(a){a[b]=this.getBBox()})}function m(){var a=(new THREE.Vector2).subVectors(v,u);return a.setLength(200*Math.random()+100),a.rotateAround(new THREE.Vector2,Math.random()*Math.PI-Math.PI/2),a.add(v)}var n,q,r=[],s=h.width(),t=h.height(),u=new THREE.Vector2(s/2,t/2),v=new THREE.Vector2(s/2-10,t/2),w=d3.layout.force().size([s,t]).charge(-2e3).friction(.7).gravity(.08).linkDistance(200).linkStrength(.5),x=w.nodes(),y=w.links(),z=w.drag().on("dragstart",b),A=d3.select(h[0]).append("svg").attr("width",s).attr("height",t),B=A.append("defs");B.append("marker").attr({id:"arrow",viewBox:"0 -5 10 10",refX:35,refY:0,markerWidth:10,markerHeight:10,orient:"auto"}).append("path").attr("class","arrowHead").attr("d","M0,-5L10,0L0,5"),this.update=function(){n=A.selectAll(".link").data(y);var c=n.enter().insert("g","g.node").attr("class","link").attr("ng-style","{opacity: nodeTransparency / 100}").attr("id",function(a){return"link"+a.id}).call(function(){f(this[0].parentNode)(g)});c.append("path").attr("class","linkPath").attr("marker-end","url(#arrow)"),c.append("path").attr("class","textPath").attr("id",function(a){return"linkId_"+a.id}),c.append("text").attr("class","linkLabel").attr("text-anchor","middle").append("textPath").attr("xlink:href",function(a){return"#linkId_"+a.id}).attr("startOffset","50%").text(function(a){return d.getPropertyName(a.type);
}),n.exit().remove(),q=A.selectAll(".node").data(x);var h=q.enter().append("g").attr("class","node").attr("ng-style","{opacity: nodeTransparency / 100}").attr("id",function(a){return"node"+a.id}).on("mouseover",e).on("mouseleave",i).on("dblclick",this.onDblclick).on("contextmenu",j).call(z).call(function(){f(this[0].parentNode)(g)});h.append("circle").attr("class","nodeChild").attr("fill",function(a){return d.getNodeColor(a.labels[0])}).attr("r",25),h.append("text").attr("text-anchor","middle").attr("dy","-.5em").attr("class","title").text(function(a){return d.getClassName(a.labels[0])}).call(l,"bbox1"),h.insert("rect","text").attr("class","bg-text").attr("x",function(a){return a.bbox1.x}).attr("y",function(a){return a.bbox1.y}).attr("width",function(a){return a.bbox1.width}).attr("height",function(a){return a.bbox1.height}),h.append("text").attr("class","caption").attr("text-anchor","middle").attr("dy",".75em"),h.insert("rect","text").attr("class","bg-text bg-caption"),h.append("title").text(function(a){return a.properties.content}),q.exit().remove(),q.select(".caption").text(k).call(l,"bbox2"),q.select(".bg-caption").attr("x",function(a){return a.bbox2.x}).attr("y",function(a){return a.bbox2.y}).attr("width",function(a){return a.bbox2.width}).attr("height",function(a){return a.bbox2.height}),w.drag().on("dragstart",b),w.on("tick",a),w.start()},this.getData=function(){return{nodes:x,links:y}},this.addNode=function(a){if(void 0===this.findNode(a.id)){var b=m();return console.log(b),a.x=b.x,a.y=b.y,x.push(a),o[p].nodes.push(a.id),!0}return!1},this.addLink=function(a){return void 0===this.findLink(a.id)&&(a.source||(a.source=this.findNode(a.startNode)),a.target||(a.target=this.findNode(a.endNode)),y.push(a),!0)},this.removeNode=function(a){for(var b=0;b<x.length;b++)if(x[b].id===a)return x.splice(b,1),!0;return!1},this.removeLink=function(a){for(var b in y)if(y[b].id===a)return y.splice(b,1),!0;return!1},this.findNode=function(a){for(var b in x)if(x[b].id===a)return x[b]},this.findLink=function(a){for(var b in y)if(y[b].id===a)return y[b]},this.findLinkByType=function(a,b){for(var c in y)if((y[c].source===b||y[c].target===b)&&y[c].type===a)return y[c]},this.findLinkByNodeId=function(a){for(var b in y)if(y[b].source.id===a||y[b].target.id===a)return y[b]},this.setClickPosition=function(a){v.set(a.x,a.y)}}function k(a){s++,c.getNodeNeighbours(a).then(function(c){if(c.data.results[0]){var d=c.data.results[0].data;console.log(d);for(var e=0,f=0,h=0;h<d.length;h++){for(var i=d[h].graph.nodes,j=d[h].graph.relationships,k=0;k<i.length;k++)r.addNode(i[k])&&e++;for(var k=0;k<j.length;k++){var m=j[k],n=+m.startNode===a?m.endNode:m.startNode,o=r.findNode(n);l(o.labels[0],o);var p=m.type+"-"+o.labels[0];l(p,o,m)?e--:r.addLink(m)&&f++}}s--,(e||f)&&(0===s&&r.update(),g.selectedNode||(g.selectedNode=r.findNode(b.startNode))),console.log(r.getData())}},function(a){e.throwApiException("on GraphVis.getNodeNeighbours()",a)})}function l(a,b,c){return a in t?t[a](b,c):null}function m(a,b,d){s++,c.getNodeTitle(a.id,b).then(function(b){a.properties.title=b.data[d]||b.data.content,s--,0===s&&r.update()},function(a){e.throwApiException("on GraphVis.getNodeTitle()",a)})}function n(a,b,c){a.properties.title=b.properties[c]||b.properties.content,r.removeNode(b.id)}g.nodeTransparency=50;var o=[],p=0,q=!1,r=new j,s=0;r.onDblclick=function(b){r.setClickPosition(b),q=!0,a.go("project.graph.node",{startNode:b.id})},b.startNode&&(o.push({stateNode:b.startNode,nodes:[]}),k(+b.startNode)),g.$on("$stateChangeSuccess",function(a,b,c){if(console.log("graph state changed",c),c.startNode&&q)o.push({stateNode:c.startNode,nodes:[]}),p++,k(+c.startNode);else if(c.startNode&&!q&&p>0){for(var d=0;d<o[p].nodes.length;d++){var e=o[p].nodes[d];if(r.findNode(e)){for(var f;f=r.findLinkByNodeId(e);)r.removeLink(f.id);r.removeNode(e),r.update()}}o.splice(p,1),p--}q=!1});var t={};t.E21=function(a){a.properties.title||m(a,"E82","value")},t.E22=function(a){a.properties.title||(s++,c.getE22Name(+a.id).then(function(b){console.log(b),a.properties.title=b.data.name||b.data.content,s--,0===s&&r.update()},function(a){e.throwApiException("on GraphVis.getE22Name()",a)}))},t.E31=function(a){m(a,"E35","content")},t.E40=function(a){m(a,"E82","content")},t.E52=function(a){m(a,"E61","value")},t.E53=function(a){m(a,"E48","content")},t.E78=function(a){m(a,"E41","content")},t["P1-E41"]=function(a,b){return r.removeNode(a.id),!0},t["P1-E75"]=function(a,b){return r.removeNode(a.id),!0},t["P82-E61"]=function(a,b){var c=r.findNode(b.startNode);return n(c,a,"value"),!0},t["P102-E35"]=function(a,b){var c=r.findNode(b.startNode);return n(c,a,"content"),!0},t["P131-E82"]=function(a,b){var c=r.findNode(b.startNode);return n(c,a,"value"),!0},t["P129-E33"]=function(a,b){s++,c.getNodeNeighbours(+a.id).then(function(b){if(b.data.results[0]){for(var c=b.data.results[0].data,d=0;d<c.length;d++){for(var e=c[d].graph.nodes,f=c[d].graph.relationships,g=0;g<e.length;g++)r.addNode(e[g]);for(var g=0;g<f.length;g++){var h=f[g],i=h.startNode===a.id?h.endNode:h.startNode,j=r.findNode(i);l(j.labels[0],j),r.addLink(h)}}var k=r.findLinkByType("P3",a);k&&(a.properties.value=k.target.properties.value,r.removeNode(k.target.id),r.removeLink(k.id),s--,0===s&&r.update())}},function(a){e.throwApiException("on GraphVis.getNodeNeighbours()",a)})},t.E65=function(a){s++,c.getNodeNeighbours(+a.id).then(function(b){if(b.data.results[0]){var c=b.data.results[0].data;console.log(c);for(var d=0;d<c.length;d++){for(var e=c[d].graph.nodes,f=c[d].graph.relationships,g=0;g<e.length;g++)r.addNode(e[g]);for(var g=0;g<f.length;g++){var h=f[g],i=h.startNode===a.id?h.endNode:h.startNode,j=r.findNode(i);l(j.labels[0],j),r.addLink(h)}}var k=r.findLinkByType("P94",a),m=r.findLinkByType("P14",a),n=r.findLinkByType("P4",a),o=r.findLinkByType("P7",a);k&&m&&r.addLink({id:k.id+m.id,type:"P14a",startNode:k.target.id,source:k.target,endNode:m.target.id,target:m.target}),k&&n&&r.addLink({id:k.id+n.id,type:"P4a",startNode:k.target.id,source:k.target,endNode:n.target.id,target:n.target}),k&&o&&r.addLink({id:k.id+o.id,type:"P7a",startNode:k.target.id,source:k.target,endNode:o.target.id,target:o.target}),k&&r.removeLink(k.id),m&&r.removeLink(m.id),n&&r.removeLink(n.id),o&&r.removeLink(o.id),r.removeNode(a.id),s--,0===s&&r.update(),console.log(r.getData())}},function(a){e.throwApiException("on GraphVis.getNodeNeighbours()",a)})},t.E84=function(a){s++,c.getNodeNeighbours(+a.id).then(function(b){if(b.data.results[0]){var c=b.data.results[0].data;console.log(c);for(var d=0;d<c.length;d++){for(var e=c[d].graph.nodes,f=c[d].graph.relationships,g=0;g<e.length;g++)r.addNode(e[g]);for(var g=0;g<f.length;g++){var h=f[g],i=h.startNode===a.id?h.endNode:h.startNode,j=r.findNode(i);l(j.labels[0],j),r.addLink(h)}}var k=r.findLinkByType("P128",a),m=r.findLinkByType("P46",a);k&&m&&r.addLink({id:k.id+m.id,type:"P128a",startNode:k.target.id,source:k.target,endNode:m.source.id,target:m.source}),k&&r.removeLink(k.id),m&&r.removeLink(m.id),r.removeNode(a.id),s--,0===s&&r.update(),console.log(r.getData())}},function(a){e.throwApiException("on GraphVis.getNodeNeighbours()",a)})},t["P70-E33"]=function(a){s++,c.getNodeNeighbours(+a.id).then(function(b){if(b.data.results[0]){var c=b.data.results[0].data;console.log(c);for(var d=0;d<c.length;d++){for(var e=c[d].graph.nodes,f=c[d].graph.relationships,g=0;g<e.length;g++)r.addNode(e[g]);for(var g=0;g<f.length;g++){var h=f[g],i=h.startNode===a.id?h.endNode:h.startNode,j=r.findNode(i);l(j.labels[0],j),r.addLink(h)}}var k=r.findLinkByType("P70",a),m=r.findLinkByType("P72",a);k&&m&&r.addLink({id:k.id+m.id,type:"P72a",startNode:k.source.id,source:k.source,endNode:m.target.id,target:m.target}),k&&r.removeLink(k.id),m&&r.removeLink(m.id),r.removeNode(a.id),s--,0===s&&r.update(),console.log(r.getData())}},function(a){e.throwApiException("on GraphVis.getNodeNeighbours()",a)})}}return{restrict:"A",templateUrl:"app/directives/graphSearch/graphSearch.html",link:g}}]),angular.module("dokuvisApp").directive("ngThumb",["$window",function(a){var b={support:!(!a.FileReader||!a.CanvasRenderingContext2D),isFile:function(b){return angular.isObject(b)&&b instanceof a.File},isImage:function(a){var b="|"+a.type.slice(a.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|gif|".indexOf(b)!==-1}};return{restrict:"A",template:"<canvas/>",link:function(a,c,d){function e(a){var b=new Image;b.onload=f,b.src=a.target.result}function f(){var a=g.width||this.width/this.height*g.height,b=g.height||this.height/this.width*g.width;h.attr({width:a,height:b}),h[0].getContext("2d").drawImage(this,0,0,a,b)}if(b.support){var g=a.$eval(d.ngThumb);if(b.isFile(g.file)&&b.isImage(g.file)){var h=c.find("canvas"),i=new FileReader;i.onload=e,i.readAsDataURL(g.file)}}}}}]),angular.module("dokuvisApp").directive("rampSlider",["$document","$throttle",function(a,b){return{require:"ngModel",template:"<div ng-style=\"{width: rsModel*100+'%'}\"></div>",link:function(c,d,e,f){function g(b){h(b),a.off("mousemove",k),a.off("mouseup",g)}function h(a){c.rsModel=parseFloat(((a.pageX-d.offset().left)/d[0].offsetWidth).toFixed(2)),c.rsModel>.9?c.rsModel=1:c.rsModel<.1&&(c.rsModel=0),f.$setViewValue(c.rsModel)}var i=e.rsColor||"#aaa",j=e.rsColorEnd||i,k=b(function(a){h(a)},100);d.css("position","relative"),d.find("div").css({position:"absolute",top:0,bottom:0,background:"linear-gradient(to right, "+i+", "+j+")"}),d.on("mousedown",function(b){b.preventDefault(),a.on("mousemove",k),a.on("mouseup",g)}),c.$watch(function(){return f.$modelValue},function(a){c.rsModel=a})}}}]),angular.module("dokuvisApp").directive("imageViewer",["$document","$window","$timeout","SpatializeInterface","$debounce",function(a,b,c,d,e){return{restrict:"E",templateUrl:"app/directives/imageViewer/imageViewer.html",scope:{source:"=src",options:"=options"},link:function(f,g,h){function i(){B=new THREE.Scene,C=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),C.setClearColor(16777215,0),C.setSize(v,w),g.append(C.domElement),D=new THREE.PerspectiveCamera(2*A*180/Math.PI,y,.01,500),D.lookAt(new THREE.Vector3(0,0,(-1)));var a=new THREE.PlaneBufferGeometry(1,1,1,1),b=new THREE.MeshBasicMaterial;F=new THREE.Mesh(a,b),F.position.set(0,0,-1),E=angular.element(C.domElement),E.on("mousedown",l),E.on("mousemove",n),E.on("mousewheel",o),E.on("DOMMouseScroll",o),E.on("contextmenu",function(a){a.preventDefault()}),I=!0,k()}function j(a){["jpg","png"].indexOf(a.split(".").pop())!==-1&&(J=!0,console.log("source:",a),I&&(K||(B.add(F),K=!0),R.load(a,function(a){x=f.options&&f.options.width&&f.options.height?f.options.width/f.options.height:a.image.width/a.image.height,f.spatialize&&(d.imageWidth=f.options.width||a.image.width,d.imageHeight=f.options.height||a.image.height),F.geometry.dispose(),F.geometry=new THREE.PlaneBufferGeometry(x,1,1,1),F.material.map&&F.material.map.dispose(),F.material.map=a,F.material.needsUpdate=!0,q()},null,function(){console.error("ImageViewer: Couldn't load texture!")})))}function k(){C.render(B,D)}function l(a){a.preventDefault(),(0===a.button&&!M||1===a.button)&&(L=!0)}function m(a){if(!L||0!==a.button&&1!==a.button){if(0===a.button&&M){var b=H;G.setNumber(d.markers2D.length+1),d.markers2D.push({object:G,u:b.x,v:b.y,x:(b.x-.5)*x,y:b.y-.5}),M=!1,G=null,k(),f.$applyAsync()}}else L=!1}function n(a){if(a.preventDefault(),L)F.translateX(a.originalEvent.movementX*N*-F.position.z),F.translateY(a.originalEvent.movementY*N*F.position.z),p(),k();else if(M){var b=new THREE.Vector2;b.x=a.offsetX/v*2-1,b.y=2*-(a.offsetY/w)+1,s(b),k()}}function o(a){if(a.deltaY>0){var b=-O*F.position.z;if(F.position.z+b>P)return;F.translateZ(b),p(),k()}else a.deltaY<0&&(b=O*F.position.z,F.position.z+b<=Q&&(b=Q-F.position.z),F.translateZ(b),p(),k())}function p(){var a=Math.abs(F.position.z)*Math.tan(z),b=Math.abs(F.position.z)*Math.tan(A),c=2*a,d=2*b,e=Math.abs(F.position.x-x/2)+Math.abs(F.position.x+x/2),f=Math.abs(F.position.y-.5)+Math.abs(F.position.y+.5);x<y&&c>e?(a<F.position.x+x/2&&F.translateX(a-(F.position.x+x/2)),-a>F.position.x-x/2&&F.translateX(-a-(F.position.x-x/2))):(a>F.position.x+x/2&&F.translateX(a-(F.position.x+x/2)),-a<F.position.x-x/2&&F.translateX(-a-(F.position.x-x/2))),x>y&&d>f?(b<F.position.y+.5&&F.translateY(b-(F.position.y+.5)),-b>F.position.y-.5&&F.translateY(-b-(F.position.y-.5))):(b>F.position.y+.5&&F.translateY(b-(F.position.y+.5)),-b<F.position.y-.5&&F.translateY(-b-(F.position.y-.5)))}function q(){if(x<y)F.position.set(0,0,-1),Q=-1;else{var a=x/2/Math.tan(z);F.position.set(0,0,-a),Q=-a}k()}function r(){G=new DV3D.TorusMarker(.008),G.addEventListener("change",k),F.add(G),M=!0}function s(a){var b=new THREE.Vector3(a.x,a.y,.5).unproject(D),c=new THREE.Raycaster(D.position,b.sub(D.position).normalize()),d=c.intersectObject(F);if(d[0]){var e=d[0].uv;H=e,G.position.set(e.x*x-x/2,e.y-.5,0)}}function t(){angular.forEach(d.markers2D,function(a){F.remove(a.object),a.object.dispose()}),d.markers2D.splice(0,d.markers2D.length),k(),f.$applyAsync()}function u(a,b){v=a||g.width(),w=b||g.height(),y=v/w,z=Math.atan(.5*y),A=Math.atan(.5);var c=F&&F.position.z===Q;Q=x&&x>y?-(x/2)/Math.tan(z):-1,D&&(D.aspect=y,D.updateProjectionMatrix()),C&&(C.setSize(v,w),F&&c?q():k())}angular.element(g).css("overflow","hidden"),"spatialize"in h&&(f.spatialize={markers:d.markers2D});var v,w,x,y,z,A,B,C,D,E,F,G,H,I=!1,J=!1,K=!1,L=!1,M=!1,N=.0015,O=.1,P=-.05,Q=-1,R=new THREE.TextureLoader;a.on("mouseup",m),angular.element(b).on("resize",function(){f.$applyAsync()});var S=e(function(){u()},200,!1,!1);f.$watch(function(){S()}),f.$watch("source",j),c(function(){u(),i(),J&&j(f.source)}),f.spatialize&&(f.startMarking=r,f.clearMarkers=t),f.$on("$destroy",function(){F&&(F.geometry.dispose(),F.material.map&&F.material.map.dispose(),F.material.dispose()),C&&C.dispose(),f.spatialize&&t(),a.off("mouseup",m),angular.element(b).off("resize",u),console.log("destroy imageViewer directive")})}}}]),angular.module("dokuvisApp").controller("homeCtrl",["$scope",function(a){}]),angular.module("dokuvisApp").controller("navCtrl",["$scope","$state","UserAuthFactory","Utilities",function(a,b,c,d){a.user={email:"",password:""},a.login=function(){var e=a.user.email,f=a.user.password;return 0===e.length?void d.dangerAlert("Ungültige Emailadresse!"):0===f.length?void d.dangerAlert("Ungültiges Passwort!"):void c.login(e,f).then(function(){b.go("root.projectlist")})["catch"](function(a){d.throwException("Login","failed",a)})},a.logout=function(){c.logout(),b.go("root.home",{},{reload:!0})}}]),angular.module("dokuvisApp").controller("registerCtrl",["$scope","$state","UserAuthFactory","Utilities",function(a,b,c,d){a.userRegister={email:"",name:"",password1:"",password2:""},a.register=function(){var e=a.userRegister.email,f=a.userRegister.name,g=a.userRegister.password1,h=a.userRegister.password2;return g!==h?void d.dangerAlert("Die Passwörter stimmen nicht überein!"):0===e.length?void d.dangerAlert("Bitte geben Sie eine Emailadresse ein!"):0===f.length?void d.dangerAlert("Bitte geben Sie einen Nutzernamen ein!"):g.length<5?void d.dangerAlert("Passwort hat nicht genügend Zeichen (mind. 6)!"):void c.register(e,f,g).then(function(){b.go("projectlist")},function(a){d.throwException("Register","failed",a)})}}]),angular.module("dokuvisApp").controller("projectlistCtrl",["$scope","$state","$window","Utilities","Project","ConfirmService","$translate",function(a,b,c,d,e,f,g){}]),angular.module("dokuvisApp").controller("projectCtrl",["$scope","$state","$stateParams","$window","UserAuthFactory",function(a,b,c,d,e){a.project=c.project,a.toProjectList=function(){var a=b.href("root.projectlist");d.open(a,"_blank")},a.logout=function(){e.logout(),b.go("root.home",{},{reload:!0})},a.$on("modal.show",function(){console.log("modal show");var a=1040+10*$(".modal:visible").length;$(this).css("z-index",a),$(".modal-backdrop").not(".modal-stack").css("z-index",a-1).addClass("modal-stack")}),a.languagePopover={title:"Sprache",templateUrl:"partials/popovers/languageConfig.03a15e17.html",html:!0}}]),angular.module("dokuvisApp").controller("projHomeCtrl",["$scope","$stateParams","Utilities","Project","Subproject","$translatePartialLoader",function(a,b,c,d,e,f){function g(){d.get({id:b.project}).$promise.then(function(b){a.projectName=b.name,a.projectDesc=b.description})["catch"](function(a){c.throwApiException("#Project.get",a)})}function h(){e.get({id:b.subproject}).$promise.then(function(b){a.projectName=b.name,a.projectDesc=b.description})["catch"](function(a){c.throwApiException("#Subproject.get",a)})}f.addPart("projects"),a.isMaster="master"===b.subproject,"master"===b.subproject?g():h()}]),angular.module("dokuvisApp").controller("explorerCtrl",["$scope","$state","$stateParams","$timeout","$sce","$q","APIRequest","neo4jRequest","Utilities","webglInterface","$modal","Source","Model","Comment","Category",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){a.project=c.project,a.wi=j,a.views={},a.views.activeMain="3dview",a.views.activeSide="versions",a.listTabs="objects",a.listSettings="hierarchy",a.screenshots=[],a.screenshotPins={isVisible:!1},a.toggleSlice=!1,a.toggleCut=!1,a.unsafeSettings={},a.unsafeSettings.opacity=50,a.unsafeSettings.edges=!0,a.unsafeSettings.autoTransparent=!1,a.viewportSettings={},a.sliceSettings={},a.sliceSettings.enabled=!1,a.sliceSettings.axisAlign="z-axis",a.sliceSettings.planePosition=50,a.sliceSettings.showPlane=!0,a.sliceSettings.showSliceFaces=!0,a.coords={},a.coords.x=a.coords.y=a.coords.z=0,a.coords.xError=a.coords.yError=a.coords.zError=!1,a.coords.enabled=!1,a.constructionPhases={},a.constructionPhases.select=0,a.fellYear={},a.fellYear=0,a.position={},a.position.minAge=1250,a.position.maxAge=1750,a.scrollConfig={theme:"dark",axis:"y",scrollInertia:500,advanced:{updateOnContentResize:!1}},a.colorMarkerArray=[],a.ramp={start:[49,29,5],end:[249,226,189]},a.markerID=0,a.lineThickness={value:5},a.lineColor={value:"#ff0000"},a.marksOpacity=50,a.categories=[],a.activeCategory=null,a.activeVersion=null,a.selectedObjects=[],a.$on("modelVersionActive",function(b,c){a.activeVersion=c}),a.$on("viewportSelectionChange",function(b,c){a.selectedObjects=c}),a.getScreenshots=function(){h.getScreenshotsWithMarkers(a.project).then(function(b){return b.data.exception?void i.throwNeo4jException("on getScreenshots()",b):(b.data&&(a.screenshots=i.cleanNeo4jData(b.data)),void console.log("Screenshots:",a.screenshots))})},a.queryComments=function(){n.query().$promise.then(function(b){for(var c=0;c<b.length;c++)if("commentSource"===b[c].type)for(var d=0;d<b[c].targets.length;d++)for(var e=0;e<a.sourceResults.length;e++)if(b[c].targets[d]===a.sourceResults[e].eid){b[c].targets[d]=a.sourceResults[e];break}a.comments=b,console.log("Comments:",a.comments)},function(a){i.throwApiException("on Comment.query()",a)})},j.callFunc.updateComments=function(){a.queryComments()},a.receiveScreenshot=function(b){var d=i.getUniqueId();b.path=c.project+"/screenshots/",b.filename=d+"_screenshot.jpg",a.openScreenshotDetail(b)},a.togglePins=function(){if(a.screenshotPins.isVisible)for(var b=0;b<a.screenshots.length;b++)a.screenshots[b].pin.matrix&&j.callFunc.addPin(a.screenshots[b].id,a.screenshots[b].pin);else j.callFunc.removePins()},a.addPin=function(b,c,d){var e=$(d.delegateTarget).height(),f=$(d.delegateTarget).offset(),g=$("#svgViz").offset();f.left-=g.left,f.top-=g.top;var h=j.callFunc.addPin(b,c),i=["M"+f.left,f.top,"Q",h.x+.75*Math.abs(h.x-f.left),(h.y+f.top+e/2)/2+",",h.x,h.y,"Q",h.x+.75*Math.abs(h.x-f.left),(h.y+f.top+e/2)/2+",",f.left,f.top+100];a.path=i.join(" ")},a.removePin=function(b){a.line=null,a.path=null,j.callFunc.removePin(b)},a.open3DPlan=function(b){h.getAttached3DPlan(c.project,b.eid,b.plan3d).success(function(c,d){if(!c)return void console.error("neo4jRequest failed");var e=i.extractNeo4jData(c)[0];console.log(e),b.plan3d=a.callDirFunc.loadCTMPlanIntoScene(b.plan3d,e.object,e.file),console.log(b)})},a.getPlansForObj=function(){h.getPlansFromObject(a.selected.eid).success(function(b,c){a.sourceResults=i.cleanNeo4jData(b),console.log(a.sourceResults)})},a.highlightObj=function(a){console.log(a),l.getLinks({id:a.eid}).$promise.then(function(b){console.log(a,b),j.callFunc.highlightObjects(b)},function(a){i.throwApiException("on Source.getLinks()",a)})},a.connectPlanToObj=function(a){var b=j.callFunc.getObjForPlans(a.plan3d.meshId);console.log(b),a.$link({targets:b.objs}).then(function(a){console.log("plan connected",a)},function(a){i.throwApiException("on Source.links()",a)})},j.callFunc.highlightSources=function(b){m.getConnections(b.name).then(function(b){console.log(b);for(var c=0;c<a.sourceResults.length;c++){a.sourceResults[c].selected=!1;for(var d=0;d<b.data.length;d++)a.sourceResults[c].eid!==b.data[d].sourceId||(a.sourceResults[c].selected=!0,a.sourcesSettings.filterSelected=!0)}},function(a){i.throwApiException("on Model.getConnections()",a)})},a.callDirFunc={},a.addSlider=function(b){var c=b.offsetX/b.delegateTarget.offsetWidth,d=Math.round((1-c)*a.ramp.start[0]+c*a.ramp.end[0]),e=Math.round((1-c)*a.ramp.start[1]+c*a.ramp.end[1]),f=Math.round((1-c)*a.ramp.start[2]+c*a.ramp.end[2]);a.colorMarkerArray.push({position:b.offsetX,color:"rgb("+d+","+e+","+f+")"})},a.updateCategoryAttr=function(a){if(a.selected!==-1){for(var b=[],c=0;c<j.selected.length;c++)b.push(j.selected[c].eid);g.assignCategoryToObjects(b,a.selected).then(function(b){for(var c=0;c<j.selected.length;c++)a.selected?j.selected[c].categories[a.id]={catId:a.id,catValue:a.value,attrId:a.selected}:delete j.selected[c].categories[a.id];j.activeCategory===a&&j.callFunc.colorByCategory(j.activeCategory)},function(a){i.throwApiException("on assignCategoryToObjects()",a)})}},d(function(){},500),a.$on("$destroy",function(){j.callFunc.removePins(),console.log("destroy explorerCtrl")})}]),angular.module("dokuvisApp").controller("tasksCtrl",["$scope",function(a){a.views={activeSide:"details"},a.activeTask=null,a.$on("taskActivate",function(b,c){a.activeTask=c})}]),angular.module("dokuvisApp").controller("configCtrl",["$scope","Staff","Utilities",function(a,b,c){}]),angular.module("dokuvisApp").controller("resourcesCtrl",["$scope","$stateParams","$state","Utilities",function(a,b,c,d){}]),angular.module("dokuvisApp").controller("modelModalCtrl",["$scope","$state","$stateParams","$timeout","Model","Utilities",function(a,b,c,d,e,f){function g(){e.get(c.modelId).then(function(b){a.model=b.data,a.color="rgba("+Math.round(255*a.model.obj.materialColor[0])+","+Math.round(255*a.model.obj.materialColor[1])+","+Math.round(255*a.model.obj.materialColor[2])+","+a.model.obj.materialColor[3]+")",i=a.model.obj.materialColor,console.log(a.model),console.log(a.model.obj.materialColor)},function(a){f.throwApiException("on Model.get()",a)})}var h=!0;a.updated=!1,a.minicolors={control:"wheel",opacity:!0,position:"bottom left",format:"rgb",changeDelay:200};var i=[];a.updateValue=function(b){console.log(b),a.updated=!0,h=!1},a.updateColor=function(){if(h)h=!1;else{var b=a.color.match(/([0-9]*\.[0-9]+|[0-9]+)/g);a.model.obj.materialColor=[+(b[0]/255).toFixed(7),+(b[1]/255).toFixed(7),+(b[2]/255).toFixed(7),+b[3]],console.log("color",a.model.obj.materialColor),a.updated=!0}},a.save=function(){e.update(a.model).then(function(b){console.log(b),a.close()},function(a){f.throwApiException("on Model.update()",a)})},g(),a.close=function(){this.$hide(),this.$destroy(),b.go("^.^")},a.$on("$stateChangeSuccess",function(){d(function(){a.$hide(),a.$destroy()})})}]),angular.module("dokuvisApp").controller("spatializeModalCtrl",["$scope","$state","$stateParams","webglInterface","SpatializeInterface","Source","Utilities",function(a,b,c,d,e,f,g){a.source=c.source,a.save=function(){return a.source.dlt=e.getDLTInputs(),a.source.dlt?void f.spatialize({id:a.source.eid,type:a.source.type,method:"DLT"},a.source).$promise.then(function(b){console.log(b),delete a.source.dlt,b.spatial.source=a.source,e.callFunc.spatial.loadSpatializeImage(b.spatial,!0).then(function(a){d.callFunc.spatial.setImageView(a.object)})},function(a){g.throwApiException("on Source.spatialize()",a)}):void g.dangerAlert("Missing markers!")},a.close=function(){this.$hide(),this.$destroy(),b.go("^")},a.$on("$stateChangeSuccess",function(){$timeout(function(){a.$hide(),a.$destroy()})})}]),angular.module("dokuvisApp").controller("simpleModalCtrl",["$scope","$state",function(a,b){a.close=function(){b.go("^")}}]);